<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Medieval Life | D20 Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=MedievalSharp&family=Spectral:ital,wght@0,400;0,700;1,400&display=swap');

        :root {
            --parchment: #f4e4bc;
            --ink: #2c1e16;
            --leather: #5d4037;
            --gold: #b8860b;
            --success: #15803d;
            --failure: #b91c1c;
            --stress: #9f1239;
            --royal: #4c1d95;
            
            /* Item Rarities */
            --common: #737373;
            --uncommon: #16a34a;
            --rare: #2563eb;
            --very-rare: #9333ea;
            --legendary: #ea580c;
            --artifact: #ca8a04;
        }

        body {
            background-color: #0f0f0f;
            color: var(--ink);
            font-family: 'Spectral', serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .parchment-container {
            background-color: var(--parchment);
            background-image: url("https://www.transparenttextures.com/patterns/p6-dark.png");
            border: 12px solid var(--leather);
            border-image: linear-gradient(to bottom, #8b4513, #5d4037) 1;
            box-shadow: 0 0 50px rgba(0,0,0,0.8), inset 0 0 120px rgba(0,0,0,0.2);
            max-width: 1000px;
            width: 95%;
            height: 95vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .header {
            font-family: 'MedievalSharp', cursive;
            border-bottom: 2px solid rgba(44, 30, 22, 0.2);
            padding: 1rem;
            text-align: center;
            background: rgba(0,0,0,0.03);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            align-items: center;
            padding-right: 3rem; /* Space for settings */
        }

        .settings-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--leather);
            transition: transform 0.3s;
            z-index: 60;
        }
        .settings-btn:hover { transform: rotate(90deg); }

        .main-layout {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 240px;
            border-right: 2px solid rgba(44, 30, 22, 0.1);
            display: flex;
            flex-direction: column;
            background: rgba(0,0,0,0.02);
            overflow-y: auto;
        }

        .tab-btn {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(44, 30, 22, 0.05);
            font-family: 'MedievalSharp', cursive;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover { background: rgba(0,0,0,0.05); }
        .tab-btn.active { background: rgba(255,255,255,0.4); border-left: 5px solid var(--leather); font-weight: bold; }

        .content-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* D&D Stat Block Styling */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            padding: 1rem;
            background: rgba(93, 64, 55, 0.05);
            border-bottom: 1px solid rgba(44,30,22,0.1);
        }

        .stat-box {
            text-align: center;
            border: 2px solid var(--leather);
            border-radius: 8px;
            background: rgba(255,255,255,0.4);
            position: relative;
            padding-bottom: 4px;
        }

        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: bold;
            display: block;
            background: var(--leather);
            color: #f4e4bc;
            padding: 2px 0;
            border-radius: 4px 4px 0 0;
        }

        .stat-val { font-family: 'MedievalSharp'; font-size: 1.2rem; font-weight: bold; display: block; margin-top: 2px; }
        .stat-mod { font-size: 0.75rem; color: #666; font-weight: bold; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); background: #f4e4bc; padding: 0 4px; border: 1px solid var(--leather); border-radius: 4px; }

        #event-log {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            scroll-behavior: smooth;
        }

        .event-entry {
            border-left: 4px solid var(--leather);
            padding: 10px 16px;
            animation: fadeIn 0.5s ease-out;
            background: rgba(255,255,255,0.3);
            border-radius: 0 8px 8px 0;
            position: relative;
        }

        .event-entry.age-marker {
            border-left: 4px solid var(--gold);
            background: rgba(184, 134, 11, 0.1);
            text-align: center;
            font-family: 'MedievalSharp';
            font-size: 1.1rem;
        }

        .dice-result {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85rem;
            margin-top: 4px;
        }
        .dice-success { background: #dcfce7; color: var(--success); border: 1px solid var(--success); }
        .dice-failure { background: #fee2e2; color: var(--failure); border: 1px solid var(--failure); }
        .dice-crit { background: var(--gold); color: white; text-shadow: 0 1px 2px black; border: 1px solid #854d0e; }

        .choices-area {
            padding: 1.5rem;
            border-top: 2px solid rgba(44, 30, 22, 0.2);
            background: rgba(0,0,0,0.04);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-btn {
            background: linear-gradient(to bottom, #5d4037, #3e2723);
            color: #f4e4bc;
            padding: 12px 16px;
            border-radius: 6px;
            font-family: 'MedievalSharp', cursive;
            text-align: left;
            width: 100%;
            transition: all 0.2s;
            border: 2px solid #2c1e16;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .choice-btn:hover:not(:disabled) { 
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            filter: brightness(1.1);
        }
        
        .choice-btn:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }
        .choice-btn.active-opt { border: 2px solid var(--gold); background: var(--leather); filter: brightness(1.2); }

        .dc-badge {
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* House System Styling */
        .house-crest { font-size: 4rem; margin-bottom: 1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .house-tier-royal { color: var(--royal); }
        .house-rank-head { border-left: 3px solid var(--gold); padding-left: 8px; font-weight: bold; }
        .house-rank-member { padding-left: 8px; opacity: 0.8; }
        
        /* Occupation Styling */
        .bar-container { height: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden; margin-top: 4px; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        .stress-fill { background: var(--stress); }
        .perf-fill { background: var(--success); }
        .affinity-fill { background: #db2777; }
        
        .job-card {
            border: 2px solid var(--leather);
            background: rgba(255,255,255,0.4);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .rel-card {
            background: rgba(255,255,255,0.3);
            border: 1px solid rgba(93, 64, 55, 0.2);
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .rel-card:hover { background: rgba(255,255,255,0.5); }

        /* Map Styling */
        .city-card {
            border: 1px solid var(--leather);
            background: rgba(255,255,255,0.4);
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .current-city { border-left: 5px solid var(--gold); background: rgba(255,255,255,0.6); }
        
        .map-visual-container {
            width: 100%; height: 300px; background: #e6d5b8; border: 2px solid var(--leather);
            margin-bottom: 1rem; position: relative; overflow: hidden;
            background-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M0 0 Q 50 50 100 0" stroke="rgba(0,0,0,0.05)" fill="none"/><path d="M0 100 Q 50 50 100 100" stroke="rgba(0,0,0,0.05)" fill="none"/></svg>');
        }
        
        .map-node {
            position: absolute; width: 12px; height: 12px; background: var(--leather); border-radius: 50%;
            transform: translate(-50%, -50%); cursor: pointer; transition: all 0.3s;
            border: 2px solid #f4e4bc; z-index: 10;
        }
        .map-node:hover { transform: translate(-50%, -50%) scale(1.5); background: var(--gold); }
        .map-node.active { background: var(--royal); width: 16px; height: 16px; border: 2px solid var(--gold); }
        
        .map-label {
            position: absolute; font-size: 10px; font-weight: bold; background: rgba(255,255,255,0.7);
            padding: 1px 4px; border-radius: 4px; pointer-events: none; white-space: nowrap;
            transform: translate(-50%, -150%);
        }

        /* Inventory Styling */
        .item-row { display: flex; align-items: center; justify-content: space-between; padding: 6px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .item-rarity-Common { color: var(--common); font-weight: bold; }
        .item-rarity-Uncommon { color: var(--uncommon); font-weight: bold; }
        .item-rarity-Rare { color: var(--rare); font-weight: bold; text-shadow: 0 0 1px rgba(37,99,235,0.2); }
        .item-rarity-VeryRare { color: var(--very-rare); font-weight: bold; text-shadow: 0 0 2px rgba(147,51,234,0.3); }
        .item-rarity-Legendary { color: var(--legendary); font-weight: bold; text-shadow: 0 0 3px rgba(234,88,12,0.4); }
        .item-rarity-Artifact { color: var(--artifact); font-weight: bold; text-shadow: 0 0 5px rgba(202,138,4,0.5); }

        /* Activities Styling */
        .act-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .act-btn { text-align: center; padding: 15px 5px; flex-direction: column; gap: 5px; height: 100px; justify-content: center; }
        .act-icon { font-size: 2rem; display: block; margin-bottom: 4px; }

        /* Utility */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(2px);
        }
        .modal-box {
            background: var(--parchment);
            border: 4px solid var(--leather);
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            border-radius: 8px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .creation-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--parchment); z-index: 50;
            display: flex; flex-direction: column; padding: 2rem;
            text-align: center; overflow-y: auto;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--leather); border-radius: 4px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="parchment-container">
    <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h2 class="text-3xl font-medieval mb-4">Settings</h2>
            <p class="mb-6 italic">Manage your journey.</p>
            <div class="flex flex-col gap-3">
                <button onclick="restartGame()" class="choice-btn text-center justify-center bg-red-800 text-white">Restart Chronicle (Delete Save)</button>
                <button onclick="closeSettings()" class="choice-btn text-center justify-center">Return to Game</button>
            </div>
        </div>
    </div>

    <!-- NPC Modal -->
    <div id="npc-modal" class="modal-overlay hidden">
        <div class="modal-box text-left relative">
            <button onclick="closeNPC()" class="absolute top-2 right-4 text-xl font-bold">X</button>
            <div id="npc-content"></div>
        </div>
    </div>

    <!-- Lore Modal -->
    <div id="lore-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h2 class="text-4xl font-medieval mb-4 text-amber-900">The Kingdom of Chep</h2>
            <div class="text-left space-y-4 mb-6 text-sm max-h-60 overflow-y-auto pr-2">
                <p>In the <strong>Age of Ash</strong>, the sky wept soot. For four hundred years, the sun was but a pale ghost behind a shroud of burning cities. Brother slew brother for a scrap of bread, and Warlords built thrones upon mounds of bone. Hope was a word forgotten by the living.</p>
                
                <p>Then, the heavens opened. A star fell to earth, shattering the eternal twilight‚Äîa meteor of pure, singing starlight. From the crater rose <strong>Hero Ren</strong>, not a king, but a savior. He forged the fallen star into <strong>Lumina</strong>, the Blade of Dawn.</p>
                
                <p>At the foot of Dread Peak, Ren stood alone against the seven greatest Warlords. With a single swing, he did not strike them, but clove the mountain itself in twain. The earth shook, and the Warlords, witnessing power beyond mortal ken, fell to their knees in silence.</p>
                
                <p>There, amidst the dust, the <strong>Oath of Unity</strong> was sworn in blood and starlight. Ren became the first King of <strong>House Chep</strong>, the anchor of the realm. The Warlords rose not as tyrants, but as the <strong>Seven Greater Houses</strong>‚Äîguardians of the peace they once sought to destroy.</p>
                
                <ul class="list-disc pl-5 mt-2 mb-2 italic opacity-80">
                    <li><strong>Valdoria:</strong> Masters of coin and trade in the golden west.</li>
                    <li><strong>Thalor:</strong> Wardens of the stormy seas and the leviathans beneath.</li>
                    <li><strong>Grimward:</strong> Sentinels of the frozen north against the darkness.</li>
                    <li><strong>Sunstrider:</strong> Keepers of the deep forests and ancient magic.</li>
                    <li><strong>Ironheart:</strong> Forgers of steel and stone in the industrial heart.</li>
                    <li><strong>Moonshadow:</strong> Scholars of the arcane arts built upon ruins.</li>
                    <li><strong>Stormbreaker:</strong> Watchers of the high peaks, touching the clouds.</li>
                </ul>
                
                <p>You are a child of this fragile peace. But the starlight is fading, and in the shadows, the old thirst for blood begins to wake.</p>
            </div>
            <button onclick="enterWorld()" class="choice-btn text-center justify-center font-bold text-lg">Enter the World</button>
        </div>
    </div>

    <!-- Character Creation Overlay -->
    <div id="creation-screen" class="creation-screen">
        <h2 class="text-5xl font-bold mb-2 text-amber-900" style="font-family: 'MedievalSharp';">A Medieval Life</h2>
        <p class="italic mb-8 text-lg opacity-70">By Juanse Gutierrez</p>
        
        <div class="max-w-xl mx-auto w-full bg-white/40 p-6 rounded-lg border-2 border-[#5d4037] shadow-xl">
            <h3 class="text-xl font-bold mb-4">Forge Your Destiny</h3>
            <input type="text" id="char-name" placeholder="Enter First Name" class="w-full p-3 border-2 border-[#5d4037] bg-[#fdf6e3] text-center text-xl font-bold mb-6 focus:outline-none focus:border-amber-600 rounded">
            
            <div class="flex justify-center gap-4 mb-6">
                <button id="gender-m" class="choice-btn w-32 justify-center" onclick="setGender('Male')">Male</button>
                <button id="gender-f" class="choice-btn w-32 justify-center opacity-60" onclick="setGender('Female')">Female</button>
            </div>

            <div class="text-left mb-2 font-bold flex justify-between">
                <span>Ability Scores</span>
                <span class="text-xs font-normal italic">Standard Array (15, 14, 13, 12, 10, 8) assigned randomly</span>
            </div>
            
            <div id="creation-stats" class="grid grid-cols-3 gap-2 mb-6">
                <!-- Stats injected here -->
            </div>

            <button onclick="rerollStats()" class="text-xs underline text-amber-900 mb-4 cursor-pointer hover:text-amber-700">Reroll Dice</button>

            <div class="border-t border-black/20 pt-4 mb-6">
                <h4 class="font-bold mb-2">Social Origin</h4>
                <div class="flex gap-2">
                    <button id="origin-peasant" class="choice-btn text-sm justify-center active-opt" onclick="setOrigin('Peasant')">Humble Beginnings</button>
                    <button id="origin-house" class="choice-btn text-sm justify-center opacity-60" onclick="setOrigin('House')">Noble Bloodline (Roll)</button>
                </div>
            </div>

            <button id="start-btn" class="w-full bg-[#8b4513] text-white font-medieval text-2xl py-3 rounded border-2 border-[#2c1e16] hover:bg-[#a0522d] transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled onclick="startGame()">Begin Chronicle</button>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="text-left">
            <h1 class="text-xl font-bold" id="display-name">Unknown Soul</h1>
            <p class="text-xs opacity-70 font-bold text-amber-900" id="display-class">Commoner</p>
        </div>
        <div class="text-center">
            <span id="header-hp" class="text-red-900 font-bold text-xl drop-shadow-md" title="Health Points">10/10 HP</span>
        </div>
        <div class="text-right">
            <h2 class="text-2xl font-bold text-amber-900" id="year-display">Year 0</h2>
            <p class="text-xs">Age: <span id="age-display">0</span></p>
        </div>
    </div>

    <!-- Main Game Area -->
    <div class="main-layout">
        <div class="sidebar">
            <div id="tab-log" class="tab-btn active" onclick="switchTab('log')">üìú Chronicle</div>
            <div id="tab-char" class="tab-btn" onclick="switchTab('char')">üë§ Character</div>
            <div id="tab-house" class="tab-btn" onclick="switchTab('house')">üè∞ House</div>
            <div id="tab-rel" class="tab-btn" onclick="switchTab('rel')">‚ù§Ô∏è Relationships</div>
            <div id="tab-occ" class="tab-btn" onclick="switchTab('occ')">‚öíÔ∏è Occupation</div>
            <div id="tab-act" class="tab-btn" onclick="switchTab('act')">üé≠ Activities</div>
            <div id="tab-map" class="tab-btn" onclick="switchTab('map')">üó∫Ô∏è Map</div>
            <div id="tab-inv" class="tab-btn" onclick="switchTab('inv')">üéí Inventory</div>
            
            <div class="mt-auto p-4 border-t border-black/10 text-xs">
                <div class="font-bold mb-1">Unlocks</div>
                <ul id="unlock-list" class="list-disc pl-4 space-y-1 opacity-70">
                    <li class="line-through">Birth</li>
                </ul>
            </div>
        </div>

        <div class="content-area">
            <!-- D&D Stat Block -->
            <div class="stats-grid">
                <div class="stat-box"><span class="stat-label">STR</span><span id="stat-str" class="stat-val">10</span><span id="mod-str" class="stat-mod">+0</span></div>
                <div class="stat-box"><span class="stat-label">DEX</span><span id="stat-dex" class="stat-val">10</span><span id="mod-dex" class="stat-mod">+0</span></div>
                <div class="stat-box"><span class="stat-label">CON</span><span id="stat-con" class="stat-val">10</span><span id="mod-con" class="stat-mod">+0</span></div>
                <div class="stat-box"><span class="stat-label">INT</span><span id="stat-int" class="stat-val">10</span><span id="mod-int" class="stat-mod">+0</span></div>
                <div class="stat-box"><span class="stat-label">WIS</span><span id="stat-wis" class="stat-val">10</span><span id="mod-wis" class="stat-mod">+0</span></div>
                <div class="stat-box"><span class="stat-label">CHA</span><span id="stat-cha" class="stat-val">10</span><span id="mod-cha" class="stat-mod">+0</span></div>
            </div>

            <!-- Tab: Log (Main Gameplay) -->
            <div id="log-tab" class="tab-content flex-grow flex flex-col overflow-hidden">
                <div id="event-log"></div>
                <div id="input-area" class="mt-auto">
                    <div id="decision-prompt" class="px-6 py-3 bg-amber-900/10 font-bold text-amber-900 border-t border-black/10 font-medieval text-lg">
                        Fate awaits...
                    </div>
                    <div id="choices-container" class="choices-area">
                        <!-- Buttons injected here -->
                    </div>
                </div>
            </div>

            <!-- Tab: Activities -->
            <div id="act-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-2 border-b border-black/20 pb-2">Activities</h2>
                <div id="act-content" class="act-grid"></div>
            </div>

            <!-- Tab: Character Sheet -->
            <div id="char-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-4 border-b border-black/20 pb-2">Character Sheet</h2>
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-bold mb-2">Vitals</h3>
                        <p><strong>Health:</strong> <span id="hp-display" class="text-green-800 font-bold">10 / 10</span></p>
                        <p><strong>Gold:</strong> <span id="gold-display">0</span> GP</p>
                        <p><strong>Social Reality:</strong> <span id="social-display">Peasant</span></p>
                        <p><strong>Location:</strong> <span id="location-display">Chep</span></p>
                        <p><strong>Alignment:</strong> <span id="align-display">True Neutral</span></p>
                        
                        <h3 class="font-bold mt-4 mb-2 border-t border-black/10 pt-2">Reputation & Fame</h3>
                        <div class="text-sm">
                             <div class="flex justify-between"><span>üëë Renown:</span> <span id="rep-renown">0</span></div>
                             <div class="flex justify-between"><span>‚öîÔ∏è Honor:</span> <span id="rep-honor">0</span></div>
                             <div class="flex justify-between"><span>üôè Piety:</span> <span id="rep-piety">0</span></div>
                             <div class="flex justify-between text-red-800"><span>‚ò†Ô∏è Infamy:</span> <span id="rep-infamy">0</span></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold mb-2">Traits & Feats</h3>
                        <div id="traits-list" class="text-sm space-y-1 italic">None yet...</div>
                    </div>
                </div>
            </div>

            <!-- Tab: Map -->
            <div id="map-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-4 border-b border-black/20 pb-2">Kingdom of Chep</h2>
                <div id="map-visual" class="map-visual-container"></div>
                <div id="map-content"></div>
            </div>

            <!-- Tab: House / Lineage -->
            <div id="house-tab" class="tab-content hidden p-6 overflow-y-auto text-center">
                <!-- Content injected via JS -->
                <div id="house-content"></div>
            </div>

            <!-- Tab: Relationships -->
            <div id="rel-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-4 border-b border-black/20 pb-2">Relationships</h2>
                <p class="text-xs italic mb-2">Click on a person to view their details.</p>
                <div id="rel-content"></div>
            </div>

            <!-- Tab: Occupation -->
            <div id="occ-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-4 border-b border-black/20 pb-2">Occupation & Trade</h2>
                <div id="occ-content"></div>
            </div>
            
             <!-- Tab: Inventory -->
             <div id="inv-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-4 border-b border-black/20 pb-2">Inventory</h2>
                <div id="inventory-list" class="flex flex-col gap-1">
                    <p class="italic opacity-50">Your satchel is empty.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    /* --- ARCANE ARCHITECT'S ENGINE --- */

    // 1. D&D 5e MECHANICS
    const ABILITIES = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
    
    function getModifier(score) {
        return Math.floor((score - 10) / 2);
    }

    function formatMod(mod) {
        return mod >= 0 ? `+${mod}` : `${mod}`;
    }

    function rollD20(mod) {
        const roll = Math.floor(Math.random() * 20) + 1;
        return {
            roll: roll,
            mod: mod,
            total: roll + mod,
            isCrit: roll === 20,
            isFail: roll === 1
        };
    }

    // 2. STATE MANAGEMENT
    const state = {
        name: "Unknown",
        gender: "Male",
        age: 0,
        year: 1200,
        stats: { str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10 },
        reputation: { renown: 0, honor: 0, piety: 0, infamy: 0 },
        gold: 0,
        health: 10,
        maxHealth: 10,
        socialClass: "Peasant", 
        house: null, 
        location: 0, // Index of current city
        relationships: [],
        interactions: {}, // tracks yearly interactions per person ID
        activityLog: { love: 0, quest: 0, crime: 0, train: 0 }, // yearly limits
        occupation: null, 
        jobHistory: {}, 
        traits: [],
        inventory: [],
        flags: {
            literate: false,
            criminal: false,
            married: false,
            employed: false,
            startOrigin: 'Peasant'
        }
    };

    // 3. DATA: OCCUPATIONS
    const CAREERS = {
        common: { 
            name: "Common Labor", 
            req: { age: 8 },
            ranks: [
                { title: "Errand Runner", wage: 1, stressMod: 1 },
                { title: "Farmhand", wage: 5, stressMod: 2 },
                { title: "Foreman", wage: 12, stressMod: 3 }
            ]
        },
        trade: { 
            name: "Skilled Trade", 
            req: { age: 10, stat: 'dex', val: 12 },
            ranks: [
                { title: "Apprentice", wage: 3, stressMod: 2 },
                { title: "Journeyman", wage: 15, stressMod: 3 },
                { title: "Master Artisan", wage: 40, stressMod: 5 }
            ]
        },
        squire: {
            name: "Squireship",
            req: { age: 12, stat: 'str', val: 12 }, // Usually special entry
            ranks: [
                { title: "Page", wage: 2, stressMod: 2 },
                { title: "Squire", wage: 5, stressMod: 4 },
                { title: "Knight-Errant", wage: 20, stressMod: 6 } // Promotes to full Knight
            ]
        },
        military: { 
            name: "Military", 
            req: { age: 14, stat: 'str', val: 11 },
            ranks: [
                { title: "Camp Follower", wage: 2, stressMod: 1 },
                { title: "Foot Soldier", wage: 10, stressMod: 5 },
                { title: "Veteran Sergeant", wage: 25, stressMod: 6 },
                { title: "Captain", wage: 60, stressMod: 8 }
            ]
        },
        scholar: {
            name: "Scholarly",
            req: { age: 12, stat: 'int', val: 13, flag: 'literate' },
            ranks: [
                { title: "Scribe's Assistant", wage: 4, stressMod: 1 },
                { title: "Junior Scribe", wage: 12, stressMod: 2 },
                { title: "Court Historian", wage: 45, stressMod: 4 }
            ]
        },
        crime: {
            name: "Criminal",
            req: { age: 8, stat: 'dex', val: 10 },
            ranks: [
                { title: "Pickpocket", wage: 5, stressMod: 4 },
                { title: "Burglar", wage: 20, stressMod: 6 },
                { title: "Crime Boss", wage: 100, stressMod: 10 }
            ]
        }
    };

    // 4. DATA: HOUSE & CITY SYSTEM
    const TIER_DATA = {
        royal: { name: 'Royal House', sigils: ['ü¶Å', 'üëë'], prob: 0.01 },
        greater: { name: 'Greater House', sigils: ['ü¶Ö', 'üê∫', 'üêâ', 'ü¶å', 'ü¶ë', 'üåπ', '‚òÄÔ∏è'], prob: 0.10 },
        lesser: { name: 'Lesser House', sigils: ['üå≤', 'üêç', 'üè∞', 'üêó', 'üó°Ô∏è', 'üõ°Ô∏è', 'üîî'], prob: 0.89 }
    };
    
    const HOUSE_RANKS = ["Lord/Lady", "Heir", "Younger Child", "House Member", "Sworn Sword", "Servant"];
    
    const HOUSE_NAMES = {
        royal: ["Chep"],
        greater: ["Valdoria", "Thalor", "Grimward", "Sunstrider", "Ironheart", "Moonshadow", "Stormbreaker"],
        lesser: ["Oakenshield", "Swiftwater", "Gloomveil", "Brightsteel", "Duskwood", "Cragstone", "Mistwalker", 
                 "Windrider", "Frostborne", "Emberfall", "Ironfoot", "Ravenhill", "Shadowmere", "Lightbringer"]
    };
    
    const CITIES = [
        { name: "Chep (Capital)", ruler: "House Chep", desc: "The royal seat of power, founded by Hero Ren.", x: 50, y: 50 },
        { name: "Frosthold", ruler: "House Grimward", desc: "A fortress of ice and stone in the far north.", x: 50, y: 15 },
        { name: "Goldspire", ruler: "House Valdoria", desc: "A glittering city of trade carved into western cliffs.", x: 15, y: 60 },
        { name: "Arcania", ruler: "House Moonshadow", desc: "A hub of knowledge built atop ancient ruins.", x: 80, y: 70 },
        { name: "Verdant Reach", ruler: "House Sunstrider", desc: "Nestled in the deep, mystical southern forests.", x: 50, y: 85 },
        { name: "Sky Bastion", ruler: "House Stormbreaker", desc: "A mountain stronghold touching the clouds.", x: 85, y: 25 },
        { name: "Ironport", ruler: "House Ironheart", desc: "The industrial heart, forging steel for the realm.", x: 20, y: 35 },
        { name: "Tidecaller's Keep", ruler: "House Thalor", desc: "A fortress withstanding the eternal ocean storms.", x: 10, y: 80 }
    ];

    const NPC_NAMES = {
        m: ["Aelar", "Thorne", "Cedric", "Dravek", "Eldric", "Fenris", "Garrick", "Haldor", "Isen", "Jorik"],
        f: ["Aeliana", "Brynn", "Caelia", "Elara", "Fae", "Gwyneth", "Isolde", "Kaida", "Lyra", "Mira"]
    };

    // 5. EVENT POOLS
    const createEvent = (id, title, text, choices) => ({ id, title, text, choices });
    const POOLS = {
        Infancy: [ 
            createEvent('inf_omen', 'Astrological Omen', 'The village elder casts bones upon your crib.', [
                { text: 'Smile at the Elder', type: 'flavor', effect: () => { state.stats.cha++; modRep('renown', 2); log(`The Elder smiles back. "A charmer," she says. (+1 CHA)`); } },
                { text: 'Cry loudly', type: 'flavor', effect: () => { state.stats.con++; log(`"Strong lungs," the Elder grunts. (+1 CON)`); } },
                { text: 'Sleep', type: 'flavor', effect: () => log("You ignore the prophecy.") }
            ]),
            createEvent('inf_lucky', 'Shiny Pebble', 'You find a perfectly round stone in the crib.', [
                { text: 'Keep it', type: 'flavor', effect: () => { addItem('Lucky Stone', 'Common', 'A smooth river stone.'); log("It feels lucky."); } },
                { text: 'Eat it', type: 'flavor', effect: () => { state.health -= 1; log("It chokes you slightly. (-1 HP)"); } },
                { text: 'Throw it', type: 'flavor', effect: () => { state.stats.dex++; log("Good aim! (+1 DEX)"); } }
            ]),
            createEvent('inf_sick', 'The Fever', 'A sweating sickness grips the nursery.', [
                { text: 'Fight the sickness', type: 'check', stat: 'con', dc: 10, success: 'You break the fever naturally. (+1 CON)', fail: 'The fever breaks, but leaves you frail. (-1 STR)', onSuccess: () => state.stats.con++, onFail: () => state.stats.str-- },
                { text: 'Cry for help', type: 'flavor', effect: () => { if(getParent()) log("Your parent comforts you."); else log("No one comes."); } }
            ]),
            createEvent('inf_first_words', 'First Words', 'You feel a desire to speak.', [
                { text: 'Say "Mama"', type: 'flavor', effect: () => { if(hasParent('Mother')) { modRel(getParent('Mother').id, 10); log("Mother is delighted."); } else log("You call out to the void."); } },
                { text: 'Say "Dada"', type: 'flavor', effect: () => { if(hasParent('Father')) { modRel(getParent('Father').id, 10); log("Father beams with pride."); } else log("You call out to the void."); } },
                { text: 'Say "Food"', type: 'flavor', effect: () => { state.stats.con++; log("Priorities. (+1 CON)"); } }
            ])
        ],
        Childhood: [
            createEvent('child_bully', 'The Bully', 'A larger child demands your lunch.', [
                { text: 'Punch him', type: 'check', stat: 'str', dc: 12, success: 'You bloody his nose! (+Honor)', fail: 'He pummels you.', onSuccess: () => modRep('honor', 5), onFail: () => modRep('honor', -2) },
                { text: 'Outsmart him', type: 'check', stat: 'int', dc: 13, success: 'You trick him.', fail: 'He hits you.', onSuccess: () => state.stats.int++, onFail: () => takeDamage(5) },
                { text: 'Give Lunch', type: 'flavor', effect: () => { modRep('honor', -1); log("You go hungry."); } }
            ]),
            createEvent('child_find', 'Lost Heirloom', 'Digging in the mud, you hit metal.', [
                { text: 'Clean it off', type: 'check', stat: 'int', dc: 10, success: 'It is a silver locket!', fail: 'Just rusty scrap.', onSuccess: () => addItem('Rusted Locket', 'Common', 'Once held a portrait.'), onFail: () => {} },
                { text: 'Bury it', type: 'flavor', effect: () => log("Some secrets should stay buried.") },
                { text: 'Show parent', type: 'flavor', effect: () => { if(getParent()) { modRel(getParent().id, 5); log("They pat your head."); } else log("You have no one to show."); } }
            ]),
            createEvent('child_parent_lesson', 'A Lesson', 'Your parent tries to teach you a trade.', [
                { text: 'Listen intently', type: 'check', stat: 'wis', dc: 10, success: 'You learn well. (+1 WIS)', fail: 'You get bored.', onSuccess: () => state.stats.wis++, onFail: () => {} },
                { text: 'Play instead', type: 'flavor', effect: () => { state.stats.dex++; log("You run around. (+1 DEX)"); } },
                { text: 'Argue', type: 'flavor', effect: () => { state.stats.cha++; log("You talk back. (+1 CHA)"); } }
            ]),
            createEvent('child_temple', 'Temple Visit', 'The bells ring for prayer.', [
                { text: 'Pray devoutly', type: 'check', stat: 'wis', dc: 12, success: 'You feel a presence. (+Piety)', fail: 'You fall asleep.', onSuccess: () => modRep('piety', 5), onFail: () => {} },
                { text: 'Steal offerings', type: 'check', stat: 'dex', dc: 14, success: 'You snag a coin. (+2g, +Infamy)', fail: 'Caught by a priest!', onSuccess: () => { state.gold += 2; modRep('infamy', 2); }, onFail: () => modRep('infamy', 5) }
            ])
        ],
        Teen: [
             createEvent('teen_love', 'First Crush', 'You catch the eye of a peer.', [
                { text: 'Woo with poetry', type: 'check', stat: 'cha', dc: 13, success: 'Romance blooms.', fail: 'You stutter.', onSuccess: () => state.stats.cha++, onFail: () => state.stats.cha-- },
                { text: 'Impress with strength', type: 'check', stat: 'str', dc: 12, success: 'They admire you.', fail: 'You fail to lift the heavy sack.', onSuccess: () => state.stats.str++, onFail: () => {} },
                { text: 'Ignore them', type: 'flavor', effect: () => { state.stats.wis++; log("Focus on studies. (+1 WIS)"); } }
            ]),
            createEvent('teen_loot', 'Old Battlefield', 'You scavenge an old skirmish site.', [
                { text: 'Search bodies', type: 'check', stat: 'wis', dc: 14, success: 'You find a blade!', fail: 'Nothing but bones.', onSuccess: () => addItem('Soldier\'s Dagger', 'Uncommon', 'A serviceable steel blade.'), onFail: () => {} },
                { text: 'Say a prayer', type: 'flavor', effect: () => { modRep('piety', 2); log("Rest in peace."); } },
                { text: 'Leave', type: 'flavor', effect: () => log("You leave the dead alone.") }
            ]),
            createEvent('teen_rebel', 'Rebellion', 'Your parents forbid you from the festival.', [
                { text: 'Sneak out', type: 'check', stat: 'dex', dc: 14, success: 'A wild night! (+Renown)', fail: 'Caught and grounded.', onSuccess: () => modRep('renown', 5), onFail: () => modRep('honor', -2) },
                { text: 'Obey', type: 'flavor', effect: () => { modRep('piety', 2); log("You meditate at home."); } },
                { text: 'Argue loudly', type: 'check', stat: 'cha', dc: 12, success: 'They let you go.', fail: 'You are confined to your room.', onSuccess: () => state.stats.cha++, onFail: () => {} }
            ])
        ],
        Adult: [
            createEvent('adult_war', 'Call to Arms', 'Levies are raised.', [
                { text: 'Go to War', type: 'check', stat: 'con', dc: 14, success: 'You survive a veteran. (+50 GP, +Honor)', fail: 'You return with a limp. (-1 DEX)', onSuccess: () => { state.gold += 50; addTrait('Veteran'); modRep('honor', 10); }, onFail: () => state.stats.dex-- },
                { text: 'Pay substitute (20 GP)', type: 'flavor', req: (s) => s.gold >= 20, effect: () => { state.gold -= 20; log("You paid a coward's tax."); modRep('honor', -5); } }
            ]),
            createEvent('adult_magic', 'Arcane Discovery', 'You find a glowing rune.', [
                { text: 'Touch it', type: 'check', stat: 'int', dc: 16, success: 'It fuses to your hand!', fail: 'It burns you.', onSuccess: () => addItem('Ring of Protection', 'Rare', 'Grants a magical shield.'), onFail: () => takeDamage(10) }
            ])
        ],
        Elder: [
             createEvent('elder_legacy', 'Family Vault', 'You decide to open the old vault.', [
                { text: 'Open it', type: 'check', stat: 'wis', dc: 15, success: 'An ancient relic!', fail: 'Just dust.', onSuccess: () => addItem('Ancient Grimoire', 'VeryRare', 'Contains lost spells.'), onFail: () => {} }
            ])
        ],
        Travel: [
            createEvent('travel_bandit', 'Roadside Ambush', 'Bandits block the path.', [
                { text: 'Fight', type: 'check', stat: 'str', dc: 12, success: 'You clear the road.', fail: 'They beat you and take gold.', onSuccess: () => modRep('renown', 2), onFail: () => { takeDamage(5); state.gold = Math.max(0, state.gold - 10); } },
                { text: 'Pay Toll (5g)', type: 'flavor', req: (s) => s.gold >= 5, effect: () => { state.gold -= 5; log("Safe but poorer."); } }
            ]),
            createEvent('travel_storm', 'Sudden Storm', 'Heavy rain turns the road to mud.', [
                { text: 'Push through', type: 'check', stat: 'con', dc: 14, success: 'You arrive tired but on time.', fail: 'You catch a cold.', onSuccess: () => {}, onFail: () => takeDamage(3) }
            ]),
            createEvent('travel_shrine', 'Forgotten Shrine', 'An overgrown altar by the road.', [
                { text: 'Pray', type: 'check', stat: 'wis', dc: 10, success: 'You feel blessed. (+Piety)', fail: 'Nothing happens.', onSuccess: () => { modRep('piety', 5); state.health = Math.min(state.maxHealth, state.health + 5); log("Healed 5 HP."); }, onFail: () => {} }
            ])
        ],
        Quest: [
            createEvent('quest_monster', 'The Beast', 'A monster plagues the local farms.', [
                { text: 'Slay it', type: 'check', stat: 'str', dc: 15, success: 'The beast falls! (+Renown, +50g)', fail: 'It mauls you.', onSuccess: () => { modRep('renown', 10); state.gold += 50; }, onFail: () => takeDamage(10) },
                { text: 'Track it', type: 'check', stat: 'wis', dc: 14, success: 'You find its lair and loot it. (+30g)', fail: 'You get lost.', onSuccess: () => state.gold += 30, onFail: () => {} }
            ]),
            createEvent('quest_escort', 'Merchant Escort', 'A merchant needs guards.', [
                { text: 'Guard him', type: 'check', stat: 'wis', dc: 12, success: 'Safe arrival. (+20g)', fail: 'Bandits raid the caravan.', onSuccess: () => state.gold += 20, onFail: () => { state.health -= 5; } }
            ])
        ],
        Crime: [
            createEvent('crime_heist', 'Manor Heist', 'A noble villa is unguarded.', [
                { text: 'Rob it', type: 'check', stat: 'dex', dc: 16, success: 'Jackpot! (+100g, +Infamy)', fail: 'Guards! (-HP, Jail)', onSuccess: () => { state.gold += 100; modRep('infamy', 10); }, onFail: () => { takeDamage(10); modRep('infamy', 5); } }
            ]),
            createEvent('crime_mug', 'Alleyway Mugging', 'A wealthy drunk stumbles by.', [
                { text: 'Mug him', type: 'check', stat: 'str', dc: 10, success: 'Easy coin. (+10g, +Infamy)', fail: 'He fights back!', onSuccess: () => { state.gold += 10; modRep('infamy', 2); }, onFail: () => takeDamage(5) }
            ])
        ]
    };

    // 6. LOGIC & ENGINE
    function init() {
        rerollStats();
        document.querySelector('.header').style.opacity = 0;
        document.querySelector('.main-layout').style.opacity = 0;
        document.getElementById('char-name').addEventListener('input', checkReady);
    }

    function rerollStats() {
        const standardArray = [15, 14, 13, 12, 10, 8];
        for (let i = standardArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [standardArray[i], standardArray[j]] = [standardArray[j], standardArray[i]];
        }
        let i = 0;
        for (let key in state.stats) state.stats[key] = standardArray[i++];
        renderCreationStats();
    }

    function renderCreationStats() {
        const container = document.getElementById('creation-stats');
        container.innerHTML = '';
        for (let key in state.stats) {
            const val = state.stats[key];
            container.innerHTML += `
                <div class="bg-white/50 p-2 rounded text-center border border-[#5d4037]">
                    <div class="text-xs uppercase font-bold">${key}</div>
                    <div class="text-xl font-medieval">${val}</div>
                    <div class="text-xs text-gray-600">${formatMod(getModifier(val))}</div>
                </div>`;
        }
    }

    function setGender(g) {
        state.gender = g;
        document.getElementById('gender-m').style.opacity = g === 'Male' ? 1 : 0.6;
        document.getElementById('gender-f').style.opacity = g === 'Female' ? 1 : 0.6;
        document.getElementById('gender-m').style.border = g === 'Male' ? '2px solid gold' : '2px solid #2c1e16';
        document.getElementById('gender-f').style.border = g === 'Female' ? '2px solid gold' : '2px solid #2c1e16';
        checkReady();
    }

    function setOrigin(origin) {
        state.flags.startOrigin = origin;
        document.getElementById('origin-peasant').classList.remove('active-opt');
        document.getElementById('origin-house').classList.remove('active-opt');
        document.getElementById('origin-peasant').classList.add('opacity-60');
        document.getElementById('origin-house').classList.add('opacity-60');
        
        if(origin === 'Peasant') {
            document.getElementById('origin-peasant').classList.add('active-opt');
            document.getElementById('origin-peasant').classList.remove('opacity-60');
        } else {
            document.getElementById('origin-house').classList.add('active-opt');
            document.getElementById('origin-house').classList.remove('opacity-60');
        }
    }

    function checkReady() {
        document.getElementById('start-btn').disabled = document.getElementById('char-name').value.length === 0;
    }

    function getRandomName(gender) {
        const list = gender === 'Male' ? NPC_NAMES.m : NPC_NAMES.f;
        return list[Math.floor(Math.random() * list.length)];
    }

    // Helper to add parents with death chance
    function tryAddParent(relation, gender, rank) {
        const roll = Math.random();
        if (roll < 0.1) {
            log(`Your ${relation} is unknown or deceased.`);
            return null;
        } else {
            const name = getRandomName(gender);
            return addRelationship(name, relation, 80 + Math.floor(Math.random()*20), gender, rank);
        }
    }

    function generateHouse() {
        if (state.flags.startOrigin === 'Peasant') {
            state.socialClass = "Peasant";
            state.house = null;
            state.class = "Peasant";
            tryAddParent("Father", "Male", "Peasant");
            tryAddParent("Mother", "Female", "Peasant");
            return;
        }

        state.socialClass = "House";
        
        const tierRoll = Math.random();
        let tierKey = 'lesser';
        if (tierRoll > 0.99) tierKey = 'royal';
        else if (tierRoll > 0.90) tierKey = 'greater';
        
        const tierData = TIER_DATA[tierKey];
        const names = HOUSE_NAMES[tierKey];
        const houseName = names[Math.floor(Math.random() * names.length)];
        const sigil = tierData.sigils[Math.floor(Math.random() * tierData.sigils.length)];
        
        const rankRoll = Math.random();
        let rank = "House Member";
        if (rankRoll > 0.95) rank = "Heir";
        else if (rankRoll > 0.70) rank = "Younger Child";

        state.house = {
            tier: tierData.name,
            name: houseName,
            sigil: sigil,
            members: []
        };
        
        state.class = `${rank} of House ${houseName}`;

        const lordName = getRandomName('Male');
        const ladyName = getRandomName('Female');
        
        addHouseMember(lordName, "Male", "Lord");
        addHouseMember(ladyName, "Female", "Lady");

        // Parents logic for nobles
        if (rank === "Heir" || rank === "Younger Child") {
            // Parents are the Lord/Lady
            // Assume Lord/Lady exist (we just added them)
            // But we need to add them to relationships
            addRelationship(lordName, "Father", 100, "Male", "Lord");
            addRelationship(ladyName, "Mother", 100, "Female", "Lady");
        } else {
            // Random parents within house
            const father = tryAddParent("Father", "Male", "House Member");
            if(father) addHouseMember(father.name, "Male", "House Member");
            
            const mother = tryAddParent("Mother", "Female", "House Member");
            if(mother) addHouseMember(mother.name, "Female", "House Member");
        }

        addHouseMember(state.name, state.gender, rank);
        addHouseMember(getRandomName('Male'), "Male", "Sworn Sword");
        addHouseMember(getRandomName('Female'), "Female", "Servant");
    }

    function addHouseMember(name, gender, rank) {
        state.house.members.push({
            name, gender, rank, id: Math.random().toString(36).substr(2, 9)
        });
    }

    // New Arg: locationIndex (defaults to current city if null)
    function addRelationship(name, relation, affinity, gender, rank, locIndex = null) {
        const location = locIndex !== null ? locIndex : Math.floor(Math.random() * CITIES.length);
        const person = {
            id: Math.random().toString(36).substr(2, 9),
            name, relation, affinity, gender, rank, locationIndex: location,
            stats: { 
                str: 8 + Math.floor(Math.random()*8),
                int: 8 + Math.floor(Math.random()*8),
                cha: 8 + Math.floor(Math.random()*8)
            }
        };
        state.relationships.push(person);
        return person;
    }

    function getParent(type) {
        if (!type) return state.relationships.find(r => r.relation === 'Father' || r.relation === 'Mother');
        return state.relationships.find(r => r.relation === type);
    }
    
    function hasParent(type) {
        return !!state.relationships.find(r => r.relation === type);
    }

    function startGame() {
        state.name = document.getElementById('char-name').value;
        generateHouse();
        state.location = Math.floor(Math.random() * CITIES.length);
        
        const conMod = getModifier(state.stats.con);
        state.maxHealth = 10 + conMod;
        state.health = state.maxHealth;

        document.getElementById('creation-screen').style.display = 'none';
        document.getElementById('lore-modal').classList.remove('hidden');
    }

    function enterWorld() {
        document.getElementById('lore-modal').classList.add('hidden');
        document.querySelector('.header').style.opacity = 1;
        document.querySelector('.main-layout').style.opacity = 1;
        document.getElementById('display-name').innerText = state.name;
        
        log(`<strong>Year ${state.year}:</strong> ${state.name} is born in <strong>${CITIES[state.location].name}</strong>.`);
        if (state.socialClass === 'House') {
            log(`You are born a ${state.class}.`);
        } else {
            log(`You are born a free peasant.`);
        }
        
        updateUI();
        processYear();
    }

    function processYear() {
        state.age++;
        state.year++;
        state.interactions = {}; 
        state.activityLog = { love: 0, quest: 0, crime: 0, train: 0 }; // Reset limits
        
        const conMod = getModifier(state.stats.con);
        // HP Increase: 1d4 + CON (min 1)
        const hpGain = Math.max(1, Math.floor(Math.random() * 4) + 1 + conMod);
        state.maxHealth += hpGain;
        state.health = Math.min(state.maxHealth, state.health + hpGain);

        document.getElementById('year-display').innerText = `Year ${state.year}`;
        document.getElementById('age-display').innerText = state.age;

        const logEl = document.getElementById('event-log');
        const marker = document.createElement('div');
        marker.className = 'event-entry age-marker';
        marker.innerText = `Age ${state.age}`;
        logEl.prepend(marker);

        processOccupation();
        checkUnlocks();

        let pool = POOLS.Infancy;
        if (state.age >= 3) pool = POOLS.Childhood;
        if (state.age >= 12) pool = POOLS.Teen;
        if (state.age >= 18) pool = POOLS.Adult;
        if (state.age >= 65) pool = POOLS.Elder;

        const validEvents = pool.filter(e => true); 
        const event = validEvents[Math.floor(Math.random() * validEvents.length)];
        renderEvent(event);
    }

    // --- ACTIVITIES ---
    function renderActivitiesTab() {
        const container = document.getElementById('act-content');
        if (state.age < 6) {
            container.innerHTML = `<p class="col-span-2 text-center italic mt-4">You are too young to explore the city alone.</p>`;
            return;
        }

        const canLove = state.activityLog.love < 3; // Limit 3 per year
        const canQuest = state.activityLog.quest < 1;
        const canCrime = state.activityLog.crime < 1;
        const canTrain = state.activityLog.train < 1;

        container.innerHTML = `
            <button onclick="actShop()" class="act-btn choice-btn"><span class="act-icon">üõçÔ∏è</span>Visit Market</button>
            <button onclick="actSocialize()" class="act-btn choice-btn"><span class="act-icon">üçª</span>Socialize</button>
            <button onclick="actLove()" class="act-btn choice-btn ${canLove?'':'opacity-50'}" ${canLove?'':'disabled'}><span class="act-icon">üíò</span>Find Love (${3-state.activityLog.love} left)</button>
            <button onclick="actQuest()" class="act-btn choice-btn ${canQuest?'':'opacity-50'}" ${canQuest?'':'disabled'}><span class="act-icon">‚öîÔ∏è</span>Quest (1/yr)</button>
            <button onclick="actCrime()" class="act-btn choice-btn ${canCrime?'':'opacity-50'}" ${canCrime?'':'disabled'}><span class="act-icon">üó°Ô∏è</span>Crime (1/yr)</button>
            <button onclick="actTrain()" class="act-btn choice-btn ${canTrain?'':'opacity-50'}" ${canTrain?'':'disabled'}><span class="act-icon">üèãÔ∏è</span>Train (1/yr)</button>
        `;
    }

    function actShop() {
        // Simple shop logic
        const items = ['Healing Potion', 'Rope', 'Torch', 'Bread', 'Dagger'];
        const item = items[Math.floor(Math.random() * items.length)];
        if(state.gold >= 5) {
            state.gold -= 5;
            addItem(item, 'Common', 'Bought from market.');
            log(`Bought ${item} for 5g.`);
        } else {
            log(`You browse the wares but have no coin.`);
        }
        switchTab('log');
    }

    function actSocialize() {
        const gender = Math.random() > 0.5 ? 'Male' : 'Female';
        const name = getRandomName(gender);
        // Chance to be a Knight
        let rank = "Commoner";
        if (Math.random() > 0.9) rank = gender === 'Male' ? 'Sir' : 'Dame'; // Knight title
        
        addRelationship(name, "Acquaintance", 20, gender, rank, state.location);
        log(`You met ${name} (${rank}) in the city square.`);
        updateUI();
        switchTab('log');
    }

    function actLove() {
        state.activityLog.love++;
        const gender = Math.random() > 0.5 ? 'Male' : 'Female';
        const name = getRandomName(gender);
        addRelationship(name, "Love Interest", 40, gender, "Commoner", state.location);
        log(`You caught the eye of ${name}.`);
        updateUI();
        switchTab('log');
    }

    function actQuest() {
        state.activityLog.quest++;
        const pool = POOLS.Quest;
        renderEvent(pool[Math.floor(Math.random() * pool.length)]);
        switchTab('log');
    }

    function actCrime() {
        state.activityLog.crime++;
        const pool = POOLS.Crime;
        renderEvent(pool[Math.floor(Math.random() * pool.length)]);
        switchTab('log');
    }

    function actTrain() {
        state.activityLog.train++;
        const stat = ABILITIES[Math.floor(Math.random() * ABILITIES.length)];
        state.stats[stat]++;
        log(`You trained hard. (+1 ${stat.toUpperCase()})`);
        updateUI();
        switchTab('log');
    }

    // --- MAP SYSTEM ---
    function renderMapTab() {
        const container = document.getElementById('map-content');
        const visual = document.getElementById('map-visual');
        
        // Render Visual Dots
        let visualHtml = '';
        CITIES.forEach((city, index) => {
            const isHere = state.location === index;
            const activeClass = isHere ? 'active' : '';
            visualHtml += `
                <div class="map-node ${activeClass}" style="left: ${city.x}%; top: ${city.y}%;" title="${city.name}">
                    <div class="map-label">${city.name}</div>
                </div>`;
        });
        visual.innerHTML = visualHtml;

        // List View
        container.innerHTML = CITIES.map((city, index) => {
            const isHere = state.location === index;
            const extraClass = isHere ? 'current-city' : '';
            
            const currentCity = CITIES[state.location];
            const dist = Math.sqrt(Math.pow(city.x - currentCity.x, 2) + Math.pow(city.y - currentCity.y, 2));
            const travelTime = Math.ceil(dist / 5); 
            const timeText = travelTime === 0 ? "" : `(${travelTime} Months)`;

            const action = isHere ? `<span class="text-xs font-bold text-amber-900">Current Location</span>` : 
                `<button onclick="travelTo(${index})" class="text-xs bg-leather text-white px-2 py-1 rounded bg-[#5d4037]">Travel ${timeText}</button>`;
            
            return `
                <div class="city-card ${extraClass}">
                    <div>
                        <div class="font-bold text-lg">${city.name}</div>
                        <div class="text-xs font-bold text-royal">${city.ruler}</div>
                        <div class="text-xs italic opacity-80">${city.desc}</div>
                    </div>
                    <div>${action}</div>
                </div>
            `;
        }).join('');
    }

    function travelTo(index) {
        const city = CITIES[index];
        const currentCity = CITIES[state.location];
        const dist = Math.sqrt(Math.pow(city.x - currentCity.x, 2) + Math.pow(city.y - currentCity.y, 2));
        const months = Math.ceil(dist / 5);
        
        log(`<strong>Travel:</strong> You journey to ${city.name}. It takes ${months} months.`);
        state.location = index;
        
        const pool = POOLS.Travel;
        const event = pool[Math.floor(Math.random() * pool.length)];
        renderEvent(event);
        updateUI();
    }

    function takeDamage(amt) {
        state.health -= amt;
        log(`<strong class="text-red-800">DAMAGE:</strong> You took ${amt} damage!`);
        updateUI();
        if (state.health <= 0) death();
    }

    // --- SETTINGS & NPC SHEETS ---
    function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
    function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
    function restartGame() { location.reload(); }
    
    function closeNPC() { document.getElementById('npc-modal').classList.add('hidden'); }
    
    function openNPC(id) {
        const r = state.relationships.find(x => x.id === id);
        if(!r) return;
        const loc = CITIES[r.locationIndex].name;
        const isKnight = r.rank === 'Sir' || r.rank === 'Dame';
        
        let squireBtn = '';
        if (isKnight && state.age >= 12 && state.occupation?.id !== 'squire') {
            squireBtn = `<button onclick="askToSquire('${id}')" class="w-full bg-amber-800 text-white p-2 rounded mt-2">Ask to Squire</button>`;
        }

        let html = `
            <h2 class="text-3xl font-medieval mb-1">${r.name}</h2>
            <div class="text-sm opacity-70 mb-4">${r.rank} ‚Ä¢ ${r.gender} ‚Ä¢ ${loc}</div>
            
            <div class="grid grid-cols-3 gap-2 mb-4 text-center">
                <div class="bg-black/5 p-1 rounded"><div class="text-xs font-bold">STR</div><div>${r.stats.str}</div></div>
                <div class="bg-black/5 p-1 rounded"><div class="text-xs font-bold">INT</div><div>${r.stats.int}</div></div>
                <div class="bg-black/5 p-1 rounded"><div class="text-xs font-bold">CHA</div><div>${r.stats.cha}</div></div>
            </div>
            
            <div class="mb-4">
                <div class="flex justify-between text-xs mb-1"><span>Affinity</span><span>${r.affinity}%</span></div>
                <div class="w-full h-3 bg-black/10 rounded overflow-hidden"><div class="h-full bg-pink-600" style="width:${r.affinity}%"></div></div>
            </div>
            
            <p class="text-sm italic mb-4">"${r.relation}"</p>
            ${squireBtn}
        `;
        document.getElementById('npc-content').innerHTML = html;
        document.getElementById('npc-modal').classList.remove('hidden');
    }

    function askToSquire(id) {
        const r = state.relationships.find(x => x.id === id);
        closeNPC();
        // Check check
        const roll = rollD20(getModifier(state.stats.str));
        if (roll.total >= 12 && r.affinity >= 30) {
            log(`<strong class="text-green-800">Success!</strong> ${r.name} accepts you as a squire.`);
            joinJob('squire'); // Using the new squire career
        } else {
            log(`<strong class="text-red-800">Refused.</strong> ${r.name} says you are not ready.`);
        }
        updateUI();
    }

    // --- OCCUPATION SYSTEM LOGIC ---
    function processOccupation() {
        if (!state.occupation) return;
        const occ = state.occupation;
        const career = CAREERS[occ.id];
        const rankInfo = career.ranks[occ.rankIndex];
        
        let income = rankInfo.wage;
        let stressGain = rankInfo.stressMod;
        let perfGain = 5;

        if (occ.workStance === 'slack') { income *= 0.7; stressGain -= 5; perfGain = -5; } 
        else if (occ.workStance === 'intense') { income *= 1.5; stressGain += 5; perfGain = 15; }

        state.gold += Math.floor(income);
        occ.stress = Math.min(100, Math.max(0, occ.stress + stressGain));
        occ.performance = Math.min(100, Math.max(0, occ.performance + perfGain));
        occ.years++;

        log(`<strong>Occupation:</strong> Earned ${Math.floor(income)} GP. Stress: ${occ.stress}%.`);
        
        if (occ.performance === 100 && occ.rankIndex < career.ranks.length - 1 && Math.random() > 0.7) {
            occ.rankIndex++;
            occ.performance = 50;
            const newTitle = career.ranks[occ.rankIndex].title;
            log(`<strong class="text-green-800">PROMOTION:</strong> Raised to ${newTitle}!`);
            modRep('renown', 10);
        }
    }

    function joinJob(id) {
        if (state.jobHistory[id]) {
            state.occupation = state.jobHistory[id];
            state.occupation.performance = Math.max(0, state.occupation.performance - 20);
            log(`<strong>Career:</strong> Resumed post as ${CAREERS[id].ranks[state.occupation.rankIndex].title}.`);
            delete state.jobHistory[id];
        } else {
            state.occupation = { id, rankIndex: 0, performance: 50, stress: 0, workStance: 'normal', years: 0 };
            log(`<strong>Career:</strong> Started as ${CAREERS[id].ranks[0].title}.`);
        }
        state.flags.employed = true;
        updateUI();
    }

    function quitJob() {
        if (state.occupation) {
            log(`<strong>Career:</strong> Resigned.`);
            state.jobHistory[state.occupation.id] = state.occupation;
            state.occupation = null;
            state.flags.employed = false;
            updateUI();
        }
    }
    
    function setStance(s) {
        if(state.occupation) state.occupation.workStance = s;
        updateUI();
    }

    // --- RELATIONSHIP SYSTEM ---
    function interact(id, action) {
        if (state.interactions[id]) {
            alert("You have already interacted with them this year.");
            return;
        }

        const rel = state.relationships.find(r => r.id === id);
        if(!rel) return;

        state.interactions[id] = true;

        if (action === 'chat') {
            rel.affinity = Math.min(100, rel.affinity + 5);
            log(`You chatted with ${rel.name}.`);
        } else if (action === 'gift') {
            if (state.gold >= 5) {
                state.gold -= 5;
                rel.affinity = Math.min(100, rel.affinity + 10);
                log(`You gave ${rel.name} a gift. (+Affinity)`);
            } else {
                log(`Not enough gold to buy a gift.`);
            }
        } else if (action === 'letter') {
            if (state.gold >= 1) {
                state.gold -= 1;
                rel.affinity = Math.min(100, rel.affinity + 2);
                log(`Sent a letter to ${rel.name} in ${CITIES[rel.locationIndex].name}.`);
            } else {
                log("Not enough gold for postage.");
            }
        }
        updateUI();
    }

    function renderRelTab() {
        const container = document.getElementById('rel-content');
        if (state.relationships.length === 0) {
            container.innerHTML = `<p class="italic opacity-50">You are alone.</p>`;
            return;
        }

        container.innerHTML = state.relationships.map(r => {
            const locName = CITIES[r.locationIndex].name;
            const sameCity = r.locationIndex === state.location;
            
            let actions = '';
            if (sameCity) {
                actions = `
                    <button onclick="interact('${r.id}', 'chat')" class="text-[10px] bg-white border border-[#5d4037] px-2 py-0.5 rounded hover:bg-amber-100" ${state.interactions[r.id] ? 'disabled style="opacity:0.5"' : ''}>Chat</button>
                    <button onclick="interact('${r.id}', 'gift')" class="text-[10px] bg-white border border-[#5d4037] px-2 py-0.5 rounded hover:bg-amber-100" ${state.interactions[r.id] ? 'disabled style="opacity:0.5"' : ''}>Gift (5g)</button>
                `;
            } else {
                actions = `
                    <button onclick="interact('${r.id}', 'letter')" class="text-[10px] bg-white border border-[#5d4037] px-2 py-0.5 rounded hover:bg-amber-100" ${state.interactions[r.id] ? 'disabled style="opacity:0.5"' : ''}>Send Letter (1g)</button>
                `;
            }

            return `
            <div class="rel-card" onclick="openNPC('${r.id}')">
                <div>
                    <div class="font-bold">${r.name}</div>
                    <div class="text-xs opacity-70">${r.relation} ‚Ä¢ ${r.rank}</div>
                    <div class="text-xs text-amber-900 font-bold">üìç ${locName}</div>
                </div>
                <div class="flex flex-col items-end gap-1">
                    <div class="text-xs font-bold">${r.affinity}%</div>
                    <div class="w-24 h-2 bg-black/10 rounded overflow-hidden">
                        <div class="h-full affinity-fill" style="width: ${r.affinity}%"></div>
                    </div>
                    <div class="flex gap-1 mt-1" onclick="event.stopPropagation()">
                        ${actions}
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    // --- HOUSE UI ---
    function renderHouseTab() {
        const container = document.getElementById('house-content');
        if (state.socialClass === 'Peasant') {
            container.innerHTML = `
                <div class="house-crest opacity-50">üåæ</div>
                <h2 class="text-3xl font-medieval mb-2">Peasant Class</h2>
                <p class="italic mb-4">You have no House affiliation.</p>
                <div class="p-4 bg-white/30 border border-dashed border-[#5d4037] rounded text-sm text-left">
                    <p><strong>Rights:</strong> Minimal. Subject to local lords.</p>
                    <p><strong>Politics:</strong> None. You are invisible to the court.</p>
                    <p class="mt-2 text-xs italic">Only by swearing a sword-oath or buying a title can you enter the House structure.</p>
                </div>`;
            return;
        }

        const h = state.house;
        // Group members by rank
        let membersHtml = '';
        HOUSE_RANKS.forEach(rank => {
            const group = h.members.filter(m => {
                if(rank === "Lord/Lady") return m.rank === "Lord" || m.rank === "Lady";
                return m.rank === rank;
            });
            
            if (group.length > 0) {
                membersHtml += `<div class="mb-2 text-left"><div class="text-xs uppercase font-bold text-amber-900 border-b border-black/10 mb-1">${rank}</div>`;
                group.forEach(m => {
                    const isMe = m.name === state.name ? " (You)" : "";
                    const isKnown = state.relationships.find(r => r.name === m.name); // Check if known
                    const style = rank.includes("Lord") ? "house-rank-head" : "house-rank-member";
                    
                    let action = "";
                    if (!isMe) {
                        if (isKnown) action = `<span class="text-xs text-green-800 float-right">Known</span>`;
                        else action = `<button onclick="meetHouseMember('${m.name}', '${m.gender}', '${m.rank}')" class="float-right text-[10px] bg-white border border-[#5d4037] px-2 rounded">Meet</button>`;
                    }

                    membersHtml += `<div class="${style} text-sm clearfix">${m.name}${isMe} ${action}</div>`;
                });
                membersHtml += `</div>`;
            }
        });

        const tierClass = h.tier === 'Royal House' ? 'house-tier-royal' : '';

        container.innerHTML = `
            <div class="house-crest ${tierClass}">${h.sigil}</div>
            <h2 class="text-4xl font-medieval text-amber-900 mb-1">House ${h.name}</h2>
            <div class="mb-6">
                <span class="font-bold text-lg uppercase tracking-widest">${h.tier}</span>
            </div>
            
            <div class="bg-white/40 p-4 rounded border border-[#5d4037] mb-4">
                <h4 class="font-bold border-b border-black/10 mb-2 text-center">House Hierarchy</h4>
                ${membersHtml}
            </div>
        `;
    }

    function meetHouseMember(name, gender, rank) {
        addRelationship(name, "Kinsman", 30, gender, rank, state.location);
        log(`You introduced yourself to ${name} of your House.`);
        updateUI();
    }

    function renderOccupationTab() {
        const container = document.getElementById('occ-content');
        if (!state.occupation) {
            let html = `<p class="italic mb-4">You currently have no vocation.</p><div class="space-y-2">`;
            const historyIds = Object.keys(state.jobHistory);
            if (historyIds.length > 0) {
                html += `<h4 class="font-bold border-b border-black/10 mb-2">Resume Career</h4>`;
                historyIds.forEach(hid => {
                    const hist = state.jobHistory[hid];
                    const c = CAREERS[hid];
                    html += `<button onclick="joinJob('${hid}')" class="choice-btn text-sm mb-2 border-l-4 border-amber-600"><span>Resume: ${c.ranks[hist.rankIndex].title}</span></button>`;
                });
                html += `<h4 class="font-bold border-b border-black/10 mb-2 mt-4">New Career</h4>`;
            }
            for (let id in CAREERS) {
                if (id === 'squire') continue; // Special entry only
                const c = CAREERS[id];
                let canJoin = true;
                if (c.req.age && state.age < c.req.age) canJoin = false;
                if (c.req.stat && state.stats[c.req.stat] < c.req.val) canJoin = false;
                if (c.req.flag && !state.flags[c.req.flag]) canJoin = false;
                if (canJoin) html += `<button onclick="joinJob('${id}')" class="choice-btn text-sm"><span>${c.name}: ${c.ranks[0].title}</span><span class="opacity-70">${c.ranks[0].wage} GP/yr</span></button>`;
            }
            container.innerHTML = html;
        } else {
            const occ = state.occupation;
            const jobData = CAREERS[occ.id].ranks[occ.rankIndex];
            container.innerHTML = `
                <div class="job-card">
                    <h3 class="font-bold text-xl">${jobData.title}</h3>
                    <p class="text-sm opacity-70">${CAREERS[occ.id].name} - Rank ${occ.rankIndex + 1}</p>
                    <div class="mt-2 text-sm">Wage: ${jobData.wage} GP/yr</div>
                    <div class="mt-4"><div class="text-xs flex justify-between"><span>Performance</span><span>${occ.performance}%</span></div><div class="bar-container"><div class="bar-fill perf-fill" style="width: ${occ.performance}%"></div></div></div>
                    <div class="mt-2"><div class="text-xs flex justify-between"><span>Stress</span><span>${occ.stress}%</span></div><div class="bar-container"><div class="bar-fill stress-fill" style="width: ${occ.stress}%"></div></div></div>
                </div>
                <div class="flex gap-2 text-xs mb-4">
                    <button onclick="setStance('slack')" class="p-2 border rounded ${occ.workStance==='slack'?'bg-amber-300':'bg-white'}">Slack</button>
                    <button onclick="setStance('normal')" class="p-2 border rounded ${occ.workStance==='normal'?'bg-amber-500 text-white':'bg-white'}">Normal</button>
                    <button onclick="setStance('intense')" class="p-2 border rounded ${occ.workStance==='intense'?'bg-red-800 text-white':'bg-white'}">Intense</button>
                </div>
                <button onclick="quitJob()" class="w-full border border-red-800 text-red-800 p-2 rounded hover:bg-red-100">Quit Job</button>
            `;
        }
    }

    function renderInventory() {
        const list = document.getElementById('inventory-list');
        if (state.inventory.length === 0) { list.innerHTML = `<p class="italic opacity-50">Your satchel is empty.</p>`; return; }
        list.innerHTML = state.inventory.map(item => `<div class="item-row"><div><div class="item-rarity-${item.rarity}">${item.name}</div><div class="text-xs opacity-70">${item.desc}</div></div><div class="text-[10px] uppercase font-bold opacity-50 border border-black/20 px-1 rounded">${item.rarity}</div></div>`).join('');
    }

    function addItem(name, rarity, desc) {
        state.inventory.push({ name, rarity, desc, id: Math.random().toString(36).substr(2, 9) });
        log(`<strong style="color:var(--gold)">ITEM GET:</strong> Found <span class="item-rarity-${rarity}">${name}</span>!`);
        updateUI();
    }

    function modRep(type, amt) { state.reputation[type] += amt; }
    
    function modRel(id, amt) {
        const r = state.relationships.find(x => x.id === id);
        if(r) r.affinity = Math.min(100, Math.max(0, r.affinity + amt));
    }

    function checkUnlocks() {
        const ul = document.getElementById('unlock-list');
        const addUnlock = (txt) => { const li = document.createElement('li'); li.innerText = `${txt} (Age ${state.age})`; li.style.color = "var(--ink)"; li.style.fontWeight = "bold"; ul.prepend(li); };
        if (state.age === 4) addUnlock("Temple Blessings");
        if (state.age === 6) { addUnlock("Basic Training"); state.flags.literate = true; }
        if (state.age === 8) addUnlock("Petty Crime");
        if (state.age === 14) addUnlock("Courtship & Enlistment");
        if (state.age === 18) { addUnlock("Adulthood"); state.flags.adult = true; }
    }

    function renderEvent(event) {
        log(`<strong>${event.title}:</strong> ${event.text}`);
        const container = document.getElementById('choices-container');
        container.innerHTML = '';
        event.choices.forEach(choice => {
            if (choice.req && !choice.req(state)) return;
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            let badge = choice.type === 'check' ? `<span class="dc-badge" style="color: ${getModifier(state.stats[choice.stat]) >= 0 ? '#86efac' : '#fca5a5'}">${choice.stat.toUpperCase()} ${formatMod(getModifier(state.stats[choice.stat]))} (DC ${choice.dc})</span>` : choice.type === 'flavor' ? `<span class="opacity-50 text-xs">Free Action</span>` : '';
            btn.innerHTML = `<span>${choice.text}</span> ${badge}`;
            btn.onclick = () => { container.querySelectorAll('button').forEach(b => b.disabled = true); resolveChoice(choice); };
            container.appendChild(btn);
        });
    }

    function resolveChoice(choice) {
        if (choice.type === 'flavor') {
            if (choice.effect) choice.effect();
            nextTurn();
        } else if (choice.type === 'check') {
            const result = rollD20(getModifier(state.stats[choice.stat]));
            const passed = result.total >= choice.dc;
            const resultClass = result.isCrit ? 'dice-crit' : (passed ? 'dice-success' : 'dice-failure');
            const resultText = result.isCrit ? 'NAT 20!' : (result.isFail ? 'CRIT FAIL!' : (passed ? 'SUCCESS' : 'FAILURE'));
            log(`<div class="mt-2 mb-2 p-2 bg-black/5 rounded text-sm"><span class="font-bold">Rolling ${choice.stat.toUpperCase()}:</span> d20(${result.roll}) ${formatMod(result.mod)} = <span class="text-lg font-bold">${result.total}</span> vs DC ${choice.dc}<br><span class="${resultClass} dice-result">${resultText}</span></div>`);
            setTimeout(() => {
                if (passed) { log(choice.success); if(choice.onSuccess) choice.onSuccess(); } 
                else { log(choice.fail); if(choice.onFail) choice.onFail(); }
                updateUI();
                nextTurn();
            }, 600);
        }
    }

    function nextTurn() {
        updateUI();
        const container = document.getElementById('choices-container');
        container.innerHTML = '';
        const btn = document.createElement('button');
        btn.className = 'choice-btn justify-center font-bold';
        btn.innerText = "Advance Year";
        btn.onclick = processYear;
        container.appendChild(btn);
        if (state.health <= 0) death();
    }

    function death() {
        const container = document.getElementById('choices-container');
        container.innerHTML = '<div class="text-center text-red-800 font-bold text-xl p-4">YOUR WATCH HAS ENDED</div>';
        log(`<strong style="color:red">DEATH:</strong> At the age of ${state.age}, ${state.name} passes.`);
        document.getElementById('input-area').style.opacity = 0.5;
        document.getElementById('input-area').style.pointerEvents = 'none';
    }

    function log(html) {
        const logEl = document.getElementById('event-log');
        const div = document.createElement('div');
        div.className = 'event-entry';
        div.innerHTML = html;
        logEl.prepend(div);
    }

    function updateUI() {
        for (let key in state.stats) {
            const val = state.stats[key];
            document.getElementById(`stat-${key}`).innerText = val;
            document.getElementById(`mod-${key}`).innerText = formatMod(getModifier(val));
        }
        document.getElementById('gold-display').innerText = state.gold;
        document.getElementById('social-display').innerText = state.socialClass;
        document.getElementById('display-class').innerText = state.class;
        document.getElementById('location-display').innerText = CITIES[state.location].name;
        document.getElementById('header-hp').innerText = `${state.health} / ${state.maxHealth} HP`;
        document.getElementById('hp-display').innerText = `${state.health} / ${state.maxHealth}`;
        
        document.getElementById('rep-renown').innerText = state.reputation.renown;
        document.getElementById('rep-honor').innerText = state.reputation.honor;
        document.getElementById('rep-piety').innerText = state.reputation.piety;
        document.getElementById('rep-infamy').innerText = state.reputation.infamy;

        renderHouseTab();
        renderRelTab();
        renderOccupationTab();
        renderInventory();
        renderMapTab();
        renderActivitiesTab();
    }

    function addTrait(trait) {
        if(state.traits.includes(trait)) return;
        state.traits.push(trait);
        const list = document.getElementById('traits-list');
        if (state.traits.length === 1) list.innerHTML = '';
        const div = document.createElement('div');
        div.innerText = `‚Ä¢ ${trait}`;
        list.appendChild(div);
        log(`<strong>New Trait:</strong> ${trait}`);
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`${tab}-tab`).classList.remove('hidden');
        document.getElementById(`tab-${tab}`).classList.add('active');
    }

    init();
</script>
</body>
</html>
