<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Medieval Life | D20 Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=MedievalSharp&family=Spectral:ital,wght@0,400;0,700;1,400&display=swap');

        :root {
            --parchment: #f4e4bc;
            --ink: #2c1e16;
            --leather: #5d4037;
            --gold: #b8860b;
            --success: #15803d;
            --failure: #b91c1c;
            --stress: #9f1239;
            --sanity: #6b21a8;
            --royal: #4c1d95;
            
            /* Item Rarities */
            --common: #737373;
            --uncommon: #16a34a;
            --rare: #2563eb;
            --very-rare: #9333ea;
            --legendary: #ea580c;
            --artifact: #ca8a04;
        }

        body {
            background-color: #0f0f0f;
            color: var(--ink);
            font-family: 'Spectral', serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .parchment-container {
            background-color: var(--parchment);
            background-image: url("https://www.transparenttextures.com/patterns/p6-dark.png");
            border: 12px solid var(--leather);
            border-image: linear-gradient(to bottom, #8b4513, #5d4037) 1;
            box-shadow: 0 0 50px rgba(0,0,0,0.8), inset 0 0 120px rgba(0,0,0,0.2);
            max-width: 1000px;
            width: 95%;
            height: 95vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .header {
            font-family: 'MedievalSharp', cursive;
            border-bottom: 2px solid rgba(44, 30, 22, 0.2);
            padding: 1rem;
            text-align: center;
            background: rgba(0,0,0,0.03);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            align-items: center;
            padding-right: 3rem; /* Space for settings */
        }

        .settings-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--leather);
            transition: transform 0.3s;
            z-index: 60;
        }
        .settings-btn:hover { transform: rotate(90deg); }

        .main-layout {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 240px;
            border-right: 2px solid rgba(44, 30, 22, 0.1);
            display: flex;
            flex-direction: column;
            background: rgba(0,0,0,0.02);
            overflow-y: auto;
        }

        .tab-btn {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(44, 30, 22, 0.05);
            font-family: 'MedievalSharp', cursive;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover { background: rgba(0,0,0,0.05); }
        .tab-btn.active { background: rgba(255,255,255,0.4); border-left: 5px solid var(--leather); font-weight: bold; }

        .content-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* D&D Stat Block Styling */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            padding: 1rem;
            background: rgba(93, 64, 55, 0.05);
            border-bottom: 1px solid rgba(44,30,22,0.1);
        }

        .stat-box {
            text-align: center;
            border: 2px solid var(--leather);
            border-radius: 8px;
            background: rgba(255,255,255,0.4);
            position: relative;
            padding-bottom: 4px;
        }

        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: bold;
            display: block;
            background: var(--leather);
            color: #f4e4bc;
            padding: 2px 0;
            border-radius: 4px 4px 0 0;
        }

        .stat-val { font-family: 'MedievalSharp'; font-size: 1.2rem; font-weight: bold; display: block; margin-top: 2px; }
        .stat-mod { font-size: 0.75rem; color: #666; font-weight: bold; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); background: #f4e4bc; padding: 0 4px; border: 1px solid var(--leather); border-radius: 4px; }

        #event-log {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            scroll-behavior: smooth;
        }

        .event-entry {
            border-left: 4px solid var(--leather);
            padding: 10px 16px;
            animation: fadeIn 0.5s ease-out;
            background: rgba(255,255,255,0.3);
            border-radius: 0 8px 8px 0;
            position: relative;
        }

        .event-entry.age-marker {
            border-left: 4px solid var(--gold);
            background: rgba(184, 134, 11, 0.1);
            text-align: center;
            font-family: 'MedievalSharp';
            font-size: 1.1rem;
        }
        
        .event-entry.npc-log {
            border-left: 4px solid #4b5563;
            background: rgba(0,0,0,0.03);
            font-size: 0.9rem;
            font-style: italic;
            padding: 6px 12px;
        }

        .dice-result {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85rem;
            margin-top: 4px;
        }
        .dice-success { background: #dcfce7; color: var(--success); border: 1px solid var(--success); }
        .dice-failure { background: #fee2e2; color: var(--failure); border: 1px solid var(--failure); }
        .dice-crit { background: var(--gold); color: white; text-shadow: 0 1px 2px black; border: 1px solid #854d0e; }

        .choices-area {
            padding: 1.5rem;
            border-top: 2px solid rgba(44, 30, 22, 0.2);
            background: rgba(0,0,0,0.04);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-btn {
            background: linear-gradient(to bottom, #5d4037, #3e2723);
            color: #f4e4bc;
            padding: 12px 16px;
            border-radius: 6px;
            font-family: 'MedievalSharp', cursive;
            text-align: left;
            width: 100%;
            transition: all 0.2s;
            border: 2px solid #2c1e16;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .choice-btn:hover:not(:disabled) { 
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            filter: brightness(1.1);
        }
        
        .choice-btn:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }
        .choice-btn.active-opt { border: 2px solid var(--gold); background: var(--leather); filter: brightness(1.2); }

        .dc-badge {
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* --- THE SOLID FOUNDATION (CSS FIX) --- */
        #input-area {
            margin-top: auto;
            background: var(--parchment);
            border-top: 4px solid var(--leather);
            box-shadow: 0 -10px 20px rgba(0,0,0,0.2);
            position: relative;
            z-index: 10;
            padding-bottom: 1rem; /* Extra padding for aesthetics */
        }

        /* Gene Styling */
        .gene-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-right: 4px;
            margin-bottom: 4px;
            border: 1px solid rgba(0,0,0,0.2);
        }
        .gene-house { background: var(--royal); color: white; border-color: var(--gold); }
        
        /* NEW MUTATION STYLES */
        .mut-common { background: #e5e7eb; color: #374151; border-color: #9ca3af; }
        .mut-uncommon { background: #dcfce7; color: #166534; border-color: #86efac; }
        .mut-rare { background: #dbeafe; color: #1e40af; border-color: #93c5fd; }
        .mut-epic { background: #f3e8ff; color: #6b21a8; border-color: #d8b4fe; border: 1px double #6b21a8; }
        .mut-legendary { background: #ffedd5; color: #9a3412; border-color: #fdba74; box-shadow: 0 0 5px #fdba74; animation: pulse 2s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }


        /* House System Styling */
        .house-crest { font-size: 4rem; margin-bottom: 1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .house-tier-royal { color: var(--royal); }
        
        .holding-card {
            background: rgba(255,255,255,0.5); border: 2px solid var(--leather); border-radius: 8px;
            padding: 1rem; text-align: left; margin-bottom: 1.5rem; position: relative;
        }
        .holding-icon { position: absolute; right: 10px; top: 5px; font-size: 2rem; opacity: 0.3; }
        
        .roster-group { margin-bottom: 1.5rem; }
        .roster-header { 
            font-family: 'MedievalSharp'; border-bottom: 2px solid rgba(93, 64, 55, 0.3); 
            margin-bottom: 0.5rem; text-align: left; font-size: 1.1rem; color: var(--leather); font-weight: bold;
        }
        .roster-item {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.3); border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 8px; transition: background 0.2s; cursor: pointer;
        }
        .roster-item:hover { background: rgba(255,255,255,0.6); }
        .roster-role { font-size: 0.8rem; opacity: 0.8; font-style: italic; }

        /* Advanced Family Tree (CSS Connectors) */
        .tree ul {
            padding-top: 20px; position: relative;
            transition: all 0.5s;
            display: flex; justify-content: center;
        }
        .tree li {
            float: left; text-align: center;
            list-style-type: none;
            position: relative;
            padding: 20px 5px 0 5px;
            transition: all 0.5s;
        }
        /* Connectors */
        .tree li::before, .tree li::after {
            content: ''; position: absolute; top: 0; right: 50%;
            border-top: 2px solid var(--leather);
            width: 50%; height: 20px;
        }
        .tree li::after {
            right: auto; left: 50%;
            border-left: 2px solid var(--leather);
        }
        .tree li:only-child::after, .tree li:only-child::before {
            display: none;
        }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after {
            border: 0 none;
        }
        .tree li:last-child::before {
            border-right: 2px solid var(--leather);
            border-radius: 0 5px 0 0;
        }
        .tree li:first-child::after {
            border-radius: 5px 0 0 0;
        }
        .tree ul ul::before {
            content: ''; position: absolute; top: 0; left: 50%;
            border-left: 2px solid var(--leather);
            width: 0; height: 20px;
        }
        /* Nodes */
        .tree-member {
            border: 2px solid var(--leather);
            background: rgba(255,255,255,0.6);
            padding: 8px;
            border-radius: 5px;
            display: inline-block;
            min-width: 100px;
            position: relative;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tree-member-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            background: rgba(255,255,255,0.2);
            padding: 5px;
            border-radius: 8px;
            border: 1px dashed rgba(93, 64, 55, 0.3);
        }
        .tree-member.player {
            border-color: var(--gold);
            background: #fff8e1;
            box-shadow: 0 0 10px rgba(184, 134, 11, 0.4);
        }
        .tree-member.dead { opacity: 0.7; filter: grayscale(1); border-style: dashed; }
        .tree-name { font-family: 'MedievalSharp'; font-weight: bold; font-size: 0.9rem; }
        .tree-role { font-size: 0.7rem; font-style: italic; }
        .tree-blood { 
            position: absolute; top: -8px; right: -8px; 
            background: #9f1239; color: white; font-size: 0.6rem; 
            padding: 2px 4px; border-radius: 4px; 
        }
        .tree-married {
            position: absolute; top: -8px; right: -8px; 
            background: #4b5563; color: white; font-size: 0.6rem; 
            padding: 2px 4px; border-radius: 4px;
        }
        .tree-crown {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            font-size: 1.2rem; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
            z-index: 20;
        }
        .tree-grave {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            font-size: 1.2rem; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
            z-index: 20;
        }

        /* Occupation Styling */
        .bar-container { height: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden; margin-top: 4px; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        .stress-fill { background: var(--stress); }
        .perf-fill { background: var(--success); }
        .friend-fill { background: #16a34a; }
        .enemy-fill { background: #dc2626; }
        .romance-fill { background: #db2777; }
        
        .job-card {
            border: 2px solid var(--leather);
            background: rgba(255,255,255,0.4);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .rel-card {
            background: rgba(255,255,255,0.3);
            border: 1px solid rgba(93, 64, 55, 0.2);
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .rel-card:hover { background: rgba(255,255,255,0.5); }
        
        #rel-search-input {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--leather);
            border-radius: 4px;
            background: rgba(255,255,255,0.5);
            font-family: 'MedievalSharp';
            margin-bottom: 12px;
            outline: none;
        }
        #rel-search-input:focus {
            background: rgba(255,255,255,0.8);
            border-color: var(--gold);
        }

        /* Map Styling */
        .city-card {
            border: 1px solid var(--leather);
            background: rgba(255,255,255,0.4);
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .current-city { border-left: 5px solid var(--gold); background: rgba(255,255,255,0.6); }
        
        .map-visual-container {
            width: 100%; height: 300px; background: #e6d5b8; border: 2px solid var(--leather);
            margin-bottom: 1rem; position: relative; overflow: hidden;
            background-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M0 0 Q 50 50 100 0" stroke="rgba(0,0,0,0.05)" fill="none"/><path d="M0 100 Q 50 50 100 100" stroke="rgba(0,0,0,0.05)" fill="none"/></svg>');
        }
        
        .map-node {
            position: absolute; width: 12px; height: 12px; background: var(--leather); border-radius: 50%;
            transform: translate(-50%, -50%); cursor: pointer; transition: all 0.3s;
            border: 2px solid #f4e4bc; z-index: 10;
        }
        .map-node:hover { transform: translate(-50%, -50%) scale(1.5); background: var(--gold); }
        .map-node.active { background: var(--royal); width: 16px; height: 16px; border: 2px solid var(--gold); }
        
        .map-label {
            position: absolute; font-size: 10px; font-weight: bold; background: rgba(255,255,255,0.7);
            padding: 1px 4px; border-radius: 4px; pointer-events: none; white-space: nowrap;
            transform: translate(-50%, -150%);
        }

        /* Inventory Styling */
        .item-row { display: flex; align-items: center; justify-content: space-between; padding: 6px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .item-rarity-Common { color: var(--common); font-weight: bold; }
        .item-rarity-Uncommon { color: var(--uncommon); font-weight: bold; }
        .item-rarity-Rare { color: var(--rare); font-weight: bold; text-shadow: 0 0 1px rgba(37,99,235,0.2); }
        .item-rarity-VeryRare { color: var(--very-rare); font-weight: bold; text-shadow: 0 0 2px rgba(147,51,234,0.3); }
        .item-rarity-Legendary { color: var(--legendary); font-weight: bold; text-shadow: 0 0 3px rgba(234,88,12,0.4); }
        .item-rarity-Artifact { color: var(--artifact); font-weight: bold; text-shadow: 0 0 5px rgba(202,138,4,0.5); }

        /* Grave Styling */
        .grave-card {
            background: rgba(0,0,0,0.05);
            border: 2px solid #5d4037;
            border-radius: 8px 8px 0 0;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
            border-bottom: 4px solid #2c1e16;
        }
        .grave-stone {
            text-align: center;
            border: 2px solid #2c1e16;
            background: #a8a29e;
            padding: 1rem;
            border-radius: 50% 50% 0 0;
            width: 150px;
            margin: 0 auto 1rem auto;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            color: #2c1e16;
        }

        /* Activities Styling */
        .act-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .act-btn { text-align: center; padding: 15px 5px; flex-direction: column; gap: 5px; height: 100px; justify-content: center; }
        .act-icon { font-size: 2rem; display: block; margin-bottom: 4px; }

        /* Market Styling */
        .market-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .shop-card {
            background: rgba(255,255,255,0.4); border: 2px solid var(--leather);
            border-radius: 8px; padding: 10px; cursor: pointer; transition: transform 0.2s;
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .shop-card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.6); }
        .shop-icon { font-size: 2.5rem; margin-bottom: 5px; }
        .shop-name { font-family: 'MedievalSharp'; font-weight: bold; font-size: 1.1rem; color: var(--leather); }
        .vendor-name { font-size: 0.8rem; font-style: italic; opacity: 0.8; }
        
        .item-card {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.3);
            margin-bottom: 4px; border-radius: 4px;
        }
        .item-card.sold-out { opacity: 0.5; background: rgba(0,0,0,0.05); }
        .buy-btn {
            background: var(--leather); color: #f4e4bc; border: none; padding: 4px 8px;
            font-family: 'MedievalSharp'; cursor: pointer; border-radius: 4px; font-size: 0.8rem;
        }
        .buy-btn:hover { background: var(--gold); color: var(--ink); }
        .buy-btn:disabled { background: #555; cursor: not-allowed; color: #ccc; }

        /* Utility */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(2px);
        }
        .modal-box {
            background: var(--parchment);
            border: 4px solid var(--leather);
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            border-radius: 8px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .creation-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--parchment); z-index: 50;
            display: flex; flex-direction: column; padding: 2rem;
            text-align: center; overflow-y: auto;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--leather); border-radius: 4px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="parchment-container">
    <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h2 class="text-3xl font-medieval mb-4">Settings</h2>
            <p class="mb-6 italic">Manage your journey.</p>
            <div class="flex flex-col gap-3">
                <button id="btn-sound-toggle" onclick="toggleSoundSetting()" class="choice-btn text-center justify-center">Sound Effects: ON</button>
                <button onclick="restartGame()" class="choice-btn text-center justify-center bg-red-800 text-white">Restart Chronicle (Delete Save)</button>
                <button onclick="closeSettings()" class="choice-btn text-center justify-center">Return to Game</button>
            </div>
        </div>
    </div>

    <!-- Message Modal (Generic) -->
    <div id="msg-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h2 id="msg-title" class="text-2xl font-medieval mb-2 text-amber-900">Message</h2>
            <p id="msg-text" class="mb-6 italic">Details here.</p>
            <button onclick="document.getElementById('msg-modal').classList.add('hidden')" class="choice-btn text-center justify-center">Close</button>
        </div>
    </div>
    
    <!-- Confirm Modal (Evil Acts) -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-box border-red-800">
            <h2 class="text-3xl font-medieval mb-2 text-red-900">Dark Deed</h2>
            <p class="mb-6 italic" id="confirm-text">This is an evil act? Are you sure?</p>
            <div class="flex gap-4 justify-center">
                <button id="confirm-yes-btn" class="choice-btn w-32 justify-center bg-red-900 text-white">Commit Evil</button>
                <button onclick="closeConfirm()" class="choice-btn w-32 justify-center">Hesitate</button>
            </div>
        </div>
    </div>

    <!-- Age Warning Modal -->
    <div id="age-modal" class="modal-overlay hidden">
        <div class="modal-box border-red-800">
            <h2 class="text-3xl font-medieval mb-2 text-red-900">Too Young</h2>
            <p class="mb-6 italic" id="age-warning-text">You are not old enough for this.</p>
            <button onclick="document.getElementById('age-modal').classList.add('hidden')" class="choice-btn text-center justify-center">I understand</button>
        </div>
    </div>

    <!-- Shop Modal -->
    <div id="shop-modal" class="modal-overlay hidden">
        <div class="modal-box text-left relative">
            <button onclick="closeShop()" class="absolute top-2 right-4 text-xl font-bold">X</button>
            <h2 class="text-3xl font-medieval mb-2 text-center">Marketplace</h2>
            <div id="shop-keeper-area" class="mb-4 p-2 bg-amber-900/10 rounded border border-amber-900/20 text-center">
                <!-- Keeper injected here -->
            </div>
            <div id="shop-content" class="space-y-2"></div>
        </div>
    </div>

    <!-- NPC Modal -->
    <div id="npc-modal" class="modal-overlay hidden">
        <div class="modal-box text-left relative">
            <button onclick="closeNPC()" class="absolute top-2 right-4 text-xl font-bold">X</button>
            <div id="npc-content"></div>
        </div>
    </div>

    <!-- Lore Modal -->
    <div id="lore-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h2 class="text-4xl font-medieval mb-4 text-amber-900">The Kingdom of Chep</h2>
            <div class="text-left space-y-4 mb-6 text-sm max-h-60 overflow-y-auto pr-2" style="font-family: 'Spectral', serif;">
                <p>Once upon a time, long before the walls of Chep rose white and gold against the sun, there was only the <strong>Age of Ash</strong>.</p>
                <p>For four hundred years, the sky wept soot. Brother slew brother for a scrap of bread, and Warlords built thrones upon mounds of bone. The gods were silent, and hope was a ghost.</p>
                <p>Then, a star fell to earth. Not a stone of fire, but a shard of pure, singing light. From the crater walked <strong>Ren</strong>‚Äîno king, but a hero. He forged the star into <strong>Lumina</strong>, the Blade of Dawn.</p>
                <p>Ren marched to Dread Peak, where the Seven Warlords gathered to divide the world. He did not strike them. Instead, he swung Lumina at the mountain itself, cleaving the peak in twain. The earth shook, and the Warlords, seeing true power, fell to their knees.</p>
                <p>There, in the dust, the <strong>Oath of Unity</strong> was sworn. Ren became the first King of <strong>House Chep</strong>. The Warlords became the <strong>Seven Greater Houses</strong>, sworn to protect the peace they once destroyed.</p>
                <p>And so the Kingdom of Chep was born. But fairytales end, and history bleeds. The starlight is fading, traveler. What will you do in the dark?</p>
            </div>
            <button onclick="enterWorld()" class="choice-btn text-center justify-center font-bold text-lg">Enter the World</button>
        </div>
    </div>

    <!-- Character Creation Overlay -->
    <div id="creation-screen" class="creation-screen">
        <h2 class="text-5xl font-bold mb-2 text-amber-900" style="font-family: 'MedievalSharp';">A Medieval Life</h2>
        <p class="italic mb-8 text-lg opacity-70">A game by Juanse Gutierrez.</p>
        
        <div class="max-w-xl mx-auto w-full bg-white/40 p-6 rounded-lg border-2 border-[#5d4037] shadow-xl">
            <h3 class="text-xl font-bold mb-4">Forge Your Destiny</h3>
            <input type="text" id="char-name" placeholder="Enter First Name" class="w-full p-3 border-2 border-[#5d4037] bg-[#fdf6e3] text-center text-xl font-bold mb-6 focus:outline-none focus:border-amber-600 rounded">
            
            <div class="flex justify-center gap-4 mb-6">
                <button id="gender-m" class="choice-btn w-32 justify-center" onclick="setGender('Male')">Male</button>
                <button id="gender-f" class="choice-btn w-32 justify-center opacity-60" onclick="setGender('Female')">Female</button>
            </div>

            <div class="text-left mb-2 font-bold flex justify-between">
                <span>Ability Scores</span>
                <span class="text-xs font-normal italic">Standard Array (15, 14, 13, 12, 10, 8) assigned randomly</span>
            </div>
            
            <div id="creation-stats" class="grid grid-cols-3 gap-2 mb-6">
                <!-- Stats injected here -->
            </div>

            <button onclick="rerollStats()" class="text-xs underline text-amber-900 mb-4 cursor-pointer hover:text-amber-700">Reroll Dice</button>

            <div class="border-t border-black/20 pt-4 mb-6">
                <h4 class="font-bold mb-2">Social Origin</h4>
                <div class="flex gap-2">
                    <button id="origin-commoner" class="choice-btn text-sm justify-center active-opt" onclick="setOrigin('Commoner')">Humble Beginnings</button>
                    <button id="origin-house" class="choice-btn text-sm justify-center opacity-60" onclick="setOrigin('House')">Noble Bloodline (Roll)</button>
                </div>
            </div>

            <button id="start-btn" class="w-full bg-[#8b4513] text-white font-medieval text-2xl py-3 rounded border-2 border-[#2c1e16] hover:bg-[#a0522d] transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled onclick="startGame()">Begin Chronicle</button>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="text-left">
            <h1 class="text-xl font-bold" id="display-name">Unknown Soul</h1>
            <p class="text-xs opacity-70 font-bold text-amber-900" id="display-class">Commoner</p>
        </div>
        <div class="text-center flex flex-col justify-center">
            <span id="header-hp" class="text-red-900 font-bold text-lg drop-shadow-md" title="Health Points">10/10 HP</span>
            <span id="header-sp" class="text-purple-800 font-bold text-xs drop-shadow-md" title="Sanity Points">8/8 SP</span>
        </div>
        <div class="text-right">
            <h2 class="text-2xl font-bold text-amber-900" id="year-display">Year 0</h2>
            <p class="text-xs">Age: <span id="age-display">0</span></p>
        </div>
    </div>

    <!-- Main Game Area -->
    <div class="main-layout">
        <div class="sidebar">
            <div id="tab-log" class="tab-btn active" onclick="switchTab('log')">üìú Chronicle</div>
            <div id="tab-char" class="tab-btn" onclick="switchTab('char')">üë§ Character</div>
            <div id="tab-inv" class="tab-btn" onclick="switchTab('inv')">üéí Inventory</div>
            <div id="tab-house" class="tab-btn" onclick="switchTab('house')">üè∞ House</div>
            <div id="tab-rel" class="tab-btn" onclick="switchTab('rel')">‚ù§Ô∏è Relationships</div>
            <div id="tab-occ" class="tab-btn" onclick="switchTab('occ')">‚öíÔ∏è Occupation</div>
            <div id="tab-market" class="tab-btn" onclick="switchTab('market')">‚öñÔ∏è Market</div>
            <div id="tab-act" class="tab-btn" onclick="switchTab('act')">üé≠ Activities</div>
            <div id="tab-map" class="tab-btn" onclick="switchTab('map')">üó∫Ô∏è Map</div>
            <div id="tab-cem" class="tab-btn" onclick="switchTab('cem')">ü™¶ Cemetery</div>
            
            <!-- REMOVED UNLOCKS SECTION HERE -->
        </div>

        <div class="content-area">
            <!-- D&D Stat Block -->
            <div class="stats-grid">
                <div class="stat-box"><span class="stat-label">STR</span><span id="stat-str" class="stat-val">10</span><span id="mod-str" class="stat-mod">+0</span></div>
                <div class="stat-box"><span class="stat-label">DEX</span><span id="stat-dex" class="stat-val">10</span><span id="mod-dex" class="stat-mod">+0</span></div>
                <div class="stat-box"><span class="stat-label">CON</span><span id="stat-con" class="stat-val">10</span><span id="mod-con" class="stat-mod">+0</span></div>
                <div class="stat-box"><span class="stat-label">INT</span><span id="stat-int" class="stat-val">10</span><span id="mod-int" class="stat-mod">+0</span></div>
                <div class="stat-box"><span class="stat-label">WIS</span><span id="stat-wis" class="stat-val">10</span><span id="mod-wis" class="stat-mod">+0</span></div>
                <div class="stat-box"><span class="stat-label">CHA</span><span id="stat-cha" class="stat-val">10</span><span id="mod-cha" class="stat-mod">+0</span></div>
            </div>

            <!-- Tab: Log (Main Gameplay) -->
            <div id="log-tab" class="tab-content flex-grow flex flex-col overflow-hidden">
                <div id="event-log"></div>
                <div id="input-area" class="mt-auto">
                    <div id="decision-prompt" class="px-6 py-3 bg-amber-900/10 font-bold text-amber-900 border-t border-black/10 font-medieval text-lg">
                        Fate awaits...
                    </div>
                    <div id="choices-container" class="choices-area">
                        <!-- Buttons injected here -->
                    </div>
                </div>
            </div>

            <!-- Tab: Activities -->
            <div id="act-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-2 border-b border-black/20 pb-2">Activities</h2>
                <div id="act-content" class="act-grid"></div>
            </div>

            <!-- Tab: Character Sheet -->
            <div id="char-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-4 border-b border-black/20 pb-2">Character Sheet</h2>
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-bold mb-2">Vitals</h3>
                        <p><strong>Health:</strong> <span id="hp-display" class="text-green-800 font-bold">10 / 10</span></p>
                        <p><strong>Sanity:</strong> <span id="sp-display" class="text-purple-800 font-bold">8 / 8</span></p>
                        <p><strong>Gold:</strong> <span id="gold-display">0</span> GP</p>
                        <p><strong>Social Reality:</strong> <span id="social-display">Commoner</span></p>
                        <p><strong>Location:</strong> <span id="location-display">Chep</span></p>
                        <p><strong>Alignment:</strong> <span id="align-display">True Neutral</span></p>
                        
                        <h3 class="font-bold mt-4 mb-2 border-t border-black/10 pt-2">Reputation & Fame</h3>
                        <div class="text-sm">
                             <div class="flex justify-between"><span>üëë Renown:</span> <span id="rep-renown">0</span></div>
                             <div class="flex justify-between"><span>‚öîÔ∏è Honor:</span> <span id="rep-honor">0</span></div>
                             <div class="flex justify-between"><span>üôè Piety:</span> <span id="rep-piety">0</span></div>
                             <div class="flex justify-between text-red-800"><span>‚ò†Ô∏è Infamy:</span> <span id="rep-infamy">0</span></div>
                        </div>
                    </div>
                    <div>
                         <h3 class="font-bold mb-2">Appearance & Genetics</h3>
                         <div id="appearance-display" class="text-sm mb-2 p-2 bg-white/30 rounded border border-black/10">
                             <!-- Injected via JS -->
                         </div>
                         <div id="gene-list" class="text-sm italic mb-4">No mutations.</div>

                        <h3 class="font-bold mb-2 border-t border-black/10 pt-2">Traits & Feats</h3>
                        <div id="traits-list" class="text-sm space-y-1 italic">None yet...</div>
                    </div>
                </div>
            </div>

            <!-- Tab: Map -->
            <div id="map-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-4 border-b border-black/20 pb-2">Kingdom of Chep</h2>
                <div id="map-visual" class="map-visual-container"></div>
                <div id="map-content"></div>
            </div>

            <!-- Tab: House / Lineage -->
            <div id="house-tab" class="tab-content hidden p-6 overflow-y-auto text-center">
                <!-- Content injected via JS -->
                <div id="house-content"></div>
            </div>

            <!-- Tab: Relationships -->
            <div id="rel-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-4 border-b border-black/20 pb-2">Relationships</h2>
                <input type="text" id="rel-search-input" onkeyup="renderRelTab()" placeholder="Search names..." class="mb-4 p-2 w-full border border-[#5d4037] rounded bg-white/50 font-medieval">
                <p class="text-xs italic mb-2">Click on a person to view their details.</p>
                <div id="rel-content"></div>
            </div>

            <!-- Tab: Occupation -->
            <div id="occ-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-4 border-b border-black/20 pb-2">Occupation & Trade</h2>
                <div id="occ-content"></div>
            </div>
            
             <!-- Tab: Inventory -->
             <div id="inv-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-4 border-b border-black/20 pb-2">Inventory</h2>
                <div id="inventory-list" class="flex flex-col gap-1">
                    <p class="italic opacity-50">Your satchel is empty.</p>
                </div>
            </div>

            <!-- Tab: Market (NEW) -->
            <div id="market-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-4 border-b border-black/20 pb-2">City Market</h2>
                <div id="market-view-main">
                    <p class="italic mb-4 text-sm" id="market-desc">The stalls are bustling with activity.</p>
                    <div id="market-content" class="market-grid"></div>
                </div>
                <div id="market-view-shop" class="hidden">
                    <button onclick="renderMarketTab()" class="mb-4 text-sm underline text-amber-900">‚Üê Back to Market</button>
                    <div id="shop-detail-content"></div>
                </div>
            </div>

            <!-- Tab: Cemetery -->
            <div id="cem-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-4 border-b border-black/20 pb-2">Family Cemetery</h2>
                <p class="italic mb-4 text-sm">Here lie those who came before. Tread carefully.</p>
                <div id="cemetery-content"></div>
            </div>
        </div>
    </div>
</div>

<script>
    /* --- ARCANE ARCHITECT'S ENGINE --- */

    // 0. AUDIO ENGINE & CONFIRMATION SYSTEM
    const AudioEngine = {
        ctx: null,
        init: function() {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
        },
        pulse: function() {
            if(!state.settings.sound) return; // Check setting
            if(!this.ctx) this.init();
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(100, this.ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(50, this.ctx.currentTime + 0.3);
            gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start();
            osc.stop(this.ctx.currentTime + 0.3);
        }
    };
    
    // 0.5 NEW GENETIC ENGINE: PHENOTYPES & MUTATIONS
    const COSMETICS = {
        hair: ['Brown', 'Black', 'Blonde', 'Red', 'Grey', 'White', 'Auburn', 'Chestnut', 'Straw'],
        eyes: ['Brown', 'Blue', 'Green', 'Hazel', 'Grey', 'Amber', 'Dark'],
        skin: ['Pale', 'Fair', 'Olive', 'Tan', 'Brown', 'Dark', 'Ebony', 'Ruddy'],
        height: ['Dwarf', 'Short', 'Average', 'Tall', 'Towering', 'Giant']
    };

    const HOUSE_PHENOTYPES = {
        "Chep": { hair: "Platinum", eyes: "Violet", skin: "Fair" },
        "Valdoria": { hair: "Golden", eyes: "Amber", skin: "Tan" },
        "Thalor": { hair: "Black", eyes: "Sea-Green", skin: "Pale" },
        "Grimward": { hair: "Raven", eyes: "Ice-Blue", skin: "Pale" },
        "Sunstrider": { hair: "Fiery Red", eyes: "Emerald", skin: "Olive" },
        "Ironheart": { hair: "Ash-Grey", eyes: "Steel-Grey", skin: "Fair" },
        "Moonshadow": { hair: "Silver", eyes: "Black", skin: "Pale" },
        "Stormbreaker": { hair: "White", eyes: "Electric Blue", skin: "Fair" }
    };

    const MUTATION_POOL = [
    // ===== COMMON (cosmetic, rumor-tier) =====
    { name: "Birthmark", rarity: "Common", desc: "A distinct mark on the skin." },
    { name: "Freckles", rarity: "Common", desc: "Sun-kissed spots across the face." },
    { name: "Cleft Chin", rarity: "Common", desc: "A prominent, noble jawline." },
    { name: "Widow's Peak", rarity: "Common", desc: "A sharp V-shaped hairline." },
    { name: "Thick Eyebrows", rarity: "Common", desc: "Dense, expressive brows." },
    { name: "Long Lashes", rarity: "Common", desc: "Unnaturally long eyelashes." },
    { name: "Crooked Smile", rarity: "Common", desc: "A slightly uneven grin." },
    { name: "Unusual Voice", rarity: "Common", desc: "A voice that sounds rough, airy, or oddly musical." },
    { name: "Asymmetrical Face", rarity: "Common", desc: "Subtle imbalance in facial features." },

    // ===== UNCOMMON (noticeable, whispered about) =====
    { name: "Heterochromia", rarity: "Uncommon", desc: "Eyes of two different colors." },
    { name: "Albinism", rarity: "Uncommon", desc: "Complete lack of pigment." },
    { name: "Vitiligo", rarity: "Uncommon", desc: "Patches of unpigmented skin." },
    { name: "Sharp Teeth", rarity: "Uncommon", desc: "Slightly pointed canines." },
    { name: "Double Pupil", rarity: "Uncommon", desc: "Two pupils in one eye." },
    { name: "Extended Canines", rarity: "Uncommon", desc: "Fangs just long enough to be unsettling." },
    { name: "Unusual Ear Shape", rarity: "Uncommon", desc: "Ears taper, curl, or angle unnaturally." },
    { name: "Heat-Resistant Skin", rarity: "Uncommon", desc: "Skin rarely blisters or burns." },

    // ===== RARE (distinctive, earns a nickname) =====
    { name: "Webbed Fingers", rarity: "Rare", desc: "Skin between fingers, good for swimming." },
    { name: "Cat Eyes", rarity: "Rare", desc: "Vertical slit pupils." },
    { name: "Forked Tongue", rarity: "Rare", desc: "A split tongue capable of precise movement." },
    { name: "Stone Nails", rarity: "Rare", desc: "Hard, grayish nails resistant to breakage." },
    { name: "Thickened Bones", rarity: "Rare", desc: "Bones are unusually dense and heavy." },
    { name: "Shadow Veins", rarity: "Rare", desc: "Dark veins visible beneath the skin." },

    // ===== EPIC (unnatural, feared or revered) =====
    { name: "Scales", rarity: "Epic", desc: "Patches of hardened, scaled skin." },
    { name: "Bioluminescence", rarity: "Epic", desc: "Skin glows faintly in absolute darkness." },
    { name: "Third Eye", rarity: "Epic", desc: "A dormant eye in the center of the forehead." },
    { name: "Horns", rarity: "Epic", desc: "Small bony protrusions on the forehead." },


    // ===== LEGENDARY (myth-tier, almost unique) =====
    { name: "Seer", rarity: "Legendary", desc: "Innate ability to perceive beyond linear time and physical reality." }
    
];

    const GeneticEngine = {
        generate: function(houseName = null, forcedTrait = null) {
            let look = {};
            
            // 1. Base Appearance (House Template or Random)
            if (houseName && HOUSE_PHENOTYPES[houseName]) {
                look = { ...HOUSE_PHENOTYPES[houseName] };
            } else {
                look.hair = COSMETICS.hair[Math.floor(Math.random() * COSMETICS.hair.length)];
                look.eyes = COSMETICS.eyes[Math.floor(Math.random() * COSMETICS.eyes.length)];
                look.skin = COSMETICS.skin[Math.floor(Math.random() * COSMETICS.skin.length)];
            }
            
            // Height is always random/independent of House template
            look.height = COSMETICS.height[Math.floor(Math.random() * COSMETICS.height.length)];

            let mutations = [];
            
            // 2. Forced Trait Logic (House Generation)
            if (forcedTrait) {
                // If the trait is a mutation, force it
                const mut = MUTATION_POOL.find(m => m.name === forcedTrait);
                if (mut) {
                    mutations.push(mut);
                } else if (forcedTrait.includes("Hair")) {
                    look.hair = forcedTrait.replace(" Hair", "");
                } else if (forcedTrait.includes("Eyes")) {
                    look.eyes = forcedTrait.replace(" Eyes", "");
                }
            }

            // 3. Random Mutation (Only if no mutation exists - LIMIT 1)
            if (mutations.length === 0 && Math.random() < 0.25) { 
                const roll = Math.random();
                let tier = 'Common';
                if (roll > 0.99) tier = 'Legendary';
                else if (roll > 0.96) tier = 'Epic';
                else if (roll > 0.85) tier = 'Rare';
                else if (roll > 0.60) tier = 'Uncommon';
                
                const pool = MUTATION_POOL.filter(m => m.rarity === tier);
                if(pool.length > 0) {
                    mutations.push(pool[Math.floor(Math.random() * pool.length)]);
                }
            }
            
            return { ...look, mutations };
        },
        
        // Inheritance Logic
        mix: function(father, mother) {
            const fGenes = father.appearance || this.generate();
            const mGenes = mother.appearance || this.generate();
            
            const hair = Math.random() > 0.5 ? fGenes.hair : mGenes.hair;
            const eyes = Math.random() > 0.5 ? fGenes.eyes : mGenes.eyes;
            const skin = Math.random() > 0.5 ? fGenes.skin : mGenes.skin;
            const height = Math.random() > 0.5 ? (fGenes.height || 'Average') : (mGenes.height || 'Average');
            
            let mutations = [];
            
            // 1. High Inheritance from Parents (80% chance)
            const parentMutations = [...(fGenes.mutations || []), ...(mGenes.mutations || [])];
            
            // Filter unique mutations from parents
            const uniqueParentMutations = [];
            const seen = new Set();
            for (const m of parentMutations) {
                if(!seen.has(m.name)) {
                    seen.add(m.name);
                    uniqueParentMutations.push(m);
                }
            }

            if (uniqueParentMutations.length > 0) {
                // Pick one potential mutation to inherit
                const candidate = uniqueParentMutations[Math.floor(Math.random() * uniqueParentMutations.length)];
                
                // 80% Chance to Inherit
                if (Math.random() < 0.80) {
                    mutations.push(candidate);
                }
            }
            
            // 2. Random new mutation (5% chance) ONLY if no mutation yet (Limit 1)
            if(mutations.length === 0 && Math.random() < 0.05) {
                 const newGen = this.generate();
                 if(newGen.mutations.length > 0) {
                     mutations.push(newGen.mutations[0]);
                 }
            }

            return { hair, eyes, skin, height, mutations };
        }
    };


    // 1. D&D 5e MECHANICS
    const ABILITIES = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
    const ALIGNMENTS = ['Lawful Good', 'Neutral Good', 'Chaotic Good', 'Lawful Neutral', 'True Neutral', 'Chaotic Neutral', 'Lawful Evil', 'Neutral Evil', 'Chaotic Evil'];
    
    function getModifier(score) {
        return Math.floor((score - 10) / 2);
    }

    function formatMod(mod) {
        return mod >= 0 ? `+${mod}` : `${mod}`;
    }

    function rollD20(mod) {
        let r1 = Math.floor(Math.random() * 20) + 1;
        let specialText = "";

        // TRAIT LOGIC REMOVED: Traits are now purely cosmetic/physical.
        // The body remembers, but the dice do not care.

        return {
            roll: r1,
            mod: mod,
            total: r1 + mod,
            isCrit: r1 === 20,
            isFail: r1 === 1,
            specialText: specialText
        };
    }

    // 2. STATE MANAGEMENT
    const state = {
        settings: { sound: true }, // Added Settings
        name: "Unknown",
        gender: "Male",
        age: 0,
        year: 1200,
        stats: { str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10 },
        appearance: { hair: "Brown", eyes: "Brown", skin: "Fair", height: "Average", mutations: [] }, // NEW: Appearance Object
        genes: [], // Legacy/Unused or purely strictly internal ID tracking if needed, but appearance.mutations is main
        reputation: { renown: 0, honor: 0, piety: 0, infamy: 0 },
        gold: 0,
        health: 10,
        maxHealth: 10,
        sanity: 8,
        maxSanity: 8,
        socialClass: "Commoner", 
        house: null, 
        location: 0, // Index of current city
        relationships: [],
        interactions: {}, // tracks yearly interactions per person ID
        activityLog: { love: 0, quest: 0, crime: 0, train: 0, lord: 0 }, 
        occupation: null, 
        jobHistory: {},
        rejectedJobs: [], // Stores rejected job IDs for the current year
        traits: [], // ACQUIRED TRAITS
        inventory: [],
        market: [], // NEW: Stores current year's shops
        eventQueue: [], // NEW: Stores events for the current year
        recentEvents: [], // NEW: Duplicate Ward memory
        flags: {
            literate: false,
            criminal: false,
            married: false,
            employed: false,
            startOrigin: 'Commoner',
            travelAllowed: false,
            travelTarget: null,
            adult: false,
            traveledThisYear: false
        }
    };

    // 3. DATA: OCCUPATIONS & GUILDS
    const CAREERS = {
        common: { 
            name: "Laborer", 
            req: { age: 8 },
            dc: 8, stat: 'con',
            ranks: [
                { title: "Errand Runner", wage: 1, stressMod: 1 },
                { title: "Farmhand", wage: 5, stressMod: 2 },
                { title: "Foreman", wage: 12, stressMod: 3 }
            ]
        },
        farmer: {
            name: "Farmer",
            req: { age: 10 },
            dc: 10, stat: 'con',
            ranks: [
                { title: "Field Hand", wage: 3, stressMod: 2 },
                { title: "Homesteader", wage: 10, stressMod: 3 },
                { title: "Land Owner", wage: 25, stressMod: 4 }
            ]
        },
        artist: {
            name: "Artist",
            req: { age: 12, stat: 'cha', val: 12 },
            dc: 12, stat: 'cha',
            ranks: [
                { title: "Apprentice Painter", wage: 5, stressMod: 2 },
                { title: "Portraitist", wage: 20, stressMod: 3 },
                { title: "Royal Court Painter", wage: 60, stressMod: 5 }
            ]
        },
        blacksmith: {
            name: "Blacksmith",
            req: { age: 12, stat: 'str', val: 12 },
            dc: 13, stat: 'str',
            ranks: [
                { title: "Bellows Boy/Girl", wage: 5, stressMod: 3 },
                { title: "Apprentice Smith", wage: 15, stressMod: 4 },
                { title: "Master Smith", wage: 45, stressMod: 5 }
            ]
        },
        carpenter: {
            name: "Carpenter",
            req: { age: 12, stat: 'dex', val: 11 },
            dc: 12, stat: 'dex',
            ranks: [
                { title: "Woodcutter", wage: 4, stressMod: 3 },
                { title: "Joiner", wage: 14, stressMod: 4 },
                { title: "Master Builder", wage: 40, stressMod: 5 }
            ]
        },
        stonemason: {
            name: "Stonemason",
            req: { age: 12, stat: 'con', val: 12 },
            dc: 13, stat: 'str',
            ranks: [
                { title: "Quarryman", wage: 5, stressMod: 4 },
                { title: "Stonecutter", wage: 16, stressMod: 4 },
                { title: "Architect", wage: 50, stressMod: 6 }
            ]
        },
        baker: {
            name: "Baker",
            req: { age: 12, stat: 'wis', val: 10 },
            dc: 11, stat: 'wis',
            ranks: [
                { title: "Dough Kneader", wage: 3, stressMod: 2 },
                { title: "Oven Keeper", wage: 12, stressMod: 3 },
                { title: "Master Patissier", wage: 35, stressMod: 4 }
            ]
        },
        weaver: {
            name: "Weaver",
            req: { age: 12, stat: 'dex', val: 12 },
            dc: 12, stat: 'dex',
            ranks: [
                { title: "Wool Carder", wage: 3, stressMod: 1 },
                { title: "Loom Operator", wage: 12, stressMod: 2 },
                { title: "Master Weaver", wage: 30, stressMod: 3 }
            ]
        },
        tanner: {
            name: "Tanner",
            req: { age: 12, stat: 'con', val: 11 },
            dc: 12, stat: 'con',
            ranks: [
                { title: "Hide Scraper", wage: 4, stressMod: 4 },
                { title: "Leatherworker", wage: 14, stressMod: 4 },
                { title: "Master Tanner", wage: 35, stressMod: 5 }
            ]
        },
        guard: {
            name: "City Guard",
            req: { age: 16, stat: 'str', val: 12 },
            dc: 13, stat: 'str',
            ranks: [
                { title: "Gate Watch", wage: 8, stressMod: 3 },
                { title: "Patrolman", wage: 15, stressMod: 4 },
                { title: "Captain of the Watch", wage: 35, stressMod: 6 }
            ]
        },
        alchemist: {
            name: "Alchemist",
            req: { age: 14, stat: 'int', val: 13 },
            dc: 14, stat: 'int',
            ranks: [
                { title: "Bottle Washer", wage: 5, stressMod: 2 },
                { title: "Apprentice Brewer", wage: 15, stressMod: 3 },
                { title: "Master Alchemist", wage: 50, stressMod: 5 }
            ]
        },
        merchant: {
            name: "Merchant",
            req: { age: 16, stat: 'cha', val: 12 },
            dc: 14, stat: 'cha',
            ranks: [
                { title: "Peddler", wage: 10, stressMod: 3 },
                { title: "Shopkeeper", wage: 30, stressMod: 4 },
                { title: "Trade Magnate", wage: 100, stressMod: 6 }
            ]
        },
        squire: {
            name: "Squireship",
            req: { age: 12, stat: 'str', val: 12 }, // Special entry via NPC interaction
            dc: 100, stat: 'str', // Impossible via menu
            ranks: [
                { title: "Page", wage: 2, stressMod: 2 },
                { title: "Squire", wage: 5, stressMod: 4 },
                { title: "Knight-Errant", wage: 20, stressMod: 6 } 
            ]
        },
        military: { 
            name: "Military", 
            req: { age: 14, stat: 'con', val: 10 },
            dc: 12, stat: 'con',
            ranks: [
                { title: "Camp Follower", wage: 2, stressMod: 1 },
                { title: "Foot Soldier", wage: 10, stressMod: 5 },
                { title: "Veteran Sergeant", wage: 25, stressMod: 6 },
                { title: "Captain", wage: 60, stressMod: 8 }
            ]
        },
        knight: {
            name: "Knight",
            req: { age: 16, stat: 'str', val: 12, class: 'House' },
            dc: 14, stat: 'str',
            ranks: [
                { title: "Household Guard", wage: 15, stressMod: 3 },
                { title: "Knight-Errant", wage: 30, stressMod: 5 },
                { title: "Lord Commander", wage: 80, stressMod: 7 }
            ]
        },
        diplomat: {
            name: "Diplomat",
            req: { age: 16, stat: 'cha', val: 12, class: 'House' },
            dc: 13, stat: 'cha',
            ranks: [
                { title: "Envoy", wage: 20, stressMod: 2 },
                { title: "Ambassador", wage: 45, stressMod: 4 },
                { title: "High Chancellor", wage: 120, stressMod: 8 }
            ]
        },
        scholar: {
            name: "Scholarly",
            req: { age: 12, stat: 'int', val: 12, flag: 'literate' },
            dc: 14, stat: 'int',
            ranks: [
                { title: "Scribe's Assistant", wage: 4, stressMod: 1 },
                { title: "Junior Scribe", wage: 12, stressMod: 2 },
                { title: "Court Historian", wage: 45, stressMod: 4 }
            ]
        },
        clergy: {
            name: "Clergy",
            req: { age: 12, stat: 'wis', val: 11 },
            dc: 13, stat: 'wis',
            ranks: [
                { title: "Novice", wage: 0, stressMod: 1 },
                { title: "Priest", wage: 5, stressMod: 3 },
                { title: "High Priest", wage: 20, stressMod: 5 }
            ]
        },
        bard: {
            name: "Bard",
            req: { age: 12, stat: 'cha', val: 12 },
            dc: 13, stat: 'cha',
            ranks: [
                { title: "Street Busker", wage: 2, stressMod: 1 },
                { title: "Tavern Singer", wage: 8, stressMod: 2 },
                { title: "Royal Minstrel", wage: 50, stressMod: 4 }
            ]
        },
        crime: {
            name: "Criminal",
            req: { age: 8, stat: 'dex', val: 10 },
            dc: 10, stat: 'dex',
            ranks: [
                { title: "Pickpocket", wage: 5, stressMod: 4 },
                { title: "Burglar", wage: 20, stressMod: 6 },
                { title: "Crime Boss", wage: 100, stressMod: 10 }
            ]
        }
    };

    // 4. DATA: HOUSE & CITY SYSTEM
    const TIER_DATA = {
        royal: { name: 'Royal House', prob: 0.01, startGold: 10000 },
        greater: { name: 'Greater House', prob: 0.10, startGold: 5000 },
        lesser: { name: 'Lesser House', sigils: ['üå≤', 'üè∞', 'üó°Ô∏è', 'üõ°Ô∏è', 'üîî',
        'üåæ', 'üçÇ', 'üçÅ', 'üåø', 'üåä', 'ü™®', 'üî•', '‚ùÑÔ∏è', 'üíé', '‚õìÔ∏è', '‚öîÔ∏è',
        'üèπ', 'ü™∂', 'üïØÔ∏è', 'ü™ô', 'üêç', 'üêó', 'ü¶Å', 'ü¶ä', 'ü¶å', 'üêè', 'üêê', 
        'üêì', 'üêü', 'ü¶¢','üêÇ', 'üêÑ', 'üêñ', 'üêá', 'ü¶î', 'ü¶ù', 'üêøÔ∏è', 'ü¶´', 
        'üêé', 'üê¥', 'ü´è', 'üêï', 'üêà', 'ü¶â', 'ü¶ú', 'ü¶§', 'üêù', 'ü¶ã', 'üï∑Ô∏è', 'ü¶Ç', 'üê¢', 'ü¶é', 'üê∏', 'ü¶Ä', 'ü¶û', 'üêö'], prob: 0.89, startGold: 500 }
    };
    
    const HOUSE_RANKS = ["Lord/Lady", "Heir", "Younger Child", "House Member", "Sworn Sword", "Servant"];
    
    const GREATER_HOUSES_INFO = {
        "Chep": { motto: "Unity in Starlight", desc: "The Royal line, descended from Hero Ren.", heirloom: "Lumina, the Star-Blade", sigil: "‚≠ê", holding: "The Sun Fortress", holdingDesc: "The radiant seat of the High King, built from white marble that glows at dawn." },
        "Valdoria": { motto: "Gold is Power", desc: "Masters of coin and trade in the golden west.", heirloom: "The Gilded Scepter", sigil: "ü¶Ö", holding: "The Golden Vaults", holdingDesc: "A massive palace carved into the cliffside, guarding the realm's treasury." },
        "Thalor": { motto: "Tides Bow to None", desc: "Wardens of the stormy seas and the leviathans beneath.", heirloom: "The Abyssal Trident", sigil: "ü¶ë", holding: "Stormwatch Keep", holdingDesc: "A formidable fortress lashed by eternal waves, protecting the southern coasts." },
        "Grimward": { motto: "Winter is our Anvil", desc: "Sentinels of the frozen north against the darkness.", heirloom: "Frostfang (Greataxe)", sigil: "üê∫", holding: "Ice-Fang Citadel", holdingDesc: "Built from black basalt and magical ice, it has never been breached." },
        "Sunstrider": { motto: "Light Pierces All", desc: "Keepers of the deep forests and ancient magic.", heirloom: "The Verdant Bow", sigil: "üåπ", holding: "The Elder Tree", holdingDesc: "A palace woven from living wood inside a tree the size of a mountain." },
        "Ironheart": { motto: "Steel Endures", desc: "Forgers of steel and stone in the industrial heart.", heirloom: "The Black Hammer", sigil: "üêâ", holding: "The Black Forge", holdingDesc: "An industrial complex of smoke and fire where the finest steel is born." },
        "Moonshadow": { motto: "Secrets in Silence", desc: "Scholars of the arcane arts built upon ruins.", heirloom: "The Crystal Orb", sigil: "üåô", holding: "Spire of Whispers", holdingDesc: "A floating tower tethered by chains, housing the greatest library in the world." },
        "Stormbreaker": { motto: "Above the Clouds", desc: "Watchers of the high peaks, touching the clouds.", heirloom: "Sky-Splitter (Spear)", sigil: "‚ö°", holding: "Cloudreach", holdingDesc: "A castle perched on the highest peak, accessible only by wyvern or narrow bridge." }
    };

    const LESSER_MOTTOS = [
        "Honor Above All", "Strength in Unity", "By Blade and Blood", "Ever Watchful",
        "Stone Endures", "The Tide Rises", "Fire Hearts", "Silent Steps",
        "Glory in Death", "Iron Will", "Truth Conquers", "Faith is Armor",
        "Never Bow", "Rise from Ash", "Guardians of the Pass", "Victory or Death",
        "Wisdom Guides", "Loyalty Binds", "Shadows Protect", "Light the Way",
        "Roots Run Deep", "Storms Pass", "We Do Not Break", "Hold the Line",
        "Courage is Capital", "Family First", "Steel and Soul", "Bound by Oath"
    ];

    const HOUSE_NAMES = {
        royal: ["Chep"],
        greater: ["Valdoria", "Thalor", "Grimward", "Sunstrider", "Ironheart", "Moonshadow", "Stormbreaker"],
        lesser: ["Oakenshield", "Swiftwater", "Gloomveil", "Brightsteel", "Duskwood", "Cragstone",
        "Mistwalker", "Windrider", "Frostborne", "Emberfall", "Ironfoot", "Ravenhill", "Shadowmere", "Lightbringer",
        "Ashford", "Briarholt", "Stonewake", "Clearbrook", "Hollowmere", "Thornfield", "Greywillow", "Highfen", 
        "Redbarrow", "Coldmere", "Duskridge", "Foxgrove", "Alderwatch", "Blackbriar", "Lowcrest", "Mournfield", "Westmere",
        "Deepwell", "Crowmere", "Marrowfen", "Stillwater", "Goldleaf", "Pineward", "Whitebarrow", "Brackenford", "Slatehollow", 
        "Amberwick", "Mirewatch", "Cinderholt", "Elderfen", "Stonebranch", "Brookhaven", "Rimefield", "Hearthmere", "Thistlemoor",]
    };
    
    const HOLDING_PREFIXES = ["The Keep of", "Fortress of", "Manor of", "Hall of"];
    
    const CITIES = [
        { name: "Chep (Capital)", ruler: "House Chep", desc: "The royal seat of power, founded by Hero Ren.", x: 50, y: 50 },
        { name: "Frosthold", ruler: "House Grimward", desc: "A fortress of ice and stone in the far north.", x: 50, y: 15 },
        { name: "Goldspire", ruler: "House Valdoria", desc: "A glittering city of trade carved into western cliffs.", x: 15, y: 60 },
        { name: "Arcania", ruler: "House Moonshadow", desc: "A hub of knowledge built atop ancient ruins.", x: 80, y: 70 },
        { name: "Verdant Reach", ruler: "House Sunstrider", desc: "Nestled in the deep, mystical southern forests.", x: 50, y: 85 },
        { name: "Sky Bastion", ruler: "House Stormbreaker", desc: "A mountain stronghold touching the clouds.", x: 85, y: 25 },
        { name: "Ironport", ruler: "House Ironheart", desc: "The industrial heart, forging steel for the realm.", x: 20, y: 35 },
        { name: "Tidecaller's Keep", ruler: "House Thalor", desc: "A fortress withstanding the eternal ocean storms.", x: 10, y: 80 }
    ];

    // --- MARKET DATA & LOGIC ---
    const SHOP_POOLS = {
        tavern: {
            name: "Tavern", icon: "üç∫",
            items: [
                { name: "Stale Bread", rarity: "Common", desc: "Better than starving. (+1 HP)", value: 2, effect: {hp: 1} },
                { name: "Meat Pie", rarity: "Common", desc: "Hearty meal. (+3 HP)", value: 5, effect: {hp: 3} },
                { name: "Ale Tankard", rarity: "Common", desc: "Dulls the senses. (+1 SP, -1 INT)", value: 3, effect: {sp: 1} },
                { name: "Fine Wine", rarity: "Uncommon", desc: "A noble drink. (+2 SP)", value: 15, effect: {sp: 2} },
                { name: "Roast Chicken", rarity: "Uncommon", desc: "Full meal. (+5 HP)", value: 8, effect: {hp: 5} },
                { name: "Royal Cake", rarity: "Rare", desc: "A noble treat. (+5 HP, +2 SP)", value: 40, effect: {hp: 5, sp: 2} }
            ]
        },
        blacksmith: {
            name: "Smithy", icon: "‚öîÔ∏è",
            items: [
                { name: "Whetstone", rarity: "Common", desc: "Sharpen your blade.", value: 5 },
                { name: "Iron Dagger", rarity: "Common", desc: "Simple sidearm.", value: 15 },
                { name: "Chain Shirt", rarity: "Uncommon", desc: "Protect your vitals.", value: 50 },
                { name: "Steel Sword", rarity: "Uncommon", desc: "A soldier's weapon.", value: 45 },
                { name: "Heavy Shield", rarity: "Uncommon", desc: "Block incoming blows.", value: 30 },
                { name: "Masterwork Helm", rarity: "Rare", desc: "Fit for a knight.", value: 150 },
                { name: "Plate Armor", rarity: "VeryRare", desc: "Heavy protection.", value: 500 }
            ]
        },
        herbalist: {
            name: "Herbalist", icon: "üåø",
            items: [
                { name: "Healing Salve", rarity: "Common", desc: "Heals 2 HP.", value: 10, effect: {hp: 2} },
                { name: "Medicinal Herbs", rarity: "Common", desc: "Soothes pain. (+1 HP)", value: 5, effect: {hp: 1} },
                { name: "Healing Potion", rarity: "Uncommon", desc: "Heals 10 HP.", value: 30, effect: {hp: 10} },
                { name: "Focus Draught", rarity: "Uncommon", desc: "Restores 2 SP.", value: 25, effect: {sp: 2} },
                { name: "Snake Oil", rarity: "Common", desc: "Does nothing.", value: 5 },
                { name: "Liquid Fire", rarity: "Rare", desc: "Dangerous substance.", value: 60 }
            ]
        },
        oddities: {
            name: "Oddities", icon: "üîÆ",
            items: [
                { name: "Warm Cloak", rarity: "Common", desc: "Good for travel.", value: 10 },
                { name: "Old Map", rarity: "Uncommon", desc: "Where does it lead?", value: 20 },
                { name: "Strange Coin", rarity: "Rare", desc: "Unknown currency.", value: 50 },
                { name: "Cursed Ring", rarity: "VeryRare", desc: "Cold to the touch.", value: 10 },
                { name: "Dragon Scale", rarity: "Legendary", desc: "Warm and hard as steel.", value: 300 }
            ]
        }
    };

    function generateMarket(cityIndex) {
        state.market = [];
        
        // Define the 4 fixed shops
        const definitions = [
            { type: 'tavern', role: 'Tavernkeeper', pool: SHOP_POOLS.tavern },
            { type: 'blacksmith', role: 'Blacksmith', pool: SHOP_POOLS.blacksmith },
            { type: 'herbalist', role: 'Herbalist', pool: SHOP_POOLS.herbalist },
            { type: 'oddities', role: 'Curio Dealer', pool: SHOP_POOLS.oddities }
        ];

        definitions.forEach(def => {
            // 1. Try to find an existing vendor NPC in this city with the right job
            let vendor = state.relationships.find(r => 
                r.locationIndex === cityIndex && 
                r.occupation === def.role && 
                r.health !== 'Deceased'
            );

            // 2. If no vendor exists, create a new persistent NPC
            if (!vendor) {
                const gender = Math.random() > 0.5 ? 'Male' : 'Female';
                const name = getRandomName(gender);
                // Create relationship with specific role
                vendor = addRelationship(name, "Merchant", 0, gender, "Commoner", cityIndex);
                vendor.occupation = def.role; // Force the correct job
            }

            // 3. Generate Items for this year
            const shopItems = [];
            const numItems = 4 + Math.floor(Math.random() * 3);
            for(let j=0; j<numItems; j++) {
                const itemTemplate = def.pool.items[Math.floor(Math.random() * def.pool.items.length)];
                shopItems.push({ ...itemTemplate, sold: false, id: Math.random().toString(36).substr(2,9) });
            }

            // 4. Add to market state
            state.market.push({
                id: Math.random().toString(36).substr(2,9),
                type: def.type,
                name: `${vendor.name}'s ${def.pool.name}`,
                vendorId: vendor.id, // Link to NPC ID
                vendorName: vendor.name,
                icon: def.pool.icon,
                items: shopItems
            });
        });
    }

    function renderMarketTab() {
        document.getElementById('market-view-main').classList.remove('hidden');
        document.getElementById('market-view-shop').classList.add('hidden');
        
        const container = document.getElementById('market-content');
        document.getElementById('market-desc').innerText = `The market of ${CITIES[state.location].name} is bustling.`;

        // Age Check Logic
        if (state.age < 6) {
            container.innerHTML = `<p class="col-span-2 text-center italic mt-4 opacity-70">You are too young to navigate the market crowds alone.</p>`;
            return;
        }

        if (state.market.length === 0) {
            container.innerHTML = `<p class="col-span-2 italic opacity-50">The market stalls are empty today.</p>`;
            return;
        }

        container.innerHTML = state.market.map(shop => `
            <div class="shop-card" onclick="openShop('${shop.id}')">
                <div class="shop-icon">${shop.icon}</div>
                <div class="shop-name">${shop.name}</div>
                <div class="vendor-name">${shop.vendorName}</div>
            </div>
        `).join('');
    }

    function openShop(shopId) {
        document.getElementById('market-view-main').classList.add('hidden');
        document.getElementById('market-view-shop').classList.remove('hidden');
        
        const shop = state.market.find(s => s.id === shopId);
        
        if (!shop) {
            console.error("Shop ID not found:", shopId);
            document.getElementById('shop-detail-content').innerHTML = `<div class="p-4 text-center italic opacity-50">This shop has closed for the day.</div>`;
            return;
        }

        const container = document.getElementById('shop-detail-content');
        
        container.innerHTML = `
            <div class="text-center mb-4 border-b border-black/10 pb-4">
                <div class="text-4xl mb-2">${shop.icon}</div>
                <h3 class="text-2xl font-medieval">${shop.name}</h3>
                <button onclick="openNPC('${shop.vendorId}')" class="choice-btn text-xs py-2 px-4 mt-2 mx-auto w-auto flex items-center justify-center gap-2">
                    <span>üë§ Keeper: ${shop.vendorName}</span>
                    <span class="opacity-70 text-[10px]">(View)</span>
                </button>
            </div>
            <div class="space-y-2">
                ${shop.items.map((item, idx) => `
                    <div class="item-card ${item.sold ? 'sold-out' : ''}">
                        <div>
                            <div class="font-bold text-sm item-rarity-${item.rarity}">${item.name}</div>
                            <div class="text-xs opacity-70">${item.desc}</div>
                        </div>
                        <button 
                            onclick="buyMarketItem('${shop.id}', ${idx})" 
                            class="buy-btn" 
                            ${item.sold || state.gold < item.value ? 'disabled' : ''}>
                            ${item.sold ? 'Sold Out' : `Buy ${item.value}g`}
                        </button>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function buyMarketItem(shopId, itemIndex) {
        const shop = state.market.find(s => s.id === shopId);
        if (!shop) return; // Safety check for invalid shop

        const item = shop.items[itemIndex];
        
        if (state.gold >= item.value && !item.sold) {
            state.gold -= item.value;
            item.sold = true;
            addItem(item.name, item.rarity, item.desc, Math.floor(item.value/2));
            AudioEngine.pulse();
            
            // Auto-use check (optional, but requested by old shop logic context)
            // Keeping it simple: Add to inventory, but if it has immediate effect property we could trigger it.
            // For now, standard inventory add.
            
            updateUI();
            openShop(shopId); // Re-render to show Sold Out
        }
    }

    // --- END MARKET DATA ---

    const NPC_NAMES = {
        m: ["Aethelred", "Baldric", "Cerdic", "Dunstan", "Eadric", "Godric", "Haldor", "Leofric", "Osric", "Roderick", "Theodoric", "Wulfric", "Alaric", "Berengar", "Cyprian", "Dorian", "Edwin", "Faramond", "Gawain", "Hereward"],
        f: ["Aalis", "Bilda", "Claricent", "Ealdgyth", "Freya", "Gisela", "Hildegard", "Ingrid", "Joan", "Katerin", "Mathilda", "Millicent", "Rosamund", "Sigrid", "Winifred", "Adelaide", "Beatrix", "Constance", "Edith", "Godiva"]
    };

    function createEvent(id, title, text, choices) {
        return { id, title, text, choices };
    }

    const POOLS = {
        Infancy: [
            createEvent('child_0', 'First Breath', 'The world is cold and bright.', [
                { text: 'Cry', type: 'flavor', effect: () => log("You scream your arrival to the world.") }
            ]),
            createEvent('child_1', 'First Steps', 'You wobble on unsteady legs.', [
                { text: 'Walk', type: 'check', stat: 'dex', dc: 10, success: 'You walk! (+1 DEX)', fail: 'You fall on your face.', onSuccess: () => state.stats.dex++, onFail: () => takeDamage(1) }
            ]),
            createEvent('child_2', 'Strange Words', 'You try to mimic the adults.', [
                { text: 'Speak', type: 'check', stat: 'int', dc: 12, success: 'You say "Mama"! (+1 INT)', fail: 'You just drool.', onSuccess: () => state.stats.int++, onFail: () => {} }
            ]),
            createEvent('child_3', 'The Stray Dog', 'A mangy dog approaches you.', [
                { text: 'Pet it', type: 'check', stat: 'wis', dc: 10, success: 'It licks your face. (+1 WIS)', fail: 'It growls at you.', onSuccess: () => state.stats.wis++, onFail: () => modSanity(-1) }
            ]),
            createEvent('child_4', 'The Bully', 'A larger kid demands your lunch.', [
                { text: 'Fight', type: 'check', stat: 'str', dc: 10, success: 'You give them a bloody nose!', fail: 'They sit on you.', onSuccess: () => { modRep('renown', 2); addTrait('Scrapped Knuckles'); }, onFail: () => { takeDamage(1); modRep('honor', -2); } },
                { text: 'Outsmart', type: 'check', stat: 'int', dc: 12, success: 'You trick them into eating mud.', fail: 'They punch you.', onSuccess: () => state.stats.int++, onFail: () => { takeDamage(2); addTrait('Chipped Tooth'); } }
            ]),
            createEvent('child_5', 'Lost Coin', 'You find a coin in the mud.', [
                { text: 'Keep it', type: 'flavor', effect: () => { state.gold++; log("Finders keepers. (+1g)"); } },
                { text: 'Donate', type: 'flavor', effect: () => { modRep('piety', 2); log("The gods see your kindness."); } }
            ])
        ],
        Teen: [
            createEvent('teen_1', 'First Crush', 'You catch someone looking at you.', [
                { text: 'Wink', type: 'check', stat: 'cha', dc: 12, success: 'They blush. (+Romance)', fail: 'You have something in your eye?', onSuccess: () => createRandomRel(30), onFail: () => { modSanity(-1); addTrait('Flushed Cheeks'); } },
                { text: 'Ignore', type: 'flavor', effect: () => log("Focus on your studies.") }
            ]),
            createEvent('teen_2', 'The Dare', 'Jump across the river!', [
                { text: 'Jump', type: 'check', stat: 'dex', dc: 14, success: 'Perfect landing! (+1 DEX)', fail: 'Splash. Soaked and cold.', onSuccess: () => state.stats.dex++, onFail: () => { takeDamage(1); modSanity(-1); } },
                { text: 'No way', type: 'flavor', effect: () => log("Cowardice is better than hypothermia.") }
            ]),
            createEvent('teen_3', 'Apprenticeship', 'The Smith needs help with the bellows.', [
                { text: 'Work hard', type: 'check', stat: 'con', dc: 12, success: 'Muscles ache, pockets heavy. (+5g)', fail: 'You pass out from heat.', onSuccess: () => { state.gold+=5; state.stats.str++; addTrait('Sooty Skin'); }, onFail: () => takeDamage(2) }
            ]),
            createEvent('teen_4', 'Rebellion', 'Your parents forbid you from the festival.', [
                { text: 'Sneak out', type: 'check', stat: 'dex', dc: 12, success: 'Best night ever! (+Sanity)', fail: 'Caught! Grounded.', onSuccess: () => modSanity(2), onFail: () => modRep('honor', -2) },
                { text: 'Obey', type: 'flavor', effect: () => { modRep('honor', 2); log("You stay home and sulk."); } }
            ]),
            createEvent('teen_5', 'Bad Crowd', 'Some delinquents invite you to steal.', [
                { text: 'Join in', type: 'check', stat: 'dex', dc: 14, success: 'You snag a purse. (+10g, +Infamy)', fail: 'Guards!', onSuccess: () => { state.gold+=10; modRep('infamy', 5); addTrait('Shifty Look'); }, onFail: () => { takeDamage(5); modRep('infamy', 5); } },
                { text: 'Refuse', type: 'flavor', effect: () => log("You walk away.") }
            ])
        ],
        Adult: [
            createEvent('adult_1', 'Business Opportunity', 'A merchant offers a risky investment.', [
                { text: 'Invest 50g', type: 'check', stat: 'int', dc: 14, req: s => s.gold >= 50, success: 'Returns are high! (+100g)', fail: 'It was a scam.', onSuccess: () => { state.gold+=100; addTrait('Fine Clothes'); }, onFail: () => { state.gold-=50; addTrait('Worn Boots'); } },
                { text: 'Decline', type: 'flavor', effect: () => log("Safe money is good money.") }
            ]),
            createEvent('adult_2', 'Tavern Brawl', 'A drunkard swings a stool at you!', [
                { text: 'Dodge', type: 'check', stat: 'dex', dc: 14, success: 'You weave effortlessly.', fail: 'Bonk. (-HP)', onSuccess: () => state.stats.dex++, onFail: () => { takeDamage(5); addTrait('Crooked Nose'); } },
                { text: 'Punch', type: 'check', stat: 'str', dc: 12, success: 'Knockout!', fail: 'You break your hand.', onSuccess: () => { modRep('renown', 2); addTrait('Scar: Knuckles'); }, onFail: () => { takeDamage(3); addTrait('Broken Hand'); } }
            ]),
            createEvent('adult_3', 'The Beggar', 'An old veteran asks for alms.', [
                { text: 'Give 5g', type: 'flavor', req: s => s.gold >= 5, effect: () => { state.gold-=5; modRep('piety', 5); modRep('honor', 2); log("He blesses you."); } },
                { text: 'Ignore', type: 'flavor', effect: () => log("You walk past.") }
            ]),
            createEvent('adult_4', 'Hard Times', 'Famine strikes the land.', [
                { text: 'Endure', type: 'check', stat: 'con', dc: 14, success: 'You survive on scraps.', fail: 'You grow weak. (-1 CON)', onSuccess: () => {}, onFail: () => { state.stats.con--; takeDamage(5); addTrait('Gaunt Face'); } },
                { text: 'Buy Food (20g)', type: 'flavor', req: s => s.gold >= 20, effect: () => { state.gold-=20; log("You eat well while others starve."); addTrait('Well-Fed'); } }
            ]),
            createEvent('adult_5', 'Strange Artifact', 'You find a glowing stone.', [
                { text: 'Touch it', type: 'check', stat: 'wis', dc: 15, success: 'Arcane knowledge flows into you. (+1 INT, +1 WIS)', fail: 'It burns your mind! (-Sanity)', onSuccess: () => { state.stats.int++; state.stats.wis++; addTrait('Far-Off Gaze'); }, onFail: () => { modSanity(-5); addTrait('Muttering'); } },
                { text: 'Sell it', type: 'flavor', effect: () => { state.gold+=50; log("A wizard bought it eagerly."); } }
            ])
        ],
        Elder: [
            createEvent('elder_1', 'Bad Back', 'Getting out of bed is a struggle.', [
                { text: 'Stretch', type: 'check', stat: 'dex', dc: 12, success: 'You pop it back in place.', fail: 'Ouch. (-HP)', onSuccess: () => {}, onFail: () => { takeDamage(2); addTrait('Stooped Posture'); } },
                { text: 'Rest', type: 'flavor', effect: () => log("You stay in bed today.") }
            ]),
            createEvent('elder_2', 'The Youth', 'Kids are playing on your lawn.', [
                { text: 'Yell', type: 'check', stat: 'cha', dc: 12, success: 'They scatter!', fail: 'They laugh at you.', onSuccess: () => {}, onFail: () => modSanity(-1) },
                { text: 'Tell Story', type: 'check', stat: 'cha', dc: 14, success: 'They listen, wide-eyed. (+Renown)', fail: 'You forget the point.', onSuccess: () => modRep('renown', 5), onFail: () => {} }
            ]),
            createEvent('elder_3', 'Legacy', 'You consider your life\'s work.', [
                { text: 'Write Memoirs', type: 'check', stat: 'int', dc: 14, success: 'A bestseller! (+Renown, +Gold)', fail: 'Ink blotches everywhere.', onSuccess: () => { modRep('renown', 10); state.gold+=20; addTrait('Ink-Stained Hands'); }, onFail: () => {} }
            ]),
            createEvent('elder_4', 'Sickness', 'A winter cough settles deep.', [
                { text: 'Resist', type: 'check', stat: 'con', dc: 14, success: 'You are tough as old leather.', fail: 'You are frail. (-HP)', onSuccess: () => {}, onFail: () => { takeDamage(5); addTrait('Pale Skin'); } }
            ]),
            createEvent('elder_5', 'Wisdom', 'The village council asks your advice.', [
                { text: 'Advise', type: 'check', stat: 'wis', dc: 12, success: 'They nod in agreement. (+Renown)', fail: 'You ramble about turnips.', onSuccess: () => modRep('renown', 5), onFail: () => {} }
            ])
        ],
        Permission: [
            createEvent('perm_ask', 'Permission to Leave', 'You wish to travel, but you are young.', [
                { text: 'Ask Parents', type: 'check', stat: 'cha', dc: 12, success: 'They agree to let you go. The family moves with you.', fail: 'They forbid it.', 
                  onSuccess: () => { 
                      state.flags.travelAllowed = true; 
                      // Move parents
                      state.relationships.forEach(r => {
                         if((r.relation === 'Father' || r.relation === 'Mother') && r.locationIndex === state.location) {
                             r.locationIndex = state.travelTarget;
                         }
                      });
                      travelTo(state.travelTarget); 
                  }, 
                  onFail: () => {} 
                },
                { text: 'Run Away', type: 'check', stat: 'dex', dc: 14, success: 'You slip away in the night.', fail: 'Caught! You are grounded.', onSuccess: () => { state.flags.travelAllowed = true; travelTo(state.travelTarget); modSanity(-2); }, onFail: () => { modRep('honor', -5); } },
                { text: 'Stay', type: 'flavor', effect: () => log("You decide to wait.") }
            ])
        ],
        // NEW: Health Complications for Old Age
        HealthIssues: [
            createEvent('health_heart', 'Fluttering Heart', 'Your chest tightens painfully as you climb the stairs.', [
                { text: 'Catch Breath', type: 'check', stat: 'con', dc: 15, success: 'The pain passes, leaving you shaken.', fail: 'You collapse. Your heart is permanently weakened. (-3 Max HP)', onSuccess: () => {}, onFail: () => { state.maxHealth = Math.max(1, state.maxHealth - 3); state.health = Math.min(state.health, state.maxHealth); log("Your vitality fades."); } },
                { text: 'Call Healer (50g)', type: 'flavor', req: s => s.gold >= 50, effect: () => { state.gold -= 50; log("The bitter medicine settles your heart. You survive."); } }
            ]),
            createEvent('health_fever', 'The Grey Fever', 'A cold sweat grips you in the night. It feels like winter in your veins.', [
                { text: 'Endure', type: 'check', stat: 'con', dc: 16, success: 'You sweat it out over three days.', fail: 'It settles deep in your lungs. (-1 CON, -5 HP)', onSuccess: () => {}, onFail: () => { state.stats.con = Math.max(3, state.stats.con - 1); takeDamage(5); } }
            ]),
            createEvent('health_joints', 'Crippling Arthritis', 'Your joints lock up in the cold damp of morning.', [
                { text: 'Force Movement', type: 'check', stat: 'str', dc: 14, success: 'You push through the agony.', fail: 'You cannot move. You lose flexibility. (-1 DEX)', onSuccess: () => {}, onFail: () => { state.stats.dex = Math.max(3, state.stats.dex - 1); log("You are less agile now."); } },
                { text: 'Bed Rest', type: 'flavor', effect: () => { log("You spend the year in a chair, watching the world go by."); } } 
            ]),
            createEvent('health_stroke', 'Sudden Darkness', 'The world spins violently and vision fades.', [
                { text: 'Hold On', type: 'check', stat: 'con', dc: 18, success: 'You regain your senses, terrified.', fail: 'DEATH CALLS.', onSuccess: () => { modSanity(-2); }, onFail: () => { takeDamage(100); } }
            ]),
            createEvent('health_memory', 'Fading Mind', 'You wake up and do not recognize the room.', [
                { text: 'Focus', type: 'check', stat: 'int', dc: 15, success: 'The fog lifts.', fail: 'Who are you? (-1 INT, -1 WIS)', onSuccess: () => {}, onFail: () => { state.stats.int = Math.max(3, state.stats.int - 1); state.stats.wis = Math.max(3, state.stats.wis - 1); modSanity(-3); } }
            ])
        ],
        LordInteraction: [
            createEvent('lord_meet', 'Audience with the Lord', 'You stand before the ruler of the city.', [
                { text: 'Pay Respects', type: 'check', stat: 'cha', dc: 10, success: 'The Lord nods. (+Renown)', fail: 'You stumble on your words.', onSuccess: () => modRep('renown', 5), onFail: () => {} },
                { text: 'Petition for Title (500g)', type: 'flavor', req: (s) => s.socialClass === 'Commoner' && s.gold >= 500, effect: () => { renderEvent(POOLS.TitleChallenge[0]); } }
            ])
        ],
        TitleChallenge: [
            createEvent('title_trial', 'The Trial of Nobility', 'To rise above your station, you must prove your worth.', [
                { text: 'Combat Tournament', type: 'check', stat: 'str', dc: 18, success: 'You defeat the champion! You are ennobled.', fail: 'You are defeated and humiliated.', onSuccess: () => ennoblePlayer(), onFail: () => { takeDamage(10); modRep('infamy', 5); } },
                { text: 'Silver Tongue', type: 'check', stat: 'cha', dc: 22, success: 'Your words weave a spell. You are ennobled.', fail: 'The court laughs at your presumption.', onSuccess: () => ennoblePlayer(), onFail: () => modRep('infamy', 5) }
            ])
        ],
        JobInterview: [], // Populated dynamically,
        Canon: [], // Populated later or empty
        Travel: [createEvent('travel_bandit', 'Roadside Ambush', 'Bandits block the path.', [{ text: 'Fight', type: 'check', stat: 'str', dc: 12, success: 'You clear the road.', fail: 'They beat you and take gold.', onSuccess: () => modRep('renown', 2), onFail: () => { takeDamage(5); state.gold = Math.max(0, state.gold - 10); } }, { text: 'Pay Toll (5g)', type: 'flavor', req: (s) => s.gold >= 5, effect: () => { state.gold -= 5; log("Safe but poorer."); } }])],
        Quest: [createEvent('quest_monster', 'The Beast', 'A monster plagues the local farms.', [{ text: 'Slay it', type: 'check', stat: 'str', dc: 15, success: 'The beast falls! (+Renown, +50g)', fail: 'It mauls you.', onSuccess: () => { modRep('renown', 10); state.gold += 50; }, onFail: () => takeDamage(10) }, { text: 'Track it', type: 'check', stat: 'wis', dc: 14, success: 'You find its lair and loot it. (+30g)', fail: 'You get lost.', onSuccess: () => state.gold += 30, onFail: () => {} }])],
        Crime: [createEvent('crime_heist', 'Manor Heist', 'A noble villa is unguarded.', [{ text: 'Rob it', type: 'check', stat: 'dex', dc: 16, success: 'Jackpot! (+100g, +Infamy)', fail: 'Guards! (-HP, Jail)', onSuccess: () => { state.gold += 100; modRep('infamy', 10); }, onFail: () => { takeDamage(10); modRep('infamy', 5); } }])],
        SocialFail: [createEvent('fail_social', 'Empty Streets', 'You wander the market but meet no one of interest.', [{ text: 'Go home', type: 'flavor', effect: () => log("A quiet day.") }]), createEvent('fail_love', 'Cold Shoulder', 'Your attempts at courtship are met with polite refusal.', [{ text: 'Try again later', type: 'flavor', effect: () => log("There are other fish in the sea.") }])],
        Interactive: [createEvent('inter_bump', 'A Chance Encounter', 'You bump into a stranger carrying a heavy load.', [{ text: 'Help them', type: 'check', stat: 'str', dc: 10, success: 'They thank you profusely. (+Friendship)', fail: 'You drop it. They yell at you.', onSuccess: () => createRandomRel(20), onFail: () => {} }, { text: 'Walk away', type: 'flavor', effect: () => log("Not your problem.") }])],
        Jeopardy: [createEvent('sanity_break', 'Mental Snap', 'The pressure is too much. Reality bends.', [{ text: 'Scream', type: 'flavor', effect: () => { modSanity(-2); log("You lose yourself for a moment."); } }]), createEvent('sanity_visions', 'Dark Visions', 'Shadows whisper your name.', [{ text: 'Pray', type: 'check', stat: 'wis', dc: 12, success: 'The voices fade.', fail: 'They scream louder. (-1 SP)', onSuccess: () => modSanity(1), onFail: () => modSanity(-1) }]), createEvent('sanity_final', 'Mental Break', 'Your mind shatters under the strain of existence.', [{ text: 'Hold it together', type: 'check', stat: 'wis', dc: 15, success: 'You claw back your sanity from the brink. (+1 SP)', fail: 'Your mind snaps. Massive shock. (-20 HP)', onSuccess: () => modSanity(1), onFail: () => { takeDamage(20); modSanity(-2); } }])]
    };
    
    // Add missing pools referenced in code if any...
    // Note: To save space, using existing pools logic.
    POOLS.Childhood = POOLS.Infancy; // Fallback for brevity in this response, ideally fill with real data from previous artifact
    

    // 6. LOGIC & ENGINE
    function init() {
        rerollStats();
        document.querySelector('.header').style.opacity = 0;
        document.querySelector('.main-layout').style.opacity = 0;
        document.getElementById('char-name').addEventListener('input', checkReady);
    }

    function checkAge(minAge) {
        if(state.age < minAge) {
            document.getElementById('age-warning-text').innerText = `You must be at least ${minAge} years old to do this.`;
            document.getElementById('age-modal').classList.remove('hidden');
            return false;
        }
        return true;
    }

    // --- NEW: UI HELPERS (Fix for Popups) ---
    function showMsg(title, text) {
        document.getElementById('msg-title').innerText = title;
        document.getElementById('msg-text').innerText = text;
        document.getElementById('msg-modal').classList.remove('hidden');
    }

    function showConfirm(text, onConfirm) {
        document.getElementById('confirm-text').innerText = text;
        const yesBtn = document.getElementById('confirm-yes-btn');
        // Clone to strip old event listeners to prevent stacking calls
        const newBtn = yesBtn.cloneNode(true);
        yesBtn.parentNode.replaceChild(newBtn, yesBtn);
        
        newBtn.onclick = () => {
            closeConfirm();
            onConfirm();
        };
        
        document.getElementById('confirm-modal').classList.remove('hidden');
    }

    function closeConfirm() {
        document.getElementById('confirm-modal').classList.add('hidden');
    }

    function rerollStats() {
        const standardArray = [15, 14, 13, 12, 10, 8];
        for (let i = standardArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [standardArray[i], standardArray[j]] = [standardArray[j], standardArray[i]];
        }
        let i = 0;
        for (let key in state.stats) state.stats[key] = standardArray[i++];
        renderCreationStats();
    }

    function renderCreationStats() {
        const container = document.getElementById('creation-stats');
        container.innerHTML = '';
        for (let key in state.stats) {
            const val = state.stats[key];
            container.innerHTML += `
                <div class="bg-white/50 p-2 rounded text-center border border-[#5d4037]">
                    <div class="text-xs uppercase font-bold">${key}</div>
                    <div class="text-xl font-medieval">${val}</div>
                    <div class="text-xs text-gray-600">${formatMod(getModifier(val))}</div>
                </div>`;
        }
    }

    function setGender(g) {
        state.gender = g;
        document.getElementById('gender-m').style.opacity = g === 'Male' ? 1 : 0.6;
        document.getElementById('gender-f').style.opacity = g === 'Female' ? 1 : 0.6;
        document.getElementById('gender-m').style.border = g === 'Male' ? '2px solid gold' : '2px solid #2c1e16';
        document.getElementById('gender-f').style.border = g === 'Female' ? '2px solid gold' : '2px solid #2c1e16';
        checkReady();
    }

    function setOrigin(origin) {
        state.flags.startOrigin = origin;
        document.getElementById('origin-commoner').classList.remove('active-opt');
        document.getElementById('origin-house').classList.remove('active-opt');
        document.getElementById('origin-commoner').classList.add('opacity-60');
        document.getElementById('origin-house').classList.add('opacity-60');
        
        if(origin === 'Commoner') {
            document.getElementById('origin-commoner').classList.add('active-opt');
            document.getElementById('origin-commoner').classList.remove('opacity-60');
        } else {
            document.getElementById('origin-house').classList.add('active-opt');
            document.getElementById('origin-house').classList.remove('opacity-60');
        }
    }

    function checkReady() {
        document.getElementById('start-btn').disabled = document.getElementById('char-name').value.length === 0;
    }

    function getRandomName(gender) {
        const list = gender === 'Male' ? NPC_NAMES.m : NPC_NAMES.f;
        return list[Math.floor(Math.random() * list.length)];
    }

    // Helper to add parents with death chance
    function tryAddParent(relation, gender, rank, locIndex, age) {
        const roll = Math.random();
        // Force parents to exist for genetic purposes if possible, but mark as dead if roll fails
        const name = getRandomName(gender);
        // CHANGED: isBlood is now true for parents
        const parent = addRelationship(name, relation, 80 + Math.floor(Math.random()*20), gender, rank, locIndex, true, true, age);
        
        if (roll < 0.1) {
            parent.health = "Deceased";
            // log(`Your ${relation} passed before your memory begins.`);
        }
        return parent;
    }

    function generateHouse() {
        let locIndex = state.location; // Use local var to track potential updates
        
        // AGE GENERATION LOGIC
        const fatherAge = 20 + Math.floor(Math.random() * 21);
        const motherAge = 18 + Math.floor(Math.random() * 21);
        const gpAge = Math.max(fatherAge, motherAge) + 20 + Math.floor(Math.random() * 21);
        
        let houseNameForGenes = null;
        
        if (state.flags.startOrigin === 'Commoner') {
            state.socialClass = "Commoner";
            state.house = null;
            state.class = "Commoner";
            // Parents MUST be created to have genes
            const dad = tryAddParent("Father", "Male", "Commoner", locIndex, fatherAge);
            const mom = tryAddParent("Mother", "Female", "Commoner", locIndex, motherAge);
            
            // SIBLING GENERATION (0-3)
            const numSiblings = Math.floor(Math.random() * 4);
            for(let i=0; i < numSiblings; i++) {
                const gen = Math.random() > 0.5 ? 'Male' : 'Female';
                const sibAge = Math.max(1, Math.floor(Math.random() * 15));
                const sib = addRelationship(getRandomName(gen), "Sibling", 50, gen, "Commoner", locIndex, true, true, sibAge);
                // Siblings inherit from parents
                sib.appearance = GeneticEngine.mix(dad, mom);
            }
            return;
        }

        // NOBLE HOUSE GENERATION
        state.socialClass = "House";
        
        const tierRoll = Math.random();
        let tierKey = 'lesser';
        if (tierRoll > 0.99) tierKey = 'royal';
        else if (tierRoll > 0.90) tierKey = 'greater';
        
        const tierData = TIER_DATA[tierKey];
        const names = HOUSE_NAMES[tierKey];
        const houseName = names[Math.floor(Math.random() * names.length)];
        
        // --- GREATER HOUSE LOCATION COMMITMENT ---
        // If we picked a major house, ensure we are born in their city
        if (tierKey === 'royal' || tierKey === 'greater') {
            const properCityIndex = CITIES.findIndex(c => c.ruler.includes(houseName));
            if (properCityIndex !== -1) {
                state.location = properCityIndex;
                locIndex = properCityIndex;
            }
        }

        // Set house name for gene generation to force phenotype
        houseNameForGenes = houseName;

        let houseDetails = {};
        if (tierKey !== 'lesser' && GREATER_HOUSES_INFO[houseName]) {
            houseDetails = GREATER_HOUSES_INFO[houseName];
            houseDetails.holding = GREATER_HOUSES_INFO[houseName].holding;
            houseDetails.holdingDesc = GREATER_HOUSES_INFO[houseName].holdingDesc;
        } else {
            const prefix = HOLDING_PREFIXES[Math.floor(Math.random() * HOLDING_PREFIXES.length)];
            houseDetails = {
                motto: LESSER_MOTTOS[Math.floor(Math.random() * LESSER_MOTTOS.length)],
                desc: "A lesser noble house striving for glory.",
                heirloom: "Old Shield",
                sigil: tierData.sigils[Math.floor(Math.random() * tierData.sigils.length)],
                holding: `${prefix} ${houseName}`,
                holdingDesc: "A sturdy manor house overseeing the surrounding lands."
            };
        }
        
        const rankRoll = Math.random();
        let rank = "House Member";
        if (rankRoll > 0.95) rank = "Heir";
        else if (rankRoll > 0.70) rank = "Younger Child";

        // NEW: Select House Trait from Phenotypes or Mutations
        let potentialTraits = [];
        if (HOUSE_PHENOTYPES[houseName]) {
            potentialTraits.push(`${HOUSE_PHENOTYPES[houseName].hair} Hair`);
            potentialTraits.push(`${HOUSE_PHENOTYPES[houseName].eyes} Eyes`);
        } else {
            // Random cosmetic feature for random houses
            potentialTraits.push(`${COSMETICS.hair[Math.floor(Math.random() * COSMETICS.hair.length)]} Hair`);
            potentialTraits.push(`${COSMETICS.eyes[Math.floor(Math.random() * COSMETICS.eyes.length)]} Eyes`);
        }
        // Add mutations to the pool
        potentialTraits = potentialTraits.concat(MUTATION_POOL.filter(m => m.rarity !== 'Common').map(m => m.name));
        
        const houseTrait = potentialTraits[Math.floor(Math.random() * potentialTraits.length)];

        state.house = {
            tier: tierData.name,
            name: houseName,
            sigil: houseDetails.sigil,
            motto: houseDetails.motto,
            desc: houseDetails.desc,
            heirloom: houseDetails.heirloom,
            holding: houseDetails.holding,
            holdingDesc: houseDetails.holdingDesc,
            treasury: tierData.startGold,
            trait: houseTrait,
            members: []
        };
        
        state.class = `${rank} of House ${houseName}`;

        // -- EXTENDED FAMILY GENERATION --
        // FORCE HOUSE TRAIT ON FOUNDER (Grandfather)
        
        const grandpa = addRelationship(getRandomName('Male'), "Grandfather", 60, "Male", "Lord Emeritus", locIndex, true, true, gpAge + 2);
        grandpa.appearance = GeneticEngine.generate(houseNameForGenes, houseTrait); 
        addHouseMember(grandpa.name, 'Male', 'Lord Emeritus', locIndex, grandpa.id);

        const grandma = addRelationship(getRandomName('Female'), "Grandmother", 60, "Female", "Dowager Lady", locIndex, false, true, gpAge);
        // Grandma marries in, usually random
        grandma.appearance = GeneticEngine.generate(); 
        addHouseMember(grandma.name, 'Female', 'Dowager Lady', locIndex, grandma.id);

        const father = addRelationship(getRandomName('Male'), "Father", 80, "Male", "Lord", locIndex, true, true, fatherAge);
        father.appearance = GeneticEngine.mix(grandpa, grandma); // Inherits (High chance due to engine update)
        addHouseMember(father.name, 'Male', 'Lord', locIndex, father.id);

        const mother = addRelationship(getRandomName('Female'), "Mother", 80, "Female", "Lady", locIndex, false, true, motherAge);
        mother.appearance = GeneticEngine.generate(); // Married in
        addHouseMember(mother.name, 'Female', 'Lady', locIndex, mother.id);

        // UNCLE/AUNT & COUSIN GENERATION
        const numUncles = Math.floor(Math.random() * 3);
        for(let i=0; i < numUncles; i++) {
            const isUncle = Math.random() > 0.5;
            const uaGen = isUncle ? 'Male' : 'Female';
            const uaRel = isUncle ? 'Uncle' : 'Aunt';
            const uaAge = fatherAge + Math.floor(Math.random() * 10) - 5;
            const ua = addRelationship(getRandomName(uaGen), uaRel, 50, uaGen, "House Member", locIndex, true, true, uaAge);
            ua.appearance = GeneticEngine.mix(grandpa, grandma); // Siblings of father
            addHouseMember(ua.name, ua.gender, "House Member", locIndex, ua.id);

            // Generate Cousins for this Uncle/Aunt
            if (Math.random() > 0.3) { 
                const numCousins = Math.floor(Math.random() * 3) + 1;
                for(let j=0; j<numCousins; j++) {
                    const cGen = Math.random() > 0.5 ? 'Male' : 'Female';
                    const cAge = Math.max(1, uaAge - (18 + Math.floor(Math.random()*10)));
                    const cousin = addRelationship(getRandomName(cGen), "Cousin", 40, cGen, "House Member", locIndex, true, true, cAge);
                    const spouseDummy = { appearance: GeneticEngine.generate() };
                    cousin.appearance = GeneticEngine.mix(ua, spouseDummy); // Inherit from Uncle/Aunt
                    addHouseMember(cousin.name, cGen, "House Member", locIndex, cousin.id);
                }
            }
        }

        addHouseMember(state.name, state.gender, rank, state.location, "PLAYER"); 
        
        // SIBLING GENERATION (0-3)
        const numSiblings = Math.floor(Math.random() * 4);
        for(let i=0; i < numSiblings; i++) {
            const sibGender = Math.random() > 0.5 ? 'Male' : 'Female';
            const sibAge = Math.floor(Math.random() * 10) + 1;
            const sib = addRelationship(getRandomName(sibGender), "Sibling", 80, sibGender, "House Member", state.location, true, true, sibAge);
            sib.appearance = GeneticEngine.mix(father, mother); // Inherit from parents
            addHouseMember(sib.name, sib.gender, sib.rank, sib.locationIndex, sib.id);
        }
    }

    function checkInheritance() {
        if (!state.house || !state.house.members) return;

        let ruler = state.house.members.find(m => 
            (m.rank === 'Lord' || m.rank === 'Lady' || m.rank === 'King' || m.rank === 'Queen')
        );

        if (!ruler) return; 

        let rulerIsDead = false;

        if (ruler.id === 'PLAYER') {
            if (state.health <= 0) rulerIsDead = true; 
        } else {
            const rel = state.relationships.find(r => r.id === ruler.id);
            if (rel && rel.health === 'Deceased') rulerIsDead = true;
        }

        if (rulerIsDead) {
            ruler.rank = ruler.gender === 'Male' ? 'Lord Emeritus' : 'Dowager Lady';
            if (ruler.id !== 'PLAYER') {
                log(`<strong style="color:var(--royal)">SUCCESSION:</strong> ${ruler.name} has passed. The House looks to the Heir.`);
            }

            let heir = state.house.members.find(m => m.rank === 'Heir');
            
            if (heir) {
                const newRank = heir.gender === 'Male' ? 'Lord' : 'Lady'; 
                heir.rank = newRank;
                
                if (heir.id === 'PLAYER') {
                    state.class = `${newRank} of House ${state.house.name}`;
                    log(`<strong style="color:var(--gold)">ASCENSION:</strong> You are now the ${newRank} of House ${state.house.name}!`);
                    modRep('renown', 50);
                } else {
                    log(`${heir.name} ascends as the new ${newRank} of House ${state.house.name}.`);
                    const heirRel = state.relationships.find(r => r.id === heir.id);
                    if (heirRel) heirRel.rank = newRank;
                }
            } else {
                log("The line of succession is broken. The House falls into chaos.");
                state.house.treasury = Math.floor(state.house.treasury / 2);
            }
            updateUI();
        }
    }

    function createLesserHouseForPlayer() {
        const tierData = TIER_DATA['lesser'];
        const names = HOUSE_NAMES['lesser'];
        const houseName = names[Math.floor(Math.random() * names.length)];
        const prefix = HOLDING_PREFIXES[Math.floor(Math.random() * HOLDING_PREFIXES.length)];
        const houseDetails = {
             motto: "Bought with Blood", // Default for ennobled commoners
             desc: "A newly risen house.",
             heirloom: "Gilded Sword",
             sigil: tierData.sigils[Math.floor(Math.random() * tierData.sigils.length)],
             holding: `${prefix} ${houseName}`,
             holdingDesc: "A modest fortification recently acquired."
        };

        // NEW: Select House Trait from Mutations for player created houses
        const validMutations = MUTATION_POOL.filter(m => m.rarity !== 'Common');
        const houseTrait = validMutations[Math.floor(Math.random() * validMutations.length)].name;

        state.house = {
            tier: tierData.name,
            name: houseName,
            sigil: houseDetails.sigil,
            motto: houseDetails.motto,
            desc: houseDetails.desc,
            heirloom: houseDetails.heirloom,
            holding: houseDetails.holding,
            holdingDesc: houseDetails.holdingDesc,
            treasury: tierData.startGold,
            trait: houseTrait,
            members: []
        };
        
        const rank = state.gender === 'Female' ? "Lady" : "Lord";
        state.class = `${rank} of House ${houseName}`;
        
        addHouseMember(state.name, state.gender, rank, state.location, "PLAYER");
        
        const sw = addRelationship(getRandomName('Male'), "Sworn Sword", 100, "Male", "Knight", state.location);
        addHouseMember(sw.name, sw.gender, "Sworn Sword", sw.locationIndex, sw.id);
    }
    
    function ennoblePlayer() {
        state.gold -= 500;
        state.socialClass = 'House';
        createLesserHouseForPlayer();
        log(`<strong style="color:var(--gold)">ENNOBLED:</strong> You are now a noble of House ${state.house.name}!`);
        updateUI();
    }

    function addHouseMember(name, gender, rank, locIndex, id) {
        state.house.members.push({
            name, gender, rank, locationIndex: locIndex, id: id || Math.random().toString(36).substr(2, 9)
        });
    }

    function addRelationship(name, relation, friendship, gender, rank, locIndex = null, isBlood = false, isFamily = false, specificAge = null) {
        const location = locIndex !== null ? locIndex : Math.floor(Math.random() * CITIES.length);
        
        // NEW: Job Selection Logic based on Rank/Class
        let careerKeys = Object.keys(CAREERS);
        const isNoble = rank.includes("Lord") || rank.includes("Lady") || rank.includes("Sir") || rank.includes("Dame") || rank === "House Member" || rank === "Heir";
        
        if (isNoble) {
            // Nobles get noble jobs
            careerKeys = ['knight', 'diplomat', 'merchant', 'scholar', 'clergy', 'military', 'alchemist', 'artist'];
        } else {
            // Peasants generally don't get noble exclusive jobs (though Merchant/Military/Clergy overlap)
            careerKeys = careerKeys.filter(k => k !== 'knight' && k !== 'diplomat' && k !== 'squire');
        }

        const rndJobKey = careerKeys[Math.floor(Math.random() * careerKeys.length)];
        const rndJob = CAREERS[rndJobKey].name;
        
        const rndStats = { 
            str: 8 + Math.floor(Math.random()*8),
            dex: 8 + Math.floor(Math.random()*8),
            con: 8 + Math.floor(Math.random()*8),
            int: 8 + Math.floor(Math.random()*8),
            wis: 8 + Math.floor(Math.random()*8),
            cha: 8 + Math.floor(Math.random()*8)
        };

        const hpVal = 10 + Math.floor((rndStats.con - 10) / 2);

        // NEW: Generate Standard Appearance
        const appearance = GeneticEngine.generate();

        const person = {
            id: Math.random().toString(36).substr(2, 9),
            name, relation, 
            friendship: friendship || 0, 
            romance: 0, 
            gender, rank, locationIndex: location,
            age: specificAge !== null ? specificAge : (18 + Math.floor(Math.random()*40)),
            health: "Healthy",
            hp: hpVal,
            maxHp: hpVal,
            occupation: rndJob,
            isBlood: isBlood,
            isFamily: isFamily,
            alignment: ALIGNMENTS[Math.floor(Math.random() * ALIGNMENTS.length)],
            stats: rndStats,
            appearance: appearance, // Store appearance
            genes: [], // Legacy
            traits: [] // Existing acquired traits
        };
        state.relationships.push(person);
        return person;
    }

    function createRandomRel(friendship) {
        const gender = Math.random() > 0.5 ? 'Male' : 'Female';
        const name = getRandomName(gender);
        addRelationship(name, "Acquaintance", friendship, gender, "Commoner", state.location);
        log(`You met ${name}.`);
    }

    function getParent(type) {
        if (!type) return state.relationships.find(r => r.relation === 'Father' || r.relation === 'Mother');
        return state.relationships.find(r => r.relation === type);
    }
    
    function hasParent(type) {
        return !!state.relationships.find(r => r.relation === type);
    }

    function startGame() {
        state.name = document.getElementById('char-name').value;
        state.location = Math.floor(Math.random() * CITIES.length);
        
        generateHouse(); 

        // --- NEW: GENETIC INHERITANCE FOR PLAYER ---
        const father = getParent('Father');
        const mother = getParent('Mother');
        
        // Apply genes
        state.appearance = GeneticEngine.mix(father, mother);
        
        // STATS NO LONGER MODIFIED BY GENES
        // Base stats are purely from the random roll/standard array
        
        const conMod = getModifier(state.stats.con);
        const wisMod = getModifier(state.stats.wis);
        const chaMod = getModifier(state.stats.cha);
        
        state.maxHealth = 10 + conMod;
        state.health = state.maxHealth;
        
        state.maxSanity = Math.max(1, 8 + wisMod + chaMod);
        state.sanity = state.maxSanity;

        document.getElementById('creation-screen').style.display = 'none';
        document.getElementById('lore-modal').classList.remove('hidden');
    }

    function enterWorld() {
        document.getElementById('lore-modal').classList.add('hidden');
        document.querySelector('.header').style.opacity = 1;
        document.querySelector('.main-layout').style.opacity = 1;
        document.getElementById('display-name').innerText = state.name;
        
        log(`<strong>Year ${state.year}:</strong> ${state.name} is born in <strong>${CITIES[state.location].name}</strong>.`);
        if (state.socialClass === 'House') {
            log(`You are born a ${state.class}. House Look: <strong style="color:var(--royal)">${state.appearance.hair} Hair, ${state.appearance.eyes} Eyes</strong>.`);
        } else {
            log(`You are born a free commoner.`);
        }
        
        generateMarket(state.location); // Initial Market Gen
        updateUI();
        processYear();
    }

    // --- NEW EVENT GENERATION SYSTEM ---
    function generateSocialEvent() {
        const livingKnown = state.relationships.filter(r => r.health !== 'Deceased');
        if (livingKnown.length === 0) return null;

        const person = livingKnown[Math.floor(Math.random() * livingKnown.length)];
        const isFriend = person.friendship > 20;
        const isEnemy = person.friendship < -20;
        const isLover = person.romance > 30;

        let type = 'neutral';
        if (isLover) type = 'lover';
        else if (isEnemy) type = 'enemy';
        else if (isFriend) type = 'friend';

        const pool = getSocialPool(person, type);
        return pool[Math.floor(Math.random() * pool.length)];
    }

    function getSocialPool(person, type) {
        // --- THE AGE OF INNOCENCE ---
        if (state.age < 13) {
            const childPools = {
                friend: [
                    createEvent(`kid_play_${person.id}`, `Playtime`, `${person.name} brings a wooden sword to play.`, [
                         { text: 'Duel!', type: 'check', stat: 'dex', dc: 10, success: 'You disarm them! (+1 DEX)', fail: 'They bonk you on the head.', onSuccess: () => { modRel(person.id, 5); state.stats.dex++; }, onFail: () => takeDamage(1) },
                         { text: 'Share Toy', type: 'flavor', effect: () => { modRel(person.id, 10); log("Sharing is caring."); } }
                    ]),
                    createEvent(`kid_secret_${person.id}`, `Secret Base`, `${person.name} shows you their hideout in the woods.`, [
                         { text: 'Keep Secret', type: 'check', stat: 'cha', dc: 8, success: 'Best friends forever.', fail: 'You blabbed to the adults.', onSuccess: () => modRel(person.id, 15), onFail: () => modRel(person.id, -10) }
                    ]),
                    createEvent(`kid_tag_${person.id}`, `Game of Tag`, `${person.name} yells "You're it!"`, [
                         { text: 'Chase', type: 'check', stat: 'dex', dc: 12, success: 'Caught them! (+1 DEX)', fail: 'They are too fast.', onSuccess: () => state.stats.dex++, onFail: () => {} }
                    ])
                ],
                enemy: [
                    createEvent(`kid_bully_${person.id}`, `Bully`, `${person.name} steals your lunch.`, [
                         { text: 'Tell Adult', type: 'check', stat: 'cha', dc: 12, success: 'They get in trouble.', fail: 'Tattletale!', onSuccess: () => modRel(person.id, -5), onFail: () => modRep('renown', -2) },
                         { text: 'Fight', type: 'check', stat: 'str', dc: 8, success: 'Pow! Right in the nose.', fail: 'Ouch. They hit back.', onSuccess: () => modRep('renown', 2), onFail: () => takeDamage(1) }
                    ]),
                    createEvent(`kid_mock_${person.id}`, `Name Calling`, `${person.name} calls you a "mud-eater".`, [
                         { text: 'Cry', type: 'flavor', effect: () => { log("Tears fall."); modSanity(-1); } },
                         { text: 'Throw Mud', type: 'check', stat: 'dex', dc: 10, success: 'Direct hit!', fail: 'You miss.', onSuccess: () => modRel(person.id, -5), onFail: () => {} }
                    ])
                ],
                neutral: [
                     createEvent(`kid_neutral_${person.id}`, `Lesson Time`, `You sit next to ${person.name} during lessons.`, [
                         { text: 'Copy Work', type: 'check', stat: 'int', dc: 10, success: 'Thanks! (+1 INT)', fail: 'Caught!', onSuccess: () => { modRel(person.id, 5); state.stats.int++; }, onFail: () => state.stats.int-- },
                         { text: 'Ignore', type: 'flavor', effect: () => log("You focus on your slate.") }
                     ]),
                     createEvent(`kid_bug_${person.id}`, `Cool Bug`, `${person.name} found a beetle.`, [
                         { text: 'Look', type: 'flavor', effect: () => { log("It is shiny."); modRel(person.id, 2); } }
                     ])
                ],
                lover: [] // Children map lovers to friends
            };
            // Fallback for kids
            if (type === 'lover') return childPools.friend;
            return childPools[type] || childPools.neutral;
        }

        // 10 Unique Events per archetype
        const pools = {
            lover: [
                createEvent(`lov_1_${person.id}`, `A Quiet Stroll`, `${person.name} asks to walk beneath the starlight.`, [
                    { text: 'Hold Hands', type: 'check', stat: 'cha', dc: 8, success: 'A tender moment. (+Romance, +Sanity)', fail: 'Your palms are sweaty.', onSuccess: () => { modRel(person.id, 5, 5); modSanity(1); }, onFail: () => modRel(person.id, 0, -1) },
                    { text: 'Recite Poetry', type: 'check', stat: 'int', dc: 12, success: 'They swoon at your words. (+Romance)', fail: 'You rhyme "love" with "turnip".', onSuccess: () => modRel(person.id, 5, 10), onFail: () => modRel(person.id, -2, -2) }
                ]),
                createEvent(`lov_2_${person.id}`, `The Gift`, `${person.name} eyes a merchant's necklace longing.`, [
                    { text: 'Buy it (20g)', type: 'flavor', req: s => s.gold >= 20, effect: () => { state.gold -= 20; modRel(person.id, 10, 20); log("Their eyes sparkle brighter than the gem."); } },
                    { text: 'Craft One', type: 'check', stat: 'dex', dc: 14, success: 'You make a beautiful charm from wood. (+Romance)', fail: 'It breaks immediately.', onSuccess: () => modRel(person.id, 5, 15), onFail: () => modRel(person.id, -2, -2) },
                    { text: 'Ignore', type: 'flavor', effect: () => { modRel(person.id, 0, -5); log("They look disappointed."); } }
                ]),
                createEvent(`lov_3_${person.id}`, `Midnight Quarrel`, `A misunderstanding with ${person.name} turns heated.`, [
                    { text: 'Apologize', type: 'check', stat: 'cha', dc: 10, success: 'Forgiveness is sweet. (+Sanity)', fail: 'They are still angry.', onSuccess: () => { modSanity(1); modRel(person.id, 2, 2); }, onFail: () => modRel(person.id, -5, -5) },
                    { text: 'Stand Ground', type: 'check', stat: 'wis', dc: 14, success: 'Logic prevails. They respect you.', fail: 'You sleep on the floor.', onSuccess: () => modRel(person.id, 5, 0), onFail: () => { modRel(person.id, -10, -10); modSanity(-1); } }
                ]),
                createEvent(`lov_4_${person.id}`, `Illness`, `${person.name} is bedridden with a fever.`, [
                    { text: 'Nurse them', type: 'check', stat: 'wis', dc: 12, success: 'Your care heals them. (+Deep Bond)', fail: 'You make the soup too salty.', onSuccess: () => modRel(person.id, 15, 10), onFail: () => modRel(person.id, 2, 0) },
                    { text: 'Hire Healer (15g)', type: 'flavor', req: s => s.gold >= 15, effect: () => { state.gold -= 15; modRel(person.id, 10, 5); log("They recover swiftly thanks to your coin."); } }
                ]),
                createEvent(`lov_5_${person.id}`, `Jealousy`, `Someone else was seen flirting with ${person.name}.`, [
                    { text: 'Trust them', type: 'check', stat: 'wis', dc: 10, success: 'Your confidence strengthens the bond.', fail: 'Doubts linger. (-Sanity)', onSuccess: () => { modRel(person.id, 5, 5); modSanity(1); }, onFail: () => modSanity(-1) },
                    { text: 'Confront Rival', type: 'check', stat: 'str', dc: 12, success: 'You scare the rival away. (+Renown)', fail: 'You make a scene.', onSuccess: () => modRep('renown', 5), onFail: () => { modRep('infamy', 2); modRel(person.id, -5, -5); } }
                ]),
                createEvent(`lov_6_${person.id}`, `Cooking Together`, `A chance to make a meal with ${person.name}.`, [
                    { text: 'Cook', type: 'check', stat: 'dex', dc: 12, success: 'A delicious feast! (+HP)', fail: 'You burn the roast.', onSuccess: () => { state.health = Math.min(state.maxHealth, state.health + 2); modRel(person.id, 5, 5); }, onFail: () => modRel(person.id, 0, -2) }
                ]),
                createEvent(`lov_7_${person.id}`, `The Future`, `${person.name} asks: "Where do you see us in ten years?"`, [
                    { text: 'Speak from Heart', type: 'check', stat: 'cha', dc: 12, success: 'They tear up with joy.', fail: 'You stutter awkwardly.', onSuccess: () => modRel(person.id, 10, 10), onFail: () => modRel(person.id, -2, -2) },
                    { text: 'Joke', type: 'flavor', effect: () => { modRel(person.id, 2, -5); log("They laugh, but eyes remain sad."); } }
                ]),
                createEvent(`lov_8_${person.id}`, `Romantic Surprise`, `You find a rare flower perfect for ${person.name}.`, [
                    { text: 'Give it', type: 'flavor', effect: () => { modRel(person.id, 5, 5); log("A simple gesture means the most."); } }
                ]),
                createEvent(`lov_9_${person.id}`, `Stargazing`, `The night sky is clear.`, [
                    { text: 'Identify Constellations', type: 'check', stat: 'int', dc: 14, success: 'You impress them with lore. (+1 INT)', fail: 'You make stuff up.', onSuccess: () => { state.stats.int++; modRel(person.id, 5, 5); }, onFail: () => {} }
                ]),
                createEvent(`lov_10_${person.id}`, `Public Affection`, `${person.name} kisses you in the busy market.`, [
                    { text: 'Kiss Back', type: 'check', stat: 'cha', dc: 10, success: 'Crowd cheers! (+Renown)', fail: 'You bump heads.', onSuccess: () => { modRep('renown', 2); modRel(person.id, 0, 5); }, onFail: () => modRep('infamy', 1) },
                    { text: 'Shy Away', type: 'flavor', effect: () => { modRel(person.id, 0, -5); log("They blush in embarrassment."); } }
                ])
            ],
            enemy: [
                createEvent(`eny_1_${person.id}`, `Public Slander`, `${person.name} is spreading lies about you!`, [
                    { text: 'Defend Honor', type: 'check', stat: 'cha', dc: 14, success: 'You turn the crowd against them. (+Renown)', fail: 'People believe the lies. (-Honor)', onSuccess: () => modRep('renown', 10), onFail: () => modRep('honor', -5) },
                    { text: 'Ignore', type: 'flavor', effect: () => { modRep('honor', -2); log("Silence is admission to some."); } }
                ]),
                createEvent(`eny_2_${person.id}`, `Alleyway Ambush`, `${person.name} jumps you with a club!`, [
                    { text: 'Fight Back', type: 'check', stat: 'str', dc: 13, success: 'You beat them senseless. (-Rel)', fail: 'Ouch! (-HP)', onSuccess: () => { modRel(person.id, -10); takeDamage(1); }, onFail: () => takeDamage(5) },
                    { text: 'Dodge', type: 'check', stat: 'dex', dc: 14, success: 'You escape unharmed.', fail: 'Too slow. (-HP)', onSuccess: () => {}, onFail: () => takeDamage(4) }
                ]),
                createEvent(`eny_3_${person.id}`, `Sabotage`, `You find your work tools damaged. You know it was ${person.name}.`, [
                    { text: 'Fix it', type: 'check', stat: 'dex', dc: 12, success: 'Good as new. (+1 DEX)', fail: 'You waste materials. (-5g)', onSuccess: () => state.stats.dex++, onFail: () => state.gold = Math.max(0, state.gold - 5) },
                    { text: 'Revenge', type: 'flavor', effect: () => { modRel(person.id, -20); log("You break their window in the night."); } }
                ]),
                createEvent(`eny_4_${person.id}`, `The Stare Down`, `You lock eyes with ${person.name} across the tavern.`, [
                    { text: 'Intimidate', type: 'check', stat: 'str', dc: 12, success: 'They look away first. (+Renown)', fail: 'They laugh at you. (-Renown)', onSuccess: () => modRep('renown', 2), onFail: () => modRep('renown', -2) },
                    { text: 'Buy them a drink', type: 'flavor', req: s => s.gold >= 2, effect: () => { state.gold -= 2; modRel(person.id, 5); log("A confused truce is formed."); } }
                ]),
                createEvent(`eny_5_${person.id}`, `Petty Theft`, `${person.name} bumps into you. Your purse feels lighter.`, [
                    { text: 'Catch them', type: 'check', stat: 'dex', dc: 14, success: 'You grab their wrist! (+Renown)', fail: 'They vanish with 5g.', onSuccess: () => { modRep('renown', 5); modRel(person.id, -10); }, onFail: () => { state.gold = Math.max(0, state.gold - 5); } }
                ]),
                createEvent(`eny_6_${person.id}`, `The Duel`, `${person.name} challenges you to a duel of honor!`, [
                    { text: 'Accept (Combat)', type: 'check', stat: 'str', dc: 15, success: 'Victory! (+Renown, +Honor)', fail: 'Defeat. (-HP, -Honor)', onSuccess: () => { modRep('renown', 10); modRep('honor', 10); }, onFail: () => { takeDamage(8); modRep('honor', -5); } },
                    { text: 'Refuse', type: 'flavor', effect: () => { modRep('honor', -10); log("Cowardice stains your name."); } }
                ]),
                createEvent(`eny_7_${person.id}`, `Mockery`, `${person.name} mimics your walk and voice.`, [
                    { text: 'Laugh with them', type: 'check', stat: 'cha', dc: 12, success: 'You disarm them with humor. (+Rel)', fail: 'It looks desperate.', onSuccess: () => modRel(person.id, 10), onFail: () => modSanity(-1) },
                    { text: 'Punch', type: 'check', stat: 'str', dc: 10, success: 'That shut them up.', fail: 'You miss.', onSuccess: () => modRel(person.id, -10), onFail: () => {} }
                ]),
                createEvent(`eny_8_${person.id}`, `Legal Trouble`, `${person.name} accuses you of a crime you didn't commit.`, [
                    { text: 'Argue Case', type: 'check', stat: 'int', dc: 13, success: 'The guard believes you.', fail: 'You pay a fine. (-10g)', onSuccess: () => {}, onFail: () => state.gold = Math.max(0, state.gold - 10) }
                ]),
                createEvent(`eny_9_${person.id}`, `Dark Rumors`, `You hear ${person.name} whispering to a dark figure.`, [
                    { text: 'Eavesdrop', type: 'check', stat: 'wis', dc: 14, success: 'You learn a secret! (+1 INT)', fail: 'They spot you.', onSuccess: () => state.stats.int++, onFail: () => modRel(person.id, -10) }
                ]),
                createEvent(`eny_10_${person.id}`, `Truce?`, `${person.name} looks tired. "Must we do this forever?"`, [
                    { text: 'Make Peace', type: 'check', stat: 'cha', dc: 10, success: 'The feud ends. (Reset Rel)', fail: 'It was a trap!', onSuccess: () => { const r = state.relationships.find(x=>x.id===person.id); if(r) r.friendship = 0; }, onFail: () => takeDamage(2) },
                    { text: 'Never', type: 'flavor', effect: () => log("The war continues.") }
                ])
            ],
            friend: [
                createEvent(`frn_1_${person.id}`, `Drinking Contest`, `${person.name} slams a tankard down. "Bet you can't outdrink me!"`, [
                    { text: 'Accept', type: 'check', stat: 'con', dc: 14, success: 'You drink them under the table! (+Renown)', fail: 'You blackout. (-2 HP)', onSuccess: () => { modRep('renown', 5); modRel(person.id, 5); }, onFail: () => takeDamage(2) },
                    { text: 'Decline', type: 'flavor', effect: () => log("You sip water sensibly.") }
                ]),
                createEvent(`frn_2_${person.id}`, `Need a Loan`, `${person.name} asks to borrow 10 gold.`, [
                    { text: 'Lend it', type: 'flavor', req: s => s.gold >= 10, effect: () => { state.gold -= 10; modRel(person.id, 15); log("They promise to pay it back."); } },
                    { text: 'Refuse', type: 'flavor', effect: () => { modRel(person.id, -5); log("They look dejected."); } }
                ]),
                createEvent(`frn_3_${person.id}`, `Sparring Partner`, `${person.name} wants to practice fighting.`, [
                    { text: 'Spar', type: 'check', stat: 'str', dc: 12, success: 'Good training. (+1 STR)', fail: 'You get bruised. (+1 CON)', onSuccess: () => state.stats.str++, onFail: () => state.stats.con++ }
                ]),
                createEvent(`frn_4_${person.id}`, `Confession`, `${person.name} confesses a dark secret to you.`, [
                    { text: 'Keep Secret', type: 'check', stat: 'wis', dc: 10, success: 'Your bond deepens.', fail: 'The burden weighs on you. (-Sanity)', onSuccess: () => modRel(person.id, 10), onFail: () => modSanity(-1) },
                    { text: 'Blackmail', type: 'flavor', effect: () => { modRel(person.id, -50); state.gold += 20; modRep('infamy', 10); log("You extorted 20g."); } }
                ]),
                createEvent(`frn_5_${person.id}`, `Adventure Hook`, `${person.name} found a map!`, [
                    { text: 'Go exploring', type: 'check', stat: 'wis', dc: 14, success: 'You find treasure! (+20g)', fail: 'You get lost in the woods.', onSuccess: () => state.gold += 20, onFail: () => {} }
                ]),
                createEvent(`frn_6_${person.id}`, `Matchmaking`, `${person.name} introduces you to their cousin.`, [
                    { text: 'Charm them', type: 'check', stat: 'cha', dc: 12, success: 'A new romance begins!', fail: 'Awkward.', onSuccess: () => { createRandomRel(20); const r = state.relationships[state.relationships.length-1]; r.romance = 20; }, onFail: () => {} }
                ]),
                createEvent(`frn_7_${person.id}`, `Gift Exchange`, `${person.name} hands you a wrapped bundle.`, [
                    { text: 'Open it', type: 'flavor', effect: () => { addItem('Wooden Flute', 'Common', 'A gift from a friend.', 5); modRel(person.id, 5); } }
                ]),
                createEvent(`frn_8_${person.id}`, `Religious Festival`, `${person.name} drags you to the temple.`, [
                    { text: 'Pray', type: 'check', stat: 'wis', dc: 10, success: 'You feel blessed. (+Piety, +Sanity)', fail: 'You fall asleep.', onSuccess: () => { modRep('piety', 5); modSanity(1); }, onFail: () => {} }
                ]),
                createEvent(`frn_9_${person.id}`, `Work Grievance`, `${person.name} complains about their boss for hours.`, [
                    { text: 'Listen', type: 'check', stat: 'con', dc: 12, success: 'You are a good listener. (+Rel)', fail: 'You snap at them.', onSuccess: () => modRel(person.id, 5), onFail: () => modRel(person.id, -5) }
                ]),
                createEvent(`frn_10_${person.id}`, `Dice Game`, `${person.name} takes out the dice.`, [
                    { text: 'Play (5g)', type: 'check', stat: 'int', dc: 12, req: s => s.gold >= 5, success: 'You win! (+5g)', fail: 'You lose. (-5g)', onSuccess: () => state.gold += 5, onFail: () => state.gold -= 5 }
                ])
            ],
            neutral: [
                createEvent(`neu_1_${person.id}`, `Bumping Shoulders`, `You collide with ${person.name} in the street.`, [
                    { text: 'Apologize', type: 'check', stat: 'cha', dc: 10, success: 'They nod politely.', fail: 'They grumble.', onSuccess: () => modRel(person.id, 2), onFail: () => modRel(person.id, -2) },
                    { text: 'Blame them', type: 'check', stat: 'str', dc: 12, success: 'They back off.', fail: 'Argument starts.', onSuccess: () => {}, onFail: () => modRel(person.id, -5) }
                ]),
                createEvent(`neu_2_${person.id}`, `Small Talk`, `${person.name} comments on the weather.`, [
                    { text: 'Chat', type: 'flavor', effect: () => { log("It is indeed a cloudy day."); modRel(person.id, 2); } }
                ]),
                createEvent(`neu_3_${person.id}`, `Dropped Item`, `${person.name} drops a handkerchief.`, [
                    { text: 'Return it', type: 'check', stat: 'dex', dc: 10, success: 'They thank you. (+Honor)', fail: 'You trip trying to pick it up.', onSuccess: () => { modRel(person.id, 5); modRep('honor', 2); }, onFail: () => {} },
                    { text: 'Steal it', type: 'flavor', effect: () => { addItem('Handkerchief', 'Common', 'Stolen.', 1); modRep('honor', -2); } }
                ]),
                createEvent(`neu_4_${person.id}`, `Market Haggle`, `You see ${person.name} selling apples.`, [
                    { text: 'Haggle', type: 'check', stat: 'cha', dc: 12, success: 'Good deal! (+1 HP)', fail: 'Full price.', onSuccess: () => { state.gold = Math.max(0, state.gold - 1); state.health++; }, onFail: () => state.gold = Math.max(0, state.gold - 2) }
                ]),
                createEvent(`neu_5_${person.id}`, `Ask Directions`, `You ask ${person.name} where the blacksmith is.`, [
                    { text: 'Ask', type: 'check', stat: 'int', dc: 10, success: 'Clear directions.', fail: 'You get lost.', onSuccess: () => {}, onFail: () => {} }
                ]),
                createEvent(`neu_6_${person.id}`, `News of the Realm`, `${person.name} has a newspaper.`, [
                    { text: 'Read over shoulder', type: 'check', stat: 'dex', dc: 12, success: 'You learn of the war. (+1 INT)', fail: 'They catch you.', onSuccess: () => state.stats.int++, onFail: () => modRel(person.id, -2) }
                ]),
                createEvent(`neu_7_${person.id}`, `Charity`, `${person.name} is collecting for the poor.`, [
                    { text: 'Give 1g', type: 'flavor', req: s => s.gold >= 1, effect: () => { state.gold -= 1; modRep('piety', 1); log("A small kindness."); } },
                    { text: 'Walk away', type: 'flavor', effect: () => log("Not today.") }
                ]),
                createEvent(`neu_8_${person.id}`, `Observation`, `You watch ${person.name} working.`, [
                    { text: 'Observe', type: 'check', stat: 'wis', dc: 12, success: 'You learn a trick of the trade. (+1 WIS)', fail: 'Boring.', onSuccess: () => state.stats.wis++, onFail: () => {} }
                ]),
                createEvent(`neu_9_${person.id}`, `Shared Grievance`, `You both wait in a long line.`, [
                    { text: 'Complain', type: 'check', stat: 'cha', dc: 10, success: 'You bond over the delay. (+Rel)', fail: 'They ignore you.', onSuccess: () => modRel(person.id, 5), onFail: () => {} }
                ]),
                createEvent(`neu_10_${person.id}`, `Fleeting Glance`, `${person.name} looks at you curiously.`, [
                    { text: 'Smile', type: 'check', stat: 'cha', dc: 10, success: 'They smile back. (+Rel)', fail: 'You have spinach in your teeth.', onSuccess: () => modRel(person.id, 5), onFail: () => modRel(person.id, -2) }
                ])
            ]
        };
        return pools[type] || pools['neutral'];
    }

    function processYear() {
        try {
            state.age++;
            state.year++;
            state.interactions = {}; 
            state.activityLog = { love: 0, quest: 0, crime: 0, train: 0, lord: 0 }; 
            state.rejectedJobs = []; // RESET JOB REJECTIONS
            state.flags.travelAllowed = false; 
            state.flags.traveledThisYear = false;
            state.eventQueue = []; 
            
            generateMarket(state.location); // REGENERATE MARKET EVERY YEAR

            state.maxHealth = 10 + getModifier(state.stats.con);
            state.health = Math.min(state.maxHealth, state.health + 5); 

            const spFlux = Math.floor(Math.random() * 3) - 1; 
            state.sanity = Math.min(state.maxSanity, Math.max(0, state.sanity + spFlux));
            
            const logEl = document.getElementById('event-log');
            const marker = document.createElement('div');
            marker.className = 'event-entry age-marker';
            marker.innerText = `Age ${state.age}`;
            logEl.appendChild(marker);

            try {
                simulateNPCs();
            } catch(e) { console.error("NPC Sim Error:", e); }

            if (state.house && state.house.members.length > 0) {
                try { checkInheritance(); } catch(e) { console.error("Inheritance Error:", e); }
            }

            document.getElementById('year-display').innerText = `Year ${state.year}`;
            document.getElementById('age-display').innerText = state.age;

            try { processOccupation(); } catch(e) { console.error("Job Error:", e); }
            checkUnlocks();

            // Update UI immediately so tabs (Market/Char) show new year data even before events resolve
            updateUI(); 

            // HEALTH COMPLICATION LOGIC (Player)
            if (state.age > 60) {
                // Risk increases by 2% per year after 60. 
                // Age 65: 10%. Age 75: 30%. Age 85: 50%.
                const risk = (state.age - 60) * 2; 
                const roll = Math.floor(Math.random() * 100);
                
                if (roll < risk) {
                    const healthPool = POOLS.HealthIssues;
                    const healthEvt = healthPool[Math.floor(Math.random() * healthPool.length)];
                    
                    // Health events take priority, pushed to front
                    state.eventQueue.unshift(healthEvt);
                    
                    // Visual warning
                    log(`<strong class="text-red-900">HEALTH CRISIS:</strong> Age takes its toll...`);
                }
            }

            const socialEvt = generateSocialEvent();
            if (socialEvt && state.age > 3) state.eventQueue.push(socialEvt);

            let pool = POOLS.Infancy;
            if (state.age >= 3) pool = POOLS.Childhood;
            if (state.age >= 12) pool = POOLS.Teen;
            if (state.age >= 18) pool = POOLS.Adult;
            if (state.age >= 65) pool = POOLS.Elder;
            
            if (state.sanity <= 2) {
                 state.eventQueue.push(POOLS.Jeopardy[2]); 
            } else if (state.sanity / state.maxSanity < 0.25) {
                log(`<strong class="text-purple-800">JEOPARDY:</strong> Your mind is fracturing...`);
                const jeoEvt = POOLS.Jeopardy[Math.floor(Math.random() * (POOLS.Jeopardy.length - 1))];
                state.eventQueue.push(jeoEvt);
            } else {
                // DUPLICATE WARD LOGIC
                const validEvents = pool.filter(e => !state.recentEvents.includes(e.id));
                // If we run out of fresh events, reset to full pool
                const finalPool = validEvents.length > 0 ? validEvents : pool;
                
                const ageEvt = finalPool[Math.floor(Math.random() * finalPool.length)];
                
                // Remember this event
                state.recentEvents.push(ageEvt.id);
                if(state.recentEvents.length > 8) state.recentEvents.shift(); // Keep last 8 unique

                state.eventQueue.push(ageEvt);
            }

            if (state.age > 5 && Math.random() < 0.15) {
                const canonEvt = POOLS.Canon[Math.floor(Math.random() * POOLS.Canon.length)];
                state.eventQueue.push(canonEvt);
            }

            processNextEvent();
        } catch(e) {
            console.error("Critical ProcessYear Failure:", e);
            log("Time marches on, though the records are blurry.");
        }
    }
    
    function simulateNPCs() {
        const logEl = document.getElementById('event-log');
        const jobs = Object.keys(CAREERS);
        
        state.relationships.forEach(r => {
            if(r.health === "Deceased") return;
            
            if (r.friendship > 0) r.friendship = Math.max(0, r.friendship - 5);
            if (r.romance > 0) r.romance = Math.max(0, r.romance - 10);
            
            r.age++;
            
            // Dynamic Death Chance for NPCs (Old Age)
            let deathChance = 0.005; // 0.5% base chance (accidents/sickness)
            
            if (r.age > 55) {
                // Curve starts gentle, gets steep
                // Age 60: ~1.5%
                // Age 70: ~3.5%
                // Age 80: ~5.5%
                // Age 90+: High risk
                deathChance += (r.age - 55) * 0.002; 
            }
            
            // Hard cap check for very old age (increasing rapidly after 80)
            if (r.age > 80) {
                deathChance += 0.10; // +10% flat risk per year after 80
            }

            if (Math.random() < deathChance) {
                r.health = "Deceased";
                
                // Flavor text for cause of death
                let cause = "passed away peacefully";
                if (r.age < 50) cause = "died of a sudden illness";
                else if (r.age > 80) cause = "succumbed to old age";
                
                log(`<span style="color:var(--failure)">‚Ä† ${r.name} (${r.relation}) has ${cause} at age ${r.age}.</span>`);
                
                if(r.friendship > 20 || r.isFamily) modSanity(-1);
                return; 
            }

            if (r.age > 16) {
                if (Math.random() < 0.05) {
                     const newJob = CAREERS[jobs[Math.floor(Math.random() * jobs.length)]].name;
                     r.occupation = newJob;
                }
            }
            
            // --- THE LIVING LINEAGE: MARRIAGE & CHILDREN ---
            if (['Sibling', 'Son', 'Daughter'].includes(r.relation) && r.health !== 'Deceased') {
                // Marriage Chance (18+, not married)
                if (r.age >= 18 && !r.isMarried && Math.random() < 0.1) {
                    r.isMarried = true;
                    // Abstract spouse
                }

                // Child Chance (Married=10%, Single=1%)
                const fertility = (r.isMarried ? 0.10 : 0.01);
                if (r.age >= 18 && r.age <= 45 && Math.random() < fertility) {
                    let childRel = '';
                    if (r.relation === 'Sibling') childRel = Math.random() > 0.5 ? 'Nephew' : 'Niece';
                    else childRel = Math.random() > 0.5 ? 'Grandson' : 'Granddaughter';
                    
                    const gender = (childRel === 'Nephew' || childRel === 'Grandson') ? 'Male' : 'Female';
                    const childName = getRandomName(gender);
                    
                    // Create the child
                    const child = addRelationship(childName, childRel, 50, gender, "House Member", r.locationIndex, true, true, 0);
                    child.parentId = r.id; // LINK TO PARENT
                    
                    // INHERIT GENES (From this parent + Random Spouse)
                    // We treat the spouse as having random genes
                    const spouseDummy = { appearance: GeneticEngine.generate() };
                    
                    child.appearance = GeneticEngine.mix(r, spouseDummy);

                    // Add to house members if applicable
                    if (state.house) {
                        addHouseMember(childName, gender, "House Member", r.locationIndex, child.id);
                    }
                    
                    log(`<strong style="color:var(--gold)">Family:</strong> Your ${r.relation} ${r.name} had a baby ${gender==='Male'?'boy':'girl'} named ${childName} (${childRel}).`);
                }
            }
        });
    }

    function processNextEvent() {
        if (state.eventQueue.length > 0) {
            const evt = state.eventQueue.shift();
            renderEvent(evt);
        } else {
            const container = document.getElementById('choices-container');
            container.innerHTML = '';
            const btn = document.createElement('button');
            btn.className = 'choice-btn justify-center font-bold';
            btn.innerText = "Advance Year";
            btn.onclick = processYear;
            container.appendChild(btn);
            if (state.health <= 0) death();
        }
    }

    // --- ACTIVITIES ---
    function renderActivitiesTab() {
        const container = document.getElementById('act-content');
        if (state.age < 6) {
            container.innerHTML = `<p class="col-span-2 text-center italic mt-4">You are too young to explore the city alone.</p>`;
            return;
        }

        const canLove = state.activityLog.love < 3; 
        const canQuest = state.activityLog.quest < 1;
        const canCrime = state.activityLog.crime < 1;
        const canTrain = state.activityLog.train < 1;
        const canLord = state.activityLog.lord < 1;

        // REMOVED SHOP BUTTON
        container.innerHTML = `
            <button onclick="actVisitLord()" class="act-btn choice-btn ${canLord?'':'opacity-50'}" ${canLord?'':'disabled'}><span class="act-icon">üëë</span>Visit Lord (1/yr)</button>
            <button onclick="actSocialize()" class="act-btn choice-btn"><span class="act-icon">üçª</span>Socialize</button>
            <button onclick="actLove()" class="act-btn choice-btn ${canLove?'':'opacity-50'}" ${canLove?'':'disabled'}><span class="act-icon">üíò</span>Find Love (${3-state.activityLog.love} left)</button>
            <button onclick="actQuest()" class="act-btn choice-btn ${canQuest?'':'opacity-50'}" ${canQuest?'':'disabled'}><span class="act-icon">‚öîÔ∏è</span>Quest (1/yr)</button>
            <button onclick="actCrime()" class="act-btn choice-btn ${canCrime?'':'opacity-50'}" ${canCrime?'':'disabled'}><span class="act-icon">üó°Ô∏è</span>Crime (1/yr)</button>
            <button onclick="actTrain()" class="act-btn choice-btn ${canTrain?'':'opacity-50'}" ${canTrain?'':'disabled'}><span class="act-icon">üèãÔ∏è</span>Train (1/yr)</button>
        `;
    }

    // REMOVED OLD actShop() and closeShop() functions as they are replaced by the Market Tab logic.

    function actVisitLord() {
        if(state.health <= 0) return; // Guard
        if(!checkAge(10)) return;
        state.activityLog.lord++;

        if (state.reputation.renown < 50) {
            log(`<strong class="text-red-800">Denied.</strong> The guards block your path. "The Lord only grants audiences to those of name (50 Renown)."`);
            switchTab('log');
            return;
        }

        const city = CITIES[state.location];
        const rulerName = city.ruler;
        log(`You attempt to gain audience with the ruling family of ${rulerName}.`);
        
        let dc = 18;
        if (state.socialClass === 'House') dc = 12;
        if (state.reputation.renown > 50) dc -= 5;
        
        const roll = rollD20(getModifier(state.stats.cha));
        if (roll.total >= dc) {
            log(`<strong class="text-green-800">Granted!</strong> You meet the Lord/Lady. They are impressed by your bearing.`);
            modRep('renown', 5);
            modSanity(1);
            const gender = Math.random() > 0.5 ? 'Male' : 'Female';
            const name = getRandomName(gender);
            addRelationship(name, "Lord of " + city.name, 20, gender, "Lord", state.location);
            renderEvent(POOLS.LordInteraction[0]);
        } else {
            log(`<strong class="text-red-800">Denied.</strong> The guards turn you away at the gate.`);
        }
        switchTab('log');
    }

    function actSocialize() {
        if(state.health <= 0) return; // Guard
        if(!checkAge(6)) return;
        const roll = Math.random();
        if (roll < 0.4) {
            log("You wander the streets but meet no one of interest.");
        } else if (roll < 0.8) {
            const gender = Math.random() > 0.5 ? 'Male' : 'Female';
            const name = getRandomName(gender);
            let rank = "Commoner";
            if (Math.random() > 0.9) rank = gender === 'Male' ? 'Sir' : 'Dame';
            
            addRelationship(name, "Acquaintance", 20, gender, "Commoner", state.location);
            log(`You met ${name} (${rank}) in the city square.`);
            modSanity(1);
            updateUI();
        } else {
            const pool = POOLS.Interactive;
            renderEvent(pool[Math.floor(Math.random() * pool.length)]);
        }
        switchTab('log');
    }

    function actLove() {
        if(state.health <= 0) return; // Guard
        if(!checkAge(14)) return;
        state.activityLog.love++;
        const roll = Math.random();
        if (roll < 0.5) {
            log("Your glances go unnoticed.");
        } else if (roll < 0.8) {
            const gender = Math.random() > 0.5 ? 'Male' : 'Female';
            const name = getRandomName(gender);
            addRelationship(name, "Love Interest", 40, gender, "Commoner", state.location);
            log(`You caught the eye of ${name}.`);
            modSanity(1);
            updateUI();
        } else {
            renderEvent(POOLS.SocialFail[1]); 
        }
        switchTab('log');
    }

    function actQuest() {
        if(state.health <= 0) return; // Guard
        if(!checkAge(16)) return;
        state.activityLog.quest++;
        const pool = POOLS.Quest;
        renderEvent(pool[Math.floor(Math.random() * pool.length)]);
        switchTab('log');
    }

    function actCrime() {
        if(state.health <= 0) return; // Guard
        if(!checkAge(8)) return;
        showConfirm("This is an evil act. Are you sure you wish to walk this path?", () => {
            state.activityLog.crime++;
            const pool = POOLS.Crime;
            renderEvent(pool[Math.floor(Math.random() * pool.length)]);
            switchTab('log');
        });
    }

    function actTrain() {
        if(state.health <= 0) return; // Guard
        if(!checkAge(6)) return;
        state.activityLog.train++;
        const stat = ABILITIES[Math.floor(Math.random() * ABILITIES.length)];
        state.stats[stat]++;
        log(`You trained hard. (+1 ${stat.toUpperCase()})`);
        modSanity(1);
        updateUI();
        switchTab('log');
    }

    // --- MAP SYSTEM ---
    function renderMapTab() {
        const container = document.getElementById('map-content');
        const visual = document.getElementById('map-visual');
        
        let visualHtml = '';
        CITIES.forEach((city, index) => {
            const isHere = state.location === index;
            const activeClass = isHere ? 'active' : '';
            visualHtml += `
                <div class="map-node ${activeClass}" style="left: ${city.x}%; top: ${city.y}%;" title="${city.name}">
                    <div class="map-label">${city.name}</div>
                </div>`;
        });
        visual.innerHTML = visualHtml;

        container.innerHTML = CITIES.map((city, index) => {
            const isHere = state.location === index;
            const extraClass = isHere ? 'current-city' : '';
            
            const currentCity = CITIES[state.location];
            const dist = Math.sqrt(Math.pow(city.x - currentCity.x, 2) + Math.pow(city.y - currentCity.y, 2));
            const travelTime = Math.min(10, Math.ceil(dist / 5)); 
            const cost = travelTime * 5; // 5 gold per month
            const timeText = travelTime === 0 ? "" : `(${travelTime} Mo, ${cost}g)`;

            let action = '';
            if (isHere) {
                action = `<span class="text-xs font-bold text-amber-900">Current Location</span>`;
            } else if (state.flags.traveledThisYear) {
                action = `<button disabled class="text-xs bg-gray-400 text-white px-2 py-1 rounded cursor-not-allowed">Travelled (Wait 1yr)</button>`;
            } else {
                action = `<button onclick="attemptTravel(${index})" class="text-xs bg-leather text-white px-2 py-1 rounded bg-[#5d4037]">Travel ${timeText}</button>`;
            }
            
            return `
                <div class="city-card ${extraClass}">
                    <div>
                        <div class="font-bold text-lg">${city.name}</div>
                        <div class="text-xs font-bold text-royal">${city.ruler}</div>
                        <div class="text-xs italic opacity-80">${city.desc}</div>
                    </div>
                    <div>${action}</div>
                </div>
            `;
        }).join('');
    }

    function attemptTravel(index) {
        if(state.health <= 0) return; // Guard
        if (!checkAge(8)) return;
        
        if (state.flags.traveledThisYear) {
            showMsg("Travel Weary", "You have already undertaken a journey this year. Rest a while.");
            return;
        }

        state.travelTarget = index;
        
        const city = CITIES[index];
        const currentCity = CITIES[state.location];
        const dist = Math.sqrt(Math.pow(city.x - currentCity.x, 2) + Math.pow(city.y - currentCity.y, 2));
        const months = Math.min(10, Math.ceil(dist / 5));
        const cost = months * 5;
        
        if (state.gold < cost) {
            showMsg("Cannot Travel", `You need ${cost} gold for supplies and safe passage.`);
            return;
        }

        const parents = [getParent('Father'), getParent('Mother')].filter(p => p && p.locationIndex === state.location);
        
        if (state.age < 16 && parents.length > 0 && !state.flags.travelAllowed) {
            renderEvent(POOLS.Permission[0]);
            switchTab('log');
        } else {
            travelTo(index);
        }
    }

    function travelTo(index) {
        const city = CITIES[index];
        const currentCity = CITIES[state.location];
        const dist = Math.sqrt(Math.pow(city.x - currentCity.x, 2) + Math.pow(city.y - currentCity.y, 2));
        const months = Math.min(10, Math.ceil(dist / 5));
        const cost = months * 5;
        
        state.gold -= cost;
        state.flags.traveledThisYear = true;
        log(`<strong>Travel:</strong> You paid ${cost}g and journeyed to ${city.name}. It took ${months} months.`);
        state.location = index;
        
        generateMarket(state.location); // REGENERATE MARKET ON TRAVEL

        const pool = POOLS.Travel;
        const event = pool[Math.floor(Math.random() * pool.length)];
        renderEvent(event);
        updateUI();
        switchTab('log');
    }

    function takeDamage(amt) {
        state.health -= amt;
        log(`<strong class="text-red-800">DAMAGE:</strong> You took ${amt} damage!`);
        updateUI();
        if (state.health <= 0) death();
    }

    function modSanity(amt) {
        state.sanity = Math.min(state.maxSanity, Math.max(0, state.sanity + amt));
    }

    // --- SETTINGS & NPC SHEETS ---
    function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
    function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
    function restartGame() { location.reload(); }
    
    function closeNPC() { document.getElementById('npc-modal').classList.add('hidden'); }
    
    function openNPC(id) {
        if(state.health <= 0) return; // Guard
        const r = state.relationships.find(x => x.id === id);
        if(!r) return;
        const loc = CITIES[r.locationIndex].name;
        const isKnight = r.rank === 'Sir' || r.rank === 'Dame';
        
        let actions = '';
        
        if (r.health === "Deceased") {
            actions = `
                <div class="col-span-2 text-center p-3 border border-gray-400 bg-gray-200 rounded text-gray-600 italic">
                    This person has passed away.<br>
                    <span class="text-xs">Visit the cemetery to pay respects.</span>
                </div>
            `;
        } else if (state.location === r.locationIndex) {
            actions = `
                <button onclick="startInteraction('${id}')" class="col-span-2 choice-btn text-lg justify-center bg-amber-900 border-amber-950 text-[#f4e4bc] hover:bg-amber-800 mb-2">
                    ‚öîÔ∏è Approach
                </button>
                <button onclick="interact('${id}', 'gift')" class="choice-btn text-sm justify-center">üéÅ Gift (5g)</button>
            `;
            if (isKnight && state.age >= 12 && state.occupation?.id !== 'squire') {
                actions += `<button onclick="attemptJob('squire')" class="choice-btn text-sm bg-blue-900 text-white">üõ°Ô∏è Ask to Squire</button>`;
            }
        } else {
            actions = `<button onclick="interact('${id}', 'letter')" class="col-span-2 choice-btn text-sm justify-center">üïäÔ∏è Send Letter (1g)</button>`;
        }

        const hpDisplay = r.health === "Deceased" ? "Deceased" : `${r.hp}/${r.maxHp}`;
        
        // NEW: RENDER APPEARANCE AND MUTATIONS
        const ap = r.appearance || { hair: "Unknown", eyes: "Unknown", skin: "Unknown", mutations: [] };
        
        let mutationsHtml = '<span class="italic text-xs opacity-50">None</span>';
        if (ap.mutations && ap.mutations.length > 0) {
            mutationsHtml = ap.mutations.map(m => {
                return `<span class="gene-tag mut-${m.rarity.toLowerCase()}" title="${m.desc}">${m.name}</span>`;
            }).join('');
        }

        let html = `
            <h2 class="text-3xl font-medieval mb-1">${r.name}</h2>
            <div class="flex justify-between items-center mb-4 border-b border-black/10 pb-2">
                <span class="text-sm font-bold text-amber-900">${r.rank}</span>
                <span class="text-xs bg-black/10 px-2 py-1 rounded">${r.alignment}</span>
            </div>
            
            <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                <div>
                    <p><strong>Age:</strong> ${r.age}</p>
                    <p><strong>City:</strong> ${loc}</p>
                    <p><strong>Job:</strong> ${r.occupation}</p>
                </div>
                <div>
                    <p><strong>Health:</strong> ${hpDisplay}</p>
                    <p><strong>Relation:</strong> ${r.relation}</p>
                </div>
            </div>

            <div class="mb-4">
                <div class="text-xs font-bold uppercase mb-1">Appearance</div>
                <div class="text-sm italic mb-2">${ap.height}, ${ap.hair} Hair, ${ap.eyes} Eyes, ${ap.skin} Skin</div>
                <div class="text-xs font-bold uppercase mb-1">Mutations</div>
                <div>${mutationsHtml}</div>
            </div>

            <div class="mb-4 space-y-2">
                <div>
                    <div class="flex justify-between text-xs mb-1"><span>Friendship (${getRelLabel(r.friendship)})</span><span>${r.friendship}</span></div>
                    <div class="bar-container"><div class="bar-fill ${r.friendship >= 0 ? 'friend-fill' : 'enemy-fill'}" style="width:${Math.abs(r.friendship)}%"></div></div>
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-1"><span>Romance</span><span>${r.romance}</span></div>
                    <div class="bar-container"><div class="bar-fill romance-fill" style="width:${r.romance}%"></div></div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-2">
                ${actions}
            </div>
        `;
        document.getElementById('npc-content').innerHTML = html;
        document.getElementById('npc-modal').classList.remove('hidden');
    }

    /**
     * DYNAMIC INTERACTION ENGINE
     */
    function startInteraction(id) {
        if(state.health <= 0) return; // Guard
        closeNPC();
        switchTab('log');
        const r = state.relationships.find(x => x.id === id);
        if(!r) return;

        const isEnemy = r.friendship <= -20;
        const isLover = r.romance > 40;
        const isSpouse = r.relation === 'Spouse';
        const isFriend = r.friendship >= 30;
        
        const isAdult = state.age >= 18;
        const isTeen = state.age >= 13 && state.age < 18;

        if (state.age < 4) {
            log(`You gurgle happily at ${r.name}. They pat your head awkwardly.`);
            return;
        }

        let evt = null;

        if (isEnemy) {
            if (isAdult || isTeen) {
                evt = createEvent(`int_enemy_${id}`, `Confrontation: ${r.name}`, `${r.name} sneers as you approach. "Lost your way, fool?"`, [
                    { text: 'Duel (Combat)', type: 'check', stat: 'str', dc: 12, success: `You batter them into submission!`, fail: `They thrash you soundly.`, onSuccess: () => { modRel(id, -10); takeDamage(2); modRep('renown', 5); }, onFail: () => { takeDamage(8); modRep('infamy', 2); } },
                    { text: 'Insult (Wit)', type: 'check', stat: 'int', dc: 13, success: `Your wit cuts deeper than a knife.`, fail: `You stutter and look weak.`, onSuccess: () => { modRel(id, -15); modRep('renown', 2); }, onFail: () => { modRep('honor', -2); } },
                    { text: 'Intimidate', type: 'check', stat: 'cha', dc: 14, success: `They back down, terrified.`, fail: `They laugh in your face.`, onSuccess: () => { modRel(id, -5); modRep('infamy', 5); }, onFail: () => {} }
                ]);
            } else {
                evt = createEvent(`int_enemy_kid_${id}`, `Bully: ${r.name}`, `${r.name} sticks their tongue out at you.`, [
                    { text: 'Push', type: 'check', stat: 'str', dc: 10, success: `You push them into the mud!`, fail: `They push you back harder.`, onSuccess: () => { modRel(id, -5); }, onFail: () => { takeDamage(1); } },
                    { text: 'Tell Adult', type: 'check', stat: 'cha', dc: 12, success: `They get in trouble!`, fail: `No one listens.`, onSuccess: () => { modRel(id, -10); }, onFail: () => {} }
                ]);
            }
        } 
        else if (isSpouse || isLover) {
            const title = isSpouse ? 'Spouse' : 'Lover';
            if (isAdult || isTeen) {
                let choices = [];
                choices.push({ text: 'Woo & Romance', type: 'check', stat: 'cha', dc: 12, success: `Sparks fly! (+Romance, +Sanity)`, fail: `It falls flat.`, onSuccess: () => { modRel(id, 5, 10); modSanity(2); }, onFail: () => modRel(id, 0, -2) });
                choices.push({ text: 'Deep Conversation', type: 'check', stat: 'wis', dc: 10, success: `You bond over shared dreams. (+Friendship)`, fail: `You argue instead.`, onSuccess: () => { modRel(id, 10); modSanity(1); }, onFail: () => { modRel(id, -5); } });
                
                if (!isSpouse && isLover && state.age >= 16) {
                    choices.push({ 
                        text: 'Propose Marriage', 
                        type: 'check', stat: 'cha', dc: 15, 
                        req: (s) => s.gold >= 50, // Ring cost?
                        success: `YES! You are now betrothed!`, 
                        fail: `They are not ready...`, 
                        onSuccess: () => { marryNPC(id); }, 
                        onFail: () => { modRel(id, -10, -5); } 
                    });
                } else if (isSpouse) {
                     choices.push({ text: 'Start a Family', type: 'check', stat: 'con', dc: 12, req: (s) => s.age < 50, success: `A child is on the way!`, fail: `Not this time.`, onSuccess: () => { log("You try for an heir."); }, onFail: () => {} });
                } else {
                     choices.push({ text: 'Spend Time', type: 'flavor', effect: () => { log(`You spend a quiet moment with ${r.name}.`); modSanity(2); } });
                }

                evt = createEvent(`int_love_${id}`, `${title}: ${r.name}`, `${r.name} smiles warmly as you approach.`, choices);
            } else {
                 evt = createEvent(`int_crush_${id}`, `Crush: ${r.name}`, `You feel butterflies near ${r.name}.`, [
                    { text: 'Give Flower', type: 'check', stat: 'cha', dc: 10, success: `They blush.`, fail: `They think it's weird.`, onSuccess: () => modRel(id, 5), onFail: () => modRel(id, -2) },
                    { text: 'Run Away', type: 'flavor', effect: () => log("You panic and run.") }
                 ]);
            }
        }
        else if (isFriend) {
            if (isAdult) {
                evt = createEvent(`int_friend_${id}`, `Friend: ${r.name}`, `You meet ${r.name} at the tavern.`, [
                    { text: 'Drink Ale', type: 'check', stat: 'con', dc: 12, success: `A hearty night! (+Sanity)`, fail: `Hangover. (-HP)`, onSuccess: () => { modSanity(3); modRel(id, 5); }, onFail: () => { takeDamage(2); } },
                    { text: 'Gossip', type: 'check', stat: 'int', dc: 12, success: `You learn secrets. (+1 INT)`, fail: `Boring news.`, onSuccess: () => state.stats.int++, onFail: () => {} },
                    { text: 'Borrow Gold', type: 'check', stat: 'cha', dc: 15, success: `They lend you 10g.`, fail: `They refuse.`, onSuccess: () => { state.gold+=10; modRel(id, -5); }, onFail: () => modRel(id, -2) }
                ]);
            } else {
                evt = createEvent(`int_friend_kid_${id}`, `Friend: ${r.name}`, `You meet ${r.name} to play.`, [
                    { text: 'Play Tag', type: 'check', stat: 'dex', dc: 12, success: `You are too fast! (+1 DEX)`, fail: `You trip.`, onSuccess: () => state.stats.dex++, onFail: () => takeDamage(1) },
                    { text: 'Share Toy', type: 'check', stat: 'cha', dc: 10, success: `Best friends forever.`, fail: `They break it.`, onSuccess: () => modRel(id, 10), onFail: () => modRel(id, -5) }
                ]);
            }
        }
        else {
            evt = createEvent(`int_neut_${id}`, `Meeting: ${r.name}`, `You approach ${r.name}.`, [
                { text: 'Chat', type: 'check', stat: 'cha', dc: 10, success: `Pleasant conversation. (+Rel)`, fail: `Awkward silence.`, onSuccess: () => modRel(id, 5), onFail: () => {} },
                { text: 'Joke', type: 'check', stat: 'cha', dc: 12, success: `They laugh! (+Rel)`, fail: `Crickets.`, onSuccess: () => modRel(id, 8), onFail: () => modRel(id, -2) },
                { text: 'Insult', type: 'check', stat: 'cha', dc: 10, success: `You mocked them good. (+Fun)`, fail: `They slap you.`, onSuccess: () => modSanity(1), onFail: () => takeDamage(1) }
            ]);
        }

        renderEvent(evt);
    }

    function marryNPC(id) {
        const r = state.relationships.find(x => x.id === id);
        if(!r) return;
        r.relation = 'Spouse';
        state.flags.married = true;
        log(`<strong style="color:var(--gold)">MARRIAGE:</strong> You and ${r.name} are joined in holy matrimony!`);
        updateUI();
    }

    function getRelLabel(val) {
        if (val <= -50) return "Enemy";
        if (val < 0) return "Disliked";
        if (val < 30) return "Acquaintance";
        if (val < 60) return "Friend";
        if (val < 90) return "Good Friend";
        return "Best Friend";
    }

    // --- OCCUPATION SYSTEM LOGIC ---
    function processOccupation() {
        if (!state.occupation) return;
        const occ = state.occupation;
        const career = CAREERS[occ.id];
        const rankInfo = career.ranks[occ.rankIndex];
        
        let income = rankInfo.wage;
        let stressGain = rankInfo.stressMod;
        let perfGain = 5;

        if (occ.workStance === 'slack') { income *= 0.7; stressGain -= 5; perfGain = -5; } 
        else if (occ.workStance === 'intense') { income *= 1.5; stressGain += 5; perfGain = 15; }

        state.gold += Math.floor(income);
        occ.stress = Math.min(100, Math.max(0, occ.stress + stressGain));
        occ.performance = Math.min(100, Math.max(0, occ.performance + perfGain));
        occ.years++;

        log(`<strong>Occupation:</strong> Earned ${Math.floor(income)} GP. Stress: ${occ.stress}%.`);
        
        if (occ.performance === 100 && occ.rankIndex < career.ranks.length - 1 && Math.random() > 0.7) {
            occ.rankIndex++;
            occ.performance = 50;
            const newTitle = career.ranks[occ.rankIndex].title;
            log(`<strong class="text-green-800">PROMOTION:</strong> Raised to ${newTitle}!`);
            modRep('renown', 10);
        }
    }

    function renderOccupationTab() {
        const container = document.getElementById('occ-content');
        if (!state.occupation) {
            let html = `<p class="italic mb-4">You currently have no vocation.</p><div class="space-y-2">`;
            const historyIds = Object.keys(state.jobHistory);
            if (historyIds.length > 0) {
                html += `<h4 class="font-bold border-b border-black/10 mb-2">Resume Career</h4>`;
                historyIds.forEach(hid => {
                    const hist = state.jobHistory[hid];
                    const c = CAREERS[hid];
                    html += `<button onclick="joinJob('${hid}')" class="choice-btn text-sm mb-2 border-l-4 border-amber-600"><span>Resume: ${c.ranks[hist.rankIndex].title}</span></button>`;
                });
                html += `<h4 class="font-bold border-b border-black/10 mb-2 mt-4">New Career</h4>`;
            }
            for (let id in CAREERS) {
                if (id === 'squire') continue; 
                const c = CAREERS[id];
                let canJoin = true;
                if (c.req.age && state.age < c.req.age) canJoin = false;
                if (c.req.stat && state.stats[c.req.stat] < c.req.val) canJoin = false;
                if (c.req.flag && !state.flags[c.req.flag]) canJoin = false;
                if (c.req.class && state.socialClass !== c.req.class) canJoin = false;
                
                // --- NEW: COOLDOWN LOGIC ---
                const isRejected = state.rejectedJobs.includes(id);
                if (isRejected) {
                    html += `<button disabled class="choice-btn text-sm opacity-50 cursor-not-allowed border-red-900"><span>${c.name}</span><span class="text-red-800 font-bold">Rejected this year</span></button>`;
                }
                else if (canJoin) {
                    html += `<button onclick="attemptJob('${id}')" class="choice-btn text-sm"><span>${c.name}: ${c.ranks[0].title}</span><span class="opacity-70">${c.ranks[0].wage} GP/yr</span></button>`;
                }
            }
            container.innerHTML = html;
        } else {
            const occ = state.occupation;
            const jobData = CAREERS[occ.id].ranks[occ.rankIndex];
            const jobName = CAREERS[occ.id].name;
            
            const coworkers = state.relationships.filter(r => r.occupation === jobName && r.locationIndex === state.location && r.health !== 'Deceased');
            
            let coworkersHtml = '<div class="mt-4 pt-4 border-t border-black/20"><h4 class="font-bold mb-2">Colleagues</h4>';
            if (coworkers.length === 0) {
                coworkersHtml += '<p class="text-xs italic opacity-70 mb-2">You haven\'t bonded with anyone here yet.</p>';
            } else {
                coworkersHtml += '<div class="grid grid-cols-2 gap-2 mb-2">';
                coworkersHtml += coworkers.map(r => `
                    <div class="p-2 border border-black/10 rounded bg-white/30 cursor-pointer hover:bg-white/60 flex justify-between items-center" onclick="openNPC('${r.id}')">
                        <div class="font-bold text-xs truncate mr-1">${r.name}</div>
                        <div class="text-[10px] opacity-70">${getRelLabel(r.friendship)}</div>
                    </div>
                `).join('');
                coworkersHtml += '</div>';
            }
            coworkersHtml += `<button onclick="meetCoworker()" class="choice-btn text-xs w-full justify-center bg-[#5d4037]">Socialize with Colleagues</button></div>`;

            container.innerHTML = `
                <div class="job-card">
                    <h3 class="font-bold text-xl">${jobData.title}</h3>
                    <p class="text-sm opacity-70">${jobName} - Rank ${occ.rankIndex + 1}</p>
                    <div class="mt-2 text-sm">Wage: ${jobData.wage} GP/yr</div>
                    <div class="mt-4"><div class="text-xs flex justify-between"><span>Performance</span><span>${occ.performance}%</span></div><div class="bar-container"><div class="bar-fill perf-fill" style="width: ${occ.performance}%"></div></div></div>
                    <div class="mt-2"><div class="text-xs flex justify-between"><span>Stress</span><span>${occ.stress}%</span></div><div class="bar-container"><div class="bar-fill stress-fill" style="width: ${occ.stress}%"></div></div></div>
                    ${coworkersHtml}
                </div>
                <div class="flex gap-2 text-xs mb-4">
                    <button onclick="setStance('slack')" class="p-2 border rounded ${occ.workStance==='slack'?'bg-amber-300':'bg-white'}">Slack</button>
                    <button onclick="setStance('normal')" class="p-2 border rounded ${occ.workStance==='normal'?'bg-amber-500 text-white':'bg-white'}">Normal</button>
                    <button onclick="setStance('intense')" class="p-2 border rounded ${occ.workStance==='intense'?'bg-red-800 text-white':'bg-white'}">Intense</button>
                </div>
                <button onclick="quitJob()" class="w-full border border-red-800 text-red-800 p-2 rounded hover:bg-red-100">Quit Job</button>
            `;
        }
    }

    function meetCoworker() {
        if(state.health <= 0) return; // Guard
        if(!state.occupation) return;
        const jobName = CAREERS[state.occupation.id].name;
        
        const existing = state.relationships.filter(r => r.occupation === jobName && r.locationIndex === state.location && r.health !== 'Deceased');
        
        if (Math.random() < 0.4 || existing.length === 0) {
             const gender = Math.random() > 0.5 ? 'Male' : 'Female';
             const name = getRandomName(gender);
             const newCo = addRelationship(name, "Colleague", 20, gender, "Commoner", state.location);
             newCo.occupation = jobName; 
             log(`You met a new colleague, ${name}.`);
        } else {
             const target = existing[Math.floor(Math.random() * existing.length)];
             log(`You spent time with ${target.name} during work.`);
             modRel(target.id, 5);
        }
    }

    function attemptJob(id) {
        if(state.health <= 0) return; // Guard
        if(id === 'squire') closeNPC(); 
        
        const career = CAREERS[id];
        log(`You attempt to find work as a ${career.name}.`);
        
        const interviewEvent = createEvent(
            'job_interview', 
            `The ${career.name} Guild`, 
            `You approach the master of the guild asking for work. They look you over critically.`,
            [
                { 
                    text: 'Demonstrate Skill', 
                    type: 'check', 
                    stat: career.stat, 
                    dc: career.dc, 
                    success: 'The Master nods approvingly. "You have the touch. We will take you on."', 
                    fail: 'The Master shakes their head. "Your hands are clumsy. Come back when you are better trained."', 
                    onSuccess: () => joinJob(id), 
                    // --- NEW: PUSH TO REJECTED ARRAY ON FAIL ---
                    onFail: () => { state.rejectedJobs.push(id); updateUI(); } 
                },
                {
                    text: 'Bribe (50g)',
                    type: 'check',
                    stat: 'cha',
                    dc: 10,
                    req: (s) => s.gold >= 50,
                    success: 'They take the coin with a wink. "Welcome aboard."',
                    fail: 'They take the coin but throw you out anyway. "We have standards."',
                    onSuccess: () => { state.gold -= 50; joinJob(id); },
                    onFail: () => { state.gold -= 50; state.rejectedJobs.push(id); updateUI(); }
                },
                {
                    text: 'Leave',
                    type: 'flavor',
                    effect: () => log("You decide to wait.")
                }
            ]
        );
        
        renderEvent(interviewEvent);
        switchTab('log');
    }

    function joinJob(id) {
        if(state.health <= 0) return; // Guard
        if (state.jobHistory[id]) {
            state.occupation = state.jobHistory[id];
            state.occupation.performance = Math.max(0, state.occupation.performance - 20);
            log(`<strong>Career:</strong> Resumed post as ${CAREERS[id].ranks[state.occupation.rankIndex].title}.`);
            delete state.jobHistory[id];
        } else {
            state.occupation = { id, rankIndex: 0, performance: 50, stress: 0, workStance: 'normal', years: 0 };
            log(`<strong>Career:</strong> Started as ${CAREERS[id].ranks[0].title}.`);
        }
        state.flags.employed = true;
        updateUI();
    }

    function quitJob() {
        if(state.health <= 0) return; // Guard
        if (state.occupation) {
            log(`<strong>Career:</strong> Resigned.`);
            state.jobHistory[state.occupation.id] = state.occupation;
            state.occupation = null;
            state.flags.employed = false;
            updateUI();
        }
    }
    
    function setStance(s) {
        if(state.occupation) state.occupation.workStance = s;
        updateUI();
    }

    // --- RELATIONSHIP SYSTEM ---
    function interact(id, action) {
        if(state.health <= 0) return; // Guard
        const r = state.relationships.find(x => x.id === id);
        if(!r) return;

        if (action === 'gift') {
            if (state.gold >= 5) {
                state.gold -= 5;
                r.friendship = Math.min(100, r.friendship + 10);
                if (r.romance > 0) r.romance += 5;
                log(`You gave ${r.name} a gift. They seem pleased.`);
            } else {
                showMsg("Insufficient Funds", "You do not have enough gold.");
            }
        } 
        else if (action === 'letter') {
            if (state.gold >= 1) {
                state.gold -= 1;
                r.friendship = Math.min(100, r.friendship + 2);
                log(`You sent a letter to ${r.name}.`);
            } else {
                showMsg("Insufficient Funds", "You do not have enough gold.");
            }
        }
        
        updateUI();
        closeNPC();
        switchTab('log');
    }

    function renderRelTab() {
        const container = document.getElementById('rel-content');
        const searchInput = document.getElementById('rel-search-input');
        const query = searchInput.value.toLowerCase();

        if (state.relationships.length === 0) {
            container.innerHTML = `<p class="italic opacity-50">You are alone.</p>`;
            return;
        }
        
        const filtered = state.relationships.filter(r => r.name.toLowerCase().includes(query) || r.relation.toLowerCase().includes(query));

        if (filtered.length === 0) {
            container.innerHTML = `<p class="italic opacity-50">No relationships found.</p>`;
            return;
        }

        container.innerHTML = filtered.map(r => {
            const locName = CITIES[r.locationIndex].name;
            const status = r.romance > 50 ? "‚ù§Ô∏è Partner" : getRelLabel(r.friendship);
            const familyTag = r.isFamily ? `<span class="text-[10px] bg-amber-900 text-white px-1 rounded ml-2">Kin</span>` : '';
            const deadClass = r.health === "Deceased" ? "opacity-50 grayscale" : "";
            
            return `
            <div class="rel-card ${deadClass}" onclick="openNPC('${r.id}')">
                <div>
                    <div class="font-bold">${r.name} ${familyTag}</div>
                    <div class="text-xs opacity-70">${r.relation} ‚Ä¢ ${r.rank}</div>
                    <div class="text-xs text-amber-900 font-bold">üìç ${locName}</div>
                </div>
                <div class="flex flex-col items-end gap-1 w-24">
                    <div class="text-xs font-bold">${status}</div>
                    <div class="w-full h-1 bg-black/10 rounded overflow-hidden">
                        <div class="h-full ${r.friendship >= 0 ? 'friend-fill' : 'enemy-fill'}" style="width:${Math.abs(r.friendship)}%"></div>
                    </div>
                    ${r.romance > 0 ? `<div class="w-full h-1 bg-black/10 rounded overflow-hidden"><div class="h-full romance-fill" style="width:${r.romance}%"></div></div>` : ''}
                </div>
            </div>`;
        }).join('');
    }

    // --- HOUSE & LINEAGE UI ---
    function donateToHouse() {
        if(state.health <= 0) return; // Guard
        const amt = 50;
        if(state.gold >= amt) {
            state.gold -= amt;
            state.house.treasury += amt;
            log(`You donated ${amt}g to House ${state.house.name}.`);
            updateUI();
        } else {
            showMsg("Insufficient Funds", "You do not have enough gold.");
        }
    }
    
    function withdrawFromHouse() {
        if(state.health <= 0) return; // Guard
        const amt = 50;
        if(state.house.treasury >= amt) {
            state.house.treasury -= amt;
            state.gold += amt;
            log(`You withdrew ${amt}g from the treasury.`);
            updateUI();
        } else {
            showMsg("Treasury Low", "The House coffers are empty.");
        }
    }

    function renderHouseTab() {
        const container = document.getElementById('house-content');
        const h = state.house || { name: 'Commoner', tier: 'Common Folk', sigil: 'üåæ', motto: 'Survival is Victory', heirloom: 'None', treasury: 0, trait: 'Hardy' };
        
        // --- HOLDINGS SECTION ---
        let holdingsHtml = '';
        if(state.socialClass === 'House') {
            const isLord = state.class.includes("Lord") || state.class.includes("Lady");
             holdingsHtml = `
                <div class="holding-card mt-6">
                    <div class="holding-icon">üè∞</div>
                    <h3 class="font-medieval text-2xl text-amber-900 mb-2">Holdings</h3>
                    <div class="font-bold text-lg">${h.holding}</div>
                    <p class="text-sm italic opacity-80 mb-2">${h.holdingDesc}</p>
                    <div class="text-xs font-bold uppercase tracking-wide text-amber-900 mt-2">Seat of Power in ${CITIES[state.location].name}</div>
                    
                    <div class="mt-4 pt-4 border-t border-black/10 flex justify-between items-center">
                        <div class="text-left">
                             <div class="text-xs uppercase font-bold">Treasury</div>
                             <div class="text-xl font-bold text-amber-900">${h.treasury} Gold</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="donateToHouse()" class="choice-btn text-xs px-2 py-1">Donate 50g</button>
                            ${isLord ? `<button onclick="withdrawFromHouse()" class="choice-btn text-xs px-2 py-1 bg-amber-800">Withdraw 50g</button>` : ''}
                        </div>
                    </div>
                </div>`;
        }

        // --- UNIFIED TREE RENDERING LOGIC ---
        const renderNode = (p) => {
            const isDead = p.health === 'Deceased' ? 'dead' : '';
            // Blood badge logic is good, keep it
            const bloodBadge = p.isBlood ? `<span class="tree-blood">Blood</span>` : (p.isFamily ? `<span class="tree-married">In-Law</span>` : '');
            
            let extraIcon = '';
            if (p.rank.includes("Lord") || p.rank.includes("Lady") || p.rank.includes("King") || p.rank.includes("Queen")) {
                if(!p.rank.includes("Emeritus") && !p.rank.includes("Dowager")) extraIcon = `<div class="tree-crown">üëë</div>`;
            }
            if (p.health === "Deceased") extraIcon += `<div class="tree-grave">üíÄ</div>`;

            // Note: Removed gene badges from tree nodes to keep them clean, 
            // as new mutations are too detailed for the tiny tree node.
            
            return `
                <div class="tree-member ${isDead}" onclick="openNPC('${p.id}')">
                    ${bloodBadge}
                    ${extraIcon}
                    <div class="tree-name">${p.name}</div>
                    <div class="tree-role">${p.relation}</div>
                </div>`;
        };

        const renderPlayerNode = () => {
             let extraIcon = '';
             if (state.class.includes("Lord") || state.class.includes("Lady")) extraIcon = `<div class="tree-crown">üëë</div>`;
             
             return `
                <div class="tree-member player">
                    <span class="tree-blood">Blood</span>
                    ${extraIcon}
                    <div class="tree-name">${state.name} (You)</div>
                    <div class="tree-role">${state.class.split(' ')[0]}</div>
                </div>`;
        };

        // Gather Relations by Group
        const grandparents = state.relationships.filter(r => ['Grandfather', 'Grandmother'].includes(r.relation));
        const parents = state.relationships.filter(r => ['Father', 'Mother'].includes(r.relation));
        const unclesAunts = state.relationships.filter(r => ['Uncle', 'Aunt'].includes(r.relation));
        const siblings = state.relationships.filter(r => r.relation === 'Sibling');
        
        // --- UPDATED TREE RENDERING ---
        
        // Helper to get kids of a specific person
        const getKidsOf = (parentId) => state.relationships.filter(r => r.parentId === parentId);

        // Recursive function to render a node and its children (Nieces/Nephews/Grandkids)
        const renderDescendants = (person) => {
            const kids = getKidsOf(person.id);
            // Check if person is dead to style
            const isDead = person.health === 'Deceased' ? 'dead' : '';
            
            // Render the node itself using existing logic
            // Note: We use the existing logic inside renderNode but call it here
            const nodeHtml = renderNode(person); 
            
            if (kids.length === 0) return `<li>${nodeHtml}</li>`;
            
            return `
                <li>
                    ${nodeHtml}
                    <ul>
                        ${kids.map(k => renderDescendants(k)).join('')}
                    </ul>
                </li>
            `;
        };

        // Player Children (Son/Daughter) are direct roots of the player branch
        const playerChildren = state.relationships.filter(r => ['Son', 'Daughter'].includes(r.relation));
        
        // --- BRANCH 1: PLAYER & SIBLINGS ---
        const playerBranch = `
            <ul>
                <li>
                    ${renderPlayerNode()}
                    ${playerChildren.length > 0 ? 
                        `<ul>${playerChildren.map(c => renderDescendants(c)).join('')}</ul>` 
                        : ''}
                </li>
                ${siblings.map(sib => renderDescendants(sib)).join('')}
            </ul>
        `;

        // --- BRANCH 2: UNCLES/AUNTS & COUSINS ---
        // We distribute cousins among Uncles/Aunts for visual cohesiveness
        let uaBranch = '';
        if (unclesAunts.length > 0) {
            uaBranch = unclesAunts.map(ua => {
                return `<li>${renderNode(ua)}</li>`;
            }).join('');
        }

        // --- LEVEL 2: PARENTS + UNCLES/AUNTS ---
        let parentsNode = '';
        if (parents.length > 0) {
            parentsNode = `
                <li>
                    <div class="tree-member-group">${parents.map(p => renderNode(p)).join('')}</div>
                    ${playerBranch}
                </li>
            `;
        } else {
             // Fallback for orphans or missing parents data in tree
             parentsNode = `
                <li>
                    <div class="tree-member-group opacity-50 border-dashed">Unknown Parents</div>
                    ${playerBranch}
                </li>
            `;
        }

        // --- LEVEL 1: ROOT (Grandparents or Placeholder) ---
        let treeStructure = '';
        
        if (grandparents.length > 0) {
            // Standard Full Tree
            treeStructure = `
                <ul>
                    <li>
                        <div class="tree-member-group">${grandparents.map(gp => renderNode(gp)).join('')}</div>
                        <ul>
                            ${parentsNode}
                            ${uaBranch}
                        </ul>
                    </li>
                </ul>
            `;
        } else {
            // No Grandparents
            if (state.socialClass === 'Commoner') {
                // For commoners, if no grandparents, skip the "Ancestors" node entirely.
                // Just render the parents/uncles at the top level.
                treeStructure = `
                    <ul>
                        ${parentsNode}
                        ${uaBranch}
                    </ul>
                `;
            } else {
                // For Nobles, always show the "House Ancestors" placeholder for flavor/structure
                treeStructure = `
                    <ul>
                        <li>
                            <div class="p-2 border border-dashed border-leather/30 rounded italic opacity-50 bg-white/20">House Ancestors</div>
                            <ul>
                                ${parentsNode}
                                ${uaBranch}
                            </ul>
                        </li>
                    </ul>
                `;
            }
        }
        
        let houseTraitHtml = '';
        if(state.house && state.house.trait) {
            const mut = MUTATION_POOL.find(m => m.name === state.house.trait);
            const rarity = mut ? mut.rarity.toLowerCase() : 'common';
            houseTraitHtml = `<div class="mt-2 text-sm">Bloodline Trait: <span class="gene-tag mut-${rarity}">${state.house.trait}</span></div>`;
        }

        let headerTitle = `House ${h.name}`;
        if (state.socialClass === 'Commoner') headerTitle = `Your Family`;

        container.innerHTML = `
            <div class="house-crest opacity-70">${h.sigil}</div>
            <h2 class="text-4xl font-medieval text-amber-900 mb-1">${headerTitle}</h2>
            <div class="mb-4 text-center">
                <span class="font-bold text-lg uppercase tracking-widest block">${h.tier}</span>
                <span class="italic text-sm">"${h.motto}"</span>
                ${houseTraitHtml}
            </div>
            ${holdingsHtml}
            
            <h2 class="text-4xl font-medieval text-amber-900 mt-8 mb-4 border-b-2 border-leather/20 pb-2">Family Tree</h2>
            <div class="tree overflow-x-auto pb-8 flex justify-center">
                ${treeStructure}
            </div>
        `;
    }

    function meetHouseMember(name, gender, rank) {
        addRelationship(name, "Kinsman", 30, gender, rank, state.location);
        log(`You introduced yourself to ${name} of your House.`);
        updateUI();
    }

    function renderInventory() {
        const list = document.getElementById('inventory-list');
        if (state.inventory.length === 0) { list.innerHTML = `<p class="italic opacity-50">Your satchel is empty.</p>`; return; }
        list.innerHTML = state.inventory.map((item, idx) => {
            let useBtn = '';
            if (['Bread', 'Healing Potion', 'Apple', 'Meat'].includes(item.name) || item.rarity === 'Consumable') {
                useBtn = `<button onclick="useItem(${idx})" class="text-[10px] bg-green-800 text-[#f4e4bc] px-2 py-0.5 rounded hover:opacity-80 mr-1">Use</button>`;
            }

            return `
            <div class="item-row">
                <div>
                    <div class="item-rarity-${item.rarity}">${item.name}</div>
                    <div class="text-xs opacity-70">${item.desc}</div>
                </div>
                <div class="flex flex-col items-end">
                    <div class="text-[10px] uppercase font-bold opacity-50 border border-black/20 px-1 rounded mb-1">${item.rarity}</div>
                    <div>
                        ${useBtn}
                        <button onclick="sellItem(${idx})" class="text-[10px] bg-[#2c1e16] text-[#f4e4bc] px-2 py-0.5 rounded hover:opacity-80">Sell (${item.value}g)</button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function useItem(index) {
        if(state.health <= 0) return; // Guard
        const item = state.inventory[index];
        let used = false;
        
        if (item.name === 'Bread') { 
            state.health += 2; 
            log("You ate the fresh bread. (+2 HP)"); 
            used = true; 
        }
        else if (item.name === 'Healing Potion') { 
            state.health += 10; 
            log("You drank the red potion. (+10 HP)"); 
            used = true; 
        }
        else if (item.name === 'Apple') {
            state.health += 1;
            log("Crunchy. (+1 HP)");
            used = true;
        }
        else if (item.name === 'Meat') {
            state.health += 5;
            log("You cooked and ate the meat. (+5 HP)");
            used = true;
        }

        if (used) {
            state.health = Math.min(state.maxHealth, state.health);
            state.inventory.splice(index, 1);
            updateUI();
        } else {
            showMsg("Cannot Use", "You don't know how to use this.");
        }
    }

    // --- CEMETERY TAB ---
    function renderCemeteryTab() {
        const container = document.getElementById('cemetery-content');
        
        if (state.age < 8) {
            container.innerHTML = `<p class="italic opacity-50 text-center mt-10">You are too young to understand the gravity of this place.</p>`;
            return;
        }

        const dead = state.relationships.filter(r => r.health === "Deceased");

        if (dead.length === 0) {
            container.innerHTML = `<p class="italic opacity-50 text-center mt-10">The earth is undisturbed. You have lost no one yet.</p>`;
            return;
        }

        container.innerHTML = dead.map(r => {
            const lootedClass = r.graveRobbed ? "opacity-50 grayscale" : "";
            const lootedText = r.graveRobbed ? `<span class="text-red-800 font-bold block mt-2 text-xs">DESECRATED</span>` : "";
            const hasInteracted = state.interactions[r.id];
            
            return `
            <div class="grave-card ${lootedClass}">
                <div class="grave-stone">
                    <div class="text-2xl mb-2">‚Ä†</div>
                    <div class="font-bold text-xs uppercase">${r.name}</div>
                    <div class="text-[10px] italic">${r.relation}</div>
                    <div class="text-[10px] mt-1">Died Age ${r.age}</div>
                </div>
                ${lootedText}
                <div class="flex justify-center gap-2 mt-4">
                    <button onclick="payRespects('${r.id}')" class="choice-btn text-xs justify-center w-auto ${hasInteracted ? 'opacity-50 cursor-not-allowed' : ''}" ${hasInteracted ? 'disabled' : ''}>Pay Respects</button>
                    <button onclick="searchGrave('${r.id}')" class="choice-btn text-xs justify-center w-auto bg-gray-800 text-gray-300 ${hasInteracted ? 'opacity-50 cursor-not-allowed' : ''}" ${hasInteracted ? 'disabled' : ''}>Search Grave</button>
                </div>
            </div>`;
        }).join('');
    }

    function payRespects(id) {
        if(state.health <= 0) return; // Guard
        const r = state.relationships.find(x => x.id === id);
        if(!r) return;
        
        if (state.interactions[id]) {
            showMsg("Visited", "You have already visited this grave this year.");
            return;
        }
        state.interactions[id] = 1; 

        modRep('piety', 2);
        modSanity(1);
        log(`You knelt before the grave of ${r.name}. Your mind feels clearer. (+Piety, +SP)`);
        updateUI();
        switchTab('log'); 
    }

    function searchGrave(id) {
        if(state.health <= 0) return; // Guard
        const r = state.relationships.find(x => x.id === id);
        if(!r) return;
        
        if (state.interactions[id]) {
            showMsg("Visited", "You have already visited this grave this year.");
            return;
        }

        if (r.graveRobbed) {
            state.interactions[id] = 1;
            log(`You dig through the disturbed earth of ${r.name}'s grave, but find nothing but old bones.`);
            modSanity(-1);
            updateUI();
            switchTab('log');
            return;
        }

        showConfirm("Desecrating the dead is a heinous act. Are you sure?", () => {
             state.interactions[id] = 1; 
             r.graveRobbed = true;
             modRep('infamy', 10);
             modRep('piety', -10);
             
             const check = rollD20(getModifier(state.stats.int));
             const dc = 14;

             if (check.total >= dc) {
                 const goldFound = Math.floor(Math.random() * 50) + 10;
                 state.gold += goldFound;
                 log(`<strong class="text-amber-600">GRAVE ROBBED:</strong> You dug up ${r.name}'s grave and found ${goldFound} gold! (+Infamy, -Piety)`);
                 if(Math.random() > 0.8) {
                     addItem('Bone Ring', 'Rare', 'Stolen from the dead.', 100);
                 }
             } else {
                 log(`<strong class="text-red-800">CURSED:</strong> You found nothing but rot, and something followed you home. (+Infamy, -Piety)`);
                 addTrait('Haunted');
                 modSanity(-3);
             }
             updateUI();
             switchTab('log');
        });
    }

    function addItem(name, rarity, desc, value) {
        state.inventory.push({ name, rarity, desc, value, id: Math.random().toString(36).substr(2, 9) });
        log(`<strong style="color:var(--gold)">ITEM GET:</strong> Found <span class="item-rarity-${rarity}">${name}</span>!`);
        updateUI();
    }

    function sellItem(index) {
        const item = state.inventory[index];
        state.gold += item.value;
        log(`Sold ${item.name} for ${item.value}g.`);
        state.inventory.splice(index, 1);
        updateUI();
    }

    function modRep(type, amt) { state.reputation[type] += amt; }
    
    function modRel(id, amt, romanceAmt = 0) {
        const r = state.relationships.find(x => x.id === id);
        if(r) {
            r.friendship = Math.min(100, Math.max(-100, r.friendship + amt));
            if (romanceAmt !== 0) r.romance = Math.min(100, Math.max(0, r.romance + romanceAmt));
        }
    }

    function checkUnlocks() {
        // Unlocks UI removed per request, logic maintained silently if needed
        // Original list population code removed.
    }

    function nextTurn() {
        processNextEvent();
    }

    function renderEvent(event) {
        if (!event) {
            nextTurn(); // Skip if invalid
            return;
        }

        log(`<strong>${event.title}:</strong> ${event.text}`);
        const container = document.getElementById('choices-container');
        container.innerHTML = '';
        
        let validChoicesCount = 0;

        event.choices.forEach(choice => {
            // Safety check for requirements
            try {
                if (choice.req && !choice.req(state)) return;
            } catch (e) {
                console.warn("Requirement check failed:", e);
                return;
            }

            validChoicesCount++;
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            
            // Safety check for stats to prevent rendering crashes
            let badge = '';
            if (choice.type === 'check') {
                const statName = choice.stat ? choice.stat : 'str'; // Fallback
                const statVal = state.stats[statName] || 10;
                const mod = getModifier(statVal);
                const color = mod >= 0 ? '#86efac' : '#fca5a5';
                badge = `<span class="dc-badge" style="color: ${color}">${statName.toUpperCase()} ${formatMod(mod)} (DC ${choice.dc})</span>`;
            } else if (choice.type === 'flavor') {
                badge = `<span class="opacity-50 text-xs">Free Action</span>`;
            }

            btn.innerHTML = `<span>${choice.text}</span> ${badge}`;
            
            // Wrap click in error handler
            btn.onclick = () => { 
                container.querySelectorAll('button').forEach(b => b.disabled = true); 
                try {
                    resolveChoice(choice); 
                } catch (e) {
                    console.error("Choice resolution failed", e);
                    // Force progression on crash to prevent softlock
                    log(`<span class="text-red-500">Fate stumbled, but time marches on.</span>`);
                    updateUI();
                    nextTurn();
                }
            };
            container.appendChild(btn);
        });

        // FALLBACK: If no choices are valid (e.g. all reqs failed), provide a default continue
        if (validChoicesCount === 0) {
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.innerHTML = `<span>...</span> <span class="opacity-50 text-xs">Continue</span>`;
            btn.onclick = () => { nextTurn(); };
            container.appendChild(btn);
        }
    }

    function resolveChoice(choice) {
        if (choice.type === 'flavor') {
            if (choice.effect) {
                try {
                    choice.effect();
                } catch(e) { console.error("Effect error", e); }
            }
            nextTurn();
        } else if (choice.type === 'check') {
            const statName = choice.stat ? choice.stat : 'str';
            const statVal = state.stats[statName] || 10;
            const result = rollD20(getModifier(statVal));
            
            const passed = result.total >= choice.dc;
            const resultClass = result.isCrit ? 'dice-crit' : (passed ? 'dice-success' : 'dice-failure');
            const resultText = result.isCrit ? 'NAT 20!' : (result.isFail ? 'CRIT FAIL!' : (passed ? 'SUCCESS' : 'FAILURE'));
            
            log(`<div class="mt-2 mb-2 p-2 bg-black/5 rounded text-sm"><span class="font-bold">Rolling ${statName.toUpperCase()}:</span> d20(${result.roll}) ${formatMod(result.mod)} = <span class="text-lg font-bold">${result.total}</span> vs DC ${choice.dc}<br><span class="${resultClass} dice-result">${resultText}</span></div>`);
            
            setTimeout(() => {
                try {
                    if (passed) { 
                        if(choice.success) log(choice.success); 
                        if(choice.onSuccess) choice.onSuccess(); 
                    } else { 
                        if(choice.fail) log(choice.fail); 
                        if(choice.onFail) choice.onFail(); 
                    }
                } catch (e) {
                    console.error("Effect execution failed", e);
                }
                updateUI();
                nextTurn();
            }, 600);
        } else {
            // Fallback for malformed types
            nextTurn();
        }
    }

    function processNextEvent() {
        if (state.health <= 0) {
            death();
            return;
        }

        if (state.eventQueue.length > 0) {
            const evt = state.eventQueue.shift();
            renderEvent(evt);
        } else {
            const container = document.getElementById('choices-container');
            container.innerHTML = '';
            const btn = document.createElement('button');
            btn.className = 'choice-btn justify-center font-bold';
            btn.innerText = "Advance Year";
            btn.onclick = processYear;
            container.appendChild(btn);
        }
    }
    function takeDamage(amt) {
        state.health -= amt;
        log(`<strong class="text-red-800">DAMAGE:</strong> You took ${amt} damage!`);
        updateUI();
        if (state.health <= 0) {
             state.eventQueue = []; // Clear pending events on death
             death();
        }
    }

    function death() {
        const container = document.getElementById('choices-container');
        container.innerHTML = `
            <div class="text-center text-red-800 font-bold text-xl p-4">YOUR WATCH HAS ENDED</div>
            <div class="text-center mb-4 italic">Fate has claimed you. History moves on.</div>
            <button onclick="restartGame()" class="choice-btn w-full justify-center bg-red-900 text-white font-medieval text-xl">Start New Chronicle</button>
        `;
        log(`<strong style="color:red">DEATH:</strong> At the age of ${state.age}, ${state.name} passes.`);
        
        // Re-enable input area for the button, but guards will stop tab actions
        document.getElementById('input-area').style.opacity = 1;
        document.getElementById('input-area').style.pointerEvents = 'auto';
    }

    function log(html) {
        const logEl = document.getElementById('event-log');
        const div = document.createElement('div');
        div.className = 'event-entry';
        div.innerHTML = html;
        logEl.appendChild(div);
        
        logEl.scrollTop = logEl.scrollHeight;
        switchTab('log');
    }

    function updateUI() {
        // Wrap render calls in safety blocks to prevent entire UI freeze if one tab fails
        const safeRender = (fn, name) => {
            try { fn(); } catch(e) { console.error(`UI Render Failed [${name}]:`, e); }
        };

        try {
            for (let key in state.stats) {
                const val = state.stats[key];
                document.getElementById(`stat-${key}`).innerText = val;
                document.getElementById(`mod-${key}`).innerText = formatMod(getModifier(val));
            }

            let displayName = state.name;
            if (state.occupation) {
                 const career = CAREERS[state.occupation.id];
                 const title = career.ranks[state.occupation.rankIndex].title;
                 displayName = `${state.name} the ${title}`;
            } else if (state.socialClass === 'House') {
                 let rank = state.class.split(' ')[0]; 
                 if (rank === 'House') rank = 'Noble'; 
                 displayName = `${rank} ${state.name}`;
            }
            document.getElementById('display-name').innerText = displayName;

            document.getElementById('gold-display').innerText = state.gold;
            document.getElementById('social-display').innerText = state.socialClass;
            document.getElementById('display-class').innerText = state.class;
            document.getElementById('location-display').innerText = CITIES[state.location].name;
            document.getElementById('header-hp').innerText = `${state.health} / ${state.maxHealth} HP`;
            document.getElementById('hp-display').innerText = `${state.health} / ${state.maxHealth}`;
            document.getElementById('header-sp').innerText = `${state.sanity} / ${state.maxSanity} SP`;
            document.getElementById('sp-display').innerText = `${state.sanity} / ${state.maxSanity}`;
            document.getElementById('align-display').innerText = "True Neutral"; 
            
            document.getElementById('rep-renown').innerText = state.reputation.renown;
            document.getElementById('rep-honor').innerText = state.reputation.honor;
            document.getElementById('rep-piety').innerText = state.reputation.piety;
            document.getElementById('rep-infamy').innerText = state.reputation.infamy;
            
            // RENDER PLAYER GENES & APPEARANCE
            const ap = state.appearance;
            document.getElementById('appearance-display').innerText = `${ap.height}, ${ap.hair} Hair, ${ap.eyes} Eyes, ${ap.skin} Skin`;

            const geneList = document.getElementById('gene-list');
            if (ap.mutations && ap.mutations.length > 0) {
                geneList.innerHTML = ap.mutations.map(m => {
                    return `<span class="gene-tag mut-${m.rarity.toLowerCase()}" title="${m.desc}">${m.name}</span>`;
                }).join('');
            } else {
                geneList.innerHTML = '<span class="italic opacity-50">No distinctive mutations.</span>';
            }
        } catch(e) { console.error("UI Header Update Failed", e); }

        safeRender(renderHouseTab, 'House');
        safeRender(renderRelTab, 'Relations');
        safeRender(renderOccupationTab, 'Occupation');
        safeRender(renderInventory, 'Inventory');
        safeRender(renderMapTab, 'Map');
        safeRender(renderActivitiesTab, 'Activities');
        safeRender(renderMarketTab, 'Market'); 
        safeRender(renderCemeteryTab, 'Cemetery'); 
    }

    function addTrait(trait) {
        if(state.traits.includes(trait)) return;
        state.traits.push(trait);
        const list = document.getElementById('traits-list');
        if (state.traits.length === 1) list.innerHTML = '';
        const div = document.createElement('div');
        div.innerText = `‚Ä¢ ${trait}`;
        list.appendChild(div);
        log(`<strong>New Trait:</strong> ${trait}`);
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`${tab}-tab`).classList.remove('hidden');
        document.getElementById(`tab-${tab}`).classList.add('active');
    }

    init();
</script>
</body>
</html>
