<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Medieval Life | D20 Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=MedievalSharp&family=Spectral:ital,wght@0,400;0,700;1,400&display=swap');

        :root {
            --parchment: #f4e4bc;
            --ink: #2c1e16;
            --leather: #5d4037;
            --gold: #b8860b;
            --success: #15803d;
            --failure: #b91c1c;
            --stress: #9f1239;
            --sanity: #6b21a8;
            --royal: #4c1d95;
            
            /* Item Rarities */
            --common: #737373;
            --uncommon: #16a34a;
            --rare: #2563eb;
            --very-rare: #9333ea;
            --legendary: #ea580c;
            --artifact: #ca8a04;
        }

        body {
            background-color: #0f0f0f;
            color: var(--ink);
            font-family: 'Spectral', serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .parchment-container {
            background-color: var(--parchment);
            background-image: url("https://www.transparenttextures.com/patterns/p6-dark.png");
            
            /* Heavy Wooden Frame Construction - Thinned */
            border: 12px solid #2a1a10; /* Reduced from 20px */
            border-radius: 6px; 
            
            /* Layered Wood Accents via Shadow */
            box-shadow: 
                /* Inner edge of the frame (Parchment shadow) */
                inset 0 0 60px rgba(0,0,0,0.3),
                /* Inner Bevel (Lighter Wood) */
                inset 0 0 0 2px #5d4037,
                /* Outer Bevel (Lighter Wood Accent) */
                0 0 0 2px #5d4037,
                /* Outer Frame Body (Mid Oak) */
                0 0 0 6px #3e2723,
                /* Deep Drop Shadow */
                0 20px 60px rgba(0,0,0,0.9);

            max-width: 1000px;
            width: 95%;
            height: 95vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .header {
            font-family: 'MedievalSharp', cursive;
            border-bottom: 2px solid rgba(44, 30, 22, 0.2);
            padding: 1rem;
            text-align: center;
            background: rgba(0,0,0,0.03);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            align-items: center;
            padding-right: 3rem; /* Space for settings */
        }

        .settings-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--leather);
            transition: transform 0.3s;
            z-index: 60;
        }
        .settings-btn:hover { transform: rotate(90deg); }

        .main-layout {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 240px;
            border-right: 2px solid rgba(44, 30, 22, 0.1);
            display: flex;
            flex-direction: column;
            background: rgba(0,0,0,0.02);
            overflow-y: auto;
        }

        .tab-btn {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(44, 30, 22, 0.05);
            font-family: 'MedievalSharp', cursive;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover { background: rgba(0,0,0,0.05); }
        .tab-btn.active { background: rgba(255,255,255,0.4); border-left: 5px solid var(--leather); font-weight: bold; }
        
        /* NEW: Disabled state for tabs during events */
        .tab-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            filter: grayscale(1);
        }

        .content-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* D&D Stat Block Styling */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            padding: 1rem;
            background: rgba(93, 64, 55, 0.05);
            border-bottom: 1px solid rgba(44,30,22,0.1);
        }

        .stat-box {
            text-align: center;
            border: 2px solid var(--leather);
            border-radius: 8px;
            background: rgba(255,255,255,0.4);
            position: relative;
            padding-bottom: 4px;
        }

        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: bold;
            display: block;
            background: var(--leather);
            color: #f4e4bc;
            padding: 2px 0;
            border-radius: 4px 4px 0 0;
        }

        .stat-val { font-family: 'MedievalSharp'; font-size: 1.2rem; font-weight: bold; display: block; margin-top: 2px; }
        .stat-mod { font-size: 0.75rem; color: #666; font-weight: bold; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); background: #f4e4bc; padding: 0 4px; border: 1px solid var(--leather); border-radius: 4px; }

        #event-log {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            scroll-behavior: smooth;
        }

        .event-entry {
            border-left: 4px solid var(--leather);
            padding: 10px 16px;
            animation: fadeIn 0.5s ease-out;
            background: rgba(255,255,255,0.3);
            border-radius: 0 8px 8px 0;
            position: relative;
        }

        .event-entry.age-marker {
            border-left: 4px solid var(--gold);
            background: rgba(184, 134, 11, 0.1);
            text-align: center;
            font-family: 'MedievalSharp';
            font-size: 1.1rem;
        }
        
        .event-entry.npc-log {
            border-left: 4px solid #4b5563;
            background: rgba(0,0,0,0.03);
            font-size: 0.9rem;
            font-style: italic;
            padding: 6px 12px;
        }

        /* NEW: Knight Alert Style */
        .event-entry.knight-alert {
            border-left: 4px solid #1e3a8a; /* Royal Blue */
            background: rgba(30, 58, 138, 0.05);
            border-right: 1px solid #1e3a8a;
            position: relative;
        }
        .event-entry.knight-alert::after {
            content: 'üõ°Ô∏è';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.15;
            font-size: 2rem;
            pointer-events: none;
        }

        .dice-result {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85rem;
            margin-top: 4px;
        }
        .dice-success { background: #dcfce7; color: var(--success); border: 1px solid var(--success); }
        .dice-failure { background: #fee2e2; color: var(--failure); border: 1px solid var(--failure); }
        .dice-crit { background: var(--gold); color: white; text-shadow: 0 1px 2px black; border: 1px solid #854d0e; }

        .choices-area {
            padding: 1.5rem;
            border-top: 2px solid rgba(44, 30, 22, 0.2);
            background: rgba(0,0,0,0.04);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-btn {
            background: linear-gradient(to bottom, #5d4037, #3e2723);
            color: #f4e4bc;
            padding: 12px 16px;
            border-radius: 6px;
            font-family: 'MedievalSharp', cursive;
            text-align: left;
            width: 100%;
            transition: all 0.2s;
            border: 2px solid #2c1e16;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .choice-btn:hover:not(:disabled) { 
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            filter: brightness(1.1);
        }
        
        .choice-btn:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }
        .choice-btn.active-opt { border: 2px solid var(--gold); background: var(--leather); filter: brightness(1.2); }

        .dc-badge {
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* --- THE SOLID FOUNDATION (CSS FIX) --- */
        #input-area {
            margin-top: auto;
            background: var(--parchment);
            border-top: 4px solid var(--leather);
            box-shadow: 0 -10px 20px rgba(0,0,0,0.2);
            position: relative;
            z-index: 10;
            padding-bottom: 1rem; /* Extra padding for aesthetics */
        }

        /* Gene Styling */
        .gene-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-right: 4px;
            margin-bottom: 4px;
            border: 1px solid rgba(0,0,0,0.2);
        }
        .gene-house { background: var(--royal); color: white; border-color: var(--gold); }
        
        /* NEW MUTATION STYLES */
        .mut-common { background: #e5e7eb; color: #374151; border-color: #9ca3af; }
        .mut-uncommon { background: #dcfce7; color: #166534; border-color: #86efac; }
        .mut-rare { background: #dbeafe; color: #1e40af; border-color: #93c5fd; }
        .mut-epic { background: #f3e8ff; color: #6b21a8; border-color: #d8b4fe; border: 1px double #6b21a8; }
        .mut-legendary { background: #ffedd5; color: #9a3412; border-color: #fdba74; box-shadow: 0 0 5px #fdba74; animation: pulse 2s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }


        /* House System Styling */
        .house-crest { font-size: 4rem; margin-bottom: 1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .house-tier-royal { color: var(--royal); }
        
        .holding-card {
            background: rgba(255,255,255,0.5); border: 2px solid var(--leather); border-radius: 8px;
            padding: 1rem; text-align: left; margin-bottom: 1.5rem; position: relative;
        }
        .holding-icon { position: absolute; right: 10px; top: 5px; font-size: 2rem; opacity: 0.3; }
        
        .roster-group { margin-bottom: 1.5rem; }
        .roster-header { 
            font-family: 'MedievalSharp'; border-bottom: 2px solid rgba(93, 64, 55, 0.3); 
            margin-bottom: 0.5rem; text-align: left; font-size: 1.1rem; color: var(--leather); font-weight: bold;
        }
        .roster-item {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.3); border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 8px; transition: background 0.2s; cursor: pointer;
        }
        .roster-item:hover { background: rgba(255,255,255,0.6); }
        .roster-role { font-size: 0.8rem; opacity: 0.8; font-style: italic; }

        /* Advanced Family Tree (CSS Connectors) */
        .tree ul {
            padding-top: 20px; position: relative;
            transition: all 0.5s;
            display: flex; justify-content: center;
        }
        .tree li {
            float: left; text-align: center;
            list-style-type: none;
            position: relative;
            padding: 20px 5px 0 5px;
            transition: all 0.5s;
        }
        /* Connectors */
        .tree li::before, .tree li::after {
            content: ''; position: absolute; top: 0; right: 50%;
            border-top: 2px solid var(--leather);
            width: 50%; height: 20px;
        }
        .tree li::after {
            right: auto; left: 50%;
            border-left: 2px solid var(--leather);
        }
        .tree li:only-child::after, .tree li:only-child::before {
            display: none;
        }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after {
            border: 0 none;
        }
        .tree li:last-child::before {
            border-right: 2px solid var(--leather);
            border-radius: 0 5px 0 0;
        }
        .tree li:first-child::after {
            border-radius: 5px 0 0 0;
        }
        .tree ul ul::before {
            content: ''; position: absolute; top: 0; left: 50%;
            border-left: 2px solid var(--leather);
            width: 0; height: 20px;
        }
        /* Nodes */
        .tree-member {
            border: 2px solid var(--leather);
            background: rgba(255,255,255,0.6);
            padding: 8px;
            border-radius: 5px;
            display: inline-block;
            min-width: 100px;
            position: relative;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tree-member-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            background: rgba(255,255,255,0.2);
            padding: 5px;
            border-radius: 8px;
            border: 1px dashed rgba(93, 64, 55, 0.3);
        }
        .tree-member.player {
            border-color: var(--gold);
            background: #fff8e1;
            box-shadow: 0 0 10px rgba(184, 134, 11, 0.4);
        }
        .tree-member.dead { opacity: 0.7; filter: grayscale(1); border-style: dashed; }
        .tree-name { font-family: 'MedievalSharp'; font-weight: bold; font-size: 0.9rem; }
        .tree-role { font-size: 0.7rem; font-style: italic; }
        .tree-blood { 
            position: absolute; top: -8px; right: -8px; 
            background: #9f1239; color: white; font-size: 0.6rem; 
            padding: 2px 4px; border-radius: 4px; 
        }
        .tree-married {
            position: absolute; top: -8px; right: -8px; 
            background: #4b5563; color: white; font-size: 0.6rem; 
            padding: 2px 4px; border-radius: 4px;
        }
        .tree-crown {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            font-size: 1.2rem; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
            z-index: 20;
        }
        .tree-grave {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            font-size: 1.2rem; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
            z-index: 20;
        }

        /* Occupation Styling */
        .bar-container { height: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden; margin-top: 4px; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        .stress-fill { background: var(--stress); }
        .perf-fill { background: var(--success); }
        .friend-fill { background: #16a34a; }
        .enemy-fill { background: #dc2626; }
        .romance-fill { background: #db2777; }
        
        .job-card {
            border: 2px solid var(--leather);
            background: rgba(255,255,255,0.4);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .rel-card {
            background: rgba(255,255,255,0.3);
            border: 1px solid rgba(93, 64, 55, 0.2);
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .rel-card:hover { background: rgba(255,255,255,0.5); }

        .npc-card {
            background: rgba(255,255,255,0.3);
            border: 1px solid rgba(93, 64, 55, 0.2);
            padding: 8px 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 6px;
            text-align: left;
        }
        .npc-card:hover { background: rgba(255,255,255,0.5); }
        
        #rel-search-input {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--leather);
            border-radius: 4px;
            background: rgba(255,255,255,0.5);
            font-family: 'MedievalSharp';
            margin-bottom: 12px;
            outline: none;
        }
        #rel-search-input:focus {
            background: rgba(255,255,255,0.8);
            border-color: var(--gold);
        }

        /* Map Styling */
        .city-card {
            border: 1px solid var(--leather);
            background: rgba(255,255,255,0.4);
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .current-city { border-left: 5px solid var(--gold); background: rgba(255,255,255,0.6); }
        
        .map-visual-container {
            width: 100%; height: 300px; background: #e6d5b8; border: 2px solid var(--leather);
            margin-bottom: 1rem; position: relative; overflow: hidden;
            background-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M0 0 Q 50 50 100 0" stroke="rgba(0,0,0,0.05)" fill="none"/><path d="M0 100 Q 50 50 100 100" stroke="rgba(0,0,0,0.05)" fill="none"/></svg>');
        }
        
        .map-node {
            position: absolute; width: 12px; height: 12px; background: var(--leather); border-radius: 50%;
            transform: translate(-50%, -50%); cursor: pointer; transition: all 0.3s;
            border: 2px solid #f4e4bc; z-index: 10;
        }
        .map-node:hover { transform: translate(-50%, -50%) scale(1.5); background: var(--gold); }
        .map-node.active { background: var(--royal); width: 16px; height: 16px; border: 2px solid var(--gold); }
        
        .map-label {
            position: absolute; font-size: 10px; font-weight: bold; background: rgba(255,255,255,0.7);
            padding: 1px 4px; border-radius: 4px; pointer-events: none; white-space: nowrap;
            transform: translate(-50%, -150%);
        }

        /* Inventory Styling */
        .item-row { display: flex; align-items: center; justify-content: space-between; padding: 6px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .item-rarity-Common { color: var(--common); font-weight: bold; }
        .item-rarity-Uncommon { color: var(--uncommon); font-weight: bold; }
        .item-rarity-Rare { color: var(--rare); font-weight: bold; text-shadow: 0 0 1px rgba(37,99,235,0.2); }
        .item-rarity-VeryRare { color: var(--very-rare); font-weight: bold; text-shadow: 0 0 2px rgba(147,51,234,0.3); }
        .item-rarity-Legendary { color: var(--legendary); font-weight: bold; text-shadow: 0 0 3px rgba(234,88,12,0.4); }
        .item-rarity-Artifact { color: var(--artifact); font-weight: bold; text-shadow: 0 0 5px rgba(202,138,4,0.5); }

        /* Inventory Styling (Card Based) */
        .inventory-grid {
            display: block; /* UPDATED: Block layout to allow flow around float */
            padding: 4px;
        }

        .inventory-card {
            background: rgba(255,255,255,0.4);
            border: 2px solid var(--leather);
            border-radius: 6px;
            padding: 8px;
            display: inline-flex; /* UPDATED: Inline for flow */
            flex-direction: column;
            justify-content: space-between;
            width: 145px; /* Fixed width for consistency */
            margin: 5px; /* Spacing */
            vertical-align: top;
            min-height: 110px;
            transition: transform 0.2s, background 0.2s;
            position: relative;
        }

        .inventory-card:hover {
            transform: translateY(-2px);
            background: rgba(255,255,255,0.6);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .inventory-card {
            background: rgba(255,255,255,0.4);
            border: 2px solid var(--leather);
            border-radius: 6px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 110px;
            transition: transform 0.2s, background 0.2s;
            position: relative;
        }

        .inventory-card:hover {
            transform: translateY(-2px);
            background: rgba(255,255,255,0.6);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .inv-item-header {
            font-size: 0.85rem;
            font-weight: bold;
            margin-bottom: 4px;
            line-height: 1.1;
        }

        .inv-item-desc {
            font-size: 0.7rem;
            opacity: 0.8;
            font-style: italic;
            margin-bottom: 8px;
            flex-grow: 1;
        }

        .inv-rarity-badge {
            font-size: 0.6rem;
            text-transform: uppercase;
            font-weight: bold;
            opacity: 0.6;
            margin-bottom: 4px;
        }

        .inv-actions {
            display: flex;
            gap: 4px;
            margin-top: auto;
        }

        .inv-btn {
            flex: 1;
            padding: 4px;
            font-size: 0.7rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            border: 1px solid rgba(0,0,0,0.2);
            font-family: 'MedievalSharp';
            transition: opacity 0.2s;
        }
        .inv-btn:hover { opacity: 0.8; }

        .btn-use { background: #15803d; color: #f0fdf4; border-color: #14532d; }
        .btn-sell { background: #78350f; color: #fef3c7; border-color: #451a03; }

        /* Grave Styling */
        .grave-card {
            background: rgba(0,0,0,0.05);
            border: 2px solid #5d4037;
            border-radius: 8px 8px 0 0;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
            border-bottom: 4px solid #2c1e16;
        }
        .grave-stone {
            text-align: center;
            border: 2px solid #2c1e16;
            background: #a8a29e;
            padding: 1rem;
            border-radius: 50% 50% 0 0;
            width: 150px;
            margin: 0 auto 1rem auto;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            color: #2c1e16;
        }

        /* Activities Styling */
        .act-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .act-btn { text-align: center; padding: 15px 5px; flex-direction: column; gap: 5px; height: 100px; justify-content: center; }
        .act-icon { font-size: 2rem; display: block; margin-bottom: 4px; }

        /* Market Styling */
        .market-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .shop-card {
            background: rgba(255,255,255,0.4); border: 2px solid var(--leather);
            border-radius: 8px; padding: 10px; cursor: pointer; transition: transform 0.2s;
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .shop-card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.6); }
        .shop-icon { font-size: 2.5rem; margin-bottom: 5px; }
        .shop-name { font-family: 'MedievalSharp'; font-weight: bold; font-size: 1.1rem; color: var(--leather); }
        .vendor-name { font-size: 0.8rem; font-style: italic; opacity: 0.8; }
        
        .item-card {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.3);
            margin-bottom: 4px; border-radius: 4px;
        }
        .item-card.sold-out { opacity: 0.5; background: rgba(0,0,0,0.05); }
        .buy-btn {
            background: var(--leather); color: #f4e4bc; border: none; padding: 4px 8px;
            font-family: 'MedievalSharp'; cursor: pointer; border-radius: 4px; font-size: 0.8rem;
        }
        .buy-btn:hover { background: var(--gold); color: var(--ink); }
        .buy-btn:disabled { background: #555; cursor: not-allowed; color: #ccc; }

        /* EQUIPPED SECTION STYLING */
        .paper-doll-grid {
            display: grid;
            grid-template-areas:
                ". head ."
                "main armor off"
                ". acc .";
            gap: 15px;
            justify-content: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--leather);
            background: rgba(0,0,0,0.03);
            padding: 1rem;
            border-radius: 8px;
            width: fit-content;
            margin: 0 auto 1.5rem auto;
        }

        .equip-slot {
            width: 70px;
            height: 70px;
            border: 2px dashed var(--leather);
            background: rgba(255,255,255,0.2);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        .equip-slot:hover { background: rgba(255,255,255,0.4); border-color: var(--gold); }
        .equip-slot.filled { border-style: solid; background: rgba(255,255,255,0.5); border-color: var(--leather); }
        .equip-label { 
            position: absolute; bottom: -18px; 
            font-size: 0.6rem; text-transform: uppercase; font-weight: bold; 
            width: 120%; text-align: center; opacity: 0.7;
        }
        .equip-icon { font-size: 1.8rem; line-height: 1; }
        .equip-remove {
            position: absolute; top: -5px; right: -5px;
            background: var(--failure); color: white;
            border-radius: 50%; width: 16px; height: 16px;
            font-size: 10px; display: flex; align-items: center; justify-content: center;
            border: 1px solid white; display: none;
        }
        .equip-slot:hover .equip-remove { display: flex; }

        /* Grid Area Assignments */
        .slot-head { grid-area: head; }
        .slot-armor { grid-area: armor; }
        .slot-mainHand { grid-area: main; }
        .slot-offHand { grid-area: off; }
        .slot-accessory { grid-area: acc; }

        /* COMBAT STYLING */
        #combat-log-area {
            font-family: 'Spectral', serif;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        #combat-log-area div {
            margin-bottom: 4px;
            padding-bottom: 4px;
            border-bottom: 1px dashed rgba(0,0,0,0.1);
        }
        #combat-log-area div:last-child {
            border-bottom: none;
            font-weight: bold;
            color: var(--leather);
        }

        /* Utility */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(2px);
        }
        .modal-box {
            background: var(--parchment);
            border: 4px solid var(--leather);
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            border-radius: 8px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .creation-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--parchment); z-index: 50;
            display: flex; flex-direction: column; padding: 2rem;
            text-align: center; overflow-y: auto;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--leather); border-radius: 4px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="parchment-container">
    <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h2 class="text-3xl font-medieval mb-4">Settings</h2>
            <p class="mb-6 italic">Manage your journey.</p>
            <div class="flex flex-col gap-3">
                <button id="btn-sound-toggle" onclick="toggleSoundSetting()" class="choice-btn text-center justify-center">Sound Effects: ON</button>
                <button onclick="restartGame()" class="choice-btn text-center justify-center bg-red-800 text-white">Restart Chronicle (Delete Save)</button>
                <button onclick="closeSettings()" class="choice-btn text-center justify-center">Return to Game</button>
            </div>
        </div>
    </div>

    <!-- Message Modal (Generic) -->
    <div id="msg-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h2 id="msg-title" class="text-2xl font-medieval mb-2 text-amber-900">Message</h2>
            <p id="msg-text" class="mb-6 italic">Details here.</p>
            <button onclick="document.getElementById('msg-modal').classList.add('hidden')" class="choice-btn text-center justify-center">Close</button>
        </div>
    </div>
    
    <!-- Confirm Modal (Evil Acts) -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-box border-red-800">
            <h2 class="text-3xl font-medieval mb-2 text-red-900">Dark Deed</h2>
            <p class="mb-6 italic" id="confirm-text">This is an evil act? Are you sure?</p>
            <div class="flex gap-4 justify-center">
                <button id="confirm-yes-btn" class="choice-btn w-32 justify-center bg-red-900 text-white">Commit Evil</button>
                <button onclick="closeConfirm()" class="choice-btn w-32 justify-center">Hesitate</button>
            </div>
        </div>
    </div>

    <!-- Age Warning Modal -->
    <div id="age-modal" class="modal-overlay hidden">
        <div class="modal-box border-red-800">
            <h2 class="text-3xl font-medieval mb-2 text-red-900">Too Young</h2>
            <p class="mb-6 italic" id="age-warning-text">You are not old enough for this.</p>
            <button onclick="document.getElementById('age-modal').classList.add('hidden')" class="choice-btn text-center justify-center">I understand</button>
        </div>
    </div>

    <!-- NEW: Birth Modal -->
    <div id="birth-modal" class="modal-overlay hidden">
        <div class="modal-box border-green-900 relative">
            <h2 class="text-4xl font-medieval mb-2 text-green-900">A Child is Born!</h2>
            <div id="birth-content" class="mb-6">
                <!-- Injected via JS -->
            </div>
            
            <div class="mb-2 text-left text-xs font-bold uppercase opacity-70">Name Your Heir</div>
            <input type="text" id="birth-name-input" class="w-full p-3 border-2 border-[#5d4037] bg-[#fdf6e3] text-center text-xl font-bold mb-6 focus:outline-none focus:border-green-700 rounded font-medieval" placeholder="Enter Name">
            
            <button onclick="confirmBirth()" class="choice-btn w-full justify-center bg-green-900 text-white font-bold text-lg">Welcome to the Family</button>
        </div>
    </div>

    <!-- NEW: Trait Info Modal -->
    <div id="trait-modal" class="modal-overlay hidden" style="z-index: 150;">
        <div class="modal-box border-amber-900 relative">
            <button onclick="document.getElementById('trait-modal').classList.add('hidden')" class="absolute top-2 right-4 text-xl font-bold hover:text-red-800">X</button>
            <h2 id="trait-modal-title" class="text-3xl font-medieval mb-2 text-amber-900">Trait Name</h2>
            <div class="flex justify-center mb-4">
                <span id="trait-modal-badge" class="gene-tag text-sm px-3 py-1 shadow-sm">Common</span>
            </div>
            <p class="mb-6 italic text-lg leading-relaxed px-4" id="trait-modal-desc">Description goes here.</p>
            <button onclick="document.getElementById('trait-modal').classList.add('hidden')" class="choice-btn text-center justify-center">Close</button>
        </div>
    </div>

    <!-- Shop Modal -->
    <div id="shop-modal" class="modal-overlay hidden">
        <div class="modal-box text-left relative">
            <button onclick="closeShop()" class="absolute top-2 right-4 text-xl font-bold">X</button>
            <h2 class="text-3xl font-medieval mb-2 text-center">Marketplace</h2>
            <div id="shop-keeper-area" class="mb-4 p-2 bg-amber-900/10 rounded border border-amber-900/20 text-center">
                <!-- Keeper injected here -->
            </div>
            <div id="shop-content" class="space-y-2"></div>
        </div>
    </div>

    <!-- NEW: Transaction Modal -->
    <div id="trans-modal" class="modal-overlay hidden">
        <div class="modal-box border-amber-900">
            <h2 id="trans-title" class="text-3xl font-medieval mb-2 text-amber-900">Treasury</h2>
            <p id="trans-text" class="mb-4 italic">How much gold?</p>
            <div class="flex justify-center mb-4">
                <input type="number" id="trans-input" class="w-1/2 p-2 border-2 border-[#5d4037] text-center font-medieval text-xl bg-[#fdf6e3] rounded" placeholder="0" min="1">
            </div>
            <div class="flex justify-center gap-4">
                <button onclick="confirmTransaction()" class="choice-btn w-32 justify-center bg-green-900 text-white">Confirm</button>
                <button onclick="document.getElementById('trans-modal').classList.add('hidden')" class="choice-btn w-32 justify-center">Cancel</button>
            </div>
        </div>
    </div>

    <!-- NEW: Combat Modal -->
    <div id="combat-modal" class="modal-overlay hidden" style="z-index: 200;">
        <div class="modal-box border-red-900 w-full max-w-2xl relative bg-[#f4e4bc]">
            <!-- Header -->
            <div class="text-center border-b-2 border-red-900/30 pb-2 mb-4 relative">
                <h2 id="combat-title" class="text-4xl font-medieval text-red-900 drop-shadow-sm">‚öîÔ∏è Combat ‚öîÔ∏è</h2>
                <div id="combat-round" class="absolute right-0 bottom-0 text-xs font-bold opacity-50">Round 1</div>
            </div>
            
            <!-- Arena / Status -->
            <div class="grid grid-cols-2 gap-8 mb-6">
                <!-- Player Side -->
                <div id="combat-player" class="text-center bg-white/20 p-2 rounded border border-black/10 transition-transform">
                    <h3 class="font-bold text-xl mb-1 font-medieval" id="combat-player-name">Hero</h3>
                    <div class="w-full bg-black/20 h-6 rounded border border-black/30 relative overflow-hidden">
                        <div id="combat-player-hp-bar" class="h-full bg-green-700 transition-all duration-500" style="width: 100%;"></div>
                        <span id="combat-player-hp-text" class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white drop-shadow-md">20/20</span>
                    </div>
                    <div id="combat-player-stats" class="text-xs mt-1 font-bold opacity-70">AC: 10 | ATK: +0</div>
                </div>

                <!-- Enemy Side -->
                <div id="combat-enemy" class="text-center bg-white/20 p-2 rounded border border-black/10 transition-transform">
                    <h3 class="font-bold text-xl mb-1 font-medieval" id="combat-enemy-name">Enemy</h3>
                    <div class="w-full bg-black/20 h-6 rounded border border-black/30 relative overflow-hidden">
                        <div id="combat-enemy-hp-bar" class="h-full bg-red-800 transition-all duration-500" style="width: 100%;"></div>
                        <span id="combat-enemy-hp-text" class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white drop-shadow-md">?/?</span>
                    </div>
                    <div id="combat-enemy-status" class="text-xs mt-1 italic opacity-70">Aggressive</div>
                </div>
            </div>

            <!-- Log -->
            <div id="combat-log-area" class="h-48 overflow-y-auto bg-black/5 border-2 border-[#5d4037] p-3 mb-4 text-left shadow-inner rounded scrollbar-thin">
                <div class="italic opacity-50 text-center mt-20">The battle begins...</div>
            </div>

            <!-- Controls -->
            <div id="combat-controls" class="grid grid-cols-2 gap-3 pt-2 border-t-2 border-red-900/30">
                <button onclick="CombatEngine.playerAction('attack')" class="choice-btn justify-center bg-red-900 text-white border-red-950 hover:bg-red-800 text-lg">‚öîÔ∏è Attack</button>
                <button onclick="CombatEngine.playerAction('defend')" class="choice-btn justify-center bg-blue-900 text-white border-blue-950 hover:bg-blue-800">üõ°Ô∏è Defend</button>
                <button onclick="CombatEngine.playerAction('item')" class="choice-btn justify-center">üéí Item (Potion)</button>
                <button onclick="CombatEngine.playerAction('flee')" class="choice-btn justify-center opacity-80 hover:opacity-100">üèÉ Flee</button>
            </div>
        </div>
    </div>

    <!-- NPC Modal -->
    <div id="npc-modal" class="modal-overlay hidden">
        <div class="modal-box text-left relative">
            <button onclick="closeNPC()" class="absolute top-2 right-4 text-xl font-bold">X</button>
            <div id="npc-content"></div>
        </div>
    </div>

    <!-- Lore Modal -->
    <div id="lore-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h2 class="text-4xl font-medieval mb-4 text-amber-900">The Kingdom of Chep</h2>
            <div class="text-left space-y-4 mb-6 text-sm max-h-60 overflow-y-auto pr-2" style="font-family: 'Spectral', serif;">
                <p>Once upon a time, long before the walls of Chep rose white and gold against the sun, there was only the <strong>Age of Ash</strong>.</p>
                <p>For four hundred years, the sky wept soot. Brother slew brother for a scrap of bread, and Warlords built thrones upon mounds of bone. The gods were silent, and hope was a ghost.</p>
                <p>Then, a star fell to earth. Not a stone of fire, but a shard of pure, singing light. From the crater walked <strong>Ren</strong>‚Äîno king, but a hero. He forged the star into <strong>Lumina</strong>, the Blade of Dawn.</p>
                <p>Ren marched to Dread Peak, where the Seven Warlords gathered to divide the world. He did not strike them. Instead, he swung Lumina at the mountain itself, cleaving the peak in twain. The earth shook, and the Warlords, seeing true power, fell to their knees.</p>
                <p>There, in the dust, the <strong>Oath of Unity</strong> was sworn. Ren became the first King of <strong>House Chep</strong>. The Warlords became the <strong>Seven Greater Houses</strong>, sworn to protect the peace they once destroyed.</p>
                <p>And so the Kingdom of Chep was born. But fairytales end, and history bleeds. The starlight is fading, traveler. What will you do in the dark?</p>
            </div>
            <button onclick="enterWorld()" class="choice-btn text-center justify-center font-bold text-lg">Enter the World</button>
        </div>
    </div>

    <!-- Character Creation Overlay -->
    <div id="creation-screen" class="creation-screen">
        <h2 class="text-5xl font-bold mb-2 text-amber-900" style="font-family: 'MedievalSharp';">A Medieval Life</h2>
        <p class="italic mb-8 text-lg opacity-70">A game by Juanse Gutierrez.</p>
        
        <div class="max-w-xl mx-auto w-full bg-white/40 p-6 rounded-lg border-2 border-[#5d4037] shadow-xl">
            <h3 class="text-xl font-bold mb-4">Forge Your Destiny</h3>
            <input type="text" id="char-name" placeholder="Enter First Name" class="w-full p-3 border-2 border-[#5d4037] bg-[#fdf6e3] text-center text-xl font-bold mb-6 focus:outline-none focus:border-amber-600 rounded">
            
            <div class="flex justify-center gap-4 mb-6">
                <!-- UPDATED: Added opacity-60 to Male button -->
                <button id="gender-m" class="choice-btn w-32 justify-center opacity-60" onclick="setGender('Male')">Male</button>
                <button id="gender-f" class="choice-btn w-32 justify-center opacity-60" onclick="setGender('Female')">Female</button>
            </div>

            <div class="text-left mb-2 font-bold flex justify-between">
                <span>Ability Scores</span>
                <span class="text-xs font-normal italic">Standard Array (15, 14, 13, 12, 10, 8) assigned randomly</span>
            </div>
            
            <div id="creation-stats" class="grid grid-cols-3 gap-2 mb-4">
                <!-- Stats injected here -->
            </div>

            <button onclick="rerollStats()" class="choice-btn w-full justify-center mb-6">Reroll Stats üé≤</button>

            <div class="border-t border-black/20 pt-4 mb-6">
                <h4 class="font-bold mb-2">Social Origin</h4>
                <div class="flex gap-2">
                    <!-- UPDATED: Removed active-opt, added opacity-60 -->
                    <button id="origin-commoner" class="choice-btn text-sm justify-center opacity-60 flex-1" onclick="setOrigin('Commoner')">Humble Beginnings</button>
                    <button id="origin-house" class="choice-btn text-sm justify-center opacity-60 flex-1" onclick="setOrigin('House')">Noble Bloodline (Roll)</button>
                </div>
            </div>

            <button id="start-btn" class="w-full bg-[#8b4513] text-white font-medieval text-2xl py-3 rounded border-2 border-[#2c1e16] hover:bg-[#a0522d] transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled onclick="startGame()">Begin Chronicle</button>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="text-left">
            <h1 class="text-xl font-bold" id="display-name">Unknown Soul</h1>
            <p class="text-xs opacity-70 font-bold text-amber-900" id="display-class">Commoner</p>
        </div>
        <div class="text-center flex flex-col justify-center">
            <span id="header-hp" class="text-red-900 font-bold text-lg drop-shadow-md" title="Health Points">10/10 Health Points</span>
            <span id="header-sp" class="text-purple-800 font-bold text-xs drop-shadow-md" title="Sanity Points">8/8 Sanity Points</span>
        </div>
        <div class="text-right">
            <h2 class="text-2xl font-bold text-amber-900" id="year-display">Year 0</h2>
            <p class="text-xs">Age: <span id="age-display">0</span></p>
        </div>
    </div>

    <!-- Main Game Area -->
    <div class="main-layout">
        <div class="sidebar">
            <div id="tab-log" class="tab-btn active" onclick="switchTab('log')">üìú Chronicle</div>
            <div id="tab-char" class="tab-btn" onclick="switchTab('char')">üë§ Character</div>
            <div id="tab-inv" class="tab-btn" onclick="switchTab('inv')">üéí Inventory</div>
            <div id="tab-quest" class="tab-btn" onclick="switchTab('quest')">üõ°Ô∏è Quests</div>
            <div id="tab-house" class="tab-btn" onclick="switchTab('house')">üè∞ House</div>
            <div id="tab-rel" class="tab-btn" onclick="switchTab('rel')">‚ù§Ô∏è Relationships</div>
            <div id="tab-occ" class="tab-btn" onclick="switchTab('occ')">‚öíÔ∏è Occupation</div>
            <div id="tab-market" class="tab-btn" onclick="switchTab('market')">‚öñÔ∏è Market</div>
            <div id="tab-act" class="tab-btn" onclick="switchTab('act')">üé≠ Activities</div>
            <div id="tab-map" class="tab-btn" onclick="switchTab('map')">üó∫Ô∏è Map</div>
            <div id="tab-cem" class="tab-btn" onclick="switchTab('cem')">ü™¶ Cemetery</div>
            
            <!-- REMOVED UNLOCKS SECTION HERE -->
        </div>

        <div class="content-area">
            <!-- D&D Stat Block -->
            <div class="stats-grid">
                <div class="stat-box"><span class="stat-label">STRENGTH</span><span id="stat-str" class="stat-val">10</span><span id="mod-str" class="stat-mod">+0</span></div>
                <div class="stat-box"><span class="stat-label">DEXTERITY</span><span id="stat-dex" class="stat-val">10</span><span id="mod-dex" class="stat-mod">+0</span></div>
                <div class="stat-box"><span class="stat-label">CONSTITUTION</span><span id="stat-con" class="stat-val">10</span><span id="mod-con" class="stat-mod">+0</span></div>
                <div class="stat-box"><span class="stat-label">INTELLIGENCE</span><span id="stat-int" class="stat-val">10</span><span id="mod-int" class="stat-mod">+0</span></div>
                <div class="stat-box"><span class="stat-label">WISDOM</span><span id="stat-wis" class="stat-val">10</span><span id="mod-wis" class="stat-mod">+0</span></div>
                <div class="stat-box"><span class="stat-label">CHARISMA</span><span id="stat-cha" class="stat-val">10</span><span id="mod-cha" class="stat-mod">+0</span></div>
            </div>

            <!-- Tab: Log (Main Gameplay) -->
            <div id="log-tab" class="tab-content flex-grow flex flex-col overflow-hidden">
                <div id="event-log"></div>
                <div id="input-area" class="mt-auto">
                    <div id="decision-prompt" class="px-6 py-3 bg-amber-900/10 font-bold text-amber-900 border-t border-black/10 font-medieval text-lg">
                        Fate awaits...
                    </div>
                    <div id="choices-container" class="choices-area">
                        <!-- Buttons injected here -->
                    </div>
                </div>
            </div>

            <!-- Tab: Activities -->
            <div id="act-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-2 border-b border-black/20 pb-2">Activities</h2>
                <div id="act-content" class="act-grid"></div>
            </div>

            <!-- Tab: Character Sheet -->
            <div id="char-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-4 border-b border-black/20 pb-2">Character Sheet</h2>
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-bold mb-2">Vitals</h3>
                        <p><strong>Health:</strong> <span id="hp-display" class="text-green-800 font-bold">10 / 10</span></p>
                        <p><strong>Armor Class:</strong> <span id="armor-display" class="text-blue-900 font-bold">10</span></p>
                        <p><strong>Sanity:</strong> <span id="sp-display" class="text-purple-800 font-bold">8 / 8</span></p>
                        <p><strong>Sex:</strong> <span id="sex-display">Unknown</span></p>
                        <p><strong>Gold:</strong> <span id="gold-display">0</span> GP</p>
                        <p><strong>Social Reality:</strong> <span id="social-display">Commoner</span></p>
                        <!-- ARCANE UPDATE: Liege Display Placeholder -->
                        <p id="liege-container" class="hidden"><strong>Liege Lord:</strong> <span id="liege-display" class="text-royal font-bold"></span></p>
                        
                        <p><strong>Location:</strong> <span id="location-display">Chep</span></p>
                        <p><strong>Alignment:</strong> <span id="align-display">True Neutral</span></p>
                        
                        <h3 class="font-bold mt-4 mb-2 border-t border-black/10 pt-2">Reputation & Fame</h3>
                        <div class="text-sm">
                             <div class="flex justify-between"><span>üëë Renown:</span> <span id="rep-renown">0</span></div>
                             <div class="flex justify-between"><span>‚öîÔ∏è Honor:</span> <span id="rep-honor">0</span></div>
                             <div class="flex justify-between"><span>üôè Piety:</span> <span id="rep-piety">0</span></div>
                             <div class="flex justify-between text-red-800"><span>‚ò†Ô∏è Infamy:</span> <span id="rep-infamy">0</span></div>
                        </div>
                    </div>
                    <div>
                         <h3 class="font-bold mb-2">Appearance & Genetics</h3>
                         <div id="appearance-display" class="text-sm mb-2 p-2 bg-white/30 rounded border border-black/10">
                             <!-- Injected via JS -->
                         </div>
                         <div id="gene-list" class="text-sm italic mb-4">No mutations.</div>

                        <h3 class="font-bold mb-2 border-t border-black/10 pt-2">Traits & Feats</h3>
                        <div id="traits-list" class="text-sm space-y-1 italic">None yet...</div>

                        <!-- NEW: HONORIFICS SECTION -->
                        <h3 class="font-bold mb-2 border-t border-black/10 pt-2">Titles & Honorifics</h3>
                        <div id="honorific-list" class="flex flex-wrap gap-2 text-sm">
                            <span class="italic opacity-50">No titles yet.</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Map -->
            <div id="map-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-4 border-b border-black/20 pb-2">Kingdom of Chep</h2>
                <div id="map-visual" class="map-visual-container"></div>
                <div id="map-content"></div>
            </div>

            <!-- Tab: House / Lineage -->
            <div id="house-tab" class="tab-content hidden p-6 overflow-y-auto text-center">
                <!-- Content injected via JS -->
                <div id="house-content"></div>
            </div>

            <!-- Tab: Relationships -->
            <div id="rel-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-4 border-b border-black/20 pb-2">Relationships</h2>
                <input type="text" id="rel-search-input" onkeyup="renderRelTab()" placeholder="Search names..." class="mb-4 p-2 w-full border border-[#5d4037] rounded bg-white/50 font-medieval">
                <p class="text-xs italic mb-2">Click on a person to view their details.</p>
                <div id="rel-content"></div>
            </div>

            <!-- Tab: Occupation -->
            <div id="occ-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-4 border-b border-black/20 pb-2">Occupation & Trade</h2>
                <div id="occ-content"></div>
            </div>
            
             <!-- Tab: Inventory -->
             <div id="inv-tab" class="tab-content hidden p-6 flex flex-col h-full overflow-hidden">
                <h2 class="text-3xl font-medieval mb-4 border-b border-black/20 pb-2 flex-shrink-0">Inventory</h2>
                <div id="inventory-list" class="flex-grow overflow-hidden">
                    <p class="italic opacity-50 text-center mt-10">Your satchel is empty.</p>
                </div>
            </div>

            <!-- Tab: Quests -->
            <div id="quest-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-4 border-b border-black/20 pb-2">Quest Log</h2>
                <div id="quest-list" class="flex flex-col gap-4">
                    <div class="bg-amber-900/5 p-4 rounded border border-amber-900/10 text-center italic opacity-70">
                        The world is wide, but your path is currently clear of obligation.
                    </div>
                </div>
            </div>

            <!-- Tab: Market (NEW) -->
            <div id="market-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-4 border-b border-black/20 pb-2">City Market</h2>
                <div id="market-view-main">
                    <p class="italic mb-4 text-sm" id="market-desc">The stalls are bustling with activity.</p>
                    <div id="market-content" class="market-grid"></div>
                </div>
                <div id="market-view-shop" class="hidden">
                    <button onclick="renderMarketTab()" class="mb-4 text-sm underline text-amber-900">‚Üê Back to Market</button>
                    <div id="shop-detail-content"></div>
                </div>
            </div>

            <!-- Tab: Cemetery -->
            <div id="cem-tab" class="tab-content hidden p-6 overflow-y-auto">
                <h2 class="text-3xl font-medieval mb-4 border-b border-black/20 pb-2">Family Cemetery</h2>
                <p class="italic mb-4 text-sm">Here lie those who came before. Tread carefully.</p>
                <div id="cemetery-content"></div>
            </div>
        </div>
    </div>
</div>

    <script>
    /* --- ARCANE ARCHITECT'S ENGINE --- */

    // 0. AUDIO ENGINE & CONFIRMATION SYSTEM
    const AudioEngine = {
        ctx: null,
        init: function() {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
        },
        pulse: function() {
            if(!state.settings.sound) return; // Check setting
            if(!this.ctx) this.init();
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(100, this.ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(50, this.ctx.currentTime + 0.3);
            gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start();
            osc.stop(this.ctx.currentTime + 0.3);
        }
    };
    
    // 0.5 NEW GENETIC ENGINE: PHENOTYPES & MUTATIONS
    const COSMETICS = {
        hair: ['Brown', 'Black', 'Blonde', 'Red', 'Grey', 'White', 'Auburn', 'Chestnut', 'Straw'],
        eyes: ['Brown', 'Blue', 'Green', 'Hazel', 'Grey', 'Amber', 'Dark'],
        skin: ['Pale', 'Fair', 'Olive', 'Tan', 'Brown', 'Dark', 'Ebony', 'Ruddy'],
        height: ['Dwarf', 'Short', 'Average', 'Tall', 'Towering', 'Giant']
    };

    const HOUSE_PHENOTYPES = {
        "Chep": { hair: "Platinum", eyes: "Violet", skin: "Fair" },
        "Valdoria": { hair: "Golden", eyes: "Amber", skin: "Tan" },
        "Thalor": { hair: "Black", eyes: "Sea-Green", skin: "Pale" },
        "Grimward": { hair: "Raven", eyes: "Ice-Blue", skin: "Pale" },
        "Sunstrider": { hair: "Fiery Red", eyes: "Emerald", skin: "Olive" },
        "Ironheart": { hair: "Ash-Grey", eyes: "Steel-Grey", skin: "Fair" },
        "Moonshadow": { hair: "Silver", eyes: "Black", skin: "Pale" },
        "Stormbreaker": { hair: "White", eyes: "Electric Blue", skin: "Fair" }
    };

    const MUTATION_POOL = [
    // ===== COMMON (Cosmetic, rumor-tier) =====
    { name: "Birthmark", rarity: "Common", desc: "A distinct mark on the skin." },
    { name: "Freckles", rarity: "Common", desc: "Sun-kissed spots across the face." },
    { name: "Cleft Chin", rarity: "Common", desc: "A prominent, noble jawline." },
    { name: "Widow's Peak", rarity: "Common", desc: "A sharp V-shaped hairline." },
    { name: "Thick Eyebrows", rarity: "Common", desc: "Dense, expressive brows." },
    { name: "Long Lashes", rarity: "Common", desc: "Unnaturally long eyelashes." },
    { name: "Crooked Smile", rarity: "Common", desc: "A slightly uneven grin." },
    { name: "Unusual Voice", rarity: "Common", desc: "A voice that sounds rough, airy, or oddly musical." },
    { name: "Asymmetrical Face", rarity: "Common", desc: "Subtle imbalance in facial features." },

    // ===== UNCOMMON (Noticeable, Minor Stats) =====
    { name: "Heterochromia", rarity: "Uncommon", desc: "Eyes of two different colors. (+1 CHA)", stats: { cha: 1 } },
    { name: "Albinism", rarity: "Uncommon", desc: "Complete lack of pigment. (-1 STR, +2 INT)", stats: { str: -1, int: 2 } },
    { name: "Vitiligo", rarity: "Uncommon", desc: "Patches of unpigmented skin. (+1 CHA)", stats: { cha: 1 } },
    { name: "Sharp Teeth", rarity: "Uncommon", desc: "Slightly pointed canines. (+1 STR)", stats: { str: 1 } },
    { name: "Double Pupil", rarity: "Uncommon", desc: "Two pupils in one eye. (+1 WIS)", stats: { wis: 1 } },
    { name: "Extended Canines", rarity: "Uncommon", desc: "Fangs just long enough to be unsettling. (+1 CHA)", stats: { cha: 1 } },
    { name: "Unusual Ear Shape", rarity: "Uncommon", desc: "Ears taper, curl, or angle unnaturally. (+1 WIS)", stats: { wis: 1 } },
    { name: "Heat-Resistant Skin", rarity: "Uncommon", desc: "Skin rarely blisters or burns. (+1 CON)", stats: { con: 1 } },
    { name: "Flexible Joints", rarity: "Uncommon", desc: "Double-jointed fingers and elbows. (+1 DEX)", stats: { dex: 1 } },
    { name: "Resonant Voice", rarity: "Uncommon", desc: "A booming voice that commands attention. (+1 CHA)", stats: { cha: 1 } },
    { name: "Nocturnal Eyes", rarity: "Uncommon", desc: "Eyes that reflect light in the dark. (+1 WIS)", stats: { wis: 1 } },

    // ===== RARE (Distinctive, Strong Stats) =====
    { name: "Webbed Fingers", rarity: "Rare", desc: "Skin between fingers, good for swimming. (+2 DEX)", stats: { dex: 2 } },
    { name: "Cat Eyes", rarity: "Rare", desc: "Vertical slit pupils. Night vision. (+2 WIS)", stats: { wis: 2 } },
    { name: "Forked Tongue", rarity: "Rare", desc: "A split tongue capable of precise movement. (+1 CHA, +1 INT)", stats: { cha: 1, int: 1 } },
    { name: "Stone Nails", rarity: "Rare", desc: "Hard, grayish nails resistant to breakage. (+2 STR)", stats: { str: 2 } },
    { name: "Thickened Bones", rarity: "Rare", desc: "Bones are unusually dense and heavy. (+2 CON)", stats: { con: 2 } },
    { name: "Shadow Veins", rarity: "Rare", desc: "Dark veins visible beneath the skin. (+2 INT)", stats: { int: 2 } },
    { name: "Iron Stomach", rarity: "Rare", desc: "Can digest almost anything without sickness. (+2 CON)", stats: { con: 2 } },
    { name: "Adrenaline Glands", rarity: "Rare", desc: "Bursts of incredible speed in danger. (+2 DEX)", stats: { dex: 2 } },
    { name: "Eidetic Memory", rarity: "Rare", desc: "Perfect recall of visual information. (+2 INT)", stats: { int: 2 } },

    // ===== EPIC (Unnatural, Major Stats) =====
    { name: "Scales", rarity: "Epic", desc: "Patches of hardened, scaled skin. (+2 AC, +1 CON)", stats: { ac: 2, con: 1 } }, 
    { name: "Bioluminescence", rarity: "Epic", desc: "Skin glows faintly. Mesmerizing. (+3 CHA)", stats: { cha: 3 } },
    { name: "Third Eye", rarity: "Epic", desc: "A dormant eye in the center of the forehead. (+3 WIS)", stats: { wis: 3 } },
    { name: "Horns", rarity: "Epic", desc: "Bony protrusions on the forehead. (+2 STR, +1 CON)", stats: { str: 2, con: 1 } },
    { name: "Giant Blood", rarity: "Epic", desc: "Massive stature, towering over others. (+3 STR, +1 CON, -1 DEX)", stats: { str: 3, con: 1, dex: -1 } },
    { name: "Regeneration", rarity: "Epic", desc: "Wounds close visibly fast. (+3 CON)", stats: { con: 3 } },

    // ===== LEGENDARY (Myth-tier, Abilities) =====
    { name: "Seer", rarity: "Legendary", desc: "Innate ability to perceive time. (+4 WIS, Psychic Blast)", stats: { wis: 4 }, combatAbility: 'psychic' },
    { name: "Fire Blood", rarity: "Legendary", desc: "Dragon ancestry. Exhale flames. (+2 STR, +2 CHA, Fire Breath)", stats: { str: 2, cha: 2 }, combatAbility: 'firebreath' },
    { name: "Titan's Strength", rarity: "Legendary", desc: "Muscles like steel cables. (+5 STR)", stats: { str: 5 } },
    { name: "Shadow Soul", rarity: "Legendary", desc: "One with the darkness. (+5 DEX)", stats: { dex: 5 } },

    // ===== DEFECTS (Inbreeding/Bad Luck) =====
    { name: "Habsburg Jaw", rarity: "Defect", desc: "A painfully prominent underbite. (-2 CHA)", stats: { cha: -2 } },
    { name: "Hemophilia", rarity: "Defect", desc: "Blood does not clot. (-2 CON)", stats: { con: -2 } },
    { name: "Clubfoot", rarity: "Defect", desc: "A twisted foot. (-2 DEX)", stats: { dex: -2 } },
    { name: "Frail Body", rarity: "Defect", desc: "Bones break like dry twigs. (-2 STR)", stats: { str: -2 } },
    { name: "Slow Mind", rarity: "Defect", desc: "Thoughts move through molasses. (-2 INT)", stats: { int: -2 } },
    { name: "Bleeder", rarity: "Defect", desc: "Constant nosebleeds. (-1 CON, -1 CHA)", stats: { con: -1, cha: -1 } },
    { name: "Hunchback", rarity: "Defect", desc: "A curvature of the spine. (-1 DEX, -1 CHA)", stats: { dex: -1, cha: -1 } },
    { name: "Weak Lungs", rarity: "Defect", desc: "Breathing is a labor. (-2 CON)", stats: { con: -2 } }
];

    // NEW: DEFINITIONS FOR ACQUIRED TRAITS
    const TRAIT_LIBRARY = {
        "Flushed Cheeks": { desc: "You blush easily in social situations.", rarity: "Common" },
        "Sooty Skin": { desc: "Permanently stained by the forge and hard labor.", rarity: "Common" },
        "Shifty Look": { desc: "People instinctively distrust you. (-1 CHA)", rarity: "Uncommon", stats: { cha: -1 } },
        "Fine Clothes": { desc: "You dress better than your station suggests. (+1 CHA)", rarity: "Uncommon", stats: { cha: 1 } },
        "Worn Boots": { desc: "You have walked many miles on hard roads.", rarity: "Common" },
        "Crooked Nose": { desc: "Broken in a fight and never set right.", rarity: "Common" },
        "Scar: Knuckles": { desc: "Calloused and scarred from many tavern brawls. (+1 STR)", rarity: "Common", stats: { str: 1 } },
        "Broken Hand": { desc: "It never healed quite right, aching in the rain. (-1 DEX)", rarity: "Common", stats: { dex: -1 } },
        "Gaunt Face": { desc: "Hunger has hollowed your cheeks. (-1 CON)", rarity: "Common", stats: { con: -1 } },
        "Well-Fed": { desc: "You haven't missed a meal in a long time. (+1 CON)", rarity: "Common", stats: { con: 1 } },
        "Far-Off Gaze": { desc: "You see things others do not. (+1 WIS)", rarity: "Rare", stats: { wis: 1 } },
        "Muttering": { desc: "You talk to yourself constantly.", rarity: "Common" },
        "Ink-Stained Hands": { desc: "The mark of a scholar or scribe. (+1 INT)", rarity: "Common", stats: { int: 1 } },
        "Stooped Posture": { desc: "Age or burden has bent your back. (-1 DEX)", rarity: "Common", stats: { dex: -1 } },
        "Pale Skin": { desc: "Sickness has leeched your color.", rarity: "Common" },
        "Scarred Lungs": { desc: "Breathing is difficult after the plague. (-1 CON)", rarity: "Uncommon", stats: { con: -1 } },
        "Blue Skin": { desc: "A fey prank gone wrong (or right?).", rarity: "Rare" },
        "Cursed": { desc: "Bad luck follows you like a shadow.", rarity: "Epic" },
        "Pet Griffin": { desc: "A loyal, feathered companion bonded to you. (+2 STR)", rarity: "Legendary", stats: { str: 2 } },
        "Burn Scars": { desc: "Painful marks from the fire.", rarity: "Uncommon" },
        "Haunted": { desc: "Something watches you from the shadows.", rarity: "Rare" },
        "Limp": { desc: "Movement is slow and painful. (-1 DEX)", rarity: "Common", stats: { dex: -1 } },
        "Scarred Face": { desc: "A badge of survival from the arena. (+1 CHA)", rarity: "Uncommon", stats: { cha: 1 } },
        "Paranoid": { desc: "They are out to get you. (+1 WIS)", rarity: "Uncommon", stats: { wis: 1 } },
        "Strange Rash": { desc: "An itchy reminder of a questionable cure.", rarity: "Common" },
        "Heavy Sleeper": { desc: "You could sleep through a siege.", rarity: "Common" },
        "Animal Bite Scar": { desc: "Teeth marks that never faded.", rarity: "Common" },
        "Family Keepsake": { desc: "A token of those who came before.", rarity: "Common" }
    };

    // --- DEATH CAUSE POOLS ---
    const DEATH_CAUSES = {
        common: [
            "succumbed to the sweating sickness", "died of a sudden fever", "withered away from consumption",
            "passed in their sleep", "took a bad fall down the stairs", "choked on a fishbone at a feast",
            "was kicked in the head by a mule", "fell from a roof while repairing thatch", 
            "drowned in the river", "was crushed by a runaway cart", "ate bad pork",
            "caught an infection from a rusty nail", "froze during the long winter"
        ],
        violent: [
            "was stabbed in a tavern brawl", "was waylaid by bandits", "died in a duel of honor",
            "was trampled by a warhorse", "took an arrow to the eye", "was executed for crimes unknown",
            "disappeared in the dark alleys", "was pushed into a well"
        ],
        fantasy: [
            "was incinerated by a stray dragon blast", "was turned to stone by a cockatrice",
            "walked into a sphere of annihilation", "was eaten by a mimic disguised as a chest",
            "insulted a wizard and was turned into a newt (permanently)", "tried to pet a dire wolf",
            "was carried off by a giant eagle", "vanished into a faerie ring", "read a cursed rune and imploded",
            "was drained dry by a vampire", "was crushed by a falling giant", "drank a Potion of Explosion by mistake",
            "was sacrificed by cultists", "lost a riddle contest to a sphinx (and was eaten)",
            "was stepped on by a troll", "touched a cursed artifact", "was absorbed by a gelatinous cube"
        ],
        old: [
            "succumbed to old age", "passed away peacefully in their sleep", "felt their heart stop beating",
            "simply faded away", "breathed their last surrounded by kin"
        ]
    };

    // --- MOVED WEAPON LIBRARY HERE TO FIX INITIALIZATION ERROR ---
    const WEAPON_LIBRARY = {
        unarmed: { name: "Fists", type: "strength", dmg: 1, cost: 0, rarity: "Common", desc: "Your bare hands." },
        dagger: { name: "Iron Dagger", type: "finesse", dmg: 4, cost: 15, rarity: "Common", desc: "Fast and concealable. (1d4 Dmg)" },
        cudgel: { name: "Wooden Cudgel", type: "strength", dmg: 4, cost: 2, rarity: "Common", desc: "A stout stick. (1d4 Dmg)" },
        shortsword: { name: "Shortsword", type: "finesse", dmg: 6, cost: 25, rarity: "Common", desc: "A soldier's sidearm. (1d6 Dmg)" },
        mace: { name: "Heavy Mace", type: "strength", dmg: 6, cost: 30, rarity: "Common", desc: "Crushes bone. (1d6 Dmg)" },
        spear: { name: "Spear", type: "strength", dmg: 6, cost: 10, rarity: "Common", desc: "Good reach. (1d6 Dmg)" },
        longsword: { name: "Longsword", type: "strength", dmg: 8, cost: 50, rarity: "Uncommon", desc: "Versatile steel blade. (1d8 Dmg)" },
        battleaxe: { name: "Battleaxe", type: "strength", dmg: 8, cost: 50, rarity: "Uncommon", desc: "A brutal cleaver. (1d8 Dmg)" },
        greatsword: { name: "Greatsword", type: "strength", dmg: 12, cost: 100, rarity: "Rare", desc: "Requires two hands. (1d12 Dmg)" },
        warhammer: { name: "Warhammer", type: "strength", dmg: 10, cost: 80, rarity: "Rare", desc: "Armor piercer. (1d10 Dmg)" },
        rapier: { name: "Noble Rapier", type: "finesse", dmg: 8, cost: 75, rarity: "Uncommon", desc: "Elegant and deadly. (1d8 Dmg)" },
        excalibur: { name: "Excalibur", type: "strength", dmg: 20, cost: 5000, rarity: "Artifact", desc: "The Sword of Kings. (1d20 Dmg)" },
        frostfang: { name: "Frostfang", type: "strength", dmg: 12, cost: 2000, rarity: "Legendary", desc: "Cold to the touch. (1d12+Frost)" }
    };

    // --- NEW: NPC INVENTORY GENERATOR ---
    function generateNPCInventory(occupation, rank) {
        const items = [];
        // UPDATED: Helper to add weapon from library
        const addWep = (key) => {
            const w = WEAPON_LIBRARY[key];
            if(w) items.push({
                name: w.name, 
                rarity: w.rarity, 
                desc: w.desc, 
                value: w.cost, 
                id: Math.random().toString(36).substr(2, 9),
                weapon: w // Attach stats
            });
        };
        const add = (name, rarity, desc, val) => items.push({name, rarity, desc, value: val, id: Math.random().toString(36).substr(2, 9)});

        // Basic Wealth/Rank Items
        const isNoble = rank.includes('Noble') || rank.includes('Lord') || rank.includes('Lady') || rank.includes('Ser') || rank.includes('Dame') || rank === 'House Member' || rank.includes('King') || rank.includes('Queen') || rank.includes('Duke') || rank.includes('Heir');
        
        if (isNoble) {
            add('Fine Clothes', 'Uncommon', 'Silk and velvet.', 25);
            if(Math.random() > 0.7) add('Signet Ring', 'Rare', 'Gold ring with crest.', 50);
            if(Math.random() > 0.8) add('Jeweled Brooch', 'Rare', 'Sparkling gemstone.', 80);
        } else {
            add('Rough Clothes', 'Common', 'Wool and linen.', 1);
            if(Math.random() > 0.5) addWep('dagger');
            add('Waterskin', 'Common', 'Leather pouch.', 1);
        }

        // Occupation Specifics
        const jobLower = (occupation || "").toLowerCase();
        
        if (jobLower.includes('smith')) { addWep('warhammer'); add('Apron', 'Common', 'Leather.', 2); }
        else if (jobLower.includes('farm')) { addWep('cudgel'); add('Seeds', 'Common', 'Bag of grain.', 1); }
        else if (jobLower.includes('merchant') || jobLower.includes('peddler') || jobLower.includes('shop')) { addWep('dagger'); add('Trade Goods', 'Uncommon', 'Assorted wares.', 20); }
        else if (jobLower.includes('knight') || jobLower.includes('guard') || jobLower.includes('soldier') || jobLower.includes('captain') || jobLower.includes('squire')) { 
            addWep('longsword'); 
            add('Chainmail', 'Uncommon', 'Protection.', 50, null, 4); // Added DR 4
        }
        else if (jobLower.includes('clerg') || jobLower.includes('priest')) { addWep('mace'); add('Prayer Beads', 'Common', 'For focus.', 2); }
        else if (jobLower.includes('scholar') || jobLower.includes('scribe') || jobLower.includes('mage') || jobLower.includes('alc')) { add('Scroll', 'Uncommon', 'Parchment.', 10); add('Quill & Ink', 'Common', 'Writing set.', 5); }
        else if (jobLower.includes('thief') || jobLower.includes('crim')) { addWep('dagger'); add('Lockpicks', 'Uncommon', 'Thieves tools.', 15); }
        else if (jobLower.includes('artist') || jobLower.includes('paint')) { add('Paints', 'Common', 'Colorful dyes.', 5); }
        else if (jobLower.includes('bake') || jobLower.includes('cook')) { add('Rolling Pin', 'Common', 'Wood.', 2); add('Flour', 'Common', 'Sack.', 1); }
        else if (jobLower.includes('hunt')) { addWep('spear'); add('Shortbow', 'Common', 'Yew wood.', 15); }
        
        return items;
    }

    const GeneticEngine = {
        getRandomMutation: function() {
            const roll = Math.random();
            let tier = 'Common';
            if (roll > 0.99) tier = 'Legendary';
            else if (roll > 0.96) tier = 'Epic';
            else if (roll > 0.85) tier = 'Rare';
            else if (roll > 0.60) tier = 'Uncommon';
            
            // Explicitly filter for non-defects just in case
            const pool = MUTATION_POOL.filter(m => m.rarity === tier);
            if(pool.length > 0) return pool[Math.floor(Math.random() * pool.length)];
            return MUTATION_POOL[0]; // Fallback to first common
        },

        generate: function(houseName = null, forcedTrait = null) {
            let look = {};
            
            // 1. Base Appearance
            if (houseName && HOUSE_PHENOTYPES[houseName]) {
                look = { ...HOUSE_PHENOTYPES[houseName] };
            } else {
                look.hair = COSMETICS.hair[Math.floor(Math.random() * COSMETICS.hair.length)];
                look.eyes = COSMETICS.eyes[Math.floor(Math.random() * COSMETICS.eyes.length)];
                look.skin = COSMETICS.skin[Math.floor(Math.random() * COSMETICS.skin.length)];
            }
            
            look.height = COSMETICS.height[Math.floor(Math.random() * COSMETICS.height.length)];

            let mutations = [];
            
            // 2. Forced Trait Logic
            if (forcedTrait) {
                const mut = MUTATION_POOL.find(m => m.name === forcedTrait);
                if (mut) {
                    mutations.push(mut);
                } else if (forcedTrait.includes("Hair")) {
                    look.hair = forcedTrait.replace(" Hair", "");
                } else if (forcedTrait.includes("Eyes")) {
                    look.eyes = forcedTrait.replace(" Eyes", "");
                }
            }

            // 3. Guaranteed Mutation (Minimum 1)
            if (mutations.length === 0) { 
                mutations.push(this.getRandomMutation());
            }
            
            // 4. Rare Chance for 2nd Mutation (20%) - UPDATED
            // Applies to all generated characters (NPCs included)
            if (mutations.length < 2 && Math.random() < 0.20) {
                let m2 = this.getRandomMutation();
                // Avoid duplicates
                if (!mutations.some(m => m.name === m2.name)) {
                    mutations.push(m2);
                }
            }

            // 5. Very Rare Chance for 3rd Mutation (5%) - UPDATED
            if (mutations.length < 3 && Math.random() < 0.05) {
                let m3 = this.getRandomMutation();
                // Avoid duplicates
                if (!mutations.some(m => m.name === m3.name)) {
                    mutations.push(m3);
                }
            }
            
            return { ...look, mutations, defect: null };
        },
        
        // Inheritance Logic
        mix: function(father, mother) {
            const fGenes = father.appearance || this.generate();
            const mGenes = mother.appearance || this.generate();
            
            // --- NEW: GRANDPARENT LOOKUP ---
            // Try to find grandparents via IDs stored on parents
            const grandparents = [];
            const findRel = (id) => state.relationships.find(r => r.id === id);

            if (father.fatherId) grandparents.push(findRel(father.fatherId));
            if (father.motherId) grandparents.push(findRel(father.motherId));
            if (mother.fatherId) grandparents.push(findRel(mother.fatherId));
            if (mother.motherId) grandparents.push(findRel(mother.motherId));

            // Filter out any undefined lookups
            const validGrandparents = grandparents.filter(gp => gp && gp.appearance);

            // Helper: 10% Chance to pull from Grandparent, else 50/50 Parents
            const inherit = (trait) => {
                // Rare Grandparent Pull (10%)
                if (validGrandparents.length > 0 && Math.random() < 0.10) {
                    const gp = validGrandparents[Math.floor(Math.random() * validGrandparents.length)];
                    return gp.appearance[trait];
                }
                // Standard Parent Split
                return Math.random() > 0.5 ? fGenes[trait] : mGenes[trait];
            };

            const hair = inherit('hair');
            const eyes = inherit('eyes');
            const skin = inherit('skin');
            
            // Height logic: 50/50 parents usually
            const height = Math.random() > 0.5 ? (fGenes.height || 'Average') : (mGenes.height || 'Average');
            
            let mutations = [];
            
            // 1. Inheritance from Parents (High Chance)
            const parentMutations = [...(fGenes.mutations || []), ...(mGenes.mutations || [])];
            
            // Deduplicate
            const uniqueParentMutations = [];
            const seen = new Set();
            for (const m of parentMutations) {
                if(!seen.has(m.name)) {
                    seen.add(m.name);
                    uniqueParentMutations.push(m);
                }
            }

            if (uniqueParentMutations.length > 0) {
                // Pick one potential mutation to inherit
                const candidate = uniqueParentMutations[Math.floor(Math.random() * uniqueParentMutations.length)];
                
                // 80% Chance to Inherit
                if (Math.random() < 0.80) {
                    mutations.push(candidate);
                }
            }
            
            // 2. Guaranteed Mutation (If none inherited)
            if (mutations.length === 0) {
                 mutations.push(this.getRandomMutation());
            }

            // 3. Rare Chance for 2nd Mutation (20%) - UPDATED
            // Can be inherited (if another avail) or new
            if (mutations.length < 2 && Math.random() < 0.20) {
                 const remainingParents = uniqueParentMutations.filter(m => !mutations.includes(m));
                 
                 // Prefer inheritance if available (50/50), otherwise random
                 if (remainingParents.length > 0 && Math.random() < 0.5) {
                     mutations.push(remainingParents[Math.floor(Math.random() * remainingParents.length)]);
                 } else {
                     let m2 = this.getRandomMutation();
                     if (!mutations.some(m => m.name === m2.name)) {
                         mutations.push(m2);
                     }
                 }
            }

            // 4. Very Rare Chance for 3rd Mutation (5%) - UPDATED
            if (mutations.length < 3 && Math.random() < 0.05) {
                 const remainingParents = uniqueParentMutations.filter(m => !mutations.includes(m));
                 
                 // Prefer inheritance if available (50/50), otherwise random
                 if (remainingParents.length > 0 && Math.random() < 0.5) {
                     mutations.push(remainingParents[Math.floor(Math.random() * remainingParents.length)]);
                 } else {
                     let m3 = this.getRandomMutation();
                     if (!mutations.some(m => m.name === m3.name)) {
                         mutations.push(m3);
                     }
                 }
            }
            
            // 4. INCEST LOGIC: Defect Generation (Separate Slot)
            let defect = null;
            let isIncest = false;
            
            const fBlood = father.isBlood || father.id === 'PLAYER';
            const mBlood = mother.isBlood || mother.id === 'PLAYER';
            
            if (fBlood && mBlood) isIncest = true;

            // 30% Chance of defect if incest
            if (isIncest && Math.random() < 0.35) {
                const defects = MUTATION_POOL.filter(m => m.rarity === 'Defect');
                if (defects.length > 0) {
                    defect = defects[Math.floor(Math.random() * defects.length)];
                }
            }

            return { hair, eyes, skin, height, mutations, defect };
        }
    };


    // 1. D&D 5e MECHANICS
    const ABILITIES = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
    const ALIGNMENTS = ['Lawful Good', 'Neutral Good', 'Chaotic Good', 'Lawful Neutral', 'True Neutral', 'Chaotic Neutral', 'Lawful Evil', 'Neutral Evil', 'Chaotic Evil'];
    
    function getModifier(score) {
        return Math.floor((score - 10) / 2);
    }

    // --- NEW: Multiple Birth Helper ---
    function getBirthCount() {
        const roll = Math.random();
        if (roll < 0.001) return 4; // Quadruplets (0.1%)
        if (roll < 0.01) return 3;  // Triplets (0.9%)
        if (roll < 0.05) return 2;  // Twins (4%)
        return 1;
    }

    function formatMod(mod) {
        return mod >= 0 ? `+${mod}` : `${mod}`;
    }

    function rollD20(mod) {
        let r1 = Math.floor(Math.random() * 20) + 1;
        let specialText = "";

        // TRAIT LOGIC REMOVED: Traits are now purely cosmetic/physical.
        // The body remembers, but the dice do not care.

        return {
            roll: r1,
            mod: mod,
            total: r1 + mod,
            isCrit: r1 === 20,
            isFail: r1 === 1,
            specialText: specialText
        };
    }

    // 2. STATE MANAGEMENT
    const state = {
        settings: { sound: true }, // Added Settings
        name: "Unknown",
        gender: null, // UPDATED: Default null
        age: 0,
        year: 1200,
        stats: { str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10 },
        growth: { hp: 0, sp: 0 }, // NEW: Track accumulated growth
        appearance: { hair: "Brown", eyes: "Brown", skin: "Fair", height: "Average", mutations: [], defect: null }, // Added defect slot
        genes: [], // Legacy/Unused or purely strictly internal ID tracking if needed, but appearance.mutations is main
        reputation: { renown: 0, honor: 0, piety: 0, infamy: 0 },
        gold: 0,
        health: 10,
        maxHealth: 10,
        sanity: 8,
        maxSanity: 8,
        socialClass: "Commoner", 
        house: null, 
        location: 0, // Index of current city
        relationships: [],
        interactions: {}, // tracks yearly interactions per person ID
        activityLog: { socialize: 0, lord: 0, tournament: 0, train: 0, brothel: 0, dungeon: 0, crime: 0, meditate: 0 }, 
        occupation: null, 
        jobHistory: {},
        rejectedJobs: [], // Stores rejected job IDs for the current year
        traits: [], // ACQUIRED TRAITS
        combatSkills: [], // Learned Combat Abilities
        inventory: [],
        equipped: { head: null, armor: null, mainHand: null, offHand: null, accessory: null }, // NEW: Equipment Slots
        market: [], // NEW: Stores current year's shops
        eventQueue: [], // NEW: Stores events for the current year
        recentEvents: [], // NEW: Duplicate Ward memory
        nextCanonAge: null, // NEW: Destiny Tracker
        honorifics: [], // ADDED: List of earned titles
        primaryHonorific: null, // ADDED: Current display title
        cityHouses: {}, // NEW: Persistent local houses per city
        // NEW: Knighthood State
        knighthood: { rank: null, masterId: null, isSworn: false, stipend: 0 },
        // Feudal Lineage (Squire/Knight)
        houseAlliance: "None",
        mentorKnight: "None",
        availableRetainers: [], // NPC IDs seeking employment at player's house
        flags: {
            literate: false,
            criminal: false,
            married: false,
            employed: false,
            startOrigin: null, // UPDATED: Default null
            travelAllowed: false,
            travelTarget: null,
            adult: false,
            traveledThisYear: false,
            requestedHouseFunds: false, // NEW: Track stipend requests
            lockedInChronicle: false // NEW: Lock flag
        }
    };

    // 3. DATA: OCCUPATIONS & GUILDS
    const CAREERS = {
        // NEW: Knighthood Career Path
        knight: {
            name: "Knighthood",
            req: { age: 8, stat: 'str', val: 10 },
            dc: 12, stat: 'str',
            ranks: [
                { title: "Squire", wage: 0, stressMod: 2 },
                { title: "Hedge Knight", wage: 0, stressMod: 4 }, // No income, free travel
                { title: "Sworn Knight", wage: 50, stressMod: 5 }, // Stipend, locked travel
                { title: "Knight Commander", wage: 100, stressMod: 8 }
            ]
        },
        common: { 
            name: "Laborer", 
            req: { age: 8 },
            dc: 8, stat: 'con',
            ranks: [
                { title: "Errand Runner", wage: 1, stressMod: 1 },
                { title: "Farmhand", wage: 5, stressMod: 2 },
                { title: "Foreman", wage: 12, stressMod: 3 }
            ]
        },
        farmer: {
            name: "Farmer",
            req: { age: 10 },
            dc: 10, stat: 'con',
            ranks: [
                { title: "Field Hand", wage: 3, stressMod: 2 },
                { title: "Homesteader", wage: 10, stressMod: 3 },
                { title: "Land Owner", wage: 25, stressMod: 4 }
            ]
        },
        artist: {
            name: "Artist",
            req: { age: 12, stat: 'cha', val: 12 },
            dc: 12, stat: 'cha',
            ranks: [
                { title: "Apprentice Painter", wage: 5, stressMod: 2 },
                { title: "Portraitist", wage: 20, stressMod: 3 },
                { title: "Royal Court Painter", wage: 60, stressMod: 5 }
            ]
        },
        blacksmith: {
            name: "Blacksmith",
            req: { age: 12, stat: 'str', val: 12 },
            dc: 13, stat: 'str',
            ranks: [
                { title: "Bellows Boy/Girl", wage: 5, stressMod: 3 },
                { title: "Apprentice Smith", wage: 15, stressMod: 4 },
                { title: "Master Smith", wage: 45, stressMod: 5 }
            ]
        },
        carpenter: {
            name: "Carpenter",
            req: { age: 12, stat: 'dex', val: 11 },
            dc: 12, stat: 'dex',
            ranks: [
                { title: "Woodcutter", wage: 4, stressMod: 3 },
                { title: "Joiner", wage: 14, stressMod: 4 },
                { title: "Master Builder", wage: 40, stressMod: 5 }
            ]
        },
        stonemason: {
            name: "Stonemason",
            req: { age: 12, stat: 'con', val: 12 },
            dc: 13, stat: 'str',
            ranks: [
                { title: "Quarryman", wage: 5, stressMod: 4 },
                { title: "Stonecutter", wage: 16, stressMod: 4 },
                { title: "Architect", wage: 50, stressMod: 6 }
            ]
        },
        baker: {
            name: "Baker",
            req: { age: 12, stat: 'wis', val: 10 },
            dc: 11, stat: 'wis',
            ranks: [
                { title: "Dough Kneader", wage: 3, stressMod: 2 },
                { title: "Oven Keeper", wage: 12, stressMod: 3 },
                { title: "Master Patissier", wage: 35, stressMod: 4 }
            ]
        },
        weaver: {
            name: "Weaver",
            req: { age: 12, stat: 'dex', val: 12 },
            dc: 12, stat: 'dex',
            ranks: [
                { title: "Wool Carder", wage: 3, stressMod: 1 },
                { title: "Loom Operator", wage: 12, stressMod: 2 },
                { title: "Master Weaver", wage: 30, stressMod: 3 }
            ]
        },
        tanner: {
            name: "Tanner",
            req: { age: 12, stat: 'con', val: 11 },
            dc: 12, stat: 'con',
            ranks: [
                { title: "Hide Scraper", wage: 4, stressMod: 4 },
                { title: "Leatherworker", wage: 14, stressMod: 4 },
                { title: "Master Tanner", wage: 35, stressMod: 5 }
            ]
        },
        guard: {
            name: "City Guard",
            req: { age: 14, stat: 'str', val: 12 },
            dc: 13, stat: 'str',
            ranks: [
                { title: "Gate Watch", wage: 8, stressMod: 3 },
                { title: "Patrolman", wage: 15, stressMod: 4 },
                { title: "Captain of the Watch", wage: 35, stressMod: 6 }
            ]
        },
        alchemist: {
            name: "Alchemist",
            req: { age: 14, stat: 'int', val: 13 },
            dc: 14, stat: 'int',
            ranks: [
                { title: "Bottle Washer", wage: 5, stressMod: 2 },
                { title: "Apprentice Brewer", wage: 15, stressMod: 3 },
                { title: "Master Alchemist", wage: 50, stressMod: 5 }
            ]
        },
        merchant: {
            name: "Merchant",
            req: { age: 16, stat: 'cha', val: 12 },
            dc: 14, stat: 'cha',
            ranks: [
                { title: "Peddler", wage: 10, stressMod: 3 },
                { title: "Shopkeeper", wage: 30, stressMod: 4 },
                { title: "Trade Magnate", wage: 80, stressMod: 6 }
            ]
        },
        military: { 
            name: "Military", 
            req: { age: 14, stat: 'con', val: 10 },
            dc: 12, stat: 'con',
            ranks: [
                { title: "Camp Follower", wage: 2, stressMod: 1 },
                { title: "Foot Soldier", wage: 10, stressMod: 5 },
                { title: "Corporal", wage: 25, stressMod: 6 },
                { title: "Sergeant", wage: 40, stressMod: 7 },
                { title: "Sergeant Major", wage: 80, stressMod: 8 }
            ]
        },
        diplomat: {
            name: "Diplomat",
            req: { age: 14, stat: 'cha', val: 12, class: 'House' },
            dc: 13, stat: 'cha',
            ranks: [
                { title: "Envoy", wage: 20, stressMod: 2 },
                { title: "Ambassador", wage: 45, stressMod: 4 },
                { title: "High Chancellor", wage: 120, stressMod: 8 }
            ]
        },
        scholar: {
            name: "Scholarly",
            req: { age: 12, stat: 'int', val: 12, flag: 'literate' },
            dc: 14, stat: 'int',
            ranks: [
                { title: "Scribe's Assistant", wage: 4, stressMod: 1 },
                { title: "Junior Scribe", wage: 12, stressMod: 2 },
                { title: "Court Historian", wage: 45, stressMod: 4 }
            ]
        },
        clergy: {
            name: "Clergy",
            req: { age: 12, stat: 'wis', val: 11 },
            dc: 13, stat: 'wis',
            ranks: [
                { title: "Novice", wage: 0, stressMod: 1 },
                { title: "Priest", wage: 5, stressMod: 3 },
                { title: "High Priest", wage: 20, stressMod: 5 }
            ]
        },
        bard: {
            name: "Bard",
            req: { age: 12, stat: 'cha', val: 12 },
            dc: 13, stat: 'cha',
            ranks: [
                { title: "Street Busker", wage: 2, stressMod: 1 },
                { title: "Tavern Singer", wage: 8, stressMod: 2 },
                { title: "Royal Minstrel", wage: 40, stressMod: 4 }
            ]
        },
        crime: {
            name: "Criminal",
            req: { age: 8, stat: 'dex', val: 10 },
            dc: 10, stat: 'dex',
            ranks: [
                { title: "Pickpocket", wage: 5, stressMod: 4 },
                { title: "Burglar", wage: 20, stressMod: 6 },
                { title: "Crime Boss", wage: 40, stressMod: 10 }
            ]
        }
    };

    // NEW: Knighthood Helpers
    function askToSquire(id) {
        if(state.health <= 0) return;
        
        const npc = state.relationships.find(r => r.id === id);
        if(!npc) return;

        // CHECK: Is this the Player's Lord?
        let isMyLord = false;
        if (state.house && state.house.members) {
            // Find current ruler of player's house
            const rulerMember = state.house.members.find(m => 
                !m.rank.includes('Emeritus') && !m.rank.includes('Dowager') && !m.rank.includes('Mother') && !m.rank.includes('Consort') &&
                (m.rank.includes('Lord') || m.rank.includes('Lady') || m.rank.includes('King') || m.rank.includes('Queen') || m.rank.includes('Duke') || m.rank.includes('Duchess'))
            );
            if (rulerMember && rulerMember.id === id) isMyLord = true;
        }

        state.interactions[id] = 1;
        closeNPC();
        switchTab('log');

        const strMod = getModifier(state.stats.str);
        const roll = rollD20(strMod);
        const dc = 12;

        // Helper for Knight Logs
        const logKnight = (msg) => {
            const logEl = document.getElementById('event-log');
            const div = document.createElement('div');
            div.className = 'event-entry knight-alert';
            div.innerHTML = msg;
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        };

        if (roll.total >= dc) {
            if (isMyLord) {
                // --- LINEAGE-BASED SQUIRING ---
                // The Lord delegates training to a vassal/household knight.
                
                const houseKnights = state.relationships.filter(r => 
                    state.house.members.some(m => m.id === r.id) && // Is member
                    (r.rank.includes('Ser') || r.rank.includes('Dame') || r.rank === 'Sworn Knight' || (r.occupation && r.occupation.includes('Knight'))) &&
                    r.id !== 'PLAYER' &&
                    r.id !== id && // Not the Lord themselves
                    r.health !== 'Deceased'
                );

                let assignedMasterId = null;
                let assignedMasterName = "";

                if (houseKnights.length > 0) {
                    // Pick existing house knight
                    const k = houseKnights[Math.floor(Math.random() * houseKnights.length)];
                    assignedMasterId = k.id;
                    assignedMasterName = getNPCName(k);
                    logKnight(`<strong style="color:var(--royal)">ACCEPTED:</strong> ${npc.name} nods approvingly. "You shall serve our House. I assign you to <strong>${assignedMasterName}</strong> for training."`);
                } else {
                    // No knights exist, Lord appoints a Sworn Knight (Generation via becomeSquire(null))
                    logKnight(`<strong style="color:var(--royal)">ACCEPTED:</strong> ${npc.name} nods. "Our ranks are thin. I shall summon a Sworn Knight to train you."`);
                    assignedMasterId = null; // Triggers generation
                }
                
                becomeSquire(assignedMasterId);
                modRel(npc.id, 20);

            } else {
                // Standard: Squire for the person asked directly
                logKnight(`<strong style="color:var(--royal)">ACCEPTED:</strong> ${npc.name} sees potential in you. "Kneel, and rise as my Squire."`);
                becomeSquire(npc.id);
                modRel(npc.id, 20);
            }
        } else {
            log(`<strong style="color:var(--failure)">REJECTED:</strong> ${npc.name} shakes their head. "You lack the strength to bear my shield."`);
            modRel(npc.id, -5);
        }
    }

    // NEW: Adult Knighthood Petition
    function askForKnighthood(id) {
        if(state.health <= 0) return;
        const npc = state.relationships.find(r => r.id === id);
        if(!npc) return;

        state.interactions[id] = 1;
        closeNPC();
        switchTab('log');

        // Check based on Reputation (Renown) and Charisma
        const chaMod = getModifier(state.stats.cha);
        const roll = rollD20(chaMod);
        // DC gets easier with Renown (Base 25, -1 per 10 Renown)
        let dc = 25 - Math.floor(state.reputation.renown / 10);
        if (dc < 12) dc = 12; // Minimum DC

        const logKnight = (msg) => {
            const logEl = document.getElementById('event-log');
            const div = document.createElement('div');
            div.className = 'event-entry knight-alert';
            div.innerHTML = msg;
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        };

        if (roll.total >= dc) {
            logKnight(`<strong style="color:var(--royal)">RISE A KNIGHT:</strong> ${npc.name} recognizes your deeds. You kneel a commoner and rise a Knight.`);
            
            // Set Hedge Knight status (Rank 1)
            state.knighthood = { rank: 'Hedge Knight', masterId: npc.id, isSworn: false, stipend: 0 };
            state.occupation = { id: 'knight', rankIndex: 1, performance: 50, stress: 0, workStance: 'normal', years: 0 };
            state.flags.employed = true;
            addHonorific(state.gender === 'Female' ? 'Dame' : 'Ser');
            syncKnightlyLineage();
            
            modRel(npc.id, 25);
            modRep('renown', 20);
            updateUI();
        } else {
            log(`<strong style="color:var(--failure)">REJECTED:</strong> ${npc.name} is unimpressed. "You have name, but you are not yet worthy of the accolade." (Rolled ${roll.total} vs DC ${dc})`);
            modRel(npc.id, -5);
        }
    }

    // NEW: Pledge Service (Hedge Knight -> Sworn Knight)
    function pledgeService(id) {
        if(state.health <= 0) return;
        const npc = state.relationships.find(r => r.id === id);
        if(!npc) return;

        closeNPC();
        switchTab('log');

        const evt = createEvent('pledge_sworn', 'Pledge of Service',
            `You kneel before ${getNPCName(npc)} and offer your sword in service to their House. "I swear to shield your lands and obey your command."`,
            [
                {
                    text: 'Swear Oath',
                    type: 'flavor',
                    effect: () => {
                        state.knighthood.rank = 'Sworn Knight';
                        state.knighthood.isSworn = true;
                        state.knighthood.masterId = id;
                        state.knighthood.stipend = 50;
                        state.occupation.rankIndex = 2; // Update job rank index to match Sworn status
                        
                        syncKnightlyLineage();
                        modRep('honor', 10);
                        modRel(id, 20);
                        
                        // Add logging
                        const logEl = document.getElementById('event-log');
                        const div = document.createElement('div');
                        div.className = 'event-entry knight-alert';
                        div.innerHTML = `<strong style="color:var(--royal)">OATH SWORN:</strong> You are now a Sworn Knight to ${getNPCName(npc)}. You receive a stipend of 50g/yr but are bound to their location.`;
                        logEl.appendChild(div);
                        logEl.scrollTop = logEl.scrollHeight;
                        
                        updateUI();
                    }
                },
                {
                    text: 'Hesitate',
                    type: 'flavor',
                    effect: () => log("You decide you are not ready to lose your freedom.")
                }
            ]
        );
        renderEvent(evt);
    }

    // NEW: Renounce Oath (Sworn Knight -> Hedge Knight)
    function renounceOath() {
        if(state.health <= 0) return;
        
        showConfirm("Renouncing your oath is a grave dishonor. You will lose your stipend and standing. Are you sure?", () => {
            const masterId = state.knighthood.masterId;
            const master = state.relationships.find(r => r.id === masterId);
            
            state.knighthood.rank = 'Hedge Knight';
            state.knighthood.isSworn = false;
            state.knighthood.masterId = null;
            state.knighthood.stipend = 0;
            state.occupation.rankIndex = 1; // Revert to Hedge Knight rank
            
            modRep('honor', -20);
            modRep('renown', -5);
            if(master) modRel(master.id, -40);
            
            syncKnightlyLineage();
            
            log(`<strong style="color:var(--failure)">OATHBROKEN:</strong> You have renounced your vows. You are a Hedge Knight once more, free but stained by dishonor.`);
            updateUI();
        });
    }

    function becomeSquire(masterId) {
        // --- ARCANE UPDATE: MANDATORY KNIGHT GENERATION ---
        // One cannot learn the arts of chivalry from thin air. 
        // If no master is specified, the Fates (or the House) provide one.
        if (!masterId) {
            const gender = Math.random() > 0.5 ? 'Male' : 'Female';
            const name = getRandomName(gender);
            const title = gender === 'Male' ? 'Ser' : 'Dame';
            
            // Create the Knight NPC
            // Rank depends on context: House -> Sworn Knight, Independent -> Knight
            const isHouse = state.socialClass === 'House' && state.house;
            const rank = isHouse ? "Sworn Knight" : title;
            
            const knight = addRelationship(name, "Mentor", 50, gender, "Noble", state.location, false, false, 28 + Math.floor(Math.random() * 25));
            knight.occupation = "Knight"; 
            knight.rank = rank;
            
            // Equip the Master
            knight.inventory.push({ name: 'Fine Steel Sword', rarity: 'Uncommon', desc: 'A blade of quality.', value: 50 });
            
            if (isHouse) {
                addHouseMember(knight.name, gender, rank, state.location, knight.id);
                log(`<strong>House Assignment:</strong> ${state.house.name} has assigned <strong>${getNPCName(knight)}</strong> as your mentor.`);
            } else {
                log(`<strong>Mentorship:</strong> You have been assigned to squire for <strong>${getNPCName(knight)}</strong>.`);
            }
            
            masterId = knight.id;
        }

        // Set State
        state.knighthood = { rank: 'Squire', masterId: masterId, isSworn: false, stipend: 0 };
        state.occupation = { id: 'knight', rankIndex: 0, performance: 50, stress: 0, workStance: 'normal', years: 0 };
        state.flags.employed = true;
        addHonorific("Squire");
        
        // Log check
        const master = state.relationships.find(r => r.id === masterId);
        const masterName = master ? getNPCName(master) : "a Mystery Knight";
        
        log(`<strong>Career:</strong> You have taken the vows of a Squire under ${masterName}.`);
        syncKnightlyLineage();
        updateUI();
    }

    function syncKnightlyLineage() {
        if (!state.occupation || state.occupation.id !== 'knight') return;
        const isSquire = state.knighthood?.rank === 'Squire';
        const isKnight = state.knighthood?.rank === 'Hedge Knight' || state.knighthood?.rank === 'Sworn Knight' || (state.occupation.rankIndex >= 1);
        if (!isSquire && !isKnight) return;
        state.houseAlliance = "None";
        if (state.house) {
            state.houseAlliance = state.house.name === 'Chep' ? "The Crown" : `House ${state.house.name}`;
        } else {
            state.houseAlliance = "Houseless";
        }
        state.mentorKnight = "None";
        if (state.knighthood?.masterId) {
            const m = state.relationships.find(r => r.id === state.knighthood.masterId);
            state.mentorKnight = m ? getNPCName(m) : "The Order";
        } else if (state.house) {
            state.mentorKnight = `House ${state.house.name}`;
        }
    }

    function requestHouseSquiring() {
        if(state.health <= 0) return;
        
        // Find Lord
        let ruler = state.house.members.find(m => 
            !m.rank.includes('Emeritus') && !m.rank.includes('Dowager') && !m.rank.includes('Mother') && !m.rank.includes('Consort') &&
            (m.rank.includes('Lord') || m.rank.includes('Lady') || m.rank.includes('King') || m.rank.includes('Queen') || m.rank.includes('Duke') || m.rank.includes('Duchess'))
        );
        
        // Fallback if no ruler found
        if (!ruler) ruler = { name: "The Council", id: "COUNCIL" };

        const rulerNPC = state.relationships.find(r => r.id === ruler.id);
        const rulerName = rulerNPC ? rulerNPC.name : ruler.name;

        // Find potential masters in the House
        const knights = state.relationships.filter(r => 
            (r.rank.includes('Ser') || r.rank.includes('Dame') || r.rank === 'Sworn Knight' || (r.occupation && r.occupation.includes('Knight'))) &&
            r.id !== 'PLAYER' &&
            r.health !== 'Deceased' &&
            state.house.members.some(m => m.id === r.id)
        );

        let masterId = null;
        let masterName = "a Household Knight";
        
        if (knights.length > 0) {
            const m = knights[Math.floor(Math.random() * knights.length)];
            masterId = m.id;
            masterName = m.name;
        }

        const evt = createEvent(
            'req_squire_house',
            'Petition for Squiring',
            `You approach ${rulerName} in the great hall. "I am of age," you say. "I wish to serve the House by the sword. Will you find me a master?"`,
            [
                {
                    text: 'Ask Respectfully',
                    type: 'check',
                    stat: 'cha',
                    dc: 10,
                    success: `${rulerName} nods approvingly. "You shall train under ${masterName}."`,
                    fail: `${rulerName} sighs. "We have no knights to spare for you. Report to the barracks."`,
                    onSuccess: () => {
                        // Pass specific ID or null (which now triggers generation of a NEW knight)
                        becomeSquire(masterId); 
                        if(rulerNPC) modRel(rulerNPC.id, 10);
                    },
                    onFail: () => {
                        // LOGIC CHANGE: Failing to get a squire position sends you to the Guard/Garrison
                        // A squire MUST have a knight. If no knight, you are just a soldier.
                        joinJob('guard');
                    }
                },
                {
                    text: 'Leave',
                    type: 'flavor',
                    effect: () => log("You decide to wait.")
                }
            ]
        );
        
        renderEvent(evt);
        switchTab('log');
    }

    // 4. DATA: HOUSE & CITY SYSTEM
    const TIER_DATA = {
        royal: { name: 'Royal House', prob: 0.01, startGold: 10000 },
        greater: { name: 'Greater House', prob: 0.10, startGold: 5000 },
        lesser: { name: 'Lesser House', sigils: ['üå≤', 'üè∞', 'üó°Ô∏è', 'üõ°Ô∏è', 'üîî',
        'üåæ', 'üçÇ', 'üçÅ', 'üåø', 'üåä', 'ü™®', 'üî•', '‚ùÑÔ∏è', 'üíé', '‚õìÔ∏è', '‚öîÔ∏è',
        'üèπ', 'ü™∂', 'üïØÔ∏è', 'ü™ô', 'üêç', 'üêó', 'ü¶Å', 'ü¶ä', 'ü¶å', 'üêè', 'üêê', 
        'üêì', 'üêü', 'ü¶¢','üêÇ', 'üêÑ', 'üêñ', 'üêá', 'ü¶î', 'ü¶ù', 'üêøÔ∏è', 'ü¶´', 
        'üêé', 'üê¥', 'ü´è', 'üêï', 'üêà', 'ü¶â', 'ü¶ú', 'ü¶§', 'üêù', 'ü¶ã', 'üï∑Ô∏è', 'ü¶Ç', 'üê¢', 'ü¶é', 'üê∏', 'ü¶Ä', 'ü¶û', 'üêö'], prob: 0.89, startGold: 500 }
    };
    
    const HOUSE_RANKS = ["Lord/Lady", "Heir", "House Member", "Sworn Knight", "Servant"];
    const KNIGHT_SERVICE_TYPES = ["Household Guard", "Master-of-Arms", "Landed Vassal"];
    
    const GREATER_HOUSES_INFO = {
        "Chep": { motto: "Unity in Starlight", desc: "The Royal line, descended from Hero Ren.", heirloom: "Lumina, the Star-Blade", sigil: "‚≠ê", holding: "The Sun Fortress", holdingDesc: "The radiant seat of the High King, built from white marble that glows at dawn." },
        "Valdoria": { motto: "Gold is Power", desc: "Masters of coin and trade in the golden west.", heirloom: "The Gilded Scepter", sigil: "ü¶Ö", holding: "The Golden Vaults", holdingDesc: "A massive palace carved into the cliffside, guarding the realm's treasury." },
        "Thalor": { motto: "Tides Bow to None", desc: "Wardens of the stormy seas and the leviathans beneath.", heirloom: "The Abyssal Trident", sigil: "ü¶ë", holding: "Stormwatch Keep", holdingDesc: "A formidable fortress lashed by eternal waves, protecting the southern coasts." },
        "Grimward": { motto: "Winter is our Anvil", desc: "Sentinels of the frozen north against the darkness.", heirloom: "Frostfang (Greataxe)", sigil: "üê∫", holding: "Ice-Fang Citadel", holdingDesc: "Built from black basalt and magical ice, it has never been breached." },
        "Sunstrider": { motto: "Light Pierces All", desc: "Keepers of the deep forests and ancient magic.", heirloom: "The Verdant Bow", sigil: "üåπ", holding: "The Elder Tree", holdingDesc: "A palace woven from living wood inside a tree the size of a mountain." },
        "Ironheart": { motto: "Steel Endures", desc: "Forgers of steel and stone in the industrial heart.", heirloom: "The Black Hammer", sigil: "üêâ", holding: "The Black Forge", holdingDesc: "An industrial complex of smoke and fire where the finest steel is born." },
        "Moonshadow": { motto: "Secrets in Silence", desc: "Scholars of the arcane arts built upon ruins.", heirloom: "The Crystal Orb", sigil: "üåô", holding: "Spire of Whispers", holdingDesc: "A floating tower tethered by chains, housing the greatest library in the world." },
        "Stormbreaker": { motto: "Above the Clouds", desc: "Watchers of the high peaks, touching the clouds.", heirloom: "Sky-Splitter (Spear)", sigil: "‚ö°", holding: "Cloudreach", holdingDesc: "A castle perched on the highest peak, accessible only by wyvern or narrow bridge." }
    };

    const LESSER_MOTTOS = [
        "Honor Above All", "Strength in Unity", "By Blade and Blood", "Ever Watchful",
        "Stone Endures", "The Tide Rises", "Fire Hearts", "Silent Steps",
        "Glory in Death", "Iron Will", "Truth Conquers", "Faith is Armor",
        "Never Bow", "Rise from Ash", "Guardians of the Pass", "Victory or Death",
        "Wisdom Guides", "Loyalty Binds", "Shadows Protect", "Light the Way",
        "Roots Run Deep", "Storms Pass", "We Do Not Break", "Hold the Line",
        "Courage is Capital", "Family First", "Steel and Soul", "Bound by Oath"
    ];

    const HOUSE_NAMES = {
        royal: ["Chep"],
        greater: ["Valdoria", "Thalor", "Grimward", "Sunstrider", "Ironheart", "Moonshadow", "Stormbreaker"],
        lesser: ["Oakenshield", "Swiftwater", "Gloomveil", "Brightsteel", "Duskwood", "Cragstone",
        "Mistwalker", "Windrider", "Frostborne", "Emberfall", "Ironfoot", "Ravenhill", "Shadowmere", "Lightbringer",
        "Ashford", "Briarholt", "Stonewake", "Clearbrook", "Hollowmere", "Thornfield", "Greywillow", "Highfen", 
        "Redbarrow", "Coldmere", "Duskridge", "Foxgrove", "Alderwatch", "Blackbriar", "Lowcrest", "Mournfield", "Westmere",
        "Deepwell", "Crowmere", "Marrowfen", "Stillwater", "Goldleaf", "Pineward", "Whitebarrow", "Brackenford", "Slatehollow", 
        "Amberwick", "Mirewatch", "Cinderholt", "Elderfen", "Stonebranch", "Brookhaven", "Rimefield", "Hearthmere", "Thistlemoor",]
    };
    
    const HOLDING_PREFIXES = ["The Keep of", "Fortress of", "Manor of", "Hall of"];
    
    // NEW: DEFINED HOLDING TEMPLATES
    const HOLDING_TEMPLATES = {
        'Farm': { 
            baseCost: 500, 
            basePop: 50, capPerLvl: 100, 
            baseDef: 0, defPerLvl: 1,
            descriptors: ["Fertile Valley", "Golden Fields", "River Basin", "Orchards", "Grazing Lands", "Terraced Hills"],
            descText: ["Rich soil tilled by many hands.", "A sprawling network of irrigation ditches.", "Fields of wheat waving in the wind.", "Orchards heavy with seasonal fruit."]
        },
        'Manor': { 
            baseCost: 2000, 
            basePop: 150, capPerLvl: 200, 
            baseDef: 5, defPerLvl: 5,
            descriptors: ["Stone Hall", "Timber Estate", "Fortified Villa", "Hilltop Manor", "Lakeside Estate"],
            descText: ["A sturdy stone house overseeing the lands.", "A grand hall surrounded by vineyards.", "An administrative hub for the region.", "A fortified estate with a tall watchtower."]
        },
        'Keep': { 
            baseCost: 10000, 
            basePop: 300, capPerLvl: 500, 
            baseDef: 20, defPerLvl: 15,
            descriptors: ["Iron Citadel", "Blackstone Fort", "High Tower", "Storm Bastion", "Dragon's Tooth"],
            descText: ["Thick walls that have withstood sieges.", "A military fortress guarding the pass.", "Towers that pierce the sky, manned by archers.", "A citadel surrounded by a treacherous moat."]
        }
    };

    const CITIES = [
        { name: "Chep (Capital)", ruler: "Royal House Chep", desc: "A sprawling walled capital of crowded markets, towering cathedrals, guildhalls, and narrow cobbled streets radiating from the royal citadel founded by Hero Ren.", x: 50, y: 50 },
        { name: "Frosthold", ruler: "Greater House Grimward", desc: "A wind-bitten northern city of timbered halls and stone keeps, its people hardened by long winters and its harbor choked with ice most of the year.", x: 50, y: 15 },
        { name: "Goldspire", ruler: "Greater House Valdoria", desc: "A wealthy cliffside trade city where terraced districts climb the western bluffs, its markets rich with foreign coin and its streets alive with merchants and sailors.", x: 15, y: 60 },
        { name: "Arcania", ruler: "Greater House Moonshadow", desc: "A scholarly city built atop ancient foundations, filled with scriptoria, academies, crumbling ruins, and scholars who debate beneath lamplit arcades.", x: 80, y: 70 },
        { name: "Verdan", ruler: "Greater House Sunstrider", desc: "A forest-woven city of wooden palisades and green courtyards, where hunters, herbalists, and foresters dwell beneath the canopy of the southern woods.", x: 50, y: 85 },
        { name: "Skybast", ruler: "Greater House Stormbreaker", desc: "A highland city carved into mountain slopes, its steep streets connected by stairways and rope lifts, bells echoing through thin alpine air.", x: 85, y: 25 },
        { name: "Ironport", ruler: "Greater House Ironheart", desc: "A smoke-veiled river port of foundries, shipyards, and crowded workers' quarters, where anvils ring day and night and barges carry steel across the realm.", x: 20, y: 35 },
        { name: "Tidecall", ruler: "Greater House Thalor", desc: "A storm-lashed coastal city of seawalls, lighthouses, and salt-stained stone, its docks packed with fishing vessels and deep-sea traders alike.", x: 10, y: 80 }
    ];

    // --- MARKET DATA & LOGIC ---
    const SHOP_POOLS = {
        tavern: {
            name: "Tavern", icon: "üç∫",
            items: [
                { name: "Stale Bread", rarity: "Common", desc: "Better than starving. (+2 HP)", value: 2, effect: {hp: 2} },
                { name: "Meat Pie", rarity: "Common", desc: "Hearty meal. (+3 HP)", value: 5, effect: {hp: 3} },
                { name: "Ale Tankard", rarity: "Common", desc: "Dulls the senses. (+4 SP)", value: 3, effect: {sp: 4} },
                { name: "Fine Wine", rarity: "Uncommon", desc: "A noble drink. (+2 SP)", value: 15, effect: {sp: 2} },
                { name: "Roast Chicken", rarity: "Uncommon", desc: "Full meal. (+5 HP)", value: 8, effect: {hp: 5} },
                { name: "Royal Cake", rarity: "Rare", desc: "A noble treat. (+5 HP, +2 SP)", value: 40, effect: {hp: 5, sp: 2} }
            ]
        },
        blacksmith: {
            name: "Smithy", icon: "‚öîÔ∏è",
            items: [
                { name: "Whetstone", rarity: "Common", desc: "Sharpen your blade.", value: 5 },
                // WEAPONS FROM LIBRARY
                { ...WEAPON_LIBRARY.dagger, weapon: WEAPON_LIBRARY.dagger, value: WEAPON_LIBRARY.dagger.cost },
                { ...WEAPON_LIBRARY.spear, weapon: WEAPON_LIBRARY.spear, value: WEAPON_LIBRARY.spear.cost },
                { ...WEAPON_LIBRARY.shortsword, weapon: WEAPON_LIBRARY.shortsword, value: WEAPON_LIBRARY.shortsword.cost },
                { ...WEAPON_LIBRARY.mace, weapon: WEAPON_LIBRARY.mace, value: WEAPON_LIBRARY.mace.cost },
                { ...WEAPON_LIBRARY.longsword, weapon: WEAPON_LIBRARY.longsword, value: WEAPON_LIBRARY.longsword.cost },
                { ...WEAPON_LIBRARY.battleaxe, weapon: WEAPON_LIBRARY.battleaxe, value: WEAPON_LIBRARY.battleaxe.cost },
                { ...WEAPON_LIBRARY.greatsword, weapon: WEAPON_LIBRARY.greatsword, value: WEAPON_LIBRARY.greatsword.cost },
                { name: "Chain Shirt", rarity: "Uncommon", desc: "Protect your vitals.", value: 50, dr: 2 },
                { name: "Heavy Shield", rarity: "Uncommon", desc: "Block incoming blows.", value: 30, dr: 1 },
                { name: "Plate Armor", rarity: "VeryRare", desc: "Heavy protection.", value: 500, dr: 5 }
            ]
        },
        herbalist: {
            name: "Herbalist", icon: "üåø",
            items: [
                { name: "Healing Salve", rarity: "Common", desc: "Heals 2 HP.", value: 10, effect: {hp: 2} },
                { name: "Medicinal Herbs", rarity: "Common", desc: "Soothes pain. (+1 HP)", value: 5, effect: {hp: 1} },
                { name: "Healing Potion", rarity: "Uncommon", desc: "Heals 10 HP.", value: 30, effect: {hp: 10} },
                { name: "Focus Draught", rarity: "Uncommon", desc: "Restores 2 SP.", value: 25, effect: {sp: 2} },
                { name: "Snake Oil", rarity: "Common", desc: "Does nothing.", value: 5 },
                { name: "Liquid Fire", rarity: "Rare", desc: "Dangerous substance.", value: 60 }
            ]
        },
        oddities: {
            name: "Oddities", icon: "üîÆ",
            items: [
                { name: "Warm Cloak", rarity: "Common", desc: "Good for travel.", value: 10 },
                { name: "Old Map", rarity: "Uncommon", desc: "Where does it lead?", value: 20 },
                { name: "Strange Coin", rarity: "Rare", desc: "Unknown currency.", value: 50 },
                { name: "Cursed Ring", rarity: "VeryRare", desc: "Cold to the touch.", value: 10 },
                { name: "Dragon Scale", rarity: "Legendary", desc: "Warm and hard as steel.", value: 300 }
            ]
        }
    };

    function generateMarket(cityIndex) {
        state.market = [];
        
        // Define the 4 fixed shops
        const definitions = [
            { type: 'tavern', role: 'Tavernkeeper', pool: SHOP_POOLS.tavern },
            { type: 'blacksmith', role: 'Blacksmith', pool: SHOP_POOLS.blacksmith },
            { type: 'herbalist', role: 'Herbalist', pool: SHOP_POOLS.herbalist },
            { type: 'oddities', role: 'Curio Dealer', pool: SHOP_POOLS.oddities }
        ];

        definitions.forEach(def => {
            // 1. Try to find an existing vendor NPC in this city with the right job
            // FILTER: Must be alive. If previous vendor died, this returns undefined, triggering succession.
            let vendor = state.relationships.find(r => 
                r.locationIndex === cityIndex && 
                r.occupation === def.role && 
                r.health !== 'Deceased'
            );

            // 2. If no vendor exists (or previous died), create a new persistent NPC
            if (!vendor) {
                const gender = Math.random() > 0.5 ? 'Male' : 'Female';
                const name = getRandomName(gender);
                // Create relationship with specific role
                // ARGS: name, relation, friendship, gender, rank, locIndex, isBlood, isFamily, age, isKnown
                vendor = addRelationship(name, "Merchant", 0, gender, "Commoner", cityIndex, false, false, null, false);
                vendor.occupation = def.role; // Force the correct job
            }

            // 3. Generate Items for this year
            const shopItems = [];
            const numItems = 4 + Math.floor(Math.random() * 3);
            for(let j=0; j<numItems; j++) {
                const itemTemplate = def.pool.items[Math.floor(Math.random() * def.pool.items.length)];
                shopItems.push({ ...itemTemplate, sold: false, id: Math.random().toString(36).substr(2,9) });
            }

            // 4. Add to market state
            state.market.push({
                id: Math.random().toString(36).substr(2,9),
                type: def.type,
                name: `${vendor.name}'s ${def.pool.name}`,
                vendorId: vendor.id, // Link to NPC ID
                vendorName: vendor.name,
                icon: def.pool.icon,
                items: shopItems
            });
        });
    }

    function renderMarketTab() {
        document.getElementById('market-view-main').classList.remove('hidden');
        document.getElementById('market-view-shop').classList.add('hidden');
        
        const container = document.getElementById('market-content');
        document.getElementById('market-desc').innerText = `The market of ${CITIES[state.location].name} is bustling.`;

        // Age Check Logic
        if (state.age < 6) {
            container.innerHTML = `<p class="col-span-2 text-center italic mt-4 opacity-70">You are too young to navigate the market crowds alone.</p>`;
            return;
        }

        if (state.market.length === 0) {
            container.innerHTML = `<p class="col-span-2 italic opacity-50">The market stalls are empty today.</p>`;
            return;
        }

        container.innerHTML = state.market.map(shop => `
            <div class="shop-card" onclick="openShop('${shop.id}')">
                <div class="shop-icon">${shop.icon}</div>
                <div class="shop-name">${shop.name}</div>
                <div class="vendor-name">${shop.vendorName}</div>
            </div>
        `).join('');
    }

    function openShop(shopId) {
        document.getElementById('market-view-main').classList.add('hidden');
        document.getElementById('market-view-shop').classList.remove('hidden');
        
        const shop = state.market.find(s => s.id === shopId);
        
        if (!shop) {
            console.error("Shop ID not found:", shopId);
            document.getElementById('shop-detail-content').innerHTML = `<div class="p-4 text-center italic opacity-50">This shop has closed for the day.</div>`;
            return;
        }

        // REVEAL LOGIC: If we enter the shop, we meet the vendor
        const vendor = state.relationships.find(r => r.id === shop.vendorId);
        if (vendor && vendor.isKnown === false) {
            vendor.isKnown = true;
            // No log needed, visual confirmation is enough in the UI
        }

        const container = document.getElementById('shop-detail-content');
        
        const vendorGold = vendor ? (vendor.gold || 0) : 0;
        container.innerHTML = `
            <div class="mb-4 border-b border-black/10 pb-4">
                <div class="flex justify-between items-start gap-4">
                    <div class="text-left flex-grow">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="text-3xl">${shop.icon}</div>
                            <h3 class="text-2xl font-medieval leading-none">${shop.name}</h3>
                        </div>
                        <div class="npc-card inline-flex items-center gap-2 px-2 py-1" onclick="openNPC('${shop.vendorId}')">
                            <span class="font-bold text-sm">üë§ ${shop.vendorName}</span>
                        </div>
                    </div>
                    
                    <div class="bg-[#fdf6e3] border-2 border-[#b8860b] rounded p-2 shadow-md text-center flex-shrink-0">
                        <div class="text-[10px] uppercase font-bold text-amber-800 tracking-wider leading-none mb-1">Your Purse</div>
                        <div class="text-xl font-bold text-amber-900 font-medieval leading-none">${state.gold} gp</div>
                    </div>
                </div>
            </div>
            <div class="space-y-2">
                ${shop.items.map((item, idx) => `
                    <div class="item-card ${item.sold ? 'sold-out' : ''}">
                        <div>
                            <div class="font-bold text-sm item-rarity-${item.rarity}">${item.name}</div>
                            <div class="text-xs opacity-70">${item.desc}</div>
                        </div>
                        <button 
                            onclick="buyMarketItem('${shop.id}', ${idx})" 
                            class="buy-btn" 
                            ${item.sold || state.gold < item.value ? 'disabled' : ''}>
                            ${item.sold ? 'Sold Out' : `Buy ${item.value}g`}
                        </button>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function buyMarketItem(shopId, itemIndex) {
        if(state.health <= 0) return; // Guard for death
        const shop = state.market.find(s => s.id === shopId);
        if (!shop) return; // Safety check for invalid shop

        const item = shop.items[itemIndex];
        
        if (state.gold >= item.value && !item.sold) {
            // UPDATED: Pass weapon object if present
            const added = addItem(item.name, item.rarity, item.desc, Math.floor(item.value/2), item.effect, item.dr, item.weapon);
            
            if (added) {
                state.gold -= item.value;
                item.sold = true;
                AudioEngine.pulse();
                updateUI();
                openShop(shopId); // Re-render to show Sold Out
            } else {
                showMsg("Inventory Full", "You are carrying too much.");
            }
        }
    }

    // --- CONSOLIDATED UTILITIES ---
    // (Removed duplicate marryNPC and getRelLabel from here as they are defined below in Relationship System)

    const NPC_NAMES = {
m: ["Aethelred", "Alaric", "Alistair", "Alvric", "Baldric", "Beren", "Berengar", "Cadeyrn", 
    "Caedmon", "Cerdic", "Ciaran", "Conrad", "Cyprian", "Darian", "Dorian", "Drustan", 
    "Dunstan", "Edric", "Edwin", "Eamon", "Emric", "Faramond", "Fenric", "Gareth", "Gawain", 
    "Godric", "Hadrian", "Haldor", "Hector", "Hereward", "Isidore", "Ivor", "Jareth", "Kaelen", 
    "Leofric", "Lucan", "Magnus", "Malric", "Merek", "Nial", "Oberon", "Osric", "Percival", 
    "Quentin", "Ragnar", "Roderick", "Roland", "Sigurd", "Soren", "Thaddeus", "Theodoric", 
    "Thorian", "Ulric", "Valerian", "Viggo", "Wulfric", "Xanthus", "Yorick", "Zephyr", 
    "Aldric", "Armand", "Brennus", "Cassian", "Corwin", "Dagon", "Eldric", "Emilian", "Faelan", 
    "Galen", "Hadwin", "Icarus", "Jorund", "Kaelith", "Leander", "Lucius", "Mordric", "Nikolai", 
    "Osmund", "Peregrin", "Quintus", "Ravric", "Savaric", "Tiberius", "Ulfred", "Varric", 
    "Wendell", "Xerxes", "Yvain", "Zephan", "Aric", "Bartholomew", "Caius", "Dacian", "Eryndor", 
    "Fendrel", "Gwydion", "Hrothgar", "Ithric", "Jovian", "Kaelor", "Lucaniel", "Maelric", 
    "Orric", "Pryderi", "Rhydderch", "Thalric", "Ulmar", "Veyron", "Wystan", "Juanse", "Ricky",
    "Max", "Jon", "Arcenio", "Tom", "Sean", "Noah", "Karl", "Dindi", "Lucifer", "Ren", "Finn", 
    "Alec", "Zeke", "Ron", "Jake", "Giovan", "Eros", "Sevon", "Aeron", "Aldwin", "Almeric", 
    "Anselm", "Arthric", "Auberon", "Baelor", "Bastian", "Belisarius", "Bors", "Brandr", "Branwen", 
    "Bricen", "Caelan", "Calder", "Cassiel", "Cedric", "Cillian", "Corentin", "Darianth", "Darius", 
    "Daxton", "Decimus", "Drogan", "Edgard", "Elric", "Elwin", "Emeric", "Evander", "Fenris", "Fintan", 
    "Gaius", "Garrick", "Gideon", "Godfrey", "Griffin", "Hadric", "Hawke", "Helric", "Heron",
    "Iagan", "Iskander", "Jorvik", "Kaedric", "Kaevan", "Kendric", "Leoric", "Loric",
    "Luther", "Maelor", "Marius", "Matthias", "Merrick", "Nerian", "Norwin", "Octavian",
    "Orion", "Owyn", "Phineas", "Quillan", "Rhydian", "Riven", "Rowan", "Sebric",
    "Severin", "Silas", "Stellan", "Sullivan", "Tarian", "Theron", "Torin", "Tristan",
    "Urian", "Vaelin", "Valen", "Varian", "Vesper", "Victarion", "Warrick", "Weston",
    "Wilric", "Wysten", "Xavian", "Yorvan", "Zarek", "Zavian"], 
f: ["Aalis", "Adelaide", "Adelina", "Aelith", "Alfhild", "Althea", "Amalind", "Annelise", 
    "Arden", "Arlena", "Bilda", "Beatrix", "Branwen", "Brunhild", "Cadence", "Claricent", 
    "Constance", "Cyrene", "Dagmar", "Daria", "Ealdgyth", "Edith", "Eira", "Elanor", "Elspeth", 
    "Emmeline", "Ermentrude", "Eseld", "Faramonde", "Freya", "Gilda", "Gisela", "Gwyneth", 
    "Hannelore", "Hedwig", "Hildegard", "Ingrid", "Isolde", "Jocelyn", "Joan", "Juliana", 
    "Kaela", "Katerin", "Leocadia", "Lenore", "Liora", "Magdalene", "Maelis", "Mathilda", 
    "Melisande", "Millicent", "Morwenna", "Nimue", "Odette", "Olwen", "Ophelia", "Rosamund", 
    "Rowena", "Sabine", "Sabrina", "Sigrid", "Sybil", "Thalassa", "Theodora", "Ulrica", 
    "Valeria", "Vevina", "Winifred", "Ysolde", "Zephyra", "Alvara", "Anastasia", "Arwen", 
    "Arielle", "Branella", "Caris", "Celestria", "Delphine", "Eadlin", "Elenora", "Elvira", 
    "Fenella", "Gwenora", "Helisent", "Ilyana", "Isabetta", "Jovienne", "Kerensa", "Leandra", 
    "Lilith", "Meliora", "Nerissa", "Oriana", "Parthenia", "Queniva", "Rhiannon", "Seraphine", 
    "Thessaly", "Vespera", "Ylva", "Zinnia", "Aeliana", "Branwyn", "Catriona", "Dextra", "Evelina",
    "Denise", "Sam", "Savanna", "Anna", "Crystal", "Delores", "Star", "Payton", "Aveline", "Aurelia", 
    "Astraea", "Almira", "Amaris", "Anwyn", "Arlisse", "Ariadne", "Belladonna", "Brielle", "Bryony", 
    "Caelia", "Calanthe", "Celandine", "Ceridwen", "Clarimond", "Cordelia", "Corisande", "Daelira", 
    "Desdemona", "Drusilla", "Elaria", "Elowen", "Elara", "Emeralda", "Elysia", "Endellion", "Evadne", 
    "Faelina", "Fiora", "Floriana", "Galadriel", "Ginevra", "Griselda", "Hadewyn", "Haleth", "Helena", 
    "Hestia", "Illyria", "Ione", "Isadora", "Jessamine", "Kaelira", "Kalista", "Lavinia", "Lorelei", 
    "Lucinda", "Lysandra", "Maerwynn", "Maribelle", "Mariselle", "Mirelda", "Miriel", "Naerys", "Nerina", 
    "Noctra", "Odelia", "Olivette", "Persephone", "Petronella", "Quilla", "Ravena", "Renata", "Rosaline",
    "Rowenna", "Sable", "Selene", "Serilda", "Solenne", "Sylvara", "Tamsin", "Tempest", "Thalira", "Valessa", 
    "Valora", "Velora", "Verena", "Vivienne", "Wynne", "Xanthe", "Yvaine", "Zafira", "Zarael", "Zephira"]
    };

    function createEvent(id, title, text, choices) {
        return { id, title, text, choices };
    }

    /* --- COMBAT ENGINE --- */
    
    // (WEAPON LIBRARY REMOVED - MOVED UP TO TOP)

    /* --- ARCANE BESTIARY & MONSTER MANUAL --- */
    const BESTIARY = {
        'goblin': {
            name: "Goblin", icon: "üë∫",
            tiers: [
                { title: "Scavenger", hp: 8, ac: 12, atk: 2, dmg: 4, xp: 10, gold: 2 },
                { title: "Raider", hp: 15, ac: 13, atk: 4, dmg: 6, xp: 25, gold: 5 },
                { title: "Warlord", hp: 35, ac: 15, atk: 6, dmg: 8, xp: 100, gold: 30 }
            ],
            skills: ["Ambush", "Pack Tactics"]
        },
        'bandit': {
            name: "Bandit", icon: "ü•∑",
            tiers: [
                { title: "Thug", hp: 12, ac: 11, atk: 3, dmg: 5, xp: 15, gold: 5 },
                { title: "Highwayman", hp: 22, ac: 13, atk: 5, dmg: 7, xp: 40, gold: 15 },
                { title: "Bandit Boss", hp: 50, ac: 15, atk: 7, dmg: 10, xp: 150, gold: 100 }
            ],
            skills: ["Dirty Fighting", "Intimidate"]
        },
        'wolf': {
            name: "Wolf", icon: "üê∫",
            tiers: [
                { title: "Stray", hp: 10, ac: 12, atk: 3, dmg: 4, xp: 10, gold: 0 },
                { title: "Timber Wolf", hp: 20, ac: 13, atk: 5, dmg: 6, xp: 30, gold: 0 },
                { title: "Dire Wolf", hp: 45, ac: 14, atk: 7, dmg: 10, xp: 120, gold: 0 }
            ],
            skills: ["Pack Tactics", "Howl"]
        },
        'bear': {
            name: "Bear", icon: "üêª",
            tiers: [
                { title: "Black Bear", hp: 25, ac: 12, atk: 4, dmg: 6, xp: 50, gold: 0 },
                { title: "Grizzly Bear", hp: 45, ac: 13, atk: 6, dmg: 9, xp: 150, gold: 0 },
                { title: "Dire Bear", hp: 80, ac: 15, atk: 8, dmg: 12, xp: 400, gold: 0 }
            ],
            skills: ["Maul", "Roar"]
        },
        'troll': {
            name: "Troll", icon: "üßü",
            tiers: [
                { title: "River Troll", hp: 30, ac: 13, atk: 5, dmg: 8, xp: 100, gold: 10 },
                { title: "Cave Troll", hp: 60, ac: 15, atk: 7, dmg: 12, xp: 300, gold: 40 },
                { title: "Mountain Troll", hp: 100, ac: 17, atk: 9, dmg: 16, xp: 1000, gold: 200 }
            ],
            skills: ["Regeneration", "Crush"]
        },
        'knight': {
            name: "Knight", icon: "üõ°Ô∏è",
            tiers: [
                { title: "Hedge Knight", hp: 25, ac: 15, atk: 4, dmg: 7, xp: 100, gold: 20 },
                { title: "Sworn Sword", hp: 50, ac: 17, atk: 6, dmg: 9, xp: 300, gold: 60 },
                { title: "Champion", hp: 90, ac: 19, atk: 9, dmg: 12, xp: 1000, gold: 250 }
            ],
            skills: ["Parry", "Riposte", "Honor"]
        }
    };

    const QUALITY_MODS = {
        'Poor': { hp: 0.8, atk: -1, prefix: "Starving" },
        'Standard': { hp: 1.0, atk: 0, prefix: "" },
        'Elite': { hp: 1.2, atk: +1, prefix: "Veteran" },
        'Legendary': { hp: 1.5, atk: +2, prefix: "Legendary" }
    };

    function generateCreature(key, tierIndex = 0, quality = 'Standard') {
        const template = BESTIARY[key];
        if (!template) {
            console.error("Creature key not found:", key);
            return null;
        }
        
        // Tier Clamp
        tierIndex = Math.max(0, Math.min(tierIndex, template.tiers.length - 1));
        const tierData = template.tiers[tierIndex];
        const qMod = QUALITY_MODS[quality] || QUALITY_MODS['Standard'];

        // Generate final stats
        const maxHp = Math.floor(tierData.hp * qMod.hp);
        const finalAtk = tierData.atk + qMod.atk;
        const name = qMod.prefix ? `${qMod.prefix} ${tierData.title}` : tierData.title;

        // Flavor name generation for Knights/Bandits
        let displayName = name;
        if (key === 'knight' || key === 'bandit') {
            const gender = Math.random() > 0.5 ? 'Male' : 'Female';
            const rndName = getRandomName(gender);
            displayName = `${name} ${rndName}`;
        }

        return {
            id: `enemy_${key}_${Date.now()}_${Math.random()}`,
            name: displayName,
            maxHp: maxHp,
            hp: maxHp,
            ac: tierData.ac,
            atk: finalAtk,
            dmg: tierData.dmg,
            icon: template.icon,
            gold: Math.floor(tierData.gold * qMod.hp),
            xp: Math.floor(tierData.xp * qMod.hp),
            skills: template.skills
        };
    }

    const CombatEngine = {
        active: false,
        player: null,
        enemy: null,
        round: 1,
        logHistory: [],
        turn: 'player', 
        callbacks: { onWin: null, onLose: null },
        modifiers: { playerDefending: false },
        menuState: 'main', // NEW: Navigation State

        flavorText: {
            playerHit: ["You lunge forward with a precision strike!", "Your blade finds a gap in their guard!", "A solid hit! The enemy winces in pain.", "You drive your weapon home!"],
            playerMiss: ["Your swing goes wide as they sidestep.", "The enemy parries your blow effortlessly.", "You lose your footing slightly, missing the mark.", "Your attack clangs harmlessly off their armor."],
            enemyHit: ["The enemy strikes you with brutal force!", "A jagged blade bites into your shoulder!", "You weren't fast enough to block that one.", "The blow staggers you!"],
            enemyMiss: ["You narrowly dodge the incoming strike!", "Your armor absorbs the impact.", "You parry the blow with a flick of your wrist.", "The enemy overextends, missing you completely."]
        },

        // NEW: Dynamic Enemy Generator
        generateEnemy: function(tier) {
            const types = ['bandit', 'wolf', 'goblin'];
            const type = types[Math.floor(Math.random() * types.length)];
            const bTier = Math.min(2, Math.floor(tier / 3));
            let quality = 'Standard';
            if (tier % 3 === 2) quality = 'Elite';
            return generateCreature(type, bTier, quality);
        },

        start: function(enemyData, onWin, onLose) {
            this.active = true;
            this.round = 1;
            this.turn = 'player';
            this.menuState = 'main'; // Reset menu
            this.callbacks = { onWin, onLose };
            this.logHistory = [];
            this.modifiers = { playerDefending: false, enemyStunned: false };

            const pArmor = getPlayerArmor();
            
            let weapon = WEAPON_LIBRARY.unarmed;
            if (state.equipped.mainHand && state.equipped.mainHand.weapon) {
                weapon = state.equipped.mainHand.weapon;
            }

            const pStr = getModifier(state.stats.str);
            const pDex = getModifier(state.stats.dex);
            
            let combatMod = pStr;
            if (weapon.type === 'finesse') {
                combatMod = Math.max(pStr, pDex);
            }

            const atkBonus = combatMod;
            const dmgBonus = combatMod;

            let natArmor = 0;
            if (state.appearance.mutations) {
                state.appearance.mutations.forEach(m => {
                    if (m.stats && m.stats.ac) natArmor += m.stats.ac;
                });
            }

            this.player = {
                name: state.name,
                maxHp: state.maxHealth,
                hp: state.health,
                ac: 10 + pDex + pArmor + natArmor,
                atk: atkBonus,
                dmgMod: dmgBonus,
                dmgDie: weapon.dmg,
                weaponName: weapon.name
            };

            if (typeof enemyData === 'number') {
                this.enemy = this.generateEnemy(enemyData);
            } else {
                this.enemy = {
                    id: enemyData.id || 'enemy',
                    name: enemyData.name || 'Enemy',
                    maxHp: enemyData.hp || 10,
                    hp: enemyData.hp || 10,
                    ac: enemyData.ac || 10,
                    atk: enemyData.atk || 0,
                    dmg: enemyData.dmg || 4,
                    icon: enemyData.icon || 'üë∫',
                    xp: enemyData.xp || 10,
                    gold: enemyData.gold || 0
                };
            }

            document.getElementById('combat-modal').classList.remove('hidden');
            document.getElementById('combat-log-area').innerHTML = ""; 
            this.log(`<strong>Battle Commences!</strong> You face ${this.enemy.name}.`);
            this.log(`<em>Wielding: ${this.player.weaponName} (1d${this.player.dmgDie}${formatMod(this.player.dmgMod)})</em>`, 'miss');
            
            this.renderControls('combat');
            this.render();
        },

        // NEW: Navigation
        navigate: function(menu) {
            this.menuState = menu;
            this.renderControls('combat');
        },

        // NEW: Item Usage Logic
        useCombatItem: function(idx) {
            const item = state.inventory[idx];
            if (!item) return;

            // Logic replicated from useItem but adapted for combat loop
            let used = false;
            
            if (item.effect) {
                if (item.effect.hp) {
                    this.player.hp = Math.min(this.player.maxHp, this.player.hp + item.effect.hp);
                    state.health = this.player.hp;
                    this.log(`You used <strong>${item.name}</strong>. (+${item.effect.hp} HP)`, 'heal');
                    used = true;
                }
                if (item.effect.sp) {
                    modSanity(item.effect.sp); // Updates global state directly
                    this.log(`You used <strong>${item.name}</strong>. (+${item.effect.sp} SP)`, 'heal');
                    used = true;
                }
            }

            if (used) {
                state.inventory.splice(idx, 1); // Remove item
                // Pass turn
                if (this.active) {
                    this.turn = 'enemy';
                    this.render();
                    // Reset to main menu for next turn
                    this.menuState = 'main'; 
                    this.renderControls('combat');
                    setTimeout(() => this.enemyTurn(), 800);
                }
            } else {
                this.log("That item has no combat effect.", 'miss');
            }
        },

        renderControls: function(mode) {
            const controls = document.getElementById('combat-controls');
            controls.innerHTML = ''; 

            if (mode === 'combat') {
                if (this.menuState === 'main') {
                    // MAIN MENU STRUCTURE
                    controls.className = "grid grid-cols-3 gap-2 pt-2 border-t-2 border-red-900/30";
                    controls.innerHTML = `
                        <button onclick="CombatEngine.navigate('fight')" class="choice-btn justify-center bg-red-900 text-white border-red-950 hover:bg-red-800 text-lg font-bold">‚öîÔ∏è Fight</button>
                        <button onclick="CombatEngine.navigate('satchel')" class="choice-btn justify-center bg-amber-700 text-white border-amber-900 hover:bg-amber-600 text-lg font-bold">üéí Satchel</button>
                        <button onclick="CombatEngine.playerAction('flee')" class="choice-btn justify-center opacity-80 hover:opacity-100 text-lg">üèÉ Flee</button>
                    `;
                } 
                else if (this.menuState === 'fight') {
                    // FIGHT SUB-MENU
                    controls.className = "grid grid-cols-2 gap-2 pt-2 border-t-2 border-red-900/30";
                    
                    let html = `<button onclick="CombatEngine.navigate('main')" class="choice-btn justify-center bg-gray-600 text-white text-xs col-span-2 py-1 h-8 min-h-0">‚Ü© Back</button>`;
                    
                    // Basic Actions
                    html += `<button onclick="CombatEngine.playerAction('attack')" class="choice-btn justify-center bg-red-900 text-white border-red-950 hover:bg-red-800 text-lg">‚öîÔ∏è Strike</button>`;
                    html += `<button onclick="CombatEngine.playerAction('defend')" class="choice-btn justify-center bg-blue-900 text-white border-blue-950 hover:bg-blue-800">üõ°Ô∏è Defend</button>`;

                    // Skills
                    if (state.combatSkills.includes('precision_strike')) {
                        html += `<button onclick="CombatEngine.playerAction('precision_strike')" class="choice-btn justify-center bg-sky-900 text-white border-sky-950 hover:bg-sky-800 text-sm">üéØ Precision</button>`;
                    }
                    if (state.combatSkills.includes('shield_bash')) {
                        html += `<button onclick="CombatEngine.playerAction('shield_bash')" class="choice-btn justify-center bg-stone-700 text-white border-stone-900 hover:bg-stone-600 text-sm">üõ°Ô∏è Bash</button>`;
                    }

                    // Mutations
                    const mutations = state.appearance.mutations || [];
                    if (mutations.some(m => m.combatAbility === 'psychic')) {
                        html += `<button onclick="CombatEngine.playerAction('psychic')" class="choice-btn justify-center bg-purple-900 text-white border-purple-950 hover:bg-purple-800 text-sm">üîÆ Psychic Blast</button>`;
                    }
                    if (mutations.some(m => m.combatAbility === 'firebreath')) {
                        html += `<button onclick="CombatEngine.playerAction('firebreath')" class="choice-btn justify-center bg-orange-700 text-white border-orange-900 hover:bg-orange-600 text-sm">üî• Fire Breath</button>`;
                    }
                    controls.innerHTML = html;
                }
                else if (this.menuState === 'satchel') {
                    // SATCHEL SUB-MENU
                    controls.className = "grid grid-cols-2 gap-2 pt-2 border-t-2 border-red-900/30 max-h-32 overflow-y-auto";
                    
                    let html = `<button onclick="CombatEngine.navigate('main')" class="choice-btn justify-center bg-gray-600 text-white text-xs col-span-2 py-1 h-8 min-h-0 sticky top-0 z-10">‚Ü© Back</button>`;
                    
                    // Filter Usable Items
                    const consumables = state.inventory
                        .map((item, idx) => ({ ...item, idx }))
                        .filter(i => i.effect && (i.effect.hp || i.effect.sp));

                    if (consumables.length === 0) {
                        html += `<div class="col-span-2 text-center italic opacity-50 text-sm p-2">Empty.</div>`;
                    } else {
                        consumables.forEach(item => {
                            html += `<button onclick="CombatEngine.useCombatItem(${item.idx})" class="choice-btn justify-center text-xs flex flex-col items-center p-1 h-auto bg-amber-50 border-amber-200 text-amber-900 hover:bg-amber-100">
                                <span class="font-bold">${item.name}</span>
                                <span class="text-[9px] opacity-70">${item.desc}</span>
                            </button>`;
                        });
                    }
                    controls.innerHTML = html;
                }
            } else if (mode === 'victory') {
                controls.className = "grid grid-cols-2 gap-3 pt-2 border-t-2 border-red-900/30";
                controls.innerHTML = `
                    <button onclick="CombatEngine.resolveVictory('finish')" class="choice-btn justify-center bg-red-900 text-white border-red-950 hover:bg-red-800 text-lg col-span-2">‚ò†Ô∏è Finish Them (Loot & Glory)</button>
                    <button onclick="CombatEngine.resolveVictory('mercy')" class="choice-btn justify-center bg-blue-900 text-white border-blue-950 hover:bg-blue-800 text-lg col-span-2">üïäÔ∏è Show Mercy (Honor)</button>
                `;
            } else if (mode === 'defeat') {
                controls.className = "grid grid-cols-2 gap-3 pt-2 border-t-2 border-red-900/30";
                controls.innerHTML = `
                    <button onclick="CombatEngine.resolveDefeat('honor')" class="choice-btn justify-center bg-red-900 text-white border-red-950 hover:bg-red-800 text-lg col-span-2">‚öîÔ∏è Die with Honor</button>
                    <button onclick="CombatEngine.resolveDefeat('beg')" class="choice-btn justify-center bg-amber-700 text-white border-amber-900 text-lg">üôè Beg for Mercy (CHA)</button>
                    <button onclick="CombatEngine.resolveDefeat('crawl')" class="choice-btn justify-center bg-stone-700 text-white border-stone-900 text-lg">ü™± Crawl Away (DEX)</button>
                `;
            }
        },

        log: function(msg, type='normal') {
            const logEl = document.getElementById('combat-log-area');
            const div = document.createElement('div');
            if (type === 'crit') div.className = "text-amber-700 font-bold";
            if (type === 'hit') div.className = "text-red-900";
            if (type === 'heal') div.className = "text-green-800 font-bold";
            if (type === 'miss') div.className = "opacity-60 italic";
            
            div.innerHTML = msg;
            logEl.prepend(div); 
        },

        render: function() {
            document.getElementById('combat-player-name').innerText = this.player.name;
            const ppct = (this.player.hp / this.player.maxHp) * 100;
            document.getElementById('combat-player-hp-bar').style.width = `${Math.max(0, ppct)}%`;
            document.getElementById('combat-player-hp-text').innerText = `${Math.ceil(this.player.hp)} / ${this.player.maxHp}`;
            document.getElementById('combat-player-stats').innerText = `AC: ${this.player.ac} | ATK: +${this.player.atk}`;

            document.getElementById('combat-enemy-name').innerText = this.enemy.name;
            const epct = (this.enemy.hp / this.enemy.maxHp) * 100;
            document.getElementById('combat-enemy-hp-bar').style.width = `${Math.max(0, epct)}%`;
            document.getElementById('combat-enemy-hp-text').innerText = `${Math.ceil(this.enemy.hp)} / ${this.enemy.maxHp}`;
            document.getElementById('combat-enemy-status').innerText = `AC: ${this.enemy.ac} | DMG: 1d${this.enemy.dmg}`;

            document.getElementById('combat-round').innerText = `Round ${this.round}`;

            if (this.active) {
                // Disable controls during enemy turn
                const btns = document.querySelectorAll('#combat-controls button');
                btns.forEach(b => b.disabled = (this.turn !== 'player'));
            }
        },

        playerAction: async function(action) {
            if (this.turn !== 'player') return;

            if (action === 'attack') {
                await this.performAttack(this.player, this.enemy, true);
            } else if (action === 'defend') {
                this.modifiers.playerDefending = true;
                this.log(`<strong>${this.player.name}</strong> braces for impact! (+2 AC)`, 'normal');
            } else if (action === 'precision_strike') {
                const oldAtk = this.player.atk;
                this.player.atk += 5;
                this.log(`<strong>${this.player.name}</strong> focuses! (+5 Hit)`);
                await this.performAttack(this.player, this.enemy, true);
                this.player.atk = oldAtk;
            } else if (action === 'shield_bash') {
                const d20 = Math.floor(Math.random() * 20) + 1;
                const total = d20 + this.player.atk;
                this.log(`<strong>${this.player.name}</strong> attempts Shield Bash!`);
                if (total >= this.enemy.ac) {
                    const dmg = Math.max(1, 2 + Math.floor(getModifier(state.stats.str)/2));
                    this.enemy.hp -= dmg;
                    this.modifiers.enemyStunned = true;
                    this.log(`<strong>CRASH!</strong> Staggered the enemy! (${dmg} DMG)`, 'hit');
                } else {
                    this.log(`Shield Bash missed.`, 'miss');
                }
                this.render();
                if (this.enemy.hp <= 0) { this.triggerPhase('victory'); return; }
            } else if (action === 'psychic') {
                const wisMod = getModifier(state.stats.wis);
                const dmg = Math.floor(Math.random() * 8) + 4 + wisMod; 
                this.log(`<strong>${this.player.name}</strong> unleashes a wave of mental energy!`, 'crit');
                document.getElementById('combat-enemy').classList.add('anim-shake');
                setTimeout(() => document.getElementById('combat-enemy').classList.remove('anim-shake'), 300);
                this.enemy.hp -= dmg;
                this.log(`The psychic blast strikes the enemy's mind for <strong>${dmg} DMG</strong>!`, 'hit');
                this.render();
                if (this.enemy.hp <= 0) { this.triggerPhase('victory'); return; }
            } else if (action === 'firebreath') {
                const conMod = getModifier(state.stats.con);
                const dmg = Math.floor(Math.random() * 10) + 5 + conMod;
                this.log(`<strong>${this.player.name}</strong> exhales a torrent of searing flames!`, 'crit');
                document.getElementById('combat-enemy').classList.add('anim-shake');
                setTimeout(() => document.getElementById('combat-enemy').classList.remove('anim-shake'), 300);
                this.enemy.hp -= dmg;
                this.log(`The fire engulfs the enemy for <strong>${dmg} DMG</strong>!`, 'hit');
                this.render();
                if (this.enemy.hp <= 0) { this.triggerPhase('victory'); return; }
            } else if (action === 'flee') {
                const roll = Math.floor(Math.random() * 20) + 1;
                const bonus = getModifier(state.stats.dex);
                const total = roll + bonus;
                const dc = 10 + Math.floor(this.enemy.atk / 2);
                this.log(`<em>Escape Roll: ${roll} + ${bonus} = ${total} (vs DC ${dc})</em>`);
                if (total >= dc) {
                    this.log("You successfully retreat from the fray!", 'heal');
                    setTimeout(() => this.endCombat(false, true), 1000);
                    return;
                } else {
                    this.log("The enemy blocks your path! You're cornered.", 'miss');
                }
            }

            if (this.active) {
                this.turn = 'enemy';
                this.render();
                // Reset menu for next turn
                this.menuState = 'main'; 
                this.renderControls('combat');
                setTimeout(() => this.enemyTurn(), 800);
            }
        },

        enemyTurn: async function() {
            if (!this.active) return;
            
            if (this.modifiers.enemyStunned) {
                this.log(`<strong>${this.enemy.name}</strong> is reeling and cannot attack!`, 'crit');
                this.modifiers.enemyStunned = false;
            } else {
                await this.performAttack(this.enemy, this.player, false);
            }

            if (this.player.hp > 0 && this.active) {
                this.round++;
                this.modifiers.playerDefending = false; 
                this.turn = 'player';
                this.render();
            }
        },

        performAttack: async function(attacker, defender, isPlayer) {
            const divId = isPlayer ? 'combat-player' : 'combat-enemy';
            const targetId = isPlayer ? 'combat-enemy' : 'combat-player';
            
            const div = document.getElementById(divId);
            if(div) {
                div.style.transform = isPlayer ? 'translateX(20px)' : 'translateX(-20px)';
                setTimeout(() => div.style.transform = 'translateX(0)', 200);
            }

            const d20 = Math.floor(Math.random() * 20) + 1;
            const hitMod = attacker.atk;
            const total = d20 + hitMod;
            
            let targetAC = defender.ac;
            if (!isPlayer && this.modifiers.playerDefending) targetAC += 2;

            const isCrit = d20 === 20;
            const isFumble = d20 === 1;
            const isHit = (total >= targetAC || isCrit) && !isFumble;

            this.log(`<em>${attacker.name} rolls: ${d20} + ${hitMod} = ${total} (vs AC ${targetAC})</em>`);

            if (isHit) {
                const dieSize = attacker.dmgDie || attacker.dmg || 4; 
                let baseDmg = Math.floor(Math.random() * dieSize) + 1;
                
                if (attacker.dmgMod) baseDmg += attacker.dmgMod;
                if (isCrit) baseDmg *= 2;
                
                const finalDmg = Math.max(1, baseDmg);
                defender.hp -= finalDmg;

                if (!isPlayer) {
                    state.health = defender.hp; 
                    updateUI();
                }

                const targetDiv = document.getElementById(targetId);
                if(targetDiv) {
                    targetDiv.style.transform = `translate(${Math.random()*10-5}px, ${Math.random()*10-5}px)`;
                    setTimeout(() => targetDiv.style.transform = 'translate(0,0)', 100);
                }

                const flavorArr = isPlayer ? this.flavorText.playerHit : this.flavorText.enemyHit;
                const flavor = flavorArr[Math.floor(Math.random() * flavorArr.length)];
                
                this.log(`${isCrit ? '<strong>CRITICAL! </strong>' : ''}${flavor} <strong>(${finalDmg} DMG)</strong>`, isCrit ? 'crit' : 'hit');
            } else {
                const flavorArr = isPlayer ? this.flavorText.playerMiss : this.flavorText.enemyMiss;
                const flavor = flavorArr[Math.floor(Math.random() * flavorArr.length)];
                this.log(`${isFumble ? '<strong>FUMBLE! </strong>' : ''}${flavor}`, 'miss');
            }

            this.render();

            if (defender.hp <= 0) {
                if (isPlayer) {
                    await new Promise(r => setTimeout(r, 800));
                    this.triggerPhase('victory');
                } else {
                    await new Promise(r => setTimeout(r, 800));
                    this.triggerPhase('defeat');
                }
            }
        },

        triggerPhase: function(phase) {
            this.active = false; 
            if (phase === 'victory') {
                this.log(`<strong>${this.enemy.name}</strong> falls to their knees! Their fate is in your hands.`, 'crit');
                this.renderControls('victory');
            } else {
                this.log(`<strong>You have fallen!</strong> Darkness creeps in...`, 'hit');
                this.renderControls('defeat');
            }
        },

        resolveVictory: function(choice) {
            if (choice === 'finish') {
                const gold = this.enemy.gold || Math.floor(Math.random() * 10) + 1;
                state.gold += gold;
                modRep('renown', 10);
                this.log(`You strike the final blow. Found ${gold}g. (+Renown)`, 'crit');
                setTimeout(() => this.endCombat(true, false), 1000);
            } else {
                modRep('honor', 15);
                this.log(`You spare their life. They flee in shame. (+Honor)`, 'heal');
                setTimeout(() => this.endCombat(true, false), 1000);
            }
        },

        resolveDefeat: function(choice) {
            if (choice === 'honor') {
                this.log(`You accept your fate.`, 'miss');
                setTimeout(() => this.endCombat(false, false), 1000);
            } else if (choice === 'beg') {
                const cha = getModifier(state.stats.cha);
                const dc = 12; 
                const roll = Math.floor(Math.random()*20)+1 + cha;
                this.log(`Begging (CHA): ${roll} vs DC ${dc}`);
                
                if (roll >= dc) {
                    this.log(`The enemy spits on you but leaves you alive. You lose your dignity.`, 'miss');
                    modRep('renown', -20);
                    modRep('infamy', 10);
                    state.health = 1; 
                    this.endCombat(false, true); 
                } else {
                    this.log(`They laugh and strike.`, 'hit');
                    setTimeout(() => this.endCombat(false, false), 1000);
                }
            } else if (choice === 'crawl') {
                const dex = getModifier(state.stats.dex);
                const dc = 14; 
                const roll = Math.floor(Math.random()*20)+1 + dex;
                this.log(`Crawling (DEX): ${roll} vs DC ${dc}`);
                
                if (roll >= dc) {
                    this.log(`You drag yourself into the shadows.`, 'heal');
                    state.health = 1; 
                    addTrait('Limp'); 
                    this.endCombat(false, true); 
                } else {
                    this.log(`You are caught.`, 'hit');
                    setTimeout(() => this.endCombat(false, false), 1000);
                }
            }
        },

        endCombat: function(victory, fled) {
            this.active = false;
            document.getElementById('combat-modal').classList.add('hidden');
            
            if (fled) {
                log("You live to fight another day.");
            } else if (victory) {
                if (this.callbacks.onWin) this.callbacks.onWin();
            } else {
                log(`<strong style="color:red">DEFEAT!</strong> You fell in battle.`);
                takeDamage(100); 
                if (this.callbacks.onLose) this.callbacks.onLose();
            }
            
            updateUI();
            if (victory || fled) nextTurn(); 
        }
    };

    const POOLS = {
Infancy: [
    createEvent('child_0', 'First Breath', 'The world is cold and bright.', [
        { text: 'Cry', type: 'flavor', effect: () => log("You scream your arrival to the world.") },
        { text: 'Sleep', type: 'flavor', effect: () => { state.health = Math.min(state.maxHealth, state.health + 1); log("You rest peacefully. (+1 HP)"); } },
        { text: 'Look Around', type: 'check', stat: 'wis', dc: 10, success: 'Your eyes focus early. (+1 WIS)', fail: 'It is all a blur.', onSuccess: () => state.stats.wis++, onFail: () => {} }
    ]),
    createEvent('child_1', 'First Steps', 'You wobble on unsteady legs.', [
        { text: 'Walk', type: 'check', stat: 'dex', dc: 10, success: 'You walk! (+1 DEX)', fail: 'You fall hard.', onSuccess: () => state.stats.dex++, onFail: () => takeDamage(1) },
        { text: 'Crawl', type: 'flavor', effect: () => log("Low to the ground feels safer.") },
        { text: 'Refuse', type: 'check', stat: 'wil', dc: 10, success: 'Stubborn resolve. (+1 WIL)', fail: 'You give in.', onSuccess: () => state.stats.wil++, onFail: () => {} }
    ]),
    createEvent('child_2', 'Strange Sounds', 'You attempt to shape noise into meaning.', [
        { text: 'Mimic', type: 'check', stat: 'int', dc: 12, success: 'You form a clear word. (+1 INT)', fail: 'Just drool.', onSuccess: () => state.stats.int++, onFail: () => {} },
        { text: 'Babble', type: 'check', stat: 'cha', dc: 10, success: 'People smile. (+1 CHA)', fail: 'Awkward silence.', onSuccess: () => state.stats.cha++, onFail: () => {} },
        { text: 'Listen', type: 'check', stat: 'wis', dc: 10, success: 'You grasp tone and intent. (+1 WIS)', fail: 'Only noise.', onSuccess: () => state.stats.wis++, onFail: () => {} }
    ]),
    createEvent('child_3', 'The Stray Dog', 'A mangy dog approaches you.', [
        { text: 'Pet it', type: 'check', stat: 'wis', dc: 10, success: 'It licks your face. (+1 WIS)', fail: 'It growls.', onSuccess: () => state.stats.wis++, onFail: () => modSanity(-1) },
        { text: 'Run', type: 'check', stat: 'dex', dc: 10, success: 'Fast escape! (+1 DEX)', fail: 'You trip.', onSuccess: () => state.stats.dex++, onFail: () => takeDamage(1) },
        { text: 'Bark Back', type: 'check', stat: 'cha', dc: 12, success: 'The dog tilts its head. (+1 CHA)', fail: 'It snaps.', onSuccess: () => state.stats.cha++, onFail: () => modSanity(-1) }
    ]),
    createEvent('child_4', 'Bright Fire', 'Flames flicker nearby.', [
        { text: 'Stare', type: 'check', stat: 'wis', dc: 10, success: 'You memorize the movement. (+1 WIS)', fail: 'It hurts to look.', onSuccess: () => state.stats.wis++, onFail: () => {} },
        { text: 'Reach', type: 'check', stat: 'dex', dc: 12, success: 'Quick fingers. (+1 DEX)', fail: 'You get burned.', onSuccess: () => state.stats.dex++, onFail: () => takeDamage(2) },
        { text: 'Cry', type: 'flavor', effect: () => log("The fire frightens you.") }
    ]),
    createEvent('child_5', 'Lost Coin', 'You find a coin in the mud.', [
        { text: 'Keep it', type: 'flavor', effect: () => { state.gold++; log("Finders keepers. (+1g)"); } },
        { text: 'Offer it', type: 'flavor', effect: () => { modRep('piety', 2); log("A quiet act of goodwill."); } },
        { text: 'Trade it', type: 'flavor', effect: () => { state.health++; log("A small treat lifts your spirits. (+1 HP)"); } }
    ]),
    createEvent('child_6', 'Sudden Noise', 'Something crashes nearby.', [
        { text: 'Hide', type: 'check', stat: 'dex', dc: 10, success: 'You vanish from sight. (+1 DEX)', fail: 'Too slow.', onSuccess: () => state.stats.dex++, onFail: () => {} },
        { text: 'Investigate', type: 'check', stat: 'wis', dc: 10, success: 'You understand the cause. (+1 WIS)', fail: 'Confusing chaos.', onSuccess: () => state.stats.wis++, onFail: () => {} },
        { text: 'Laugh', type: 'check', stat: 'cha', dc: 12, success: 'Your calm spreads. (+1 CHA)', fail: 'No one joins in.', onSuccess: () => state.stats.cha++, onFail: () => {} }
    ]),
    createEvent('child_7', 'Soft Song', 'A gentle melody fills the air.', [
        { text: 'Hum Along', type: 'check', stat: 'cha', dc: 10, success: 'Your voice matches. (+1 CHA)', fail: 'Off-key.', onSuccess: () => state.stats.cha++, onFail: () => {} },
        { text: 'Listen Closely', type: 'check', stat: 'wis', dc: 10, success: 'You remember it perfectly. (+1 WIS)', fail: 'It fades.', onSuccess: () => state.stats.wis++, onFail: () => {} },
        { text: 'Clap', type: 'flavor', effect: () => log("Rhythm comes naturally.") }
    ]),
    createEvent('child_8', 'Mirror Reflection', 'You see yourself reflected.', [
        { text: 'Touch', type: 'check', stat: 'int', dc: 10, success: 'You recognize yourself. (+1 INT)', fail: 'Confusing illusion.', onSuccess: () => state.stats.int++, onFail: () => {} },
        { text: 'Smile', type: 'check', stat: 'cha', dc: 10, success: 'Charm even yourself. (+1 CHA)', fail: 'Awkward stare.', onSuccess: () => state.stats.cha++, onFail: () => {} },
        { text: 'Ignore', type: 'flavor', effect: () => log("You lose interest quickly.") }
    ]),
    createEvent('child_9', 'Cold Rain', 'Rain soaks your clothes.', [
        { text: 'Endure', type: 'check', stat: 'con', dc: 10, success: 'You tough it out. (+1 CON)', fail: 'You shiver.', onSuccess: () => state.stats.con++, onFail: () => takeDamage(1) },
        { text: 'Splash', type: 'check', stat: 'cha', dc: 10, success: 'Joy in the storm. (+1 CHA)', fail: 'Just cold.', onSuccess: () => state.stats.cha++, onFail: () => {} },
        { text: 'Curl Up', type: 'flavor', effect: () => log("You wait for it to pass.") }
    ]),
        createEvent('child_10', 'Warm Blanket', 'You are wrapped tightly in cloth.', [
        { text: 'Relax', type: 'check', stat: 'con', dc: 10, success: 'You rest deeply. (+1 CON)', fail: 'Too tight.', onSuccess: () => state.stats.con++, onFail: () => {} },
        { text: 'Wiggle Free', type: 'check', stat: 'dex', dc: 10, success: 'You escape! (+1 DEX)', fail: 'Still stuck.', onSuccess: () => state.stats.dex++, onFail: () => {} },
        { text: 'Cry', type: 'flavor', effect: () => log("Someone rushes to comfort you.") }
    ]),
    createEvent('child_11', 'Gentle Hands', 'Someone lifts you carefully.', [
        { text: 'Reach Out', type: 'check', stat: 'cha', dc: 10, success: 'They smile warmly. (+1 CHA)', fail: 'They reposition you.', onSuccess: () => state.stats.cha++, onFail: () => {} },
        { text: 'Go Limp', type: 'flavor', effect: () => log("You trust the moment.") },
        { text: 'Observe', type: 'check', stat: 'wis', dc: 10, success: 'You read their mood. (+1 WIS)', fail: 'Hard to tell.', onSuccess: () => state.stats.wis++, onFail: () => {} }
    ]),
    createEvent('child_12', 'Bright Colors', 'Painted toys sway overhead.', [
        { text: 'Focus', type: 'check', stat: 'int', dc: 10, success: 'Patterns emerge. (+1 INT)', fail: 'Too many colors.', onSuccess: () => state.stats.int++, onFail: () => {} },
        { text: 'Grab', type: 'check', stat: 'dex', dc: 10, success: 'You catch one! (+1 DEX)', fail: 'Just air.', onSuccess: () => state.stats.dex++, onFail: () => {} },
        { text: 'Laugh', type: 'check', stat: 'cha', dc: 10, success: 'Joy spreads. (+1 CHA)', fail: 'Quiet moment.', onSuccess: () => state.stats.cha++, onFail: () => {} }
    ]),
    createEvent('child_13', 'Distant Thunder', 'The sky rumbles far away.', [
        { text: 'Startle', type: 'check', stat: 'wis', dc: 10, success: 'You learn caution. (+1 WIS)', fail: 'Fear lingers.', onSuccess: () => state.stats.wis++, onFail: () => modSanity(-1) },
        { text: 'Sleep Through', type: 'flavor', effect: () => { state.health++; log("You sleep soundly. (+1 HP)"); } },
        { text: 'Gaze Skyward', type: 'check', stat: 'int', dc: 12, success: 'Curiosity awakens. (+1 INT)', fail: 'Too abstract.', onSuccess: () => state.stats.int++, onFail: () => {} }
    ]),
    createEvent('child_14', 'Tasty Mash', 'A spoon approaches your mouth.', [
        { text: 'Eat', type: 'check', stat: 'con', dc: 10, success: 'Nutritious! (+1 CON)', fail: 'You spit it out.', onSuccess: () => state.stats.con++, onFail: () => {} },
        { text: 'Refuse', type: 'check', stat: 'wil', dc: 10, success: 'Strong will. (+1 WIL)', fail: 'You relent.', onSuccess: () => state.stats.wil++, onFail: () => {} },
        { text: 'Play With It', type: 'flavor', effect: () => log("The food ends up everywhere.") }
    ]),
    createEvent('child_15', 'Sunlight', 'Warm light spills across the floor.', [
        { text: 'Crawl Into It', type: 'check', stat: 'dex', dc: 10, success: 'Comfort found. (+1 DEX)', fail: 'Too slow.', onSuccess: () => state.stats.dex++, onFail: () => {} },
        { text: 'Close Eyes', type: 'check', stat: 'wis', dc: 10, success: 'You savor the warmth. (+1 WIS)', fail: 'Distracted.', onSuccess: () => state.stats.wis++, onFail: () => {} },
        { text: 'Nap', type: 'flavor', effect: () => { state.health++; log("A peaceful rest. (+1 HP)"); } }
    ]),
    createEvent('child_16', 'Rough Floor', 'You tumble onto hard ground.', [
        { text: 'Brace', type: 'check', stat: 'con', dc: 10, success: 'You endure it. (+1 CON)', fail: 'It hurts.', onSuccess: () => state.stats.con++, onFail: () => takeDamage(1) },
        { text: 'Cry Loudly', type: 'check', stat: 'cha', dc: 10, success: 'Help arrives fast. (+1 CHA)', fail: 'Delayed response.', onSuccess: () => state.stats.cha++, onFail: () => {} },
        { text: 'Stay Quiet', type: 'check', stat: 'wil', dc: 10, success: 'Inner strength grows. (+1 WIL)', fail: 'Fear creeps in.', onSuccess: () => state.stats.wil++, onFail: () => modSanity(-1) }
    ]),
    createEvent('child_17', 'Moving Shadows', 'Shapes dance on the wall.', [
        { text: 'Track Them', type: 'check', stat: 'wis', dc: 10, success: 'You predict movement. (+1 WIS)', fail: 'Disorienting.', onSuccess: () => state.stats.wis++, onFail: () => {} },
        { text: 'Reach Out', type: 'check', stat: 'dex', dc: 12, success: 'Quick hands. (+1 DEX)', fail: 'Nothing there.', onSuccess: () => state.stats.dex++, onFail: () => {} },
        { text: 'Ignore', type: 'flavor', effect: () => log("They lose their mystery.") }
    ]),
    createEvent('child_18', 'Familiar Face', 'A well-known face appears.', [
        { text: 'Smile', type: 'check', stat: 'cha', dc: 10, success: 'Bond deepens. (+1 CHA)', fail: 'They still smile.', onSuccess: () => state.stats.cha++, onFail: () => {} },
        { text: 'Study Them', type: 'check', stat: 'int', dc: 10, success: 'You memorize features. (+1 INT)', fail: 'Details slip away.', onSuccess: () => state.stats.int++, onFail: () => {} },
        { text: 'Reach Up', type: 'flavor', effect: () => log("You seek comfort.") }
    ]),
    createEvent('child_19', 'Quiet Night', 'The world grows still.', [
        { text: 'Listen', type: 'check', stat: 'wis', dc: 10, success: 'You sense safety. (+1 WIS)', fail: 'Uneasy silence.', onSuccess: () => state.stats.wis++, onFail: () => modSanity(-1) },
        { text: 'Sleep', type: 'flavor', effect: () => { state.health++; log("Deep rest. (+1 HP)"); } },
        { text: 'Fidget', type: 'check', stat: 'dex', dc: 10, success: 'Restless energy. (+1 DEX)', fail: 'You tire yourself.', onSuccess: () => state.stats.dex++, onFail: () => {} }
    ])
],
Childhood: [
    createEvent('kid_1', 'The Old Oak', 'The great tree in the square looks climbable.', [
        { text: 'Climb High', type: 'check', stat: 'dex', dc: 12, success: 'You see the whole world from up here! (+1 DEX)', fail: 'You slip and scrape your knee. (-1 HP)', onSuccess: () => state.stats.dex++, onFail: () => takeDamage(1) },
        { text: 'Stay Low', type: 'flavor', effect: () => log("You play safely among the roots.") },
        { text: 'Shake Branch', type: 'check', stat: 'str', dc: 10, success: 'An apple falls! (+1 HP)', fail: 'Nothing happens.', onSuccess: () => state.health++, onFail: () => {} }
    ]),
    createEvent('kid_2', 'Mud Pies', 'Heavy rain has turned the road into a playground.', [
        { text: 'Play', type: 'check', stat: 'con', dc: 10, success: 'You build a mighty mud fortress. (+1 CON)', fail: 'You feel awful later. (-2 HP)', onSuccess: () => state.stats.con++, onFail: () => takeDamage(2) },
        { text: 'Avoid Dirt', type: 'flavor', effect: () => log("You keep yourself spotless.") },
        { text: 'Throw Mud', type: 'check', stat: 'dex', dc: 12, success: 'Direct hit! (+3 SP)', fail: 'You slip and fall.', onSuccess: () => modSanity(3), onFail: () => modSanity(-1) }
    ]),
    createEvent('kid_3', 'The Market Thief', 'You see a man steal an apple.', [
        { text: 'Yell', type: 'check', stat: 'cha', dc: 10, success: 'The guards catch him! (+Renown)', fail: 'He glares and escapes.', onSuccess: () => modRep('renown', 5), onFail: () => modSanity(-1) },
        { text: 'Stay Silent', type: 'flavor', effect: () => log("You keep the secret to yourself.") },
        { text: 'Trip Him', type: 'check', stat: 'dex', dc: 12, success: 'He falls! A small hero is born. (+Renown, +1 DEX)', fail: 'He steps over you.', onSuccess: () => { modRep('renown', 5); state.stats.dex++; }, onFail: () => {} }
    ]),
    createEvent('kid_4', 'Lesson Time', 'An elder offers to teach you letters.', [
        { text: 'Learn', type: 'check', stat: 'int', dc: 12, success: 'You learn to write your name. (+1 INT)', fail: 'Ink stains everything.', onSuccess: () => { state.stats.int++; state.flags.literate = true; }, onFail: () => {} },
        { text: 'Skip Class', type: 'flavor', effect: () => { state.stats.dex++; log("You explore instead. (+1 DEX)"); } },
        { text: 'Daydream', type: 'flavor', effect: () => { modSanity(2); log("Your mind wanders to fantastic places. (+2 SP)"); } }
    ]),
    createEvent('kid_5', 'Scary Story', 'Older kids tell ghost stories after dark.', [
        { text: 'Listen', type: 'check', stat: 'wis', dc: 12, success: 'You spot the holes in the tale. (+1 WIS)', fail: 'Nightmares follow. (-Sanity)', onSuccess: () => state.stats.wis++, onFail: () => modSanity(-2) },
        { text: 'Scare Them', type: 'check', stat: 'cha', dc: 12, success: 'You turn the tables! (+1 CHA)', fail: 'They laugh at you.', onSuccess: () => state.stats.cha++, onFail: () => {} },
        { text: 'Leave', type: 'flavor', effect: () => log("You decide it is not worth it.") }
    ]),
    createEvent('kid_6', 'Broken Cart', 'A merchant‚Äôs cart has snapped a wheel.', [
        { text: 'Help Push', type: 'check', stat: 'str', dc: 10, success: 'Teamwork pays off. (+1 STR)', fail: 'Too heavy.', onSuccess: () => state.stats.str++, onFail: () => {} },
        { text: 'Watch Closely', type: 'check', stat: 'wis', dc: 10, success: 'You learn how carts work. (+1 WIS)', fail: 'Boring details.', onSuccess: () => state.stats.wis++, onFail: () => {} },
        { text: 'Sneak Away', type: 'flavor', effect: () => log("Not your problem.") }
    ]),
    createEvent('kid_7', 'Thrown Stone', 'Someone challenges you to hit a distant mark.', [
        { text: 'Take Aim', type: 'check', stat: 'dex', dc: 12, success: 'Bullseye! (+1 DEX)', fail: 'Wide miss.', onSuccess: () => state.stats.dex++, onFail: () => {} },
        { text: 'Throw Hard', type: 'check', stat: 'str', dc: 10, success: 'Raw power impresses. (+1 STR)', fail: 'It drops short.', onSuccess: () => state.stats.str++, onFail: () => {} },
        { text: 'Refuse', type: 'flavor', effect: () => log("You decline the challenge.") }
    ]),
    createEvent('kid_8', 'Hidden Path', 'You discover a narrow trail behind the buildings.', [
        { text: 'Explore', type: 'check', stat: 'wis', dc: 10, success: 'You map the shortcut. (+1 WIS)', fail: 'You get lost.', onSuccess: () => state.stats.wis++, onFail: () => modSanity(-1) },
        { text: 'Mark It', type: 'check', stat: 'int', dc: 10, success: 'You remember it forever. (+1 INT)', fail: 'Details fade.', onSuccess: () => state.stats.int++, onFail: () => {} },
        { text: 'Ignore It', type: 'flavor', effect: () => log("Better not to wander.") }
    ]),
    createEvent('kid_9', 'First Dare', 'You are dared to do something embarrassing.', [
        { text: 'Accept', type: 'check', stat: 'cha', dc: 12, success: 'Everyone cheers. (+1 CHA)', fail: 'Awkward silence.', onSuccess: () => state.stats.cha++, onFail: () => modSanity(-1) },
        { text: 'Twist It', type: 'check', stat: 'int', dc: 10, success: 'You turn it clever. (+1 INT)', fail: 'It falls flat.', onSuccess: () => state.stats.int++, onFail: () => {} },
        { text: 'Walk Away', type: 'flavor', effect: () => log("You keep your dignity.") }
    ]),
    createEvent('kid_10', 'Night Watch', 'You stay awake later than usual, listening to the dark.', [
        { text: 'Stay Alert', type: 'check', stat: 'con', dc: 10, success: 'You endure the fatigue. (+1 CON)', fail: 'You nod off.', onSuccess: () => state.stats.con++, onFail: () => {} },
        { text: 'Imagine Monsters', type: 'flavor', effect: () => { modSanity(-1); log("Your imagination runs wild."); } },
        { text: 'Count Stars', type: 'check', stat: 'wis', dc: 10, success: 'You feel calm and small. (+1 WIS)', fail: 'Clouds hide them.', onSuccess: () => state.stats.wis++, onFail: () => {} }
    ]),
        createEvent('kid_11', 'Scraped Knee', 'You take a tumble while running.', [
        { text: 'Shake It Off', type: 'check', stat: 'con', dc: 10, success: 'You barely feel it. (+1 CON)', fail: 'It stings badly.', onSuccess: () => state.stats.con++, onFail: () => takeDamage(1) },
        { text: 'Laugh It Away', type: 'check', stat: 'cha', dc: 10, success: 'Others laugh with you. (+1 CHA)', fail: 'They wince instead.', onSuccess: () => state.stats.cha++, onFail: () => {} },
        { text: 'Cry', type: 'flavor', effect: () => log("Someone comforts you.") }
    ]),
    createEvent('kid_12', 'Borrowed Tool', 'You sneak a look at an adult‚Äôs tools.', [
        { text: 'Examine', type: 'check', stat: 'int', dc: 10, success: 'You understand their purpose. (+1 INT)', fail: 'Confusing shapes.', onSuccess: () => state.stats.int++, onFail: () => {} },
        { text: 'Try It', type: 'check', stat: 'dex', dc: 12, success: 'Careful hands. (+1 DEX)', fail: 'Almost drop it.', onSuccess: () => state.stats.dex++, onFail: () => {} },
        { text: 'Put It Back', type: 'flavor', effect: () => log("Better not risk trouble.") }
    ]),
    createEvent('kid_13', 'Street Game', 'Children gather for a noisy game.', [
        { text: 'Join In', type: 'check', stat: 'dex', dc: 10, success: 'You keep up! (+1 DEX)', fail: 'Too fast.', onSuccess: () => state.stats.dex++, onFail: () => {} },
        { text: 'Make Rules', type: 'check', stat: 'cha', dc: 10, success: 'They listen to you. (+1 CHA)', fail: 'Arguments erupt.', onSuccess: () => state.stats.cha++, onFail: () => modSanity(-1) },
        { text: 'Watch', type: 'check', stat: 'wis', dc: 10, success: 'You learn their tricks. (+1 WIS)', fail: 'Hard to follow.', onSuccess: () => state.stats.wis++, onFail: () => {} }
    ]),
    createEvent('kid_14', 'Lost Friend', 'You cannot find someone you play with.', [
        { text: 'Search', type: 'check', stat: 'wis', dc: 10, success: 'You track them down. (+1 WIS)', fail: 'You wander aimlessly.', onSuccess: () => state.stats.wis++, onFail: () => modSanity(-1) },
        { text: 'Ask Around', type: 'check', stat: 'cha', dc: 10, success: 'Someone helps you. (+1 CHA)', fail: 'No one knows.', onSuccess: () => state.stats.cha++, onFail: () => {} },
        { text: 'Give Up', type: 'flavor', effect: () => log("You play alone instead.") }
    ]),
    createEvent('kid_15', 'Shiny Beetle', 'A colorful insect crawls nearby.', [
        { text: 'Catch It', type: 'check', stat: 'dex', dc: 12, success: 'You hold it gently. (+1 DEX)', fail: 'It escapes.', onSuccess: () => state.stats.dex++, onFail: () => {} },
        { text: 'Study It', type: 'check', stat: 'int', dc: 10, success: 'You notice its patterns. (+1 INT)', fail: 'It moves too fast.', onSuccess: () => state.stats.int++, onFail: () => {} },
        { text: 'Let It Be', type: 'flavor', effect: () => log("Some things are best untouched.") }
    ]),
    createEvent('kid_16', 'Raised Voices', 'Adults argue nearby.', [
        { text: 'Listen Closely', type: 'check', stat: 'wis', dc: 12, success: 'You grasp the tension. (+1 WIS)', fail: 'It makes no sense.', onSuccess: () => state.stats.wis++, onFail: () => {} },
        { text: 'Hide', type: 'check', stat: 'dex', dc: 10, success: 'You stay unseen. (+1 DEX)', fail: 'They notice you.', onSuccess: () => state.stats.dex++, onFail: () => modSanity(-1) },
        { text: 'Ignore It', type: 'flavor', effect: () => log("You pretend nothing is wrong.") }
    ]),
    createEvent('kid_17', 'Small Errand', 'You are asked to deliver a message.', [
        { text: 'Deliver Quickly', type: 'check', stat: 'dex', dc: 10, success: 'Fast and reliable. (+1 DEX)', fail: 'You get distracted.', onSuccess: () => state.stats.dex++, onFail: () => {} },
        { text: 'Remember Exactly', type: 'check', stat: 'int', dc: 10, success: 'Word-perfect. (+1 INT)', fail: 'You forget part of it.', onSuccess: () => state.stats.int++, onFail: () => {} },
        { text: 'Ask Questions', type: 'check', stat: 'cha', dc: 10, success: 'They appreciate it. (+1 CHA)', fail: 'They wave you off.', onSuccess: () => state.stats.cha++, onFail: () => {} }
    ]),
    createEvent('kid_18', 'Hidden Snack', 'You find food saved for later.', [
        { text: 'Eat It', type: 'check', stat: 'con', dc: 10, success: 'Energy restored. (+1 CON)', fail: 'Stomach ache.', onSuccess: () => state.stats.con++, onFail: () => takeDamage(1) },
        { text: 'Share It', type: 'check', stat: 'cha', dc: 10, success: 'Friendship grows. (+1 CHA)', fail: 'They decline.', onSuccess: () => state.stats.cha++, onFail: () => {} },
        { text: 'Leave It', type: 'flavor', effect: () => log("You resist temptation.") }
    ]),
    createEvent('kid_19', 'Tall Fence', 'A fence blocks your path.', [
        { text: 'Climb It', type: 'check', stat: 'str', dc: 10, success: 'You pull yourself over. (+1 STR)', fail: 'Too slick.', onSuccess: () => state.stats.str++, onFail: () => {} },
        { text: 'Find a Gap', type: 'check', stat: 'wis', dc: 10, success: 'You spot an opening. (+1 WIS)', fail: 'No luck.', onSuccess: () => state.stats.wis++, onFail: () => {} },
        { text: 'Turn Back', type: 'flavor', effect: () => log("Another route it is.") }
    ]),
    createEvent('kid_20', 'Quiet Moment', 'You sit alone with your thoughts.', [
        { text: 'Reflect', type: 'check', stat: 'wis', dc: 10, success: 'You feel steadier. (+1 WIS)', fail: 'Thoughts tangle.', onSuccess: () => state.stats.wis++, onFail: () => {} },
        { text: 'Plan Ahead', type: 'check', stat: 'int', dc: 10, success: 'You imagine futures. (+1 INT)', fail: 'Too abstract.', onSuccess: () => state.stats.int++, onFail: () => {} },
        { text: 'Hum Softly (+1 SP)', type: 'flavor', effect: () => { modSanity(1); log("A calm settles in."); } }
    ])
],
 Teen: [
    createEvent('teen_1', 'First Crush', 'You catch someone looking at you.', [
        { text: 'Wink', type: 'check', stat: 'cha', dc: 12, success: 'They blush. (+Romance)', fail: 'Awkward moment.', onSuccess: () => createRandomRel(30), onFail: () => { modSanity(-1); addTrait('Flushed Cheeks'); } },
        { text: 'Ignore', type: 'flavor', effect: () => log("You pretend not to notice.") },
        { text: 'Write Note', type: 'check', stat: 'int', dc: 12, success: 'Well-written and charming. (+Romance)', fail: 'The message is unclear.', onSuccess: () => createRandomRel(25), onFail: () => modRep('renown', -1) }
    ]),
    createEvent('teen_2', 'The Dare', 'Jump across the river!', [
        { text: 'Jump', type: 'check', stat: 'dex', dc: 14, success: 'Perfect landing! (+1 DEX)', fail: 'Splash. Soaked and cold.', onSuccess: () => state.stats.dex++, onFail: () => { takeDamage(1); modSanity(-1); } },
        { text: 'Refuse', type: 'flavor', effect: () => log("You decide it is not worth it.") },
        { text: 'Find Another Way', type: 'check', stat: 'int', dc: 10, success: 'A clever route. (+1 INT)', fail: 'No alternative presents itself.', onSuccess: () => state.stats.int++, onFail: () => {} }
    ]),
    createEvent('teen_3', 'Apprenticeship', 'The smith needs help with the bellows.', [
        { text: 'Work Hard', type: 'check', stat: 'con', dc: 12, success: 'Grueling work pays off. (+5g, +1 STR)', fail: 'You collapse from exhaustion.', onSuccess: () => { state.gold += 5; state.stats.str++; addTrait('Sooty Skin'); }, onFail: () => takeDamage(2) },
        { text: 'Slack Off', type: 'check', stat: 'cha', dc: 12, success: 'You still get paid. (+5g)', fail: 'Caught and dismissed.', onSuccess: () => state.gold += 5, onFail: () => modRep('infamy', 1) },
        { text: 'Ask Questions', type: 'check', stat: 'int', dc: 12, success: 'You learn the basics of the trade. (+1 INT)', fail: 'Your curiosity annoys.', onSuccess: () => state.stats.int++, onFail: () => {} }
    ]),
    createEvent('teen_4', 'Curfew Bell', 'The town bell rings, signaling the end of festivities.', [
        { text: 'Sneak Around', type: 'check', stat: 'dex', dc: 12, success: 'A thrilling night. (+2 SP)', fail: 'You are noticed.', onSuccess: () => modSanity(2), onFail: () => modRep('honor', -2) },
        { text: 'Head Back', type: 'flavor', effect: () => { modRep('honor', 2); log("You play it safe."); } },
        { text: 'Talk Your Way Out', type: 'check', stat: 'cha', dc: 14, success: 'You are let go. (+1 CHA)', fail: 'Extra chores assigned.', onSuccess: () => state.stats.cha++, onFail: () => modSanity(-1) }
    ]),
    createEvent('teen_5', 'Bad Crowd', 'Some delinquents invite you to steal.', [
        { text: 'Join In', type: 'check', stat: 'dex', dc: 14, success: 'You grab some coin. (+10g, +Infamy)', fail: 'Guards intervene.', onSuccess: () => { state.gold += 10; modRep('infamy', 5); addTrait('Shifty Look'); }, onFail: () => { takeDamage(5); modRep('infamy', 5); } },
        { text: 'Refuse', type: 'flavor', effect: () => log("You keep your distance.") },
        { text: 'Lecture Them', type: 'check', stat: 'cha', dc: 14, success: 'They hesitate. (+Piety)', fail: 'They rough you up.', onSuccess: () => modRep('piety', 5), onFail: () => takeDamage(3) }
    ]),
    createEvent('teen_6', 'Late Study', 'You stay up late practicing a skill.', [
        { text: 'Push Through', type: 'check', stat: 'con', dc: 12, success: 'Progress at a cost. (+1 CON)', fail: 'Burnout hits.', onSuccess: () => state.stats.con++, onFail: () => modSanity(-1) },
        { text: 'Focus Smart', type: 'check', stat: 'int', dc: 12, success: 'Efficient learning. (+1 INT)', fail: 'Little sticks.', onSuccess: () => state.stats.int++, onFail: () => {} },
        { text: 'Quit Early', type: 'flavor', effect: () => log("You decide rest matters more.") }
    ]),
    createEvent('teen_7', 'Public Performance', 'You are pushed toward the center of attention.', [
        { text: 'Embrace It', type: 'check', stat: 'cha', dc: 12, success: 'The crowd loves you. (+1 CHA)', fail: 'You freeze.', onSuccess: () => state.stats.cha++, onFail: () => modSanity(-1) },
        { text: 'Deflect', type: 'check', stat: 'int', dc: 10, success: 'You redirect smoothly. (+1 INT)', fail: 'Still awkward.', onSuccess: () => state.stats.int++, onFail: () => {} },
        { text: 'Disappear', type: 'check', stat: 'dex', dc: 10, success: 'You slip away unseen. (+1 DEX)', fail: 'Too slow.', onSuccess: () => state.stats.dex++, onFail: () => {} }
    ]),
    createEvent('teen_8', 'Secret Meeting', 'You overhear talk of something hidden.', [
        { text: 'Investigate', type: 'check', stat: 'wis', dc: 12, success: 'You piece things together. (+1 WIS)', fail: 'Confusing whispers.', onSuccess: () => state.stats.wis++, onFail: () => modSanity(-1) },
        { text: 'Spread Rumor', type: 'check', stat: 'cha', dc: 12, success: 'Your story spreads. (+Renown)', fail: 'No one listens.', onSuccess: () => modRep('renown', 3), onFail: () => {} },
        { text: 'Ignore It', type: 'flavor', effect: () => log("You mind your own business.") }
    ]),
    createEvent('teen_9', 'Street Scuffle', 'Tempers flare over a small insult.', [
        { text: 'Fight Back', type: 'check', stat: 'str', dc: 12, success: 'You hold your ground. (+1 STR)', fail: 'You take a hit.', onSuccess: () => state.stats.str++, onFail: () => takeDamage(2) },
        { text: 'Talk It Down', type: 'check', stat: 'cha', dc: 12, success: 'The tension breaks. (+1 CHA)', fail: 'Words fail.', onSuccess: () => state.stats.cha++, onFail: () => modSanity(-1) },
        { text: 'Walk Away', type: 'flavor', effect: () => log("You refuse to escalate.") }
    ]),
    createEvent('teen_10', 'Quiet Resolve', 'You reflect on who you want to become.', [
        { text: 'Train Body', type: 'check', stat: 'str', dc: 10, success: 'Strength grows. (+1 STR)', fail: 'Little change.', onSuccess: () => state.stats.str++, onFail: () => {} },
        { text: 'Train Mind', type: 'check', stat: 'int', dc: 10, success: 'Clarity sharpens. (+1 INT)', fail: 'Distracted thoughts.', onSuccess: () => state.stats.int++, onFail: () => {} },
        { text: 'Train Spirit', type: 'check', stat: 'wis', dc: 10, success: 'Inner calm settles. (+1 WIS)', fail: 'Restless night.', onSuccess: () => state.stats.wis++, onFail: () => {} }
    ]),
        createEvent('teen_11', 'First Job', 'You are offered a small paid task.', [
        { text: 'Accept Eagerly', type: 'check', stat: 'con', dc: 12, success: 'Hard work earns respect. (+10g, +1 CON)', fail: 'You tire quickly.', onSuccess: () => { state.gold += 10; state.stats.con++; }, onFail: () => takeDamage(1) },
        { text: 'Negotiate Pay', type: 'check', stat: 'cha', dc: 12, success: 'They agree to more. (+15g)', fail: 'Offer withdrawn.', onSuccess: () => state.gold += 15, onFail: () => modRep('renown', -1) },
        { text: 'Decline', type: 'flavor', effect: () => log("You decide your time is worth more.") }
    ]),
    createEvent('teen_12', 'Rumor About You', 'Whispers follow you through town.', [
        { text: 'Confront It', type: 'check', stat: 'cha', dc: 14, success: 'You shut it down. (+Renown)', fail: 'It spreads faster.', onSuccess: () => modRep('renown', 5), onFail: () => modSanity(-2) },
        { text: 'Lean Into It', type: 'check', stat: 'cha', dc: 12, success: 'You control the narrative. (+Infamy)', fail: 'It turns cruel.', onSuccess: () => modRep('infamy', 3), onFail: () => modSanity(-1) },
        { text: 'Ignore It', type: 'flavor', effect: () => log("You hope it fades with time.") }
    ]),
    createEvent('teen_13', 'Mentor‚Äôs Advice', 'An older figure offers guidance.', [
        { text: 'Listen Closely', type: 'check', stat: 'wis', dc: 12, success: 'Wisdom sinks in. (+1 WIS)', fail: 'It feels irrelevant.', onSuccess: () => state.stats.wis++, onFail: () => {} },
        { text: 'Ask Questions', type: 'check', stat: 'int', dc: 12, success: 'You gain clarity. (+1 INT)', fail: 'You overwhelm them.', onSuccess: () => state.stats.int++, onFail: () => {} },
        { text: 'Dismiss It', type: 'flavor', effect: () => log("You trust your own instincts.") }
    ]),
    createEvent('teen_14', 'Festival Night', 'Music and lanterns fill the streets.', [
        { text: 'Dance', type: 'check', stat: 'dex', dc: 12, success: 'You move effortlessly. (+1 DEX)', fail: 'Clumsy steps.', onSuccess: () => state.stats.dex++, onFail: () => modSanity(-1) },
        { text: 'Flirt', type: 'check', stat: 'cha', dc: 12, success: 'Sparks fly. (+Romance)', fail: 'Rejection stings.', onSuccess: () => createRandomRel(20), onFail: () => modSanity(-2) },
        { text: 'Watch Lights', type: 'check', stat: 'wis', dc: 10, success: 'You feel at peace. (+2 SP)', fail: 'You feel distant.', onSuccess: () => modSanity(2), onFail: () => {} }
    ]),
    createEvent('teen_15', 'Crossed Line', 'You break a rule you were warned about.', [
        { text: 'Lie About It', type: 'check', stat: 'cha', dc: 14, success: 'They believe you. (+Infamy)', fail: 'Caught red-handed.', onSuccess: () => modRep('infamy', 3), onFail: () => modRep('honor', -3) },
        { text: 'Confess', type: 'check', stat: 'wis', dc: 12, success: 'Honesty softens punishment. (+Honor)', fail: 'Disappointment cuts deep.', onSuccess: () => modRep('honor', 3), onFail: () => modSanity(-2) },
        { text: 'Run', type: 'check', stat: 'dex', dc: 12, success: 'You escape consequences. (+1 DEX)', fail: 'You are stopped.', onSuccess: () => state.stats.dex++, onFail: () => takeDamage(2) }
    ]),
    createEvent('teen_16', 'Skill Rival', 'Someone challenges you openly.', [
        { text: 'Compete', type: 'check', stat: 'str', dc: 12, success: 'You prove yourself. (+1 STR, +Renown)', fail: 'You are outmatched.', onSuccess: () => { state.stats.str++; modRep('renown', 3); }, onFail: () => modSanity(-1) },
        { text: 'Outthink Them', type: 'check', stat: 'int', dc: 12, success: 'You win cleverly. (+1 INT)', fail: 'They mock you.', onSuccess: () => state.stats.int++, onFail: () => modRep('renown', -1) },
        { text: 'Decline', type: 'flavor', effect: () => log("You refuse to play their game.") }
    ]),
    createEvent('teen_17', 'Trusted Secret', 'Someone confides in you.', [
        { text: 'Keep It', type: 'check', stat: 'wis', dc: 10, success: 'Trust deepens. (+Honor)', fail: 'It weighs on you.', onSuccess: () => modRep('honor', 3), onFail: () => modSanity(-1) },
        { text: 'Share It', type: 'check', stat: 'cha', dc: 12, success: 'It spreads carefully. (+Renown)', fail: 'Betrayal is noticed.', onSuccess: () => modRep('renown', 2), onFail: () => modRep('honor', -3) },
        { text: 'Avoid Them', type: 'flavor', effect: () => log("You distance yourself.") }
    ]),
    createEvent('teen_18', 'Night Patrol', 'You help watch the streets after dark.', [
        { text: 'Stay Alert', type: 'check', stat: 'wis', dc: 12, success: 'You spot trouble early. (+1 WIS)', fail: 'Eyes grow heavy.', onSuccess: () => state.stats.wis++, onFail: () => modSanity(-1) },
        { text: 'Show Bravery', type: 'check', stat: 'str', dc: 12, success: 'You scare off danger. (+Renown)', fail: 'You are shaken.', onSuccess: () => modRep('renown', 3), onFail: () => takeDamage(2) },
        { text: 'Slack Off', type: 'flavor', effect: () => log("Nothing happens‚Ä¶ hopefully.") }
    ]),
    createEvent('teen_19', 'Unexpected Loss', 'Something important to you is gone.', [
        { text: 'Search Everywhere', type: 'check', stat: 'wis', dc: 12, success: 'You recover it. (+2 SP)', fail: 'It is truly lost.', onSuccess: () => modSanity(2), onFail: () => modSanity(-3) },
        { text: 'Let Go', type: 'check', stat: 'wis', dc: 10, success: 'You accept it. (+1 WIS)', fail: 'Regret lingers.', onSuccess: () => state.stats.wis++, onFail: () => {} },
        { text: 'Blame Someone', type: 'check', stat: 'cha', dc: 12, success: 'They apologize. (+Infamy)', fail: 'It backfires.', onSuccess: () => modRep('infamy', 2), onFail: () => modRep('renown', -2) }
    ]),
    createEvent('teen_20', 'Defining Choice', 'You realize this moment will shape you.', [
        { text: 'Choose Discipline', type: 'check', stat: 'con', dc: 12, success: 'You harden your resolve. (+1 CON)', fail: 'Doubt creeps in.', onSuccess: () => state.stats.con++, onFail: () => modSanity(-1) },
        { text: 'Choose Ambition', type: 'check', stat: 'int', dc: 12, success: 'You set bold goals. (+1 INT)', fail: 'Plans feel hollow.', onSuccess: () => state.stats.int++, onFail: () => {} },
        { text: 'Choose Compassion', type: 'check', stat: 'wis', dc: 12, success: 'You vow to care. (+1 WIS)', fail: 'The world feels cold.', onSuccess: () => state.stats.wis++, onFail: () => modSanity(-1) }
    ])
],
Adult: [
    createEvent('adult_1', 'Business Opportunity', 'A merchant offers a risky investment.', [
        { text: 'Invest 50g', type: 'check', stat: 'int', dc: 14, req: s => s.gold >= 50, success: 'Returns are high! (+100g)', fail: 'It was a scam.', onSuccess: () => { state.gold += 100; addTrait('Fine Clothes'); }, onFail: () => { state.gold -= 50; addTrait('Worn Boots'); } },
        { text: 'Decline', type: 'flavor', effect: () => log("You keep your coin safe.") },
        { text: 'Haggle', type: 'check', stat: 'cha', dc: 12, success: 'You squeeze out extra value. (+10g)', fail: 'Talks collapse.', onSuccess: () => state.gold += 10, onFail: () => {} }
    ]),
    createEvent('adult_2', 'Tavern Brawl', 'A drunkard swings a stool at you!', [
        { text: 'Dodge', type: 'check', stat: 'dex', dc: 14, success: 'You slip aside cleanly. (+1 DEX)', fail: 'Bonk. (-HP)', onSuccess: () => state.stats.dex++, onFail: () => { takeDamage(5); addTrait('Crooked Nose'); } },
        { text: 'Punch', type: 'check', stat: 'str', dc: 12, success: 'Knockout!', fail: 'You injure your hand.', onSuccess: () => { modRep('renown', 2); addTrait('Scar: Knuckles'); }, onFail: () => { takeDamage(3); addTrait('Broken Hand'); } },
        { text: 'Talk Down', type: 'check', stat: 'cha', dc: 14, success: 'The fight dissolves. (+2 SP)', fail: 'He swings mid-sentence.', onSuccess: () => modSanity(2), onFail: () => takeDamage(4) }
    ]),
    createEvent('adult_3', 'The Beggar', 'A weathered veteran asks for alms.', [
        { text: 'Give 5g', type: 'flavor', req: s => s.gold >= 5, effect: () => { state.gold -= 5; modRep('piety', 5); modRep('honor', 2); log("A quiet blessing follows you."); } },
        { text: 'Ignore', type: 'flavor', effect: () => log("You keep walking.") },
        { text: 'Ask Story', type: 'check', stat: 'wis', dc: 10, success: 'Hard-earned wisdom is shared. (+1 INT)', fail: 'Rambling tales.', onSuccess: () => state.stats.int++, onFail: () => {} }
    ]),
    createEvent('adult_4', 'Hard Times', 'Famine grips the land.', [
        { text: 'Endure', type: 'check', stat: 'con', dc: 14, success: 'You survive on little.', fail: 'You grow gaunt.', onSuccess: () => {}, onFail: () => { state.stats.con--; takeDamage(5); addTrait('Gaunt Face'); } },
        { text: 'Buy Food (20g)', type: 'flavor', req: s => s.gold >= 20, effect: () => { state.gold -= 20; addTrait('Well-Fed'); log("You keep your strength."); } },
        { text: 'Hunt', type: 'check', stat: 'dex', dc: 14, success: 'Fresh meat sustains you. (+HP)', fail: 'You return injured.', onSuccess: () => { state.health = Math.min(state.maxHealth, state.health + 5); }, onFail: () => takeDamage(2) }
    ]),
    createEvent('adult_5', 'Strange Artifact', 'You find a faintly glowing stone.', [
        { text: 'Touch It', type: 'check', stat: 'wis', dc: 15, success: 'Hidden truths surface. (+1 INT, +1 WIS)', fail: 'Your mind recoils.', onSuccess: () => { state.stats.int++; state.stats.wis++; addTrait('Far-Off Gaze'); }, onFail: () => { modSanity(-5); addTrait('Muttering'); } },
        { text: 'Sell It', type: 'flavor', effect: () => { state.gold += 50; log("A mage pays well."); } },
        { text: 'Study It', type: 'check', stat: 'int', dc: 16, success: 'You decode its nature. (+1 INT)', fail: 'Splitting headache.', onSuccess: () => state.stats.int++, onFail: () => modSanity(-1) }
    ]),
    createEvent('adult_6', 'Contract Work', 'A short-term job promises quick pay.', [
        { text: 'Accept', type: 'check', stat: 'con', dc: 12, success: 'The work is done. (+15g)', fail: 'You overextend yourself.', onSuccess: () => state.gold += 15, onFail: () => takeDamage(2) },
        { text: 'Negotiate', type: 'check', stat: 'cha', dc: 12, success: 'Better terms secured. (+20g)', fail: 'They hire someone else.', onSuccess: () => state.gold += 20, onFail: () => {} },
        { text: 'Decline', type: 'flavor', effect: () => log("You pass on the offer.") }
    ]),
    createEvent('adult_7', 'Road Ambush', 'Bandits block the road ahead.', [
        { text: 'Fight', type: 'check', stat: 'str', dc: 14, success: 'They scatter. (+Renown)', fail: 'You are wounded.', onSuccess: () => modRep('renown', 3), onFail: () => takeDamage(6) },
        { text: 'Flee', type: 'check', stat: 'dex', dc: 14, success: 'You escape unharmed.', fail: 'An arrow grazes you.', onSuccess: () => {}, onFail: () => takeDamage(3) },
        { text: 'Parley', type: 'check', stat: 'cha', dc: 14, success: 'They let you pass. (+Honor)', fail: 'They demand coin.', onSuccess: () => modRep('honor', 2), onFail: () => state.gold = Math.max(0, state.gold - 10) }
    ]),
    createEvent('adult_8', 'Political Favor', 'A minor official requests discreet help.', [
        { text: 'Assist', type: 'check', stat: 'int', dc: 13, success: 'You gain influence. (+Renown)', fail: 'It backfires.', onSuccess: () => modRep('renown', 4), onFail: () => modRep('infamy', 2) },
        { text: 'Refuse', type: 'flavor', effect: () => log("You avoid entanglement.") },
        { text: 'Exploit', type: 'check', stat: 'cha', dc: 14, success: 'You extract payment. (+25g)', fail: 'They shut you out.', onSuccess: () => state.gold += 25, onFail: () => {} }
    ]),
    createEvent('adult_9', 'Lingering Injury', 'An old wound flares painfully.', [
        { text: 'Push Through', type: 'check', stat: 'con', dc: 14, success: 'You endure it. (+1 CON)', fail: 'Pain slows you.', onSuccess: () => state.stats.con++, onFail: () => takeDamage(2) },
        { text: 'Rest', type: 'flavor', effect: () => { state.health = Math.min(state.maxHealth, state.health + 3); log("Time heals you."); } },
        { text: 'Seek Remedy', type: 'check', stat: 'wis', dc: 12, success: 'You find relief. (+2 SP)', fail: 'No improvement.', onSuccess: () => modSanity(2), onFail: () => {} }
    ]),
    createEvent('adult_10', 'Crossroads', 'You pause to reassess your direction.', [
        { text: 'Pursue Wealth', type: 'check', stat: 'int', dc: 10, success: 'Plans sharpen. (+1 INT)', fail: 'Doubts linger.', onSuccess: () => state.stats.int++, onFail: () => {} },
        { text: 'Pursue Power', type: 'check', stat: 'str', dc: 10, success: 'Resolve hardens. (+1 STR)', fail: 'Motivation fades.', onSuccess: () => state.stats.str++, onFail: () => {} },
        { text: 'Pursue Peace', type: 'check', stat: 'wis', dc: 10, success: 'Calm settles in. (+1 WIS)', fail: 'Restlessness remains.', onSuccess: () => state.stats.wis++, onFail: () => {} }
    ]),
        createEvent('adult_11', 'Market Fire', 'A sudden blaze erupts among crowded stalls.', [
        { text: 'Help Others', type: 'check', stat: 'str', dc: 13, success: 'You pull people to safety. (+Honor)', fail: 'You suffer burns.', onSuccess: () => modRep('honor', 3), onFail: () => { takeDamage(4); addTrait('Burn Scars'); } },
        { text: 'Save Goods', type: 'check', stat: 'dex', dc: 13, success: 'You salvage valuables. (+20g)', fail: 'Smoke overwhelms you.', onSuccess: () => state.gold += 20, onFail: () => takeDamage(2) },
        { text: 'Slip Away', type: 'flavor', effect: () => log("You vanish before blame can fall.") }
    ]),

    createEvent('adult_12', 'Old Rival', 'Someone from your past confronts you publicly.', [
        { text: 'Challenge Them', type: 'check', stat: 'str', dc: 14, success: 'You assert dominance. (+Renown)', fail: 'You are humiliated.', onSuccess: () => modRep('renown', 3), onFail: () => modRep('infamy', 2) },
        { text: 'Outwit Them', type: 'check', stat: 'int', dc: 13, success: 'You expose their lies.', fail: 'Your words falter.', onSuccess: () => modRep('honor', 2), onFail: () => {} },
        { text: 'Let It Go', type: 'check', stat: 'wis', dc: 12, success: 'Peace feels earned. (+2 SP)', fail: 'Bitterness lingers.', onSuccess: () => modSanity(2), onFail: () => modSanity(-1) }
    ]),

    createEvent('adult_13', 'Traveling Healer', 'A wandering healer offers unconventional aid.', [
        { text: 'Submit to Treatment', type: 'check', stat: 'con', dc: 12, success: 'Your body feels renewed. (+HP)', fail: 'Side effects linger.', onSuccess: () => state.health = Math.min(state.maxHealth, state.health + 6), onFail: () => addTrait('Strange Rash') },
        { text: 'Ask Questions', type: 'check', stat: 'wis', dc: 12, success: 'You learn herbal lore. (+1 WIS)', fail: 'Conflicting advice.', onSuccess: () => state.stats.wis++, onFail: () => {} },
        { text: 'Refuse', type: 'flavor', effect: () => log("You trust your own resilience.") }
    ]),

    createEvent('adult_14', 'Night Watch', 'You are asked to guard a district overnight.', [
        { text: 'Stay Alert', type: 'check', stat: 'wis', dc: 13, success: 'Trouble never comes. (+Renown)', fail: 'You miss something.', onSuccess: () => modRep('renown', 2), onFail: () => modRep('infamy', 1) },
        { text: 'Confront Suspicion', type: 'check', stat: 'cha', dc: 13, success: 'You defuse tensions.', fail: 'Words escalate.', onSuccess: () => modRep('honor', 2), onFail: () => takeDamage(2) },
        { text: 'Doze Off', type: 'flavor', effect: () => addTrait('Heavy Sleeper') }
    ]),

    createEvent('adult_15', 'Forbidden Book', 'You discover a book others avoid.', [
        { text: 'Read It', type: 'check', stat: 'int', dc: 15, success: 'Dark knowledge sharpens you. (+1 INT)', fail: 'The words gnaw at you.', onSuccess: () => state.stats.int++, onFail: () => modSanity(-3) },
        { text: 'Burn It', type: 'flavor', effect: () => { modRep('piety', 3); log("The smoke feels cleansing."); } },
        { text: 'Sell It Quietly', type: 'check', stat: 'cha', dc: 14, success: 'A collector pays well. (+30g)', fail: 'You attract suspicion.', onSuccess: () => state.gold += 30, onFail: () => modRep('infamy', 1) }
    ]),

    createEvent('adult_16', 'Rumor Mill', 'Your name circulates in whispered conversations.', [
        { text: 'Lean Into It', type: 'check', stat: 'cha', dc: 12, success: 'Your mystique grows. (+Renown)', fail: 'Rumors twist.', onSuccess: () => modRep('renown', 2), onFail: () => modRep('infamy', 2) },
        { text: 'Correct the Record', type: 'check', stat: 'int', dc: 12, success: 'Truth prevails. (+Honor)', fail: 'No one listens.', onSuccess: () => modRep('honor', 2), onFail: () => {} },
        { text: 'Ignore It', type: 'flavor', effect: () => log("You let gossip burn itself out.") }
    ]),

    createEvent('adult_17', 'Debt Called In', 'An old obligation comes due.', [
        { text: 'Pay (25g)', type: 'flavor', req: s => s.gold >= 25, effect: () => { state.gold -= 25; modRep('honor', 3); } },
        { text: 'Delay', type: 'check', stat: 'cha', dc: 13, success: 'You buy time.', fail: 'Pressure mounts.', onSuccess: () => {}, onFail: () => modRep('infamy', 2) },
        { text: 'Intimidate', type: 'check', stat: 'str', dc: 14, success: 'They back off. (+Renown)', fail: 'They bring help.', onSuccess: () => modRep('renown', 2), onFail: () => takeDamage(3) }
    ]),

    createEvent('adult_18', 'Hunting Mishap', 'A routine hunt turns dangerous.', [
        { text: 'Finish the Hunt', type: 'check', stat: 'dex', dc: 14, success: 'You bring back a prize. (+Food, +Renown)', fail: 'You are mauled.', onSuccess: () => modRep('renown', 2), onFail: () => { takeDamage(5); addTrait('Animal Bite Scar'); } },
        { text: 'Retreat Carefully', type: 'check', stat: 'wis', dc: 12, success: 'You escape unharmed.', fail: 'You stumble.', onSuccess: () => {}, onFail: () => takeDamage(2) },
        { text: 'Abandon the Hunt', type: 'flavor', effect: () => log("Some prey is not worth the risk.") }
    ]),

    createEvent('adult_19', 'Unexpected Inheritance', 'A distant relation leaves you something small.', [
        { text: 'Accept Graciously', type: 'flavor', effect: () => { state.gold += 20; addTrait('Family Keepsake'); } },
        { text: 'Investigate', type: 'check', stat: 'int', dc: 13, success: 'You uncover hidden value. (+40g)', fail: 'Nothing more is found.', onSuccess: () => state.gold += 40, onFail: () => {} },
        { text: 'Decline', type: 'check', stat: 'wis', dc: 10, success: 'Peace of mind. (+2 SP)', fail: 'Lingering regret.', onSuccess: () => modSanity(2), onFail: () => modSanity(-1) }
    ]),

    createEvent('adult_20', 'Moment of Reflection', 'A quiet night invites honesty with yourself.', [
        { text: 'Recall Triumphs', type: 'check', stat: 'cha', dc: 10, success: 'Confidence swells. (+1 CHA)', fail: 'Doubts creep in.', onSuccess: () => state.stats.cha++, onFail: () => {} },
        { text: 'Confront Regrets', type: 'check', stat: 'wis', dc: 12, success: 'You make peace. (+3 SP)', fail: 'Old wounds reopen.', onSuccess: () => modSanity(3), onFail: () => modSanity(-2) },
        { text: 'Plan the Future', type: 'check', stat: 'int', dc: 12, success: 'A clear path forms. (+1 INT)', fail: 'Uncertainty remains.', onSuccess: () => state.stats.int++, onFail: () => {} }
    ])
],
Elder: [
    createEvent('elder_1', 'Bad Back', 'Getting out of bed is a struggle.', [
        { text: 'Stretch', type: 'check', stat: 'dex', dc: 12, success: 'You loosen up slowly.', fail: 'A sharp pain shoots through you.', onSuccess: () => {}, onFail: () => { takeDamage(2); addTrait('Stooped Posture'); } },
        { text: 'Rest', type: 'flavor', effect: () => log("You decide today is for rest.") },
        { text: 'Medicine (10g)', type: 'flavor', req: s => s.gold >= 10, effect: () => { state.gold -= 10; log("The salve dulls the pain."); } }
    ]),
    createEvent('elder_2', 'The Youth', 'Children are playing noisily nearby.', [
        { text: 'Yell', type: 'check', stat: 'cha', dc: 12, success: 'They scatter in a panic.', fail: 'They mock you.', onSuccess: () => {}, onFail: () => modSanity(-1) },
        { text: 'Tell Story', type: 'check', stat: 'cha', dc: 14, success: 'They listen in awe. (+Renown)', fail: 'You lose your train of thought.', onSuccess: () => modRep('renown', 5), onFail: () => {} },
        { text: 'Watch Quietly', type: 'check', stat: 'wis', dc: 10, success: 'Memories warm you. (+3 SP)', fail: 'Nostalgia stings.', onSuccess: () => modSanity(3), onFail: () => modSanity(-1) }
    ]),
    createEvent('elder_3', 'Legacy', 'You reflect on what you will leave behind.', [
        { text: 'Write Memoirs', type: 'check', stat: 'int', dc: 14, success: 'Your life fills many pages. (+Renown, +Gold)', fail: 'The words won‚Äôt come.', onSuccess: () => { modRep('renown', 10); state.gold += 20; addTrait('Ink-Stained Hands'); }, onFail: () => {} },
        { text: 'Teach', type: 'check', stat: 'wis', dc: 12, success: 'Hard-earned lessons are passed on. (+Piety)', fail: 'Patience runs thin.', onSuccess: () => modRep('piety', 5), onFail: () => modSanity(-1) },
        { text: 'Let Go', type: 'flavor', effect: () => { modSanity(5); log("You release the past."); } }
    ]),
    createEvent('elder_4', 'Sickness', 'A deep cough lingers in your chest.', [
        { text: 'Resist', type: 'check', stat: 'con', dc: 14, success: 'You weather the illness.', fail: 'It drains you.', onSuccess: () => {}, onFail: () => { takeDamage(5); addTrait('Pale Skin'); } },
        { text: 'Healer (20g)', type: 'flavor', req: s => s.gold >= 20, effect: () => { state.gold -= 20; log("You recover with care."); } },
        { text: 'Pray', type: 'check', stat: 'wis', dc: 12, success: 'You find calm acceptance. (+Piety)', fail: 'No answer comes.', onSuccess: () => modRep('piety', 5), onFail: () => {} }
    ]),
    createEvent('elder_5', 'Wisdom', 'The council seeks your guidance.', [
        { text: 'Advise', type: 'check', stat: 'wis', dc: 12, success: 'Your words carry weight. (+Renown)', fail: 'They seem unconvinced.', onSuccess: () => modRep('renown', 5), onFail: () => {} },
        { text: 'Ramble', type: 'flavor', effect: () => log("You drift through old stories.") },
        { text: 'Listen Carefully', type: 'check', stat: 'int', dc: 14, success: 'You untangle the issue. (+Renown)', fail: 'It is too tangled.', onSuccess: () => modRep('renown', 10), onFail: () => {} }
    ]),
    createEvent('elder_6', 'Fading Strength', 'Simple tasks feel heavier than before.', [
        { text: 'Push Through', type: 'check', stat: 'con', dc: 12, success: 'You prove you still can. (+3 SP)', fail: 'You overdo it.', onSuccess: () => modSanity(3), onFail: () => takeDamage(2) },
        { text: 'Ask for Help', type: 'flavor', effect: () => log("You accept your limits.") },
        { text: 'Change Routine', type: 'check', stat: 'int', dc: 10, success: 'You adapt wisely. (+1 INT)', fail: 'Old habits persist.', onSuccess: () => state.stats.int++, onFail: () => {} }
    ]),
    createEvent('elder_7', 'Old Rival', 'You encounter someone from long ago.', [
        { text: 'Make Peace', type: 'check', stat: 'cha', dc: 12, success: 'Bitterness fades. (+2 SP)', fail: 'Old wounds reopen.', onSuccess: () => modSanity(2), onFail: () => modSanity(-2) },
        { text: 'Ignore', type: 'flavor', effect: () => log("Some things are better left alone.") },
        { text: 'Reminisce', type: 'check', stat: 'wis', dc: 12, success: 'You gain perspective. (+1 WIS)', fail: 'Memories hurt.', onSuccess: () => state.stats.wis++, onFail: () => modSanity(-1) }
    ]),
    createEvent('elder_8', 'Quiet Days', 'Your days grow slower and quieter.', [
        { text: 'Embrace Stillness', type: 'check', stat: 'wis', dc: 10, success: 'Peace settles in. (+1 WIS)', fail: 'Restlessness creeps in.', onSuccess: () => state.stats.wis++, onFail: () => modSanity(-1) },
        { text: 'Seek Distraction', type: 'check', stat: 'int', dc: 10, success: 'Your mind stays sharp. (+1 INT)', fail: 'It feels hollow.', onSuccess: () => state.stats.int++, onFail: () => {} },
        { text: 'Sleep More', type: 'flavor', effect: () => log("You let time pass gently.") }
    ]),
    createEvent('elder_9', 'Final Project', 'One last task weighs on your mind.', [
        { text: 'Finish It', type: 'check', stat: 'con', dc: 14, success: 'You see it done. (+Renown)', fail: 'It remains unfinished.', onSuccess: () => modRep('renown', 8), onFail: () => modSanity(-1) },
        { text: 'Delegate', type: 'check', stat: 'cha', dc: 12, success: 'Others carry it forward. (+Honor)', fail: 'They misunderstand.', onSuccess: () => modRep('honor', 3), onFail: () => {} },
        { text: 'Abandon It', type: 'flavor', effect: () => log("You decide it no longer matters.") }
    ]),
    createEvent('elder_10', 'Closing Reflections', 'You sit quietly with your thoughts.', [
        { text: 'Seek Meaning', type: 'check', stat: 'wis', dc: 12, success: 'You feel content. (+3 SP)', fail: 'Questions linger.', onSuccess: () => modSanity(3), onFail: () => {} },
        { text: 'Count Blessings', type: 'check', stat: 'int', dc: 10, success: 'Gratitude fills you. (+Piety)', fail: 'It feels forced.', onSuccess: () => modRep('piety', 3), onFail: () => {} },
        { text: 'Simply Rest', type: 'flavor', effect: () => log("You close your eyes and breathe.") }
    ]),
        createEvent('elder_11', 'Old Friends', 'You meet a friend from decades past.', [
        { text: 'Share Memories', type: 'check', stat: 'cha', dc: 12, success: 'Laughter warms your heart. (+3 SP)', fail: 'Stories falter.', onSuccess: () => modSanity(3), onFail: () => modSanity(-1) },
        { text: 'Listen', type: 'check', stat: 'wis', dc: 12, success: 'You gain insight. (+1 WIS)', fail: 'The tales confuse you.', onSuccess: () => state.stats.wis++, onFail: () => {} },
        { text: 'Walk Away', type: 'flavor', effect: () => log("Time has changed you both.")}
    ]),

    createEvent('elder_12', 'Stormy Night', 'Thunder shakes the old roof.', [
        { text: 'Reassure Yourself', type: 'check', stat: 'wis', dc: 12, success: 'You feel safe inside. (+2 SP)', fail: 'Fear lingers.', onSuccess: () => modSanity(2), onFail: () => modSanity(-1) },
        { text: 'Inspect Damage', type: 'check', stat: 'dex', dc: 14, success: 'Repairs are minor. (+1 DEX)', fail: 'A beam falls.', onSuccess: () => state.stats.dex++, onFail: () => takeDamage(3) },
        { text: 'Stay in Bed', type: 'flavor', effect: () => log("You let the storm pass overhead.")}
    ]),

    createEvent('elder_13', 'Local Ceremony', 'The village honors your years of service.', [
        { text: 'Attend Proudly', type: 'check', stat: 'cha', dc: 12, success: 'Applause warms your soul. (+Renown)', fail: 'You fumble words.', onSuccess: () => modRep('renown', 5), onFail: () => {} },
        { text: 'Observe Silently', type: 'check', stat: 'wis', dc: 10, success: 'You appreciate traditions. (+Piety)', fail: 'Distracted thoughts.', onSuccess: () => modRep('piety', 3), onFail: () => {} },
        { text: 'Skip It', type: 'flavor', effect: () => log("Some honors feel distant.")}
    ]),

    createEvent('elder_14', 'Unexpected Visitor', 'Someone seeks your advice unexpectedly.', [
        { text: 'Help Generously', type: 'check', stat: 'wis', dc: 12, success: 'You guide them well. (+Renown)', fail: 'Advice misfires.', onSuccess: () => modRep('renown', 5), onFail: () => {} },
        { text: 'Cautious Counsel', type: 'check', stat: 'int', dc: 12, success: 'Your guidance is careful and useful. (+1 INT)', fail: 'They misunderstand.', onSuccess: () => state.stats.int++, onFail: () => {} },
        { text: 'Turn Away', type: 'flavor', effect: () => log("You choose solitude over obligation.")}
    ]),

    createEvent('elder_15', 'Memory Lane', 'You wander familiar streets from your youth.', [
        { text: 'Recall Details', type: 'check', stat: 'int', dc: 12, success: 'Memories sharpen your mind. (+1 INT)', fail: 'Some memories confuse you.', onSuccess: () => state.stats.int++, onFail: () => modSanity(-1) },
        { text: 'Relive Joys', type: 'check', stat: 'wis', dc: 10, success: 'Nostalgia soothes you. (+2 SP)', fail: 'Bittersweet feelings arise.', onSuccess: () => modSanity(2), onFail: () => modSanity(-1) },
        { text: 'Avoid Old Haunts', type: 'flavor', effect: () => log("Not all paths are worth treading.")}
    ]),

    createEvent('elder_16', 'A Gift', 'A young villager offers you something small.', [
        { text: 'Accept Graciously', type: 'flavor', effect: () => { modRep('honor', 2); log("The gesture warms your heart."); } },
        { text: 'Teach Them', type: 'check', stat: 'wis', dc: 12, success: 'You give more than a gift. (+Piety)', fail: 'They do not understand.', onSuccess: () => modRep('piety', 3), onFail: () => {} },
        { text: 'Decline Politely', type: 'check', stat: 'cha', dc: 12, success: 'You avoid burden. (+2 SP)', fail: 'They feel slighted.', onSuccess: () => modSanity(2), onFail: () => modRep('infamy', 1) }
    ]),

    createEvent('elder_17', 'Minor Mishap', 'A small accident reminds you of your age.', [
        { text: 'Recover Gracefully', type: 'check', stat: 'dex', dc: 12, success: 'You rise unshaken. (+1 DEX)', fail: 'You stumble awkwardly.', onSuccess: () => state.stats.dex++, onFail: () => takeDamage(2) },
        { text: 'Call for Aid', type: 'flavor', effect: () => log("Help arrives without fuss.") },
        { text: 'Ignore It', type: 'check', stat: 'con', dc: 10, success: 'Pain is minor. (+2 SP)', fail: 'Aches linger.', onSuccess: () => modSanity(2), onFail: () => modSanity(-1) }
    ]),

    createEvent('elder_18', 'Evening Reflection', 'You watch the sunset in silence.', [
        { text: 'Meditate', type: 'check', stat: 'wis', dc: 12, success: 'A deep calm fills you. (+3 SP)', fail: 'Thoughts wander restlessly.', onSuccess: () => modSanity(3), onFail: () => modSanity(-1) },
        { text: 'Recall Achievements', type: 'check', stat: 'int', dc: 12, success: 'You feel proud. (+Renown)', fail: 'Regrets creep in.', onSuccess: () => modRep('renown', 5), onFail: () => modSanity(-1) },
        { text: 'Simply Watch', type: 'flavor', effect: () => log("The colors fade into memory.")}
    ]),

    createEvent('elder_19', 'Final Advice', 'Someone asks your last words of guidance.', [
        { text: 'Speak from Experience', type: 'check', stat: 'wis', dc: 12, success: 'They learn well. (+Piety, +Renown)', fail: 'Your meaning is lost.', onSuccess: () => { modRep('piety', 3); modRep('renown', 3); }, onFail: () => {} },
        { text: 'Offer Simple Truths', type: 'check', stat: 'int', dc: 10, success: 'They understand clearly. (+1 INT)', fail: 'They misunderstand.', onSuccess: () => state.stats.int++, onFail: () => {} },
        { text: 'Say Nothing', type: 'flavor', effect: () => log("Silence speaks volumes.")}
    ]),

    createEvent('elder_20', 'Twilight Rest', 'You lie down as the day ends.', [
        { text: 'Reflect Peacefully', type: 'check', stat: 'wis', dc: 12, success: 'Contentment fills you. (+3 SP)', fail: 'Unresolved thoughts trouble you.', onSuccess: () => modSanity(3), onFail: () => modSanity(-1) },
        { text: 'Dream of Youth', type: 'check', stat: 'int', dc: 10, success: 'Memory sharpens. (+1 INT)', fail: 'Fleeting visions fade.', onSuccess: () => state.stats.int++, onFail: () => {} },
        { text: 'Simply Sleep', type: 'flavor', effect: () => log("The world drifts away gently.")}
    ])
],
        Permission: [
            createEvent('perm_ask', 'Permission to Leave', 'You wish to travel, but you are young.', [
                { text: 'Ask Parents', type: 'check', stat: 'cha', dc: 12, success: 'They agree to let you go. The family moves with you.', fail: 'They forbid it.', 
                  onSuccess: () => { 
                      state.flags.travelAllowed = true; 
                      // Move parents
                      state.relationships.forEach(r => {
                         if((r.relation === 'Father' || r.relation === 'Mother') && r.locationIndex === state.location) {
                             r.locationIndex = state.travelTarget;
                         }
                      });
                      travelTo(state.travelTarget); 
                  }, 
                  onFail: () => {} 
                },
                { text: 'Run Away', type: 'check', stat: 'dex', dc: 14, success: 'You slip away in the night.', fail: 'Caught! You are grounded.', onSuccess: () => { state.flags.travelAllowed = true; travelTo(state.travelTarget); modSanity(-2); }, onFail: () => { modRep('honor', -5); } },
                { text: 'Stay', type: 'flavor', effect: () => log("You decide to wait.") }
            ])
        ],
        // NEW: Health Complications for Old Age
        HealthIssues: [
            createEvent('health_heart', 'Fluttering Heart', 'Your chest tightens painfully as you climb the stairs.', [
                { text: 'Catch Breath', type: 'check', stat: 'con', dc: 15, success: 'The pain passes, leaving you shaken.', fail: 'You collapse. Your heart is permanently weakened. (-3 Max HP)', onSuccess: () => {}, onFail: () => { state.maxHealth = Math.max(1, state.maxHealth - 3); state.health = Math.min(state.health, state.maxHealth); log("Your vitality fades."); } },
                { text: 'Call Healer (50g)', type: 'flavor', req: s => s.gold >= 50, effect: () => { state.gold -= 50; log("The bitter medicine settles your heart. You survive."); } },
                { text: 'Ignore', type: 'flavor', effect: () => { takeDamage(5); log("You push through the pain, damaging your body."); } }
            ]),
            createEvent('health_fever', 'The Grey Fever', 'A cold sweat grips you in the night. It feels like winter in your veins.', [
                { text: 'Endure', type: 'check', stat: 'con', dc: 16, success: 'You sweat it out over three days.', fail: 'It settles deep in your lungs. (-1 CON, -5 HP)', onSuccess: () => {}, onFail: () => { state.stats.con = Math.max(3, state.stats.con - 1); takeDamage(5); } },
                { text: 'Medicine (20g)', type: 'flavor', req: s => s.gold >= 20, effect: () => { state.gold-=20; log("It helps slightly."); } },
                { text: 'Pray', type: 'check', stat: 'wis', dc: 12, success: 'Faith heals the spirit. (+ 2 SP)', fail: 'No answer. (-1 SP)', onSuccess: () => modSanity(2), onFail: () => modSanity(-1) }
            ]),
            createEvent('health_joints', 'Crippling Arthritis', 'Your joints lock up in the cold damp of morning.', [
                { text: 'Force Movement', type: 'check', stat: 'str', dc: 14, success: 'You push through the agony.', fail: 'You cannot move. You lose flexibility. (-1 DEX)', onSuccess: () => {}, onFail: () => { state.stats.dex = Math.max(3, state.stats.dex - 1); log("You are less agile now."); } },
                { text: 'Bed Rest', type: 'flavor', effect: () => { log("You spend the year in a chair, watching the world go by."); } },
                { text: 'Warm Bath (5g)', type: 'flavor', req: s => s.gold >= 5, effect: () => { state.gold-=5; log("The heat soothes your bones."); } }
            ]),
            createEvent('health_stroke', 'Sudden Darkness', 'The world spins violently and vision fades.', [
                { text: 'Hold On', type: 'check', stat: 'con', dc: 18, success: 'You regain your senses, terrified.', fail: 'DEATH CALLS.', onSuccess: () => { modSanity(-2); }, onFail: () => { takeDamage(100); } },
                { text: 'Scream', type: 'flavor', effect: () => { log("No sound comes out."); takeDamage(5); } },
                { text: 'Accept', type: 'flavor', effect: () => { modRep('piety', 5); log("You make peace with the end."); } }
            ]),
            createEvent('health_memory', 'Fading Mind', 'You wake up and do not recognize the room.', [
                { text: 'Focus', type: 'check', stat: 'int', dc: 15, success: 'The fog lifts.', fail: 'Who are you? (-1 INT, -1 WIS)', onSuccess: () => {}, onFail: () => { state.stats.int = Math.max(3, state.stats.int - 1); state.stats.wis = Math.max(3, state.stats.wis - 1); modSanity(-3); } },
                { text: 'Panic', type: 'flavor', effect: () => { modSanity(-2); log("Terror grips you."); } },
                { text: 'Rest', type: 'flavor', effect: () => { log("Maybe tomorrow will be better."); } }
            ])
        ],
        LordInteraction: [
            createEvent('lord_meet', 'Audience with the Lord', 'You stand before the ruler of the city.', [
                { text: 'Pay Respects', type: 'check', stat: 'cha', dc: 10, success: 'The Lord nods. (+Renown)', fail: 'You stumble on your words.', onSuccess: () => modRep('renown', 5), onFail: () => {} },
                { text: 'Petition for Title (500g)', type: 'flavor', req: (s) => s.socialClass === 'Commoner' && s.gold >= 500, effect: () => { renderEvent(POOLS.TitleChallenge[0]); } },
                { text: 'Offer Service', type: 'check', stat: 'str', dc: 14, success: 'You are hired as a guard.', fail: 'They laugh at your weakness.', onSuccess: () => joinJob('guard'), onFail: () => modRep('infamy', 1) }
            ])
        ],
        TitleChallenge: [
            createEvent('title_trial', 'The Trial of Nobility', 'To rise above your station, you must prove your worth.', [
                { text: 'Combat Tournament', type: 'check', stat: 'str', dc: 18, success: 'You defeat the champion! You are ennobled.', fail: 'You are defeated and humiliated.', onSuccess: () => ennoblePlayer(), onFail: () => { takeDamage(10); modRep('infamy', 5); } },
                { text: 'Silver Tongue', type: 'check', stat: 'cha', dc: 22, success: 'Your words weave a spell. You are ennobled.', fail: 'The court laughs at your presumption.', onSuccess: () => ennoblePlayer(), onFail: () => modRep('infamy', 5) },
                { text: 'Bribe (1000g)', type: 'flavor', req: s => s.gold >= 1000, effect: () => { state.gold -= 1000; ennoblePlayer(); log("Gold buys anything."); } }
            ])
        ],
        JobInterview: [], // Populated dynamically,
        Canon: [
            createEvent('canon_goblin', 'The Goblin Raid', 'Screeches echo in the night. Goblins are raiding the granary!', [
                { 
                    text: 'Slay them all (Combat)', type: 'combat', 
                    enemy: generateCreature('goblin', 1),
                    success: 'Green blood soaks the earth. You stand victorious.', 
                    fail: 'They swarm you. You are dragged away injured.', 
                    onSuccess: () => { addHonorific('Goblin-Slayer'); modRep('renown', 20); state.gold+=50; }, 
                    onFail: () => { takeDamage(4); modRep('infamy', 2); } 
                },
                { text: 'Set Trap (INT)', type: 'check', stat: 'int', dc: 14, success: 'They blow themselves up!', fail: 'The trap fails.', onSuccess: () => { addHonorific('The Cunning'); state.gold+=50; }, onFail: () => takeDamage(5) },
                { text: 'Hide', type: 'flavor', effect: () => { log("You survived, but the village suffered."); modRep('honor', -5); } }
            ]),

            createEvent('canon_troll', 'The Bridge Troll', 'A massive troll demands a toll to cross the river.', [
                { 
                    text: 'Fight (Combat)', type: 'combat', 
                    enemy: generateCreature('troll', 0),
                    success: 'You chopped off its head!', 
                    fail: 'It smashed you into the mud.', 
                    onSuccess: () => { addHonorific('Trollsbane'); modRep('renown', 30); }, 
                    onFail: () => takeDamage(5) 
                },
                { 
                    text: 'Persuade (CHA)', type: 'check', stat: 'cha', dc: 15, 
                    success: 'You tricked it into letting you pass.', 
                    fail: 'The troll roars! "NO TRICKS!" It attacks!', 
                    onSuccess: () => { addHonorific('Silver-Tongue'); }, 
                    onFail: () => {
                        CombatEngine.start(
                            generateCreature('troll', 0, 'Elite'),
                            () => { log("You survived the enraged beast!"); addHonorific('Trollsbane'); },
                            () => { log("The troll feasted upon your bones."); }
                        );
                    } 
                },
                { text: 'Pay Toll (50g)', type: 'flavor', req: s => s.gold >= 50, effect: () => { state.gold -= 50; log("Costly, but safe."); } }
            ]),

            createEvent('canon_wizard', 'The Dark Ritual', 'An evil wizard is abducting villagers for a sacrifice.', [
                { text: 'Disrupt Ritual (INT)', type: 'check', stat: 'int', dc: 16, success: 'You counterspell the magic!', fail: 'The magic backfires.', onSuccess: () => { addHonorific('Mage-Breaker'); modRep('honor', 20); }, onFail: () => { modSanity(-3); } },
                { text: 'Charge! (STR)', type: 'check', stat: 'str', dc: 15, success: 'You tackle the wizard mid-chant.', fail: 'You are blasted by lightning.', onSuccess: () => { addHonorific('The Brave'); modRep('renown', 20); }, onFail: () => takeDamage(10) },
                { text: 'Flee', type: 'flavor', effect: () => { log("You ran, leaving them to their fate."); modRep('infamy', 10); } }
            ]),

            createEvent('canon_festival', 'The Grand Festival', 'The King declares a month of celebration!', [
                { text: 'Perform (CHA)', type: 'check', stat: 'cha', dc: 15, success: 'You become a legend of the tavern!', fail: 'You trip on stage.', onSuccess: () => { addHonorific('Party Legend'); modRep('renown', 15); }, onFail: () => modRep('infamy', 2) },
                { text: 'Feast (CON)', type: 'check', stat: 'con', dc: 14, success: 'You ate an entire boar.', fail: 'Food poisoning.', onSuccess: () => { addHonorific('Iron-Stomach'); state.health+=5; }, onFail: () => takeDamage(3) },
                { text: 'Enjoy', type: 'flavor', effect: () => { modSanity(5); log("A wonderful time."); } }
            ]),

            createEvent('canon_bear', 'The Great Bear', 'A bear the size of a wagon attacks the camp.', [
                { 
                    text: 'Fight (Combat)', type: 'combat', 
                    enemy: generateCreature('bear', 2), // Dire Bear
                    success: 'You slew the beast!', 
                    fail: 'It mauled you.', 
                    onSuccess: () => { addHonorific('Bear-Slayer'); modRep('renown', 30); }, 
                    onFail: () => takeDamage(10) 
                },
                { text: 'Wrestle (STR)', type: 'check', stat: 'str', dc: 18, success: 'You pinned the bear!', fail: 'It mauled you.', onSuccess: () => { addHonorific('Bear-Wrestler'); modRep('renown', 40); }, onFail: () => takeDamage(15) },
                { text: 'Shoot (DEX)', type: 'check', stat: 'dex', dc: 14, success: 'Clean shot between the eyes.', fail: 'You missed.', onSuccess: () => { addHonorific('Deadeye'); state.gold+=20; }, onFail: () => takeDamage(10) },
                { text: 'Play Dead', type: 'check', stat: 'con', dc: 12, success: 'It sniffed you and left.', fail: 'It took a bite.', onSuccess: () => { addHonorific('The Survivor'); }, onFail: () => takeDamage(8) }
            ]),

            createEvent('canon_fey', 'The Sprite\'s Prank', 'A fey creature turns your skin blue.', [
                { text: 'Outsmart (WIS)', type: 'check', stat: 'wis', dc: 15, success: 'You trick it into reversing the spell.', fail: 'It turns your hair green too.', onSuccess: () => { addHonorific('Fey-Touched'); state.stats.int++; }, onFail: () => { addHonorific('The Colorful'); modRep('infamy', 5); } },
                { text: 'Beg (CHA)', type: 'check', stat: 'cha', dc: 14, success: 'It laughs and fixes you.', fail: 'It laughs and leaves.', onSuccess: () => {}, onFail: () => addTrait('Blue Skin') },
                { text: 'Endure', type: 'flavor', effect: () => { log("It wears off in a year."); } }
            ]),

            createEvent('canon_bandit', 'The Bandit Boss', 'The notorious Bandit Boss challenges you to a duel.', [
                { 
                    text: 'Accept Duel (Combat)', type: 'combat', 
                    enemy: generateCreature('bandit', 2), // Boss
                    success: 'You ended his reign of terror.', 
                    fail: 'He thrashed you and took your gold.', 
                    onSuccess: () => { addHonorific('Justicar'); state.gold+=100; modRep('honor', 30); }, 
                    onFail: () => { takeDamage(5); state.gold=0; } 
                },
                { text: 'Cheat (DEX)', type: 'check', stat: 'dex', dc: 15, success: 'Pocket sand!', fail: 'He saw it coming.', onSuccess: () => { addHonorific('The Ruthless'); state.gold+=100; }, onFail: () => takeDamage(15) },
                { text: 'Pay Tribute (100g)', type: 'flavor', req: s => s.gold >= 100, effect: () => { state.gold -= 100; log("You bought your life."); } }
            ]),

            createEvent('canon_plague', 'The Plague Ship', 'A ship arrives carrying the Black Death. Do you help?', [
                { text: 'Heal Sick (WIS)', type: 'check', stat: 'wis', dc: 16, success: 'You saved the crew!', fail: 'You caught the plague.', onSuccess: () => { addHonorific('The Saint'); modRep('piety', 50); }, onFail: () => { takeDamage(10); addTrait('Scarred Lungs'); } },
                { text: 'Burn Ship', type: 'flavor', effect: () => { log("Cruel, but necessary."); addHonorific('The Purifier'); modRep('infamy', 20); } },
                { text: 'Flee', type: 'flavor', effect: () => { log("You ran to the hills."); } }
            ]),

            createEvent('canon_meteor', 'The Starfall', 'A meteorite crashes nearby, glowing with strange light.', [
                { text: 'Harvest (STR)', type: 'check', stat: 'str', dc: 15, success: 'You mined stymetal ore.', fail: 'It burned you.', onSuccess: () => { addHonorific('Star-Caller'); addItem('Star Metal', 'Legendary', 'Ore from the heavens.', 500); }, onFail: () => takeDamage(5) },
                { text: 'Study (INT)', type: 'check', stat: 'int', dc: 16, success: 'Cosmic secrets revealed.', fail: 'Mind overload.', onSuccess: () => { addHonorific('The Astrologer'); state.stats.int+=2; }, onFail: () => modSanity(-3) },
                { text: 'Worship', type: 'flavor', effect: () => { modRep('piety', 10); log("A sign from the gods."); } }
            ]),

            createEvent('canon_sword', 'The Sword in the Stone', 'Legend says only the worthy can pull it.', [
                { 
                    text: 'Pull (STR)', type: 'check', stat: 'str', dc: 20, 
                    success: 'IT MOVES! You hold the blade!', 
                    fail: 'It does not budge.', 
                    onSuccess: () => { 
                        addHonorific('Chosen One'); 
                        // UPDATED: Award Excalibur as real weapon
                        addItem(WEAPON_LIBRARY.excalibur.name, 'Artifact', WEAPON_LIBRARY.excalibur.desc, 1000, null, 0, WEAPON_LIBRARY.excalibur); 
                        modRep('renown', 100); 
                    }, 
                    onFail: () => log("You are not the one.") 
                },
                { text: 'Study (INT)', type: 'check', stat: 'int', dc: 15, success: 'You realize it is a magnetic trick.', fail: 'Just a rock.', onSuccess: () => { addHonorific('The Skeptic'); state.stats.int++; }, onFail: () => {} },
                { text: 'Ignore', type: 'flavor', effect: () => log("Fairy tales.") }
            ]),

            createEvent('canon_dopple', 'The Imposter', 'You return home to find... YOURSELF sitting at the table.', [
                { text: 'Attack (STR)', type: 'check', stat: 'str', dc: 15, success: 'The monster melts into goo.', fail: 'It parries your blow.', onSuccess: () => { addHonorific('Truth-Seer'); }, onFail: () => takeDamage(10) },
                { text: 'Outsmart (INT)', type: 'check', stat: 'int', dc: 16, success: 'You asked a question only you know.', fail: 'It answers correctly!', onSuccess: () => { addHonorific('Mind-Master'); modSanity(2); }, onFail: () => modSanity(-5) },
                { text: 'Run', type: 'flavor', effect: () => { log("You fled your own life."); modSanity(-2); } }
            ]),

            createEvent('canon_fire', 'The Burning Barn', 'A barn is on fire! Children are trapped inside!', [
                { text: 'Rescue (DEX)', type: 'check', stat: 'dex', dc: 14, success: 'You saved them all!', fail: 'You got burned.', onSuccess: () => { addHonorific('Fire-Walker'); modRep('heroism', 20); }, onFail: () => { takeDamage(8); addTrait('Burn Scars'); } },
                { text: 'Douse (STR)', type: 'check', stat: 'str', dc: 15, success: 'You organized the bucket line.', fail: 'The fire spreads.', onSuccess: () => { addHonorific('The Savior'); }, onFail: () => log("Tragedy strikes.") },
                { text: 'Watch', type: 'flavor', effect: () => { log("You did nothing."); modRep('infamy', 10); } }
            ]),

            createEvent('canon_idol', 'The Cursed Idol', 'You find a golden idol. It whispers to you.', [
                { text: 'Take it (Will)', type: 'check', stat: 'wis', dc: 18, success: 'You resist the curse and keep the gold.', fail: 'The curse takes hold.', onSuccess: () => { addHonorific('Iron-Will'); state.gold+=200; }, onFail: () => { addTrait('Cursed'); modSanity(-4); } },
                { text: 'Destroy it', type: 'flavor', effect: () => { log("You smashed the evil."); modRep('piety', 20); } },
                { text: 'Sell it', type: 'flavor', effect: () => { log("You sold the curse to another."); state.gold+=100; modRep('infamy', 5); } }
            ]),

            createEvent('canon_griffin', 'The Griffin Egg', 'You find an abandoned griffin egg.', [
                { text: 'Hatch it (WIS)', type: 'check', stat: 'wis', dc: 16, success: 'It bonds with you!', fail: 'It bites you and flies off.', onSuccess: () => { addHonorific('Griffin-Friend'); addTrait('Pet Griffin'); }, onFail: () => takeDamage(5) },
                { text: 'Omelette', type: 'flavor', effect: () => { log("Delicious."); state.health+=10; } },
                { text: 'Sell (200g)', type: 'flavor', effect: () => { state.gold+=200; log("Sold to a wizard."); } }
            ]),

            createEvent('canon_necro', 'The Necromancer', 'Dead rise from the cemetery!', [
                { text: 'Smite (STR)', type: 'check', stat: 'str', dc: 15, success: 'You crushed the skeletons.', fail: 'Overwhelmed.', onSuccess: () => { addHonorific('Bone-Crusher'); modRep('renown', 20); }, onFail: () => takeDamage(10) },
                { text: 'Turn Undead (WIS)', type: 'check', stat: 'wis', dc: 16, success: 'Holy light burns them.', fail: 'Your faith wavered.', onSuccess: () => { addHonorific('Lightbringer'); modRep('piety', 30); }, onFail: () => modSanity(-3) },
                { text: 'Join', type: 'flavor', effect: () => { log("You offered to help."); addHonorific('The Traitor'); modRep('infamy', 50); } }
            ])
        ], 
        Travel: [createEvent('travel_bandit', 'Roadside Ambush', 'Bandits block the path.', [{ text: 'Fight', type: 'check', stat: 'str', dc: 12, success: 'You clear the road.', fail: 'They beat you and take gold.', onSuccess: () => modRep('renown', 2), onFail: () => { takeDamage(5); state.gold = Math.max(0, state.gold - 10); } }, { text: 'Pay Toll (5g)', type: 'flavor', req: (s) => s.gold >= 5, effect: () => { state.gold -= 5; log("Safe but poorer."); } }, { text: 'Run', type: 'check', stat: 'dex', dc: 14, success: 'You escape!', fail: 'They catch you.', onSuccess: () => {}, onFail: () => takeDamage(3) }])],
        Quest: [createEvent('quest_monster', 'The Beast', 'A monster plagues the local farms.', [{ text: 'Slay it', type: 'check', stat: 'str', dc: 15, success: 'The beast falls! (+Renown, +50g)', fail: 'It mauls you.', onSuccess: () => { modRep('renown', 10); state.gold += 50; }, onFail: () => takeDamage(10) }, { text: 'Track it', type: 'check', stat: 'wis', dc: 14, success: 'You find its lair and loot it. (+30g)', fail: 'You get lost.', onSuccess: () => state.gold += 30, onFail: () => {} }, { text: 'Set Trap', type: 'check', stat: 'int', dc: 14, success: 'Smart catch! (+40g)', fail: 'Trap failed.', onSuccess: () => state.gold += 40, onFail: () => {} }])],
        Crime: [createEvent('crime_heist', 'Manor Heist', 'A noble villa is unguarded.', [{ text: 'Rob it', type: 'check', stat: 'dex', dc: 16, success: 'Jackpot! (+100g, +Infamy)', fail: 'Guards! (-HP, Jail)', onSuccess: () => { state.gold += 100; modRep('infamy', 10); }, onFail: () => { takeDamage(10); modRep('infamy', 5); } }, { text: 'Leave', type: 'flavor', effect: () => log("Too risky.") }, { text: 'Tip Guards', type: 'check', stat: 'cha', dc: 12, success: 'Reward! (+10g, +Honor)', fail: 'Ignored.', onSuccess: () => { state.gold+=10; modRep('honor', 5); }, onFail: () => {} }])],
        SocialFail: [createEvent('fail_social', 'Empty Streets', 'You wander the market but meet no one of interest.', [{ text: 'Go home', type: 'flavor', effect: () => log("A quiet day.") }, { text: 'Train Alone', type: 'check', stat: 'str', dc: 12, success: '+1 STR', fail: 'Tired.', onSuccess: () => state.stats.str++, onFail: () => {} }, { text: 'Read', type: 'check', stat: 'int', dc: 12, success: '+1 INT', fail: 'Boring.', onSuccess: () => state.stats.int++, onFail: () => {} }]), createEvent('fail_love', 'Cold Shoulder', 'Your attempts at courtship are met with polite refusal.', [{ text: 'Try again later', type: 'flavor', effect: () => log("There are other fish in the sea.") }, { text: 'Drink', type: 'flavor', effect: () => { state.gold = Math.max(0, state.gold-2); log("You drown your sorrows."); } }, { text: 'Write Poem', type: 'check', stat: 'cha', dc: 12, success: 'Practice makes perfect. (+1 CHA)', fail: 'Terrible.', onSuccess: () => state.stats.cha++, onFail: () => {} }])],
        Interactive: [createEvent('inter_bump', 'A Chance Encounter', 'You bump into a stranger carrying a heavy load.', [{ text: 'Help them', type: 'check', stat: 'str', dc: 10, success: 'They thank you profusely. (+Rel)', fail: 'You drop it. They yell at you.', onSuccess: () => createRandomRel(20), onFail: () => {} }, { text: 'Walk away', type: 'flavor', effect: () => log("Not your problem.") }, { text: 'Apologize', type: 'check', stat: 'cha', dc: 10, success: 'They nod.', fail: 'They grumble.', onSuccess: () => {}, onFail: () => {} }])],
        Jeopardy: [createEvent('sanity_break', 'Mental Snap', 'The pressure is too much. Reality bends.', [{ text: 'Scream', type: 'flavor', effect: () => { modSanity(-2); log("You lose yourself for a moment."); } }, { text: 'Hide', type: 'flavor', effect: () => log("You curl up in a corner.") }, { text: 'Run', type: 'flavor', effect: () => { state.health--; log("You run until you collapse."); } }]), createEvent('sanity_visions', 'Dark Visions', 'Shadows whisper your name.', [{ text: 'Pray', type: 'check', stat: 'wis', dc: 12, success: 'The voices fade. (+2 SP)', fail: 'They scream louder. (-1 SP)', onSuccess: () => modSanity(2), onFail: () => modSanity(-1) }, { text: 'Listen', type: 'check', stat: 'int', dc: 14, success: 'Forbidden knowledge! (+1 INT)', fail: 'Madness.', onSuccess: () => state.stats.int++, onFail: () => modSanity(-2) }, { text: 'Ignore', type: 'check', stat: 'con', dc: 12, success: 'You push them away.', fail: 'They persist.', onSuccess: () => {}, onFail: () => modSanity(-1) }]), createEvent('sanity_final', 'Mental Break', 'Your mind shatters under the strain of existence.', [{ text: 'Hold it together', type: 'check', stat: 'wis', dc: 15, success: 'You claw back your sanity from the brink. (+3 SP)', fail: 'Your mind snaps. Massive shock. (-20 HP)', onSuccess: () => modSanity(3), onFail: () => { takeDamage(20); modSanity(-2); } }, { text: 'Give In', type: 'flavor', effect: () => { modSanity(-5); takeDamage(10); log("You embrace the madness."); } }, { text: 'Seek Help', type: 'flavor', req: s => s.gold >= 50, effect: () => { state.gold-=50; state.sanity=5; log("Healers restore your mind."); } }])],
        Financial: [
            // Generic pool for NPCs asking PC for money
            (npc) => createEvent(`fin_ask_${npc.id}`, `Financial Request`, `Your ${npc.relation} ${npc.name} approaches you, looking sheepish. "I am in dire straits. Could you spare some coin?"`, [
                { text: 'Give 10g', type: 'flavor', req: s => s.gold >= 10, effect: () => { state.gold -= 10; modRel(npc.id, 15); log(`You helped ${npc.name} in their time of need. (+Rel)`); } },
                { text: 'Refuse', type: 'flavor', effect: () => { modRel(npc.id, -10); log(`${npc.name} leaves, clearly upset. (-Rel)`); } },
                { text: 'Give 50g', type: 'flavor', req: s => s.gold >= 50, effect: () => { state.gold -= 50; modRel(npc.id, 40); log(`You were incredibly generous. ${npc.name} weeps with gratitude. (+Rel)`); } }
            ])
        ]
    };
    
    // REMOVED POOLS.Childhood = POOLS.Infancy; 

    // 6. LOGIC & ENGINE
    function init() {
        rerollStats();
        document.querySelector('.header').style.opacity = 0;
        document.querySelector('.main-layout').style.opacity = 0;
        document.getElementById('char-name').addEventListener('input', checkReady);
    }

    function checkAge(minAge) {
        if(state.age < minAge) {
            document.getElementById('age-warning-text').innerText = `You must be at least ${minAge} years old to do this.`;
            document.getElementById('age-modal').classList.remove('hidden');
            return false;
        }
        return true;
    }

    // --- NEW: UI HELPERS (Fix for Popups) ---
    function showMsg(title, text) {
        document.getElementById('msg-title').innerText = title;
        document.getElementById('msg-text').innerText = text;
        document.getElementById('msg-modal').classList.remove('hidden');
    }

    function showConfirm(text, onConfirm) {
        document.getElementById('confirm-text').innerText = text;
        const yesBtn = document.getElementById('confirm-yes-btn');
        // Clone to strip old event listeners to prevent stacking calls
        const newBtn = yesBtn.cloneNode(true);
        yesBtn.parentNode.replaceChild(newBtn, yesBtn);
        
        newBtn.onclick = () => {
            closeConfirm();
            onConfirm();
        };
        
        document.getElementById('confirm-modal').classList.remove('hidden');
    }

    function closeConfirm() {
        document.getElementById('confirm-modal').classList.add('hidden');
    }

    function rerollStats() {
        const standardArray = [15, 14, 13, 12, 10, 8];
        for (let i = standardArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [standardArray[i], standardArray[j]] = [standardArray[j], standardArray[i]];
        }
        let i = 0;
        for (let key in state.stats) state.stats[key] = standardArray[i++];
        renderCreationStats();
    }

    function renderCreationStats() {
        const container = document.getElementById('creation-stats');
        container.innerHTML = '';
        const labels = { str: 'STRENGTH', dex: 'DEXTERITY', con: 'CONSTITUTION', int: 'INTELLIGENCE', wis: 'WISDOM', cha: 'CHARISMA' };
        for (let key in state.stats) {
            const val = state.stats[key];
            container.innerHTML += `
                <div class="bg-white/50 p-2 rounded text-center border border-[#5d4037]">
                    <div class="text-xs uppercase font-bold">${labels[key]}</div>
                    <div class="text-xl font-medieval">${val}</div>
                    <div class="text-xs text-gray-600">${formatMod(getModifier(val))}</div>
                </div>`;
        }
    }

    function setGender(g) {
        state.gender = g;
        
        const btnM = document.getElementById('gender-m');
        const btnF = document.getElementById('gender-f');

        // Reset classes
        btnM.classList.remove('active-opt');
        btnF.classList.remove('active-opt');
        btnM.classList.add('opacity-60');
        btnF.classList.add('opacity-60');
        
        // Clear legacy inline styles
        btnM.style.border = '';
        btnF.style.border = '';
        btnM.style.opacity = '';
        btnF.style.opacity = '';

        if (g === 'Male') {
            btnM.classList.add('active-opt');
            btnM.classList.remove('opacity-60');
        } else {
            btnF.classList.add('active-opt');
            btnF.classList.remove('opacity-60');
        }
        checkReady();
    }

    function setOrigin(origin) {
        state.flags.startOrigin = origin;
        document.getElementById('origin-commoner').classList.remove('active-opt');
        document.getElementById('origin-house').classList.remove('active-opt');
        document.getElementById('origin-commoner').classList.add('opacity-60');
        document.getElementById('origin-house').classList.add('opacity-60');
        
        if(origin === 'Commoner') {
            document.getElementById('origin-commoner').classList.add('active-opt');
            document.getElementById('origin-commoner').classList.remove('opacity-60');
        } else {
            document.getElementById('origin-house').classList.add('active-opt');
            document.getElementById('origin-house').classList.remove('opacity-60');
        }
        checkReady(); // UPDATED: Added check logic
    }

    function checkReady() {
        // UPDATED: Now checks Name, Gender, and Origin
        const isName = document.getElementById('char-name').value.length > 0;
        const isGender = state.gender !== null;
        const isOrigin = state.flags.startOrigin !== null;
        document.getElementById('start-btn').disabled = !(isName && isGender && isOrigin);
    }

    function getRandomName(gender) {
        const list = gender === 'Male' ? NPC_NAMES.m : NPC_NAMES.f;
        return list[Math.floor(Math.random() * list.length)];
    }

    // Helper to add parents with death chance
    function tryAddParent(relation, gender, rank, locIndex, age) {
        const roll = Math.random();
        // Force parents to exist for genetic purposes if possible, but mark as dead if roll fails
        const name = getRandomName(gender);
        // CHANGED: isBlood is now true for parents
        const parent = addRelationship(name, relation, 80 + Math.floor(Math.random()*20), gender, rank, locIndex, true, true, age);
        
        if (roll < 0.1) {
            parent.health = "Deceased";
            parent.deathYear = state.year - Math.floor(Math.random() * 5); // Died recently
            parent.deathCause = "passed away before your memory";
            // log(`Your ${relation} passed before your memory begins.`);
        }
        return parent;
    }

    function generateHouse() {
        let locIndex = state.location; // Use local var to track potential updates
        
        // AGE GENERATION LOGIC
        const fatherAge = 20 + Math.floor(Math.random() * 21);
        const motherAge = 18 + Math.floor(Math.random() * 21);
        const gpAge = Math.max(fatherAge, motherAge) + 20 + Math.floor(Math.random() * 21);

        // --- NEW: INCEST SPAWN CHANCE (5%) ---
        // If this hits, the parents are related (Mother is blood-related instead of married-in)
        const isIncestSpawn = Math.random() < 0.05; 
        
        let houseNameForGenes = null;
        
        if (state.flags.startOrigin === 'Commoner') {
            state.socialClass = "Commoner";
            state.house = null;
            state.class = "Commoner";
            // Parents MUST be created to have genes
            // Father is always blood (lineage starter for commoner context), Mother is usually not.
            // If isIncestSpawn is true, Mother is marked isBlood: true (implying sister/cousin)
            const dad = tryAddParent("Father", "Male", "Commoner", locIndex, fatherAge);
            const mom = tryAddParent("Mother", "Female", "Commoner", locIndex, motherAge);
            if (isIncestSpawn) mom.isBlood = true; 
            
            // SIBLING GENERATION (0-3)
            const numSiblings = Math.floor(Math.random() * 4);
            // Calculate max sibling age based on mother's age (Ensure at least 15 year gap)
            const maxSibAge = Math.max(1, motherAge - 15);

            for(let i=0; i < numSiblings; i++) {
                const gen = Math.random() > 0.5 ? 'Male' : 'Female';
                // UPDATED: Cohesive Age Logic
                const sibAge = Math.floor(Math.random() * maxSibAge) + 1;
                
                const sib = addRelationship(getRandomName(gen), "Sibling", 50, gen, "Commoner", locIndex, true, true, sibAge);
                // Siblings inherit from parents
                sib.appearance = GeneticEngine.mix(dad, mom);
            }
            return;
        }

        // NOBLE HOUSE GENERATION
        state.socialClass = "House";
        
        const tierRoll = Math.random();
        let tierKey = 'lesser';
        if (tierRoll > 0.99) tierKey = 'royal';
        else if (tierRoll > 0.90) tierKey = 'greater';
        
        const tierData = TIER_DATA[tierKey];
        const names = HOUSE_NAMES[tierKey];
        const houseName = names[Math.floor(Math.random() * names.length)];
        
        // --- GREATER HOUSE LOCATION COMMITMENT ---
        // If we picked a major house, ensure we are born in their city
        if (tierKey === 'royal' || tierKey === 'greater') {
            const properCityIndex = CITIES.findIndex(c => c.ruler.includes(houseName));
            if (properCityIndex !== -1) {
                state.location = properCityIndex;
                locIndex = properCityIndex;
            }
        }

        // Set house name for gene generation to force phenotype
        houseNameForGenes = houseName;

        let houseDetails = {};
        if (tierKey !== 'lesser' && GREATER_HOUSES_INFO[houseName]) {
            houseDetails = GREATER_HOUSES_INFO[houseName];
            houseDetails.holding = GREATER_HOUSES_INFO[houseName].holding;
            houseDetails.holdingDesc = GREATER_HOUSES_INFO[houseName].holdingDesc;
        } else {
            const prefix = HOLDING_PREFIXES[Math.floor(Math.random() * HOLDING_PREFIXES.length)];
            houseDetails = {
                motto: LESSER_MOTTOS[Math.floor(Math.random() * LESSER_MOTTOS.length)],
                desc: "A lesser noble house striving for glory.",
                heirloom: "Old Shield",
                sigil: tierData.sigils[Math.floor(Math.random() * tierData.sigils.length)],
                holding: `${prefix} ${houseName}`,
                holdingDesc: "A sturdy manor house overseeing the surrounding lands."
            };
        }
        
        // NEW: Select House Trait from Phenotypes or Mutations
        let potentialTraits = [];
        if (HOUSE_PHENOTYPES[houseName]) {
            potentialTraits.push(`${HOUSE_PHENOTYPES[houseName].hair} Hair`);
            potentialTraits.push(`${HOUSE_PHENOTYPES[houseName].eyes} Eyes`);
        } else {
            // Random cosmetic feature for random houses
            potentialTraits.push(`${COSMETICS.hair[Math.floor(Math.random() * COSMETICS.hair.length)]} Hair`);
            potentialTraits.push(`${COSMETICS.eyes[Math.floor(Math.random() * COSMETICS.eyes.length)]} Eyes`);
        }
        // Add mutations to the pool
        potentialTraits = potentialTraits.concat(MUTATION_POOL.filter(m => m.rarity !== 'Common').map(m => m.name));
        
        const houseTrait = potentialTraits[Math.floor(Math.random() * potentialTraits.length)];

        // Calculate initial population based on tier
        let startPop = 100;
        let startLevel = 1;
        let startType = 'Manor';
        let extraHoldingsCount = 0;
        let startTreasury = tierData.startGold;

        if (tierKey === 'royal') {
            startPop = 15000 + Math.floor(Math.random() * 5000);
            startType = 'Keep';
            startTreasury = 50000; // Royals need war chests
            extraHoldingsCount = 3 + Math.floor(Math.random() * 3); // 3-5 extra holdings
        }
        else if (tierKey === 'greater') {
            startPop = 5000 + Math.floor(Math.random() * 2000);
            startType = 'Keep';
            startTreasury = 15000;
            extraHoldingsCount = 1 + Math.floor(Math.random() * 3); // 1-3 extra holdings
        }
        else {
            // Lesser House
            startPop = 200 + Math.floor(Math.random() * 300);
            startType = 'Manor';
            // 20% Chance for a lesser house to have a secondary farm
            extraHoldingsCount = Math.random() < 0.2 ? 1 : 0;
        }

        // Calculate required level to house the population
        const mainTmpl = HOLDING_TEMPLATES[startType] || HOLDING_TEMPLATES['Manor'];
        // Ensure capacity > startPop. Cap = Base + (Lvl * PerLvl)
        // Lvl = (Pop - Base) / PerLvl
        let calculatedLevel = Math.ceil((startPop - mainTmpl.basePop) / mainTmpl.capPerLvl);
        startLevel = Math.max(1, calculatedLevel);

        // Cap Level reasonably so we don't have Level 100 keeps immediately unless necessary
        // Add a buffer so they aren't at 100% capacity instantly
        startLevel += 2; 

        state.house = {
            tier: tierData.name,
            name: houseName,
            sigil: houseDetails.sigil,
            motto: houseDetails.motto,
            desc: houseDetails.desc,
            heirloom: houseDetails.heirloom,
            // holdings replaces the single string 'holding'
            holdings: [
                { 
                    name: houseDetails.holding, 
                    desc: houseDetails.holdingDesc, 
                    type: startType, 
                    level: startLevel, 
                    locationIndex: locIndex, // ADDED: Location tracking
                    population: startPop,
                    capacity: mainTmpl.basePop + (startLevel * mainTmpl.capPerLvl),
                    defense: mainTmpl.baseDef + (startLevel * mainTmpl.defPerLvl),
                    upgradedThisYear: false
                }
            ],
            treasury: startTreasury,
            trait: houseTrait,
            members: []
        };

        // --- GENERATE EXTRA HOLDINGS ---
        for (let i = 0; i < extraHoldingsCount; i++) {
            const extraTypes = ['Farm', 'Manor']; // Satellite holdings are usually smaller
            const type = extraTypes[Math.floor(Math.random() * extraTypes.length)];
            const tmpl = HOLDING_TEMPLATES[type];
            
            // Random location nearby (same city or random)
            // For now, keep it in the main city for simplicity of management
            const hLoc = locIndex; 
            
            const descriptor = tmpl.descriptors[Math.floor(Math.random() * tmpl.descriptors.length)];
            const newName = `The ${descriptor} of ${houseName}`;
            const hDesc = tmpl.descText[Math.floor(Math.random() * tmpl.descText.length)];
            
            // Randomize level slightly (1-3)
            const hLvl = 1 + Math.floor(Math.random() * 3);
            const hPop = Math.floor((tmpl.basePop + (hLvl * tmpl.capPerLvl)) * (0.5 + Math.random() * 0.4)); // 50-90% full

            state.house.holdings.push({
                name: newName,
                desc: hDesc,
                type: type,
                level: hLvl,
                locationIndex: hLoc,
                population: hPop,
                capacity: tmpl.basePop + (hLvl * tmpl.capPerLvl),
                defense: tmpl.baseDef + (hLvl * tmpl.defPerLvl),
                upgradedThisYear: false
            });
        }
        
        // Initial Ranks will be recalculated by checkInheritance immediately after generation
        // EDITED: Default to "House Member" to avoid "Younger Child" or incorrect "Heir" assignment before logic runs.
        let rank = "House Member";
        state.class = `${rank} of House ${houseName}`;

        // -- EXTENDED FAMILY GENERATION --
        // FORCE HOUSE TRAIT ON FOUNDER (Grandfather)
        
        const grandpa = addRelationship(getRandomName('Male'), "Grandfather", 60, "Male", "House Member", locIndex, true, true, gpAge + 2);
        grandpa.appearance = GeneticEngine.generate(houseNameForGenes, houseTrait); 
        addHouseMember(grandpa.name, 'Male', 'House Member', locIndex, grandpa.id);

        const grandma = addRelationship(getRandomName('Female'), "Grandmother", 60, "Female", "House Member", locIndex, false, true, gpAge);
        // Grandma marries in, usually random
        grandma.appearance = GeneticEngine.generate(); 
        addHouseMember(grandma.name, 'Female', 'House Member', locIndex, grandma.id);

        // LINK GRANDPARENTS
        grandpa.spouseId = grandma.id;
        grandma.spouseId = grandpa.id;
        grandpa.isMarried = true;
        grandma.isMarried = true;

        // --- NEW: DETERMINE BLOODLINE CARRIER (Patrilineal vs Matrilineal) ---
        // 50% Chance the mother is the heir instead of the father
        const isMatrilineal = Math.random() < 0.5;
        let father, mother;

        if (isMatrilineal) {
            // Mother is the Blood Descendant
            mother = addRelationship(getRandomName('Female'), "Mother", 80, "Female", "House Member", locIndex, true, true, motherAge);
            mother.fatherId = grandpa.id;
            mother.motherId = grandma.id;
            mother.appearance = GeneticEngine.mix(grandpa, grandma); // Inherits from House Founders
            addHouseMember(mother.name, 'Female', 'House Member', locIndex, mother.id);

            // Father Married In
            father = addRelationship(getRandomName('Male'), "Father", 80, "Male", "House Member", locIndex, false, true, fatherAge);
            father.appearance = GeneticEngine.generate(); // Outsider genes
            if (isIncestSpawn) father.isBlood = true; // Incest: Spouse is also kin
            addHouseMember(father.name, 'Male', 'House Member', locIndex, father.id);
        } else {
            // Father is the Blood Descendant (Standard)
            father = addRelationship(getRandomName('Male'), "Father", 80, "Male", "House Member", locIndex, true, true, fatherAge);
            father.fatherId = grandpa.id;
            father.motherId = grandma.id;
            father.appearance = GeneticEngine.mix(grandpa, grandma); // Inherits from House Founders
            addHouseMember(father.name, 'Male', 'House Member', locIndex, father.id);

            // Mother Married In
            mother = addRelationship(getRandomName('Female'), "Mother", 80, "Female", "House Member", locIndex, false, true, motherAge);
            mother.appearance = GeneticEngine.generate(); // Outsider genes
            if (isIncestSpawn) mother.isBlood = true; // Incest: Spouse is also kin
            addHouseMember(mother.name, 'Female', 'House Member', locIndex, mother.id);
        }

        // LINK PARENTS
        father.spouseId = mother.id;
        mother.spouseId = father.id;
        father.isMarried = true;
        mother.isMarried = true;

        // UNCLE/AUNT & COUSIN GENERATION
        addHouseMember(state.name, state.gender, "House Member", state.location, "PLAYER"); 
        
        // --- NEW: PLAYER MULTIPLE BIRTH CHECK ---
        const pcBirths = getBirthCount();
        if (pcBirths > 1) {
            const types = ["Twin", "Triplet", "Quadruplet"];
            const typeName = types[pcBirths - 2] || "Multiple";
            log(`<strong>Birth:</strong> You were born a ${typeName}!`);
            
            // Generate the womb-mates (Age 0)
            for(let i=0; i < pcBirths - 1; i++) {
                const sibGender = Math.random() > 0.5 ? 'Male' : 'Female';
                const sib = addRelationship(getRandomName(sibGender), "Sibling", 90, sibGender, "House Member", state.location, true, true, 0);
                sib.appearance = GeneticEngine.mix(father, mother); 
                addHouseMember(sib.name, sib.gender, sib.rank, sib.locationIndex, sib.id);
            }
        }

        // OLDER SIBLING GENERATION (0-3)
        const numSiblings = Math.floor(Math.random() * 4);
        // Calculate max sibling age based on mother's age (Ensure at least 15 year gap)
        const maxSibAge = Math.max(1, motherAge - 15);

        for(let i=0; i < numSiblings; i++) {
            const sibGender = Math.random() > 0.5 ? 'Male' : 'Female';
            // UPDATED: Cohesive Age Logic
            const sibAge = Math.floor(Math.random() * maxSibAge) + 1;
            
            const sib = addRelationship(getRandomName(sibGender), "Sibling", 80, sibGender, "House Member", state.location, true, true, sibAge);
            sib.appearance = GeneticEngine.mix(father, mother); // Inherit from parents
            addHouseMember(sib.name, sib.gender, sib.rank, sib.locationIndex, sib.id);
        }
        
        generateHouseKnights(tierKey, houseName, locIndex);
        if (tierKey === 'lesser') ensureAvailableRetainers(0);

        // Apply Initial Titles Logic immediately
        checkInheritance();
    }

    // --- NEW: SUCCESSION LOGIC ---
    // Helper for Titles
    function getTitleSet(tier, gender) {
        const isMale = gender === 'Male';
        if (tier === 'Royal House') {
            return {
                head: isMale ? 'King' : 'Queen',
                spouse: isMale ? 'Prince Consort' : 'Queen Consort',
                heir: isMale ? 'Crown Prince' : 'Crown Princess',
                emeritus: isMale ? 'King Emeritus' : 'Queen Mother'
            };
        } else if (tier === 'Greater House') {
            return {
                head: isMale ? 'Duke' : 'Duchess',
                spouse: isMale ? 'Duke' : 'Duchess',
                heir: isMale ? 'Marquess' : 'Marchioness',
                emeritus: isMale ? 'Duke Emeritus' : 'Dowager Duchess'
            };
        } else {
            return {
                head: isMale ? 'Lord' : 'Lady',
                spouse: isMale ? 'Lord' : 'Lady',
                heir: 'Heir',
                emeritus: isMale ? 'Lord Emeritus' : 'Dowager Lady'
            };
        }
    }

    function checkInheritance() {
        if (!state.house || !state.house.members) return;

        // 1. Identify Current Ruler
        // UPDATED: Check for King, Queen, Duke, Duchess as well
        let ruler = state.house.members.find(m => 
            !m.rank.includes('Emeritus') && !m.rank.includes('Dowager') && !m.rank.includes('Mother') && !m.rank.includes('Consort') &&
            (m.rank.includes('Lord') || m.rank.includes('Lady') || m.rank.includes('King') || m.rank.includes('Queen') || m.rank.includes('Duke') || m.rank.includes('Duchess'))
        );

        // If no ruler found (e.g. game start), defaults to Oldest Male Bloodline
        if (!ruler) {
            const candidates = calculateSuccession(null);
            if (candidates.length > 0) {
                ruler = candidates[0];
                const titles = getTitleSet(state.house.tier, ruler.gender);
                updateRank(ruler.id, titles.head);
                log(`<strong style="color:var(--royal)">HOUSE:</strong> ${ruler.name} is recognized as the ${titles.head} of House ${state.house.name}.`);
            }
        }

        if (!ruler) return; // Should not happen

        // 2. Check if Ruler Died
        let rulerIsDead = false;
        if (ruler.id === 'PLAYER') {
            if (state.health <= 0) rulerIsDead = true;
        } else {
            const rel = state.relationships.find(r => r.id === ruler.id);
            if (rel && rel.health === 'Deceased') rulerIsDead = true;
        }

        // 3. Calculate Heir (Always update this to keep UI fresh)
        const heirs = calculateSuccession(ruler);
        const heirApparent = heirs.length > 0 ? heirs[0] : null;

        // Ensure only one person has 'Heir' rank at a time (if ruler is alive)
        // UPDATED: Check for specific heir titles (Crown Prince, Marquess)
        if (!rulerIsDead && heirApparent) {
            const heirTitles = getTitleSet(state.house.tier, heirApparent.gender);
            
            state.house.members.forEach(m => {
                if ((m.rank === 'Heir' || m.rank === 'Crown Prince' || m.rank === 'Crown Princess' || m.rank === 'Marquess' || m.rank === 'Marchioness') && m.id !== heirApparent.id) {
                    m.rank = 'House Member'; // Demote previous heir
                    // If player was demoted, update their state class string
                    if (m.id === 'PLAYER') updateRank('PLAYER', 'House Member');
                }
            });
            if (heirApparent.rank !== heirTitles.heir) updateRank(heirApparent.id, heirTitles.heir);
        }

        // 4. Process Succession if Ruler Died
        if (rulerIsDead) {
            const oldTitles = getTitleSet(state.house.tier, ruler.gender);
            updateRank(ruler.id, oldTitles.emeritus);
            
            if (ruler.id !== 'PLAYER') {
                log(`<strong style="color:var(--failure)">DEATH:</strong> The ${ruler.rank} has passed. The House looks to the bloodline.`);
            }

            if (heirApparent) {
                const newTitles = getTitleSet(state.house.tier, heirApparent.gender);
                updateRank(heirApparent.id, newTitles.head);
                
                if (heirApparent.id === 'PLAYER') {
                    log(`<strong style="color:var(--gold)">ASCENSION:</strong> You are now the ${newTitles.head} of House ${state.house.name}!`);
                    modRep('renown', 50);
                } else {
                    log(`<strong style="color:var(--royal)">ASCENSION:</strong> ${heirApparent.name} ascends as the new ${newTitles.head}.`);
                }
                
                // Trigger recursive check in case the new Lord has an heir ready
                checkInheritance(); 
            } else {
                log("The line of succession is broken. The House falls into chaos.");
                state.house.treasury = Math.floor(state.house.treasury / 2);
            }
            updateUI();
        }
    }

    function calculateSuccession(currentRuler) {
        // Gather all LIVING blood members
        let pool = state.house.members.filter(m => {
            // Must be blood relative or the Player (who is blood)
            // We check ID: if it's Player, always blood. If NPC, check isBlood flag.
            if (m.id === 'PLAYER') return true;
            const rel = state.relationships.find(r => r.id === m.id);
            return rel && rel.isBlood && rel.health !== 'Deceased';
        });

        // Filter out the current ruler themselves
        if (currentRuler) {
            pool = pool.filter(m => m.id !== currentRuler.id);
        }

        // If no current ruler (Start of game), find Oldest Male
        if (!currentRuler) {
            return pool.sort((a, b) => {
                const ageA = getAge(a.id);
                const ageB = getAge(b.id);
                // Males first
                if (a.gender === 'Male' && b.gender !== 'Male') return -1;
                if (a.gender !== 'Male' && b.gender === 'Male') return 1;
                // Then Oldest
                return ageB - ageA;
            });
        }

        // SCORED SUCCESSION: Primogeniture (Male Preference)
        // 1. Sons > 2. Grandsons > 3. Brothers > 4. Uncles > 5. Daughters > 6. Sisters
        
        const rulerId = currentRuler.id;
        const rulerRelType = currentRuler.id === 'PLAYER' ? 'Self' : (state.relationships.find(r => r.id === currentRuler.id)?.relation || 'Unknown');

        pool.sort((a, b) => {
            const scoreA = getClaimScore(a, rulerId, rulerRelType);
            const scoreB = getClaimScore(b, rulerId, rulerRelType);
            
            if (scoreA !== scoreB) return scoreB - scoreA; // High score first
            
            // Tie-breaker: Age (Oldest first)
            return getAge(b.id) - getAge(a.id);
        });

        return pool;
    }

    function getClaimScore(candidate, rulerId, rulerRelType) {
        let score = 0;
        
        // 1. GENDER BIAS (Massive weight)
        if (candidate.gender === 'Male') score += 10000;

        // 2. RELATIONSHIP TO RULER
        // We must infer the relationship between Candidate and Ruler based on their relationship to PLAYER
        
        const candRelType = candidate.id === 'PLAYER' ? 'Self' : (state.relationships.find(r => r.id === candidate.id)?.relation || 'Unknown');

        // Logic Matrix
        let relationToRuler = 'Remote';

        if (rulerRelType === 'Self') { // Ruler is Player
            if (candRelType === 'Son') relationToRuler = 'Child';
            if (candRelType === 'Grandson') relationToRuler = 'Grandchild';
            if (candRelType === 'Sibling') relationToRuler = 'Sibling';
            if (candRelType === 'Uncle') relationToRuler = 'Uncle';
            if (candRelType === 'Daughter') relationToRuler = 'Child';
        } 
        else if (rulerRelType === 'Father') { // Ruler is Father
            if (candRelType === 'Self' || candRelType === 'Sibling') relationToRuler = 'Child';
            if (candRelType === 'Uncle') relationToRuler = 'Sibling'; // Father's brother is my uncle
        }
        else if (rulerRelType === 'Grandfather') { // Ruler is Grandfather
            if (candRelType === 'Father' || candRelType === 'Uncle') relationToRuler = 'Child';
            if (candRelType === 'Self' || candRelType === 'Sibling') relationToRuler = 'Grandchild';
        }
        else if (rulerRelType === 'Brother') { // Ruler is Brother
            if (candRelType === 'Nephew') relationToRuler = 'Child';
            if (candRelType === 'Self' || candRelType === 'Sibling') relationToRuler = 'Sibling';
            if (candRelType === 'Uncle') relationToRuler = 'Uncle';
        }

        // Apply Scores based on inferred relationship
        if (relationToRuler === 'Child') score += 5000;
        else if (relationToRuler === 'Grandchild') score += 4000;
        else if (relationToRuler === 'Sibling') score += 3000;
        else if (relationToRuler === 'Uncle') score += 2000;
        else if (relationToRuler === 'Nephew') score += 1000; // Rare case depending on perspective
        
        return score;
    }

    function getAge(id) {
        if (id === 'PLAYER') return state.age;
        const r = state.relationships.find(x => x.id === id);
        return r ? r.age : 0;
    }

    function updateRank(id, newRank) {
        // Update House Member List
        const member = state.house.members.find(m => m.id === id);
        if (member) member.rank = newRank;
        
        // Update Player State
        if (id === 'PLAYER') {
            state.class = `${newRank} of House ${state.house.name}`;
            state.socialClass = 'House'; // Ensure consistency
        } 
        // Update Relationship State
        else {
            const rel = state.relationships.find(r => r.id === id);
            if (rel) rel.rank = newRank;
        }
    }

    function createLesserHouseForPlayer() {
        const tierData = TIER_DATA['lesser'];
        const names = HOUSE_NAMES['lesser'];
        const houseName = names[Math.floor(Math.random() * names.length)];
        const prefix = HOLDING_PREFIXES[Math.floor(Math.random() * HOLDING_PREFIXES.length)];
        const houseDetails = {
             motto: "Bought with Blood", // Default for ennobled commoners
             desc: "A newly risen house.",
             heirloom: "Gilded Sword",
             sigil: tierData.sigils[Math.floor(Math.random() * tierData.sigils.length)],
             holding: `${prefix} ${houseName}`,
             holdingDesc: "A modest fortification recently acquired."
        };

        // NEW: Select House Trait from Mutations for player created houses
        const validMutations = MUTATION_POOL.filter(m => m.rarity !== 'Common');
        const houseTrait = validMutations[Math.floor(Math.random() * validMutations.length)].name;

        state.house = {
            tier: tierData.name,
            name: houseName,
            sigil: houseDetails.sigil,
            motto: houseDetails.motto,
            desc: houseDetails.desc,
            heirloom: houseDetails.heirloom,
            holdings: [
                { 
                    name: houseDetails.holding, 
                    desc: houseDetails.holdingDesc, 
                    type: 'Manor', 
                    level: 1, 
                    locationIndex: state.location, // ADDED: Player's current location
                    population: 150,
                    defense: 5 
                }
            ],
            treasury: tierData.startGold,
            trait: houseTrait,
            members: []
        };
        
        const rank = state.gender === 'Female' ? "Lady" : "Lord";
        state.class = `${rank} of House ${houseName}`;
        
        addHouseMember(state.name, state.gender, rank, state.location, "PLAYER");
        
        const knightCount = 1 + Math.floor(Math.random() * 3);
        generateHouseKnights('lesser', houseName, state.location);
        ensureAvailableRetainers(0);
    }
    
    function ennoblePlayer() {
        state.gold -= 500;
        state.socialClass = 'House';
        createLesserHouseForPlayer();
        log(`<strong style="color:var(--gold)">ENNOBLED:</strong> You are now a noble of House ${state.house.name}!`);
        updateUI();
    }

    function addHouseMember(name, gender, rank, locIndex, id) {
        state.house.members.push({
            name, gender, rank, locationIndex: locIndex, id: id || Math.random().toString(36).substr(2, 9)
        });
    }

    function createHouseKnight(houseName, locIndex, serviceType = null, isAvailable = false) {
        const gender = Math.random() > 0.5 ? 'Male' : 'Female';
        const name = getRandomName(gender);
        const knight = addRelationship(name, "Sworn Knight", 60, gender, "Sworn Knight", locIndex, false, false, 25 + Math.floor(Math.random() * 25));
        knight.occupation = "Sworn Knight";
        knight.rank = "Sworn Knight";
        knight.inventory.push({ name: 'Chainmail', rarity: 'Uncommon', desc: 'Protection.', value: 50, dr: 4 });
        knight.inventory.push({ ...WEAPON_LIBRARY.longsword, weapon: WEAPON_LIBRARY.longsword, value: 25 });
        if (serviceType) knight.serviceType = serviceType;
        if (isAvailable) knight.seekingEmployment = true;
        if (!isAvailable) addHouseMember(knight.name, knight.gender, "Sworn Knight", locIndex, knight.id);
        return knight;
    }

    function createVeteranManAtArms(locIndex) {
        const gender = Math.random() > 0.5 ? 'Male' : 'Female';
        const name = getRandomName(gender);
        const vet = addRelationship(name, "Acquaintance", 40, gender, "Commoner", locIndex, false, false, 35 + Math.floor(Math.random() * 20));
        vet.occupation = "Veteran Man-at-Arms";
        vet.rank = "Veteran Man-at-Arms";
        vet.seekingEmployment = true;
        vet.inventory.push({ name: 'Chainmail', rarity: 'Uncommon', desc: 'Worn but serviceable.', value: 40, dr: 3 });
        vet.inventory.push({ ...WEAPON_LIBRARY.longsword, weapon: WEAPON_LIBRARY.longsword, value: 25 });
        return vet;
    }

    function generateHouseKnights(tierKey, houseName, locIndex) {
        let minKnights = 0, maxKnights = 0;
        if (tierKey === 'lesser') { minKnights = 1; maxKnights = 3; }
        else if (tierKey === 'greater') { minKnights = 5; maxKnights = 12; }
        else if (tierKey === 'royal') { minKnights = 8; maxKnights = 15; }
        const count = minKnights + Math.floor(Math.random() * (maxKnights - minKnights + 1));
        for (let i = 0; i < count; i++) {
            const serviceType = (tierKey === 'lesser') ? KNIGHT_SERVICE_TYPES[Math.floor(Math.random() * KNIGHT_SERVICE_TYPES.length)] : null;
            createHouseKnight(houseName, locIndex, serviceType, false);
        }
    }

    function ensureAvailableRetainers(holdingIndex) {
        if (!state.house || state.house.tier !== 'Lesser House') return;
        if (!state.availableRetainers) state.availableRetainers = [];
        const h = state.house.holdings[holdingIndex];
        if (!h) return;
        const atLocation = state.availableRetainers.filter(id => {
            const r = state.relationships.find(x => x.id === id);
            return r && r.locationIndex === h.locationIndex && r.health !== 'Deceased';
        });
        if (atLocation.length >= 1) return;
        if (Math.random() > 0.5) {
            const knight = createHouseKnight(state.house.name, h.locationIndex, KNIGHT_SERVICE_TYPES[Math.floor(Math.random() * KNIGHT_SERVICE_TYPES.length)], true);
            state.availableRetainers.push(knight.id);
        } else {
            const vet = createVeteranManAtArms(h.locationIndex);
            state.availableRetainers.push(vet.id);
        }
    }

    // --- EQUIPMENT LOGIC ---

    function getEquipSlot(name) {
        const n = name.toLowerCase();
        if (n.includes('helm') || n.includes('hat') || n.includes('crown') || n.includes('hood') || n.includes('cap')) return 'head';
        if (n.includes('armor') || n.includes('shirt') || n.includes('robe') || n.includes('vest') || n.includes('mail') || n.includes('tunic') || n.includes('cloak')) return 'armor';
        if (n.includes('sword') || n.includes('dagger') || n.includes('blade') || n.includes('axe') || n.includes('mace') || n.includes('hammer') || n.includes('spear') || n.includes('staff') || n.includes('wand') || n.includes('excalibur')) return 'mainHand';
        if (n.includes('shield') || n.includes('buckler') || n.includes('orb') || n.includes('tome')) return 'offHand';
        if (n.includes('ring') || n.includes('amulet') || n.includes('charm') || n.includes('necklace') || n.includes('trinket')) return 'accessory';
        return null;
    }

    function equipItem(index) {
        if(state.health <= 0) return;
        const item = state.inventory[index];
        const slot = getEquipSlot(item.name);
        
        if (!slot) return; // Should be handled by UI, but safety check

        // If slot is filled, swap
        if (state.equipped[slot]) {
            const temp = state.equipped[slot];
            state.equipped[slot] = item;
            state.inventory[index] = temp; // Direct Swap
            log(`Swapped ${temp.name} for ${item.name}.`);
        } else {
            // Slot empty, just move
            state.equipped[slot] = item;
            state.inventory.splice(index, 1);
            log(`Equipped ${item.name}.`);
        }
        
        AudioEngine.pulse();
        updateUI();
    }

    function unequipItem(slot) {
        if(state.health <= 0) return;
        const item = state.equipped[slot];
        if (!item) return;

        // Cap Check
        const maxSlots = 10 + getModifier(state.stats.str);
        if (state.inventory.length >= maxSlots) {
            showMsg("Inventory Full", "No room to unequip this item.");
            return;
        }

        state.inventory.push(item);
        state.equipped[slot] = null;
        log(`Unequipped ${item.name}.`);
        updateUI();
    }

    // --- NEW: ROMAN NUMERAL HELPER ---
    function romanize(num) {
        if (!num || num <= 1) return "";
        const lookup = {M:1000,CM:900,D:500,CD:400,C:100,XC:90,L:50,XL:40,X:10,IX:9,V:5,IV:4,I:1};
        let roman = '', i;
        for ( i in lookup ) {
            while ( num >= lookup[i] ) {
                roman += i;
                num -= lookup[i];
            }
        }
        return " " + roman;
    }

    function getPlayerAC() {
        const base = 10;
        const dexMod = getModifier(state.stats.dex);
        const armorBonus = getPlayerArmor();
        let natArmor = 0;
        if (state.appearance.mutations) {
            state.appearance.mutations.forEach(m => {
                if (m.stats && m.stats.ac) natArmor += m.stats.ac;
            });
        }
        return base + dexMod + armorBonus + natArmor;
    }

    // --- NEW: COMBAT STATS HELPER ---
    function getPlayerCombatStats() {
        const pStr = getModifier(state.stats.str);
        const pDex = getModifier(state.stats.dex);
        let weapon = WEAPON_LIBRARY.unarmed;
        if (state.equipped.mainHand && state.equipped.mainHand.weapon) {
            weapon = state.equipped.mainHand.weapon;
        }

        let atkMod = pStr;
        if (weapon.type === 'finesse') atkMod = Math.max(pStr, pDex);

        const dmgDie = weapon.dmg || 1;
        const dmgMod = atkMod; // Simplified 5e logic

        return {
            name: weapon.name,
            atk: atkMod >= 0 ? `+${atkMod}` : atkMod,
            dmg: `1d${dmgDie}${dmgMod >= 0 ? '+' + dmgMod : dmgMod}`
        };
    }

    function renderInventory() {
        const list = document.getElementById('inventory-list');
        const maxSlots = 10 + getModifier(state.stats.str);
        
        // 1. Render Equipped Section (Paper Doll)
        const slots = [
            { id: 'head', icon: 'ü™ñ', label: 'Head' },
            { id: 'mainHand', icon: '‚öîÔ∏è', label: 'Main Hand' },
            { id: 'armor', icon: 'üëï', label: 'Body' },
            { id: 'offHand', icon: 'üõ°Ô∏è', label: 'Off Hand' },
            { id: 'accessory', icon: 'üíç', label: 'Accessory' }
        ];

        let equipHtml = `<div class="paper-doll-grid" style="border-bottom:none; margin:0; width:auto;">`;
        equipHtml += slots.map(s => {
            const item = state.equipped[s.id];
            const slotClass = `slot-${s.id}`;
            
            if (item) {
                const drText = item.dr ? `(+${item.dr} AC)` : '';
                const wepText = item.weapon ? `(1d${item.weapon.dmg})` : ''; // Show weapon dmg
                return `
                <div class="equip-slot filled item-rarity-${item.rarity} ${slotClass}" onclick="unequipItem('${s.id}')" title="${item.name}: ${item.desc}">
                    <div class="equip-remove">x</div>
                    <div class="equip-icon">${s.icon}</div>
                    <div class="text-[9px] font-bold truncate w-full text-center mt-1 leading-tight">${item.name}</div>
                    <div class="equip-label">${s.label} ${drText} ${wepText}</div>
                </div>`;
            } else {
                return `
                <div class="equip-slot opacity-50 ${slotClass}">
                    <div class="equip-icon">${s.icon}</div>
                    <div class="equip-label">${s.label}</div>
                </div>`;
            }
        }).join('');
        equipHtml += `</div>`;

        // 2. Render Overview Panel (Stats)
        const currentAC = getPlayerAC();
        const combatStats = getPlayerCombatStats();
        
        const overviewHtml = `
        <div class="mb-4 bg-amber-900/10 rounded-lg p-3 border border-amber-900/20 grid grid-cols-2 gap-4 text-sm">
            <div class="flex flex-col gap-1">
                <div class="flex justify-between border-b border-black/10 pb-1">
                    <span class="font-bold text-amber-900">üí∞ Treasury</span>
                    <span class="font-medieval text-lg">${state.gold} gp</span>
                </div>
                <div class="flex justify-between border-b border-black/10 pb-1">
                    <span class="font-bold text-blue-900">üõ°Ô∏è Armor Class</span>
                    <span class="font-bold text-lg">${currentAC}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-bold text-gray-700">üéí Capacity</span>
                    <span>${state.inventory.length} / ${maxSlots}</span>
                </div>
            </div>
            <div class="flex flex-col gap-1">
                <div class="flex justify-between border-b border-black/10 pb-1">
                    <span class="font-bold text-red-900">‚öîÔ∏è Weapon</span>
                    <span class="text-xs truncate ml-2 text-right">${combatStats.name}</span>
                </div>
                <div class="flex justify-between border-b border-black/10 pb-1">
                    <span class="font-bold text-red-900">üéØ Attack</span>
                    <span class="font-bold">${combatStats.atk}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-bold text-red-900">üí• Damage</span>
                    <span class="font-bold">${combatStats.dmg}</span>
                </div>
            </div>
        </div>`;

        let invHtml = '';
        if (state.inventory.length === 0) { 
            invHtml = `<p class="italic opacity-50 text-center mt-4">Your satchel is empty.</p>`; 
        } else {
            invHtml = `<h4 class="font-bold text-sm mb-2 border-b border-black/10 clear-both">Acquired Items</h4><div class="inventory-grid">` + state.inventory.map((item, idx) => {
                const canUse = item.effect && (item.effect.hp || item.effect.sp || item.effect.trait);
                const equipSlot = getEquipSlot(item.name);
                
                let primaryBtn = '';
                
                if (equipSlot) {
                    primaryBtn = `<button onclick="equipItem(${idx})" class="inv-btn bg-blue-900 text-blue-100 border-blue-950">Equip</button>`;
                } else if (canUse) {
                    primaryBtn = `<button onclick="useItem(${idx})" class="inv-btn btn-use">Use</button>`;
                } else {
                    primaryBtn = `<span class="flex-1"></span>`; 
                }

                const drBadge = item.dr ? `<span class="ml-1 text-[9px] bg-blue-100 text-blue-900 border border-blue-200 px-1 rounded font-bold">üõ°Ô∏è ${item.dr}</span>` : '';
                // NEW: Damage Badge
                const dmgBadge = item.weapon ? `<span class="ml-1 text-[9px] bg-red-100 text-red-900 border border-red-200 px-1 rounded font-bold">‚öîÔ∏è 1d${item.weapon.dmg}</span>` : '';

                return `
                <div class="inventory-card">
                    <div>
                        <div class="inv-rarity-badge item-rarity-${item.rarity}">${item.rarity}</div>
                        <div class="inv-item-header item-rarity-${item.rarity}">${item.name} ${drBadge} ${dmgBadge}</div>
                        <div class="inv-item-desc">${item.desc}</div>
                    </div>
                    <div class="inv-actions">
                        ${primaryBtn}
                        <button onclick="sellItem(${idx})" class="inv-btn btn-sell">Sell (${item.value}g)</button>
                    </div>
                </div>`;
            }).join('') + `</div>`;
        }

        // UPDATED: Float layout for "Flow Around" effect + Scroll Fix
        list.innerHTML = `
        <div class="h-full overflow-y-auto pr-2 scrollbar-thin">
            <!-- Equipped Panel (Floated) -->
            <div class="w-full md:w-auto float-none md:float-left mr-0 md:mr-4 mb-4 bg-black/5 p-4 rounded border border-[#5d4037]/20 flex flex-col items-center">
                <h3 class="font-bold text-center mb-2 text-[#5d4037] uppercase text-xs tracking-widest">Equipped</h3>
                ${equipHtml}
            </div>
            
            <!-- Content wrapping around -->
            ${overviewHtml}
            ${invHtml}
            <div style="clear:both;"></div>
        </div>`;
    }

    function addRelationship(name, relation, friendship, gender, rank, locIndex = null, isBlood = false, isFamily = false, specificAge = null, isKnown = true) {
        const location = locIndex !== null ? locIndex : Math.floor(Math.random() * CITIES.length);
        
        // --- DYNASTIC NAMING SYSTEM ---
        // If this is a family member (Blood/Kin), check for name collisions to assign Regnal Numbers (II, III, etc.)
        if (isBlood || isFamily) {
            // Get base name (strip existing numerals just in case, though usually input is clean)
            const baseName = name.split(' ')[0]; 
            
            // Check Player
            let count = 0;
            if (state.name.split(' ')[0] === baseName) count++;
            
            // Check Relatives (Family/Blood only to avoid counting random merchants)
            state.relationships.forEach(r => {
                if ((r.isBlood || r.isFamily) && r.name.split(' ')[0] === baseName) {
                    count++;
                }
            });

            // If ancestors/relatives exist with this name, append the number
            if (count > 0) {
                name = `${baseName}${romanize(count + 1)}`;
            }
        }

        // DETERMINE AGE FIRST (Moved up for career logic)
        const age = specificAge !== null ? specificAge : (18 + Math.floor(Math.random()*40));

        // NEW: Job Selection Logic based on Rank/Class
        let careerKeys = Object.keys(CAREERS);
        const isNoble = rank.includes("Lord") || rank.includes("Lady") || rank.includes("Ser") || rank.includes("Dame") || rank === "House Member" || rank === "Heir";
        
        if (isNoble) {
            // Nobles get noble jobs
            careerKeys = ['diplomat', 'merchant', 'scholar', 'clergy', 'military', 'alchemist', 'artist'];
        } else {
            // Peasants generally don't get noble exclusive jobs (though Merchant/Military/Clergy overlap)
            careerKeys = careerKeys.filter(k => k !== 'knight' && k !== 'diplomat');
        }

        const rndJobKey = careerKeys[Math.floor(Math.random() * careerKeys.length)];
        
        // UPDATED: Pick rank based on Age
        const careerData = CAREERS[rndJobKey];
        const maxRank = careerData.ranks.length - 1;
        let rankIdx = 0;
        let rndJob = "Child";

        // Only assign job if old enough (Randomized start age 10-14)
        if (age >= 10 + Math.floor(Math.random() * 5)) {
            if (age < 20) {
                rankIdx = 0; // Apprentice/Entry
            } else if (age < 30) {
                // Mostly mid, occasional entry
                rankIdx = Math.random() > 0.7 ? Math.min(1, maxRank) : 0;
            } else if (age < 50) {
                // Mid to High
                rankIdx = Math.min(Math.floor(Math.random() * (maxRank + 1)), maxRank);
                if(rankIdx === 0 && Math.random() > 0.2) rankIdx = 1; // Reduce chance of old apprentices
            } else {
                // Elder - Mostly Masters
                rankIdx = Math.random() > 0.3 ? maxRank : Math.min(1, maxRank);
            }
            rndJob = careerData.ranks[rankIdx].title;
        }

        const rndRank = careerData.ranks[rankIdx];
        
        const rndStats = { 
            str: 8 + Math.floor(Math.random()*8),
            dex: 8 + Math.floor(Math.random()*8),
            con: 8 + Math.floor(Math.random()*8),
            int: 8 + Math.floor(Math.random()*8),
            wis: 8 + Math.floor(Math.random()*8),
            cha: 8 + Math.floor(Math.random()*8)
        };

        // NEW: Retroactive Health Calculation based on Age
        const npcConMod = Math.floor((rndStats.con - 10) / 2);
        let hpVal = 10 + npcConMod;
        
        // Apply growth for every 5 years lived, up to age 30
        const growthSteps = Math.floor(Math.min(age, 30) / 5);
        for (let i = 0; i < growthSteps; i++) {
            hpVal += Math.max(1, Math.floor(Math.random() * 4) + 1 + npcConMod);
        }

        // NEW: Generate Standard Appearance
        const appearance = GeneticEngine.generate();

        // NEW: Generate Gold & Inventory
        let npcGold = 0;
        const isNobleRank = rank.includes('Lord') || rank.includes('Lady') || rank.includes('Ser') || rank.includes('Dame') || rank.includes('King') || rank.includes('Queen') || rank.includes('Duke') || rank === 'House Member' || rank.includes('Heir');
        
        if (isNobleRank) npcGold = 100 + Math.floor(Math.random() * 400);
        else if (rndJob.includes('Merchant') || rndJob.includes('Magnate')) npcGold = 50 + Math.floor(Math.random() * 150);
        else if (rndJob.includes('Master') || rndJob.includes('Captain')) npcGold = 30 + Math.floor(Math.random() * 50);
        else if (rndJob === 'Child') npcGold = Math.floor(Math.random() * 2);
        else npcGold = Math.floor(Math.random() * 20) + 1;

        const npcInv = generateNPCInventory(rndJob, rank);

        const person = {
            id: Math.random().toString(36).substr(2, 9),
            name, relation, 
            friendship: friendship || 0, 
            romance: 0, 
            gender, rank, locationIndex: location,
            age: age, // Use pre-calculated age
            health: "Healthy",
            hp: hpVal,
            maxHp: hpVal,
            occupation: rndJob,
            isBlood: isBlood,
            isFamily: isFamily,
            isKnown: isKnown, // NEW FLAG
            alignment: ALIGNMENTS[Math.floor(Math.random() * ALIGNMENTS.length)],
            stats: rndStats,
            appearance: appearance, // Store appearance
            genes: [], // Legacy
            traits: [], // Existing acquired traits
            gold: npcGold, // NEW
            inventory: npcInv // NEW
        };
        state.relationships.push(person);
        return person;
    }

    function createRandomRel(friendship) {
        const gender = Math.random() > 0.5 ? 'Male' : 'Female';
        const name = getRandomName(gender);
        addRelationship(name, "Acquaintance", friendship, gender, "Commoner", state.location);
        log(`You met ${name}.`);
    }

    function getParent(type) {
        if (!type) return state.relationships.find(r => r.relation === 'Father' || r.relation === 'Mother');
        return state.relationships.find(r => r.relation === type);
    }
    
    function hasParent(type) {
        return !!state.relationships.find(r => r.relation === type);
    }

    function startGame() {
        state.name = document.getElementById('char-name').value;
        state.location = Math.floor(Math.random() * CITIES.length);
        
        generateHouse(); 

        // --- NEW: GENETIC INHERITANCE FOR PLAYER ---
        const father = getParent('Father');
        const mother = getParent('Mother');
        
        // Apply genes
        state.appearance = GeneticEngine.mix(father, mother);

        // Apply Mutation Stats (Beneficial)
        if (state.appearance.mutations) {
            state.appearance.mutations.forEach(m => {
                if (m.stats) {
                    for (let s in m.stats) {
                        if (s !== 'ac') { // Skip AC, handled in combat
                            state.stats[s] += m.stats[s];
                        }
                    }
                }
            });
        }

        // --- NEW: DEFECT APPLICATION ---
        // If both parents are blood (triggered by the 5% spawn chance), Force a Defect
        if (father && mother && father.isBlood && mother.isBlood) {
            const defects = MUTATION_POOL.filter(m => m.rarity === 'Defect');
            const defect = defects[Math.floor(Math.random() * defects.length)];
            
            // Set in distinct slot
            state.appearance.defect = defect;
            
            // Apply Penalty
            if (defect.stats) {
                for (let stat in defect.stats) {
                    state.stats[stat] = Math.max(3, state.stats[stat] + defect.stats[stat]);
                }
            }
            // Flavor update to parents
            // Note: renderNode uses isBlood flag for badges, so visually they are already marked
        }
        
        // STATS NO LONGER MODIFIED BY GENES (Except Defects now)
        // Base stats are purely from the random roll/standard array
        
        const conMod = getModifier(state.stats.con);
        const wisMod = getModifier(state.stats.wis);
        const chaMod = getModifier(state.stats.cha);
        
        state.maxHealth = 10 + conMod;
        state.health = state.maxHealth;
        
        state.maxSanity = Math.max(1, 8 + wisMod + chaMod);
        state.sanity = state.maxSanity;

        document.getElementById('creation-screen').style.display = 'none';
        document.getElementById('lore-modal').classList.remove('hidden');
    }

    function enterWorld() {
        document.getElementById('lore-modal').classList.add('hidden');
        document.querySelector('.header').style.opacity = 1;
        document.querySelector('.main-layout').style.opacity = 1;
        document.getElementById('display-name').innerText = state.name;
        
        // Format appearance string
        const app = state.appearance;
        const mutsReadable = app.mutations.length > 0 ? ` You were born with a mutation(s): ${app.mutations.map(m => m.name).join(', ')}.` : '';

        log(`<strong>Year ${state.year}:</strong> You are born in <strong>${CITIES[state.location].name}</strong>. You are of ${app.height} height, with ${app.hair} hair, ${app.eyes} eyes, and ${app.skin} skin.${mutsReadable}`);
        
        if (state.socialClass === 'House') {
            log(`You are born a ${state.class}. Your House's Bloodline Trait is <strong style="color:var(--royal)">${state.house.trait}</strong>.`);
        } else {
            log(`You are born a free commoner.`);
        }

        // --- INCEST REVEAL ---
        if (state.appearance.defect) {
             const father = getParent('Father');
             const mother = getParent('Mother');
             // Check if born of incest
             if (father && mother && father.isBlood && mother.isBlood) {
                 log(`<strong style="color:var(--stress)">DARK SECRET:</strong> You were born of a union between kin (${father.name} and ${mother.name}). This impurity of blood has marked you with: <strong style="color:var(--failure)">${state.appearance.defect.name}</strong>.`);
             }
        }
        
        generateMarket(state.location); // Initial Market Gen
        updateUI();
        processYear();
    }

    // --- NEW EVENT GENERATION SYSTEM ---
    function generateSocialEvent() {
        // UPDATED: Filter now requires 'isKnown' to be true to prevent random merchants/strangers
        const livingKnown = state.relationships.filter(r => r.health !== 'Deceased' && r.isKnown);
        if (livingKnown.length === 0) return null;

        const person = livingKnown[Math.floor(Math.random() * livingKnown.length)];
        const isFriend = person.friendship > 20;
        const isEnemy = person.friendship < -20;
        const isLover = person.romance > 30;

        // 10% Chance for Financial Request if Friend/Family
        // UPDATED: Age check added (Player 12+, NPC 12+)
        if (state.age >= 12 && (isFriend || person.isFamily) && person.age >= 12 && Math.random() < 0.10) {
            return POOLS.Financial[0](person);
        }

        let type = 'neutral';
        if (isLover) type = 'lover';
        else if (isEnemy) type = 'enemy';
        else if (isFriend) type = 'friend';

        const pool = getSocialPool(person, type);
        return pool[Math.floor(Math.random() * pool.length)];
    }

    function getSocialPool(person, type) {
        // --- THE AGE OF INNOCENCE ---
        if (state.age < 13) {
            const childPools = {
                friend: [
                    createEvent(`kid_play_${person.id}`, `Playtime`, `Your ${person.relation} ${person.name} brings a wooden sword to play.`, [
                         { text: 'Duel!', type: 'check', stat: 'dex', dc: 8, success: 'You disarm them! (+Rel)', fail: 'They bonk you on the head.', onSuccess: () => { modRel(person.id, 15); }, onFail: () => takeDamage(1) },
                         { text: 'Share Toy', type: 'flavor', effect: () => { modRel(person.id, 20); log("Sharing is caring. (+Rel)"); } },
                         { text: 'Refuse', type: 'flavor', effect: () => { modRel(person.id, -2); log("You play alone."); } }
                    ]),
                    createEvent(`kid_secret_${person.id}`, `Secret Base`, `Your ${person.relation} ${person.name} shows you their hideout in the woods.`, [
                         { text: 'Keep Secret', type: 'check', stat: 'cha', dc: 8, success: 'Best friends forever. (+Rel)', fail: 'You blabbed to the adults. (-Rel)', onSuccess: () => modRel(person.id, 25), onFail: () => modRel(person.id, -5) },
                         { text: 'Explore', type: 'check', stat: 'wis', dc: 8, success: 'You find cool rocks! (+Rel)', fail: 'You get muddy.', onSuccess: () => modRel(person.id, 15), onFail: () => {} },
                         { text: 'Leave', type: 'flavor', effect: () => log("Too scary.") }
                    ]),
                    createEvent(`kid_tag_${person.id}`, `Game of Tag`, `Your ${person.relation} ${person.name} yells "You're it!"`, [
                         { text: 'Chase', type: 'check', stat: 'dex', dc: 10, success: 'Caught them! (+Rel)', fail: 'They are too fast.', onSuccess: () => { modRel(person.id, 15); }, onFail: () => {} },
                         { text: 'Hide', type: 'check', stat: 'int', dc: 8, success: 'They run past you. (+Rel)', fail: 'Found you!', onSuccess: () => modRel(person.id, 15), onFail: () => {} },
                         { text: 'Quit', type: 'flavor', effect: () => log("You are tired.") }
                    ]),
                                        createEvent(`kid_race_${person.id}`, `Footrace`, `Your ${person.relation} ${person.name} challenges you to a sprint.`, [
                         { text: 'Sprint', type: 'check', stat: 'dex', dc: 10, success: 'You win the race! (+Rel)', fail: 'Tripped! (-Rel)', onSuccess: () => { modRel(person.id, 15); }, onFail: () => modRel(person.id, -2) },
                         { text: 'Let Them Win', type: 'flavor', effect: () => { modRel(person.id, 15); log("They cheer for you. (+Rel)"); } },
                         { text: 'Refuse', type: 'flavor', effect: () => { modRel(person.id, -1); log("You skip the race."); } }
                    ]),

                    createEvent(`kid_hide_${person.id}`, `Hide and Seek`, `Your ${person.relation} ${person.name} counts while you hide.`, [
                         { text: 'Hide Well', type: 'check', stat: 'dex', dc: 10, success: 'They cannot find you! (+Rel)', fail: 'They spot you quickly. (-Rel)', onSuccess: () => modRel(person.id, 20), onFail: () => modRel(person.id, -5) },
                         { text: 'Peek', type: 'check', stat: 'int', dc: 8, success: 'You spot them first! (+Rel)', fail: 'They catch you. (-Rel)', onSuccess: () => modRel(person.id, 15), onFail: () => modRel(person.id, -5) },
                         { text: 'Quit', type: 'flavor', effect: () => log("Hiding is too tiring.") }
                    ]),

                    createEvent(`kid_story_${person.id}`, `Storytime`, `Your ${person.relation} ${person.name} asks you to tell a story.`, [
                         { text: 'Make One Up', type: 'check', stat: 'cha', dc: 8, success: 'They are captivated! (+Rel)', fail: 'They get bored. (-Rel)', onSuccess: () => modRel(person.id, 20), onFail: () => modRel(person.id, -5) },
                         { text: 'Tell a Real Tale', type: 'check', stat: 'wis', dc: 8, success: 'They listen intently. (+Rel)', fail: 'You forget the details.', onSuccess: () => modRel(person.id, 15), onFail: () => {} },
                         { text: 'Refuse', type: 'flavor', effect: () => log("No stories today.") }
                    ]),

                    createEvent(`kid_snack_${person.id}`, `Snack Time`, `Your ${person.relation} ${person.name} offers you a treat.`, [
                         { text: 'Accept', type: 'flavor', effect: () => { modRel(person.id, 15); log("Yum! Friendship grows. (+Rel)"); } },
                         { text: 'Share Yours', type: 'flavor', effect: () => { modRel(person.id, 25); log("Sharing makes you friends. (+Rel)"); } },
                         { text: 'Decline', type: 'flavor', effect: () => { modRel(person.id, -1); log("You politely refuse."); } }
                    ]),

                    createEvent(`kid_hideout_${person.id}`, `Secret Hideout`, `Your ${person.relation} ${person.name} invites you to a treehouse.`, [
                         { text: 'Climb Up', type: 'check', stat: 'dex', dc: 10, success: 'You reach it safely! (+Rel)', fail: 'Slip and scrape knee.', onSuccess: () => modRel(person.id, 20), onFail: () => takeDamage(1) },
                         { text: 'Explore Inside', type: 'check', stat: 'int', dc: 8, success: 'You discover hidden treasures! (+Rel)', fail: 'Nothing interesting.', onSuccess: () => modRel(person.id, 15), onFail: () => {} },
                         { text: 'Stay Below', type: 'flavor', effect: () => log("You prefer to stay grounded.") }
                    ]),

                    createEvent(`kid_art_${person.id}`, `Drawing Together`, `Your ${person.relation} ${person.name} wants to color a picture with you.`, [
                         { text: 'Draw Boldly', type: 'check', stat: 'cha', dc: 8, success: 'Your masterpiece impresses! (+Rel)', fail: 'Colors smudge.', onSuccess: () => modRel(person.id, 20), onFail: () => modRel(person.id, -2) },
                         { text: 'Follow Along', type: 'check', stat: 'int', dc: 8, success: 'You learn new techniques. (+Rel)', fail: 'It‚Äôs messy.', onSuccess: () => modRel(person.id, 15), onFail: () => {} },
                         { text: 'Refuse', type: 'flavor', effect: () => log("Art is not your thing.") }
                    ]),

                    createEvent(`kid_song_${person.id}`, `Singing Game`, `Your ${person.relation} ${person.name} starts a silly song.`, [
                         { text: 'Join In', type: 'check', stat: 'cha', dc: 8, success: 'You harmonize perfectly! (+Rel)', fail: 'You sing off-key. (-Rel)', onSuccess: () => modRel(person.id, 20), onFail: () => modRel(person.id, -2) },
                         { text: 'Make Up Words', type: 'check', stat: 'int', dc: 8, success: 'They love your creativity! (+Rel)', fail: 'It confuses them.', onSuccess: () => modRel(person.id, 15), onFail: () => modRel(person.id, -2) },
                         { text: 'Stay Silent', type: 'flavor', effect: () => log("You prefer to listen.") }
                    ])
                ],
                enemy: [
                    createEvent(`kid_bully_${person.id}`, `Bully`, `Your ${person.relation} ${person.name} steals your lunch.`, [
                         { text: 'Tell Adult', type: 'check', stat: 'cha', dc: 10, success: 'They get in trouble.', fail: 'Tattletale!', onSuccess: () => modRel(person.id, -20), onFail: () => modRep('renown', -2) },
                         { text: 'Fight', type: 'check', stat: 'str', dc: 8, success: 'Pow! Right in the nose. (-Rel)', fail: 'Ouch. They hit back.', onSuccess: () => { modRel(person.id, -20); modRep('renown', 2); }, onFail: () => takeDamage(1) },
                         { text: 'Give Up', type: 'flavor', effect: () => { modRel(person.id, 5); log("You go hungry today."); } }
                    ]),
                    createEvent(`kid_mock_${person.id}`, `Name Calling`, `Your ${person.relation} ${person.name} calls you a "mud-eater".`, [
                         { text: 'Cry', type: 'flavor', effect: () => { log("Tears fall."); modSanity(-1); } },
                         { text: 'Throw Mud', type: 'check', stat: 'dex', dc: 8, success: 'Direct hit! (-Rel)', fail: 'You miss.', onSuccess: () => modRel(person.id, -10), onFail: () => {} },
                         { text: 'Ignore', type: 'check', stat: 'wis', dc: 10, success: 'Sticks and stones... (+1 SP)', fail: 'It hurts your feelings. (-1 SP)', onSuccess: () => modSanity(1), onFail: () => modSanity(-1) }
                    ]),
                                        createEvent(`kid_push_${person.id}`, `Pushed Around`, `Your ${person.relation} ${person.name} shoves you in the dirt.`, [
                         { text: 'Push Back', type: 'check', stat: 'str', dc: 10, success: 'You stand your ground. (-Rel)', fail: 'They push harder.', onSuccess: () => modRel(person.id, -15), onFail: () => takeDamage(1) },
                         { text: 'Run Away', type: 'check', stat: 'dex', dc: 10, success: 'Escape unscathed.', fail: 'They grab you.', onSuccess: () => {}, onFail: () => takeDamage(1) },
                         { text: 'Cry Out', type: 'flavor', effect: () => { log("You call for help."); modSanity(-1); } }
                    ]),

                    createEvent(`kid_tease_${person.id}`, `Teasing`, `Your ${person.relation} ${person.name} keeps mimicking you.`, [
                         { text: 'Retaliate', type: 'check', stat: 'cha', dc: 8, success: 'They are embarrassed. (-Rel)', fail: 'They laugh harder.', onSuccess: () => modRel(person.id, -15), onFail: () => modSanity(-1) },
                         { text: 'Ignore', type: 'check', stat: 'wis', dc: 10, success: 'They lose interest.', fail: 'They persist.', onSuccess: () => {}, onFail: () => modSanity(-1) },
                         { text: 'Mimic Back', type: 'check', stat: 'dex', dc: 8, success: 'They are caught off guard.', fail: 'You trip yourself.', onSuccess: () => modRel(person.id, -10), onFail: () => takeDamage(1) }
                    ]),

                    createEvent(`kid_hide_${person.id}`, `Hide Your Belongings`, `Your ${person.relation} ${person.name} hides your favorite toy.`, [
                         { text: 'Search', type: 'check', stat: 'wis', dc: 10, success: 'Found it! (-Rel)', fail: 'It remains hidden.', onSuccess: () => modRel(person.id, -10), onFail: () => {} },
                         { text: 'Accuse', type: 'check', stat: 'cha', dc: 8, success: 'They return it. (-Rel)', fail: 'They deny everything.', onSuccess: () => modRel(person.id, -10), onFail: () => modSanity(-1) },
                         { text: 'Let Go', type: 'flavor', effect: () => log("You decide not to worry about it.") }
                    ]),

                    createEvent(`kid_prank_${person.id}`, `Prank`, `Your ${person.relation} ${person.name} ties your shoes together.`, [
                         { text: 'Untie Quickly', type: 'check', stat: 'dex', dc: 10, success: 'No one notices. (-Rel)', fail: 'Trip and fall.', onSuccess: () => modRel(person.id, -5), onFail: () => takeDamage(1) },
                         { text: 'Play Along', type: 'check', stat: 'cha', dc: 8, success: 'They laugh together. (-Rel)', fail: 'They laugh at you.', onSuccess: () => modRel(person.id, -5), onFail: () => modSanity(-1) },
                         { text: 'Ignore', type: 'flavor', effect: () => log("You just walk on.") }
                    ]),

                    createEvent(`kid_namecall_${person.id}`, `Mockery`, `Your ${person.relation} ${person.name} calls you a silly name loudly.`, [
                         { text: 'Shout Back', type: 'check', stat: 'cha', dc: 10, success: 'They quiet down. (-Rel)', fail: 'They tease harder.', onSuccess: () => modRel(person.id, -15), onFail: () => modSanity(-1) },
                         { text: 'Laugh It Off', type: 'check', stat: 'wis', dc: 8, success: 'They are confused. (-Rel)', fail: 'They persist.', onSuccess: () => modRel(person.id, -5), onFail: () => modSanity(-1) },
                         { text: 'Walk Away', type: 'flavor', effect: () => log("You refuse to engage.") }
                    ]),

                    createEvent(`kid_sabotage_${person.id}`, `Sabotage`, `Your ${person.relation} ${person.name} ruins your drawing.`, [
                         { text: 'Confront', type: 'check', stat: 'cha', dc: 10, success: 'They apologize. (-Rel)', fail: 'They deny it.', onSuccess: () => modRel(person.id, -15), onFail: () => modSanity(-1) },
                         { text: 'Fix It', type: 'check', stat: 'int', dc: 8, success: 'You salvage it. (-Rel)', fail: 'It remains ruined.', onSuccess: () => modRel(person.id, -5), onFail: () => modSanity(-1) },
                         { text: 'Ignore', type: 'flavor', effect: () => log("You move on from the incident.") }
                    ]),

                    createEvent(`kid_challenge_${person.id}`, `Challenge`, `Your ${person.relation} ${person.name} dares you to climb the tree.`, [
                         { text: 'Climb', type: 'check', stat: 'dex', dc: 10, success: 'You reach the top! (-Rel)', fail: 'You fall slightly. (-Rel)', onSuccess: () => modRel(person.id, -5), onFail: () => takeDamage(1) },
                         { text: 'Decline', type: 'flavor', effect: () => log("You play it safe.") },
                         { text: 'Mock Them', type: 'check', stat: 'cha', dc: 8, success: 'They get embarrassed. (-Rel)', fail: 'They laugh at you.', onSuccess: () => modRel(person.id, -5), onFail: () => modSanity(-1) }
                    ])
                ],
                neutral: [
                     createEvent(`kid_neutral_${person.id}`, `Lesson Time`, `You sit next to your ${person.relation} ${person.name} during lessons.`, [
                         { text: 'Copy Work', type: 'check', stat: 'int', dc: 8, success: 'Thanks! (+Rel)', fail: 'Caught!', onSuccess: () => { modRel(person.id, 15); }, onFail: () => { modRel(person.id, -10); } },
                         { text: 'Ignore', type: 'flavor', effect: () => log("You focus on your slate.") },
                         { text: 'Pass Note', type: 'check', stat: 'dex', dc: 8, success: 'You giggle together. (+Rel)', fail: 'Teacher sees.', onSuccess: () => modRel(person.id, 15), onFail: () => {} }
                     ]),
                     createEvent(`kid_bug_${person.id}`, `Cool Bug`, `Your ${person.relation} ${person.name} found a beetle.`, [
                         { text: 'Look', type: 'flavor', effect: () => { log("It is shiny. (+Rel)"); modRel(person.id, 15); } },
                         { text: 'Squish', type: 'check', stat: 'dex', dc: 8, success: 'Gross! (-Rel)', fail: 'Missed.', onSuccess: () => modRel(person.id, -15), onFail: () => {} },
                         { text: 'Eat it', type: 'flavor', effect: () => { log("Crunchy. (+1 HP, -Rel)"); state.health++; modRel(person.id, -5); } }
                     ]),
                                         createEvent(`kid_snack_${person.id}`, `Sharing Snacks`, `Your ${person.relation} ${person.name} offers you a treat.`, [
                         { text: 'Accept', type: 'flavor', effect: () => { log("Yum! (+Rel)"); modRel(person.id, 15); } },
                         { text: 'Decline', type: 'flavor', effect: () => { log("You politely refuse."); } },
                         { text: 'Trade', type: 'check', stat: 'cha', dc: 8, success: 'You get a better snack! (+Rel, +3 SP)', fail: 'They refuse.', onSuccess: () => { modRel(person.id, 15); modSanity(3); }, onFail: () => {} }
                    ]),

                    createEvent(`kid_draw_${person.id}`, `Drawing Together`, `Your ${person.relation} ${person.name} invites you to draw.`, [
                         { text: 'Draw', type: 'check', stat: 'int', dc: 8, success: 'A masterpiece! (+Rel)', fail: 'Smudged paper.', onSuccess: () => modRel(person.id, 15), onFail: () => {} },
                         { text: 'Copy', type: 'check', stat: 'int', dc: 10, success: 'Looks great! (+Rel)', fail: 'Caught copying!', onSuccess: () => modRel(person.id, 15), onFail: () => modRel(person.id, -5) },
                         { text: 'Watch', type: 'flavor', effect: () => log("You admire their art.") }
                    ]),

                    createEvent(`kid_hideandseek_${person.id}`, `Hide and Seek`, `Your ${person.relation} ${person.name} wants to play hide and seek.`, [
                         { text: 'Hide', type: 'check', stat: 'dex', dc: 8, success: 'No one finds you! (+Rel)', fail: 'They spot you.', onSuccess: () => modRel(person.id, 15), onFail: () => {} },
                         { text: 'Seek', type: 'check', stat: 'wis', dc: 8, success: 'Found them! (+Rel)', fail: 'They escape.', onSuccess: () => modRel(person.id, 15), onFail: () => {} },
                         { text: 'Refuse', type: 'flavor', effect: () => log("Not today.") }
                    ]),

                    createEvent(`kid_fightplay_${person.id}`, `Mock Fight`, `Your ${person.relation} ${person.name} challenges you to a pretend duel.`, [
                         { text: 'Engage', type: 'check', stat: 'dex', dc: 10, success: 'Great parry! (+Rel)', fail: 'You stumble.', onSuccess: () => modRel(person.id, 15), onFail: () => {} },
                         { text: 'Refuse', type: 'flavor', effect: () => log("You step back.") },
                         { text: 'Cheer Them On', type: 'flavor', effect: () => { log("They grin. (+Rel)"); modRel(person.id, 10); } }
                    ]),

                    createEvent(`kid_hideobject_${person.id}`, `Hide and Find`, `Your ${person.relation} ${person.name} hides an object for you to find.`, [
                         { text: 'Search', type: 'check', stat: 'wis', dc: 10, success: 'Found it! (+Rel)', fail: 'No luck.', onSuccess: () => modRel(person.id, 15), onFail: () => {} },
                         { text: 'Guess', type: 'check', stat: 'int', dc: 8, success: 'You guess right! (+Rel)', fail: 'Wrong guess.', onSuccess: () => modRel(person.id, 15), onFail: () => {} },
                         { text: 'Give Up', type: 'flavor', effect: () => log("You let them keep it hidden.") }
                    ]),

                    createEvent(`kid_story_${person.id}`, `Storytelling`, `Your ${person.relation} ${person.name} tells you a story during recess.`, [
                         { text: 'Listen', type: 'flavor', effect: () => { log("You enjoy the story. (+Rel)"); modRel(person.id, 15); } },
                         { text: 'Add Your Part', type: 'check', stat: 'cha', dc: 8, success: 'They love it! (+Rel)', fail: 'They ignore you.', onSuccess: () => modRel(person.id, 15), onFail: () => {} },
                         { text: 'Leave', type: 'flavor', effect: () => log("You wander off quietly.") }
                    ]),

                    createEvent(`kid_puzzle_${person.id}`, `Puzzle Time`, `Your ${person.relation} ${person.name} brings a puzzle to solve together.`, [
                         { text: 'Solve Together', type: 'check', stat: 'int', dc: 10, success: 'Perfect teamwork! (+Rel)', fail: 'Pieces don‚Äôt fit.', onSuccess: () => modRel(person.id, 15), onFail: () => {} },
                         { text: 'Take Lead', type: 'check', stat: 'cha', dc: 8, success: 'They follow your lead. (+Rel)', fail: 'They ignore your ideas.', onSuccess: () => modRel(person.id, 15), onFail: () => {} },
                         { text: 'Watch', type: 'flavor', effect: () => log("You quietly observe.") }
                    ]),

                    createEvent(`kid_treasure_${person.id}`, `Treasure Hunt`, `Your ${person.relation} ${person.name} digs up a shiny rock and shows you.`, [
                         { text: 'Excited', type: 'flavor', effect: () => { log("You admire the find. (+Rel)"); modRel(person.id, 15); } },
                         { text: 'Trade', type: 'check', stat: 'cha', dc: 10, success: 'They accept! (+Rel)', fail: 'They refuse.', onSuccess: () => modRel(person.id, 15), onFail: () => {} },
                         { text: 'Ignore', type: 'flavor', effect: () => log("You move on.") }
                    ])
                ],
                lover: [] // Children map lovers to friends
            };
            // Fallback for kids
            if (type === 'lover') return childPools.friend;
            return childPools[type] || childPools.neutral;
        }

        // 10 Unique Events per archetype
        const pools = {
            lover: [
                createEvent(`lov_1_${person.id}`, `A Quiet Stroll`, `Your ${person.relation} ${person.name} asks to walk beneath the starlight.`, [
                    { text: 'Hold Hands', type: 'check', stat: 'cha', dc: 8, success: 'A tender moment. (+Romance, +2 SP)', fail: 'Your palms are sweaty.', onSuccess: () => { modRel(person.id, 10, 10); modSanity(2); }, onFail: () => modRel(person.id, 0, -1) },
                    { text: 'Recite Poetry', type: 'check', stat: 'int', dc: 10, success: 'They swoon at your words. (+Romance)', fail: 'You rhyme "love" with "turnip".', onSuccess: () => modRel(person.id, 10, 20), onFail: () => modRel(person.id, -2, -2) },
                    { text: 'Silence', type: 'check', stat: 'wis', dc: 8, success: 'Comfortable silence. (+Rel)', fail: 'Awkward silence.', onSuccess: () => modRel(person.id, 15), onFail: () => modRel(person.id, -2) }
                ]),
                createEvent(`lov_2_${person.id}`, `The Gift`, `Your ${person.relation} ${person.name} eyes a merchant's necklace longing.`, [
                    { text: 'Buy it (20g)', type: 'flavor', req: s => s.gold >= 20, effect: () => { state.gold -= 20; modRel(person.id, 20, 30); log("Their eyes sparkle brighter than the gem."); } },
                    { text: 'Craft One', type: 'check', stat: 'dex', dc: 12, success: 'You make a beautiful charm from wood. (+Romance)', fail: 'It breaks immediately.', onSuccess: () => modRel(person.id, 10, 25), onFail: () => modRel(person.id, -2, -2) },
                    { text: 'Ignore', type: 'flavor', effect: () => { modRel(person.id, 0, -10); log("They look disappointed."); } }
                ]),
                createEvent(`lov_3_${person.id}`, `Midnight Quarrel`, `A misunderstanding with your ${person.relation} ${person.name} turns heated.`, [
                    { text: 'Apologize', type: 'check', stat: 'cha', dc: 8, success: 'Forgiveness is sweet. (+3 SP)', fail: 'They are still angry.', onSuccess: () => { modSanity(3); modRel(person.id, 10, 10); }, onFail: () => modRel(person.id, -10, -10) },
                    { text: 'Stand Ground', type: 'check', stat: 'wis', dc: 12, success: 'Logic prevails. They respect you.', fail: 'You sleep on the floor.', onSuccess: () => modRel(person.id, 15, 0), onFail: () => { modRel(person.id, -15, -15); modSanity(-1); } },
                    { text: 'Distract', type: 'check', stat: 'cha', dc: 10, success: 'You kiss them mid-sentence. (+Romance)', fail: 'They push you away.', onSuccess: () => modRel(person.id, 10, 15), onFail: () => modRel(person.id, -10, -10) }
                ]),
                createEvent(`lov_4_${person.id}`, `Illness`, `Your ${person.relation} ${person.name} is bedridden with a fever.`, [
                    { text: 'Nurse them', type: 'check', stat: 'wis', dc: 10, success: 'Your care heals them. (+Deep Bond)', fail: 'You make the soup too salty.', onSuccess: () => modRel(person.id, 25, 20), onFail: () => modRel(person.id, 5, 0) },
                    { text: 'Hire Healer (15g)', type: 'flavor', req: s => s.gold >= 15, effect: () => { state.gold -= 15; modRel(person.id, 20, 10); log("They recover swiftly thanks to your coin."); } },
                    { text: 'Pray', type: 'check', stat: 'wis', dc: 8, success: 'They recover slowly.', fail: 'No change.', onSuccess: () => modRel(person.id, 5), onFail: () => {} }
                ]),
                createEvent(`lov_5_${person.id}`, `Jealousy`, `Someone else was seen flirting with your ${person.relation} ${person.name}.`, [
                    { text: 'Trust them', type: 'check', stat: 'wis', dc: 8, success: 'Your confidence strengthens the bond. (+2 SP)', fail: 'Doubts linger. (-1 SP)', onSuccess: () => { modRel(person.id, 15, 10); modSanity(1); }, onFail: () => modSanity(-1) },
                    { text: 'Confront Rival', type: 'check', stat: 'str', dc: 10, success: 'You scare the rival away. (+Renown)', fail: 'You make a scene.', onSuccess: () => modRep('renown', 5), onFail: () => { modRep('infamy', 2); modRel(person.id, -10, -10); } },
                    { text: 'Spy', type: 'check', stat: 'dex', dc: 10, success: 'It was innocent. Phew. (+1 SP)', fail: 'Caught spying!', onSuccess: () => modSanity(1), onFail: () => modRel(person.id, -20, -20) }
                ]),
                createEvent(`lov_6_${person.id}`, `Cooking Together`, `A chance to make a meal with your ${person.relation} ${person.name}.`, [
                    { text: 'Cook', type: 'check', stat: 'dex', dc: 10, success: 'A delicious feast! (+HP, +Rel)', fail: 'You burn the roast.', onSuccess: () => { state.health = Math.min(state.maxHealth, state.health + 2); modRel(person.id, 15, 10); }, onFail: () => modRel(person.id, 0, -2) },
                    { text: 'Clean Up', type: 'check', stat: 'con', dc: 8, success: 'They appreciate the help.', fail: 'You break a plate.', onSuccess: () => modRel(person.id, 10), onFail: () => {} },
                    { text: 'Order Food (5g)', type: 'flavor', req: s => s.gold >= 5, effect: () => { state.gold -= 5; modRel(person.id, 5); log("Tasty takeout."); } }
                ]),
                createEvent(`lov_7_${person.id}`, `The Future`, `Your ${person.relation} ${person.name} asks: "Where do you see us in ten years?"`, [
                    { text: 'Speak from Heart', type: 'check', stat: 'cha', dc: 10, success: 'They tear up with joy.', fail: 'You stutter awkwardly.', onSuccess: () => modRel(person.id, 20, 20), onFail: () => modRel(person.id, -5, -5) },
                    { text: 'Joke', type: 'flavor', effect: () => { modRel(person.id, 5, -10); log("They laugh, but eyes remain sad."); } },
                    { text: 'Change Subject', type: 'check', stat: 'cha', dc: 8, success: 'Dodged.', fail: 'They notice.', onSuccess: () => {}, onFail: () => modRel(person.id, -5) }
                ]),
                createEvent(`lov_8_${person.id}`, `Romantic Surprise`, `You find a rare flower perfect for your ${person.relation} ${person.name}.`, [
                    { text: 'Give it', type: 'flavor', effect: () => { modRel(person.id, 15, 10); log("A simple gesture means the most."); } },
                    { text: 'Press it', type: 'check', stat: 'dex', dc: 10, success: 'A keepsake forever.', fail: 'Crumbled.', onSuccess: () => modRel(person.id, 20, 15), onFail: () => {} },
                    { text: 'Sell it', type: 'flavor', effect: () => { state.gold += 5; log("Money over love."); } }
                ]),
                createEvent(`lov_9_${person.id}`, `Stargazing`, `The night sky is clear.`, [
                    { text: 'Identify Constellations', type: 'check', stat: 'int', dc: 12, success: 'You impress them with lore. (+Rel)', fail: 'You make stuff up.', onSuccess: () => { modRel(person.id, 15, 10); }, onFail: () => {} },
                    { text: 'Cuddle', type: 'flavor', effect: () => { modRel(person.id, 15, 10); log("Warm and cozy."); } },
                    { text: 'Philosrophize', type: 'check', stat: 'wis', dc: 10, success: 'Deep thoughts. (+ 1 SP)', fail: 'Boring.', onSuccess: () => modSanity(1), onFail: () => {} }
                ]),
                createEvent(`lov_10_${person.id}`, `Public Affection`, `Your ${person.relation} ${person.name} kisses you in the busy market.`, [
                    { text: 'Kiss Back', type: 'check', stat: 'cha', dc: 8, success: 'Crowd cheers! (+Renown, +Romance)', fail: 'You bump heads.', onSuccess: () => { modRep('renown', 2); modRel(person.id, 0, 15); }, onFail: () => modRep('infamy', 1) },
                    { text: 'Shy Away', type: 'flavor', effect: () => { modRel(person.id, 0, -10); log("They blush in embarrassment."); } },
                    { text: 'Show Off', type: 'check', stat: 'cha', dc: 12, success: 'A passionate display! (+Romance)', fail: 'Too much.', onSuccess: () => modRel(person.id, 0, 20), onFail: () => modRep('infamy', 1) }
                ]),
                                createEvent(`lov_11_${person.id}`, `Rainy Day`, `Your ${person.relation} ${person.name} forgot their cloak in the rain.`, [
                    { text: 'Share Yours', type: 'check', stat: 'cha', dc: 8, success: 'They feel cherished. (+Romance, +2 SP)', fail: 'You get soaked too.', onSuccess: () => { modRel(person.id, 15, 10); modSanity(2); }, onFail: () => modSanity(-1) },
                    { text: 'Run Together', type: 'check', stat: 'dex', dc: 10, success: 'Laughing all the way! (+Rel)', fail: 'Slipped in the mud.', onSuccess: () => modRel(person.id, 15), onFail: () => takeDamage(1) },
                    { text: 'Let Them Shiver', type: 'flavor', effect: () => { modRel(person.id, -10); log("They glare at you."); } }
                ]),

                createEvent(`lov_12_${person.id}`, `Dancing`, `Your ${person.relation} ${person.name} invites you to dance at the festival.`, [
                    { text: 'Dance Close', type: 'check', stat: 'dex', dc: 10, success: 'They smile warmly. (+Romance)', fail: 'Step on toes.', onSuccess: () => modRel(person.id, 15, 10), onFail: () => modRel(person.id, -2) },
                    { text: 'Lead', type: 'check', stat: 'cha', dc: 12, success: 'Impressive moves! (+Rel)', fail: 'Tripped.', onSuccess: () => modRel(person.id, 15), onFail: () => takeDamage(1) },
                    { text: 'Refuse', type: 'flavor', effect: () => log("You sit out awkwardly.") }
                ]),

                createEvent(`lov_13_${person.id}`, `Shared Secret`, `Your ${person.relation} ${person.name} whispers a secret only for you.`, [
                    { text: 'Promise to Keep', type: 'check', stat: 'wis', dc: 10, success: 'Trust deepens. (+Romance)', fail: 'You almost blurt it out.', onSuccess: () => modRel(person.id, 20, 10), onFail: () => modRel(person.id, -10) },
                    { text: 'Share Your Secret', type: 'check', stat: 'cha', dc: 8, success: 'They appreciate honesty. (+Rel)', fail: 'Overshare.', onSuccess: () => modRel(person.id, 15), onFail: () => modRel(person.id, -5) },
                    { text: 'Ignore', type: 'flavor', effect: () => log("You nod politely.") }
                ]),

                createEvent(`lov_14_${person.id}`, `Star-Crossed`, `You both spot a falling star.`, [
                    { text: 'Make a Wish', type: 'check', stat: 'wis', dc: 10, success: 'The wish feels shared. (+Romance)', fail: 'You wish poorly.', onSuccess: () => modRel(person.id, 15, 10), onFail: () => {} },
                    { text: 'Point It Out', type: 'flavor', effect: () => { modRel(person.id, 5); log("They giggle at your enthusiasm."); } },
                    { text: 'Ignore', type: 'flavor', effect: () => { log("Missed opportunity."); } }
                ]),

                createEvent(`lov_15_${person.id}`, `Shared Adventure`, `Your ${person.relation} ${person.name} suggests a walk in the forest.`, [
                    { text: 'Take Lead', type: 'check', stat: 'str', dc: 10, success: 'You navigate safely. (+Romance, +Rel)', fail: 'Get lost briefly.', onSuccess: () => modRel(person.id, 15, 10), onFail: () => modRel(person.id, 0, -2) },
                    { text: 'Follow', type: 'check', stat: 'wis', dc: 8, success: 'They enjoy your company.', fail: 'Trip over roots.', onSuccess: () => modRel(person.id, 15), onFail: () => takeDamage(1) },
                    { text: 'Refuse', type: 'flavor', effect: () => { modRel(person.id, -10); log("They look disappointed."); } }
                ]),

                createEvent(`lov_16_${person.id}`, `Secret Note`, `Your ${person.relation} ${person.name} slips you a folded paper in class.`, [
                    { text: 'Read Silently', type: 'check', stat: 'wis', dc: 10, success: 'Your heart warms. (+Romance)', fail: 'You fumble the note.', onSuccess: () => modRel(person.id, 15, 10), onFail: () => modRel(person.id, -5) },
                    { text: 'Reply', type: 'check', stat: 'cha', dc: 10, success: 'They blush! (+Rel)', fail: 'Ink smudges.', onSuccess: () => modRel(person.id, 15), onFail: () => {} },
                    { text: 'Ignore', type: 'flavor', effect: () => log("You fold it back into your pocket.") }
                ]),

                createEvent(`lov_17_${person.id}`, `Morning Walk`, `Your ${person.relation} ${person.name} joins you for an early stroll.`, [
                    { text: 'Chat', type: 'check', stat: 'cha', dc: 8, success: 'A peaceful conversation. (+Rel)', fail: 'Awkward pauses.', onSuccess: () => modRel(person.id, 15), onFail: () => modRel(person.id, -5) },
                    { text: 'Silent Walk', type: 'flavor', effect: () => { modRel(person.id, 10); log("Comfortable silence shared."); } },
                    { text: 'Jog Ahead', type: 'check', stat: 'dex', dc: 10, success: 'You race them playfully. (+Rel, +2 SP)', fail: 'Trip and fall.', onSuccess: () => { modRel(person.id, 15); modSanity(2); }, onFail: () => takeDamage(1) }
                ]),

                createEvent(`lov_18_${person.id}`, `Board Game`, `Your ${person.relation} ${person.name} challenges you to a friendly game.`, [
                    { text: 'Play Fair', type: 'check', stat: 'int', dc: 10, success: 'Fun is had by all. (+Romance)', fail: 'You mess up the rules.', onSuccess: () => modRel(person.id, 15, 10), onFail: () => {} },
                    { text: 'Cheat', type: 'check', stat: 'dex', dc: 12, success: 'They forgive you. (+Rel)', fail: 'Caught cheating! (-Rel)', onSuccess: () => modRel(person.id, 15), onFail: () => modRel(person.id, -10) },
                    { text: 'Watch', type: 'flavor', effect: () => log("You enjoy their strategy.") }
                ]),

                createEvent(`lov_19_${person.id}`, `Rainy Confession`, `Caught in a sudden downpour, your ${person.relation} ${person.name} admits their feelings.`, [
                    { text: 'Confess Back', type: 'check', stat: 'cha', dc: 10, success: 'Mutual feelings bloom. (+Romance, +Rel)', fail: 'You stammer awkwardly.', onSuccess: () => modRel(person.id, 25, 25), onFail: () => modRel(person.id, -5, -5) },
                    { text: 'Stay Silent', type: 'flavor', effect: () => { log("You let them speak."); } },
                    { text: 'Run Inside', type: 'check', stat: 'dex', dc: 8, success: 'They follow happily. (+Rel)', fail: 'You slip.', onSuccess: () => modRel(person.id, 15), onFail: () => takeDamage(1) }
                ]),

                createEvent(`lov_20_${person.id}`, `Festival Fireworks`, `Your ${person.relation} ${person.name} holds your hand as fireworks explode overhead.`, [
                    { text: 'Gaze Together', type: 'flavor', effect: () => { modRel(person.id, 15, 10); log("Magic fills the air."); } },
                    { text: 'Whisper Promise', type: 'check', stat: 'cha', dc: 10, success: 'Your words linger in memory. (+Romance)', fail: 'They frown slightly.', onSuccess: () => modRel(person.id, 15, 20), onFail: () => modRel(person.id, -5, -5) },
                    { text: 'Cheer Loudly', type: 'flavor', effect: () => { modRel(person.id, 5); log("Fun but less intimate."); } }
                ])
            ],
            enemy: [
                createEvent(`eny_1_${person.id}`, `Public Slander`, `Your ${person.relation} ${person.name} is spreading lies about you!`, [
                    { text: 'Defend Honor', type: 'check', stat: 'cha', dc: 12, success: 'You turn the crowd against them. (+Renown, -Rel)', fail: 'People believe the lies. (-Honor)', onSuccess: () => { modRep('renown', 10); modRel(person.id, -10); }, onFail: () => modRep('honor', -5) },
                    { text: 'Ignore', type: 'flavor', effect: () => { modRep('honor', -2); log("Silence is admission to some."); } },
                    { text: 'Spread Rumor', type: 'check', stat: 'int', dc: 10, success: 'Two can play that game.', fail: 'Backfires.', onSuccess: () => modRel(person.id, -20), onFail: () => modRep('infamy', 2) }
                ]),
                createEvent(`eny_2_${person.id}`, `Alleyway Ambush`, `Your ${person.relation} ${person.name} jumps you with a club!`, [
                    { text: 'Fight Back', type: 'check', stat: 'str', dc: 12, success: 'You beat them senseless. (-Rel)', fail: 'Ouch! (-HP)', onSuccess: () => { modRel(person.id, -20); takeDamage(1); }, onFail: () => takeDamage(5) },
                    { text: 'Dodge', type: 'check', stat: 'dex', dc: 12, success: 'You escape unharmed.', fail: 'Too slow. (-HP)', onSuccess: () => {}, onFail: () => takeDamage(4) },
                    { text: 'Bribe (10g)', type: 'flavor', req: s => s.gold >= 10, effect: () => { state.gold -= 10; log("They take the coin and leave."); } }
                ]),
                createEvent(`eny_3_${person.id}`, `Sabotage`, `You find your work tools damaged. You know it was your ${person.relation} ${person.name}.`, [
                    { text: 'Fix it', type: 'check', stat: 'dex', dc: 10, success: 'Good as new. (+Rel)', fail: 'You waste materials. (-5g)', onSuccess: () => modRel(person.id, 5), onFail: () => state.gold = Math.max(0, state.gold - 5) },
                    { text: 'Revenge', type: 'flavor', effect: () => { modRel(person.id, -30); log("You break their window in the night. (-Rel)"); } },
                    { text: 'Report', type: 'check', stat: 'cha', dc: 10, success: 'They are fined. (+Honor)', fail: 'No proof.', onSuccess: () => modRep('honor', 2), onFail: () => {} }
                ]),
                createEvent(`eny_4_${person.id}`, `The Stare Down`, `You lock eyes with your ${person.relation} ${person.name} across the tavern.`, [
                    { text: 'Intimidate', type: 'check', stat: 'str', dc: 10, success: 'They look away first. (+Renown)', fail: 'They laugh at you. (-Renown)', onSuccess: () => modRep('renown', 2), onFail: () => modRep('renown', -2) },
                    { text: 'Buy them a drink', type: 'flavor', req: s => s.gold >= 2, effect: () => { state.gold -= 2; modRel(person.id, 10); log("A confused truce is formed. (+Rel)"); } },
                    { text: 'Look Away', type: 'flavor', effect: () => log("You avoid conflict.") }
                ]),
                createEvent(`eny_5_${person.id}`, `Petty Theft`, `Your ${person.relation} ${person.name} bumps into you. Your purse feels lighter.`, [
                    { text: 'Catch them', type: 'check', stat: 'dex', dc: 12, success: 'You grab their wrist! (+Renown, -Rel)', fail: 'They vanish with 5g.', onSuccess: () => { modRep('renown', 5); modRel(person.id, -15); }, onFail: () => { state.gold = Math.max(0, state.gold - 5); } },
                    { text: 'Let it go', type: 'flavor', effect: () => { state.gold = Math.max(0, state.gold - 5); log("Not worth the fight."); } },
                    { text: 'Yell Thief', type: 'check', stat: 'cha', dc: 10, success: 'Guards!', fail: 'Ignored.', onSuccess: () => modRep('renown', 2), onFail: () => {} }
                ]),
                createEvent(`eny_6_${person.id}`, `The Duel`, `Your ${person.relation} ${person.name} challenges you to a duel of honor!`, [
                    { text: 'Accept (Combat)', type: 'check', stat: 'str', dc: 14, success: 'Victory! (+Renown, +Honor, -Rel)', fail: 'Defeat. (-HP, -Honor)', onSuccess: () => { modRep('renown', 10); modRep('honor', 10); modRel(person.id, -20); }, onFail: () => { takeDamage(8); modRep('honor', -5); } },
                    { text: 'Refuse', type: 'flavor', effect: () => { modRep('honor', -10); log("Cowardice stains your name."); } },
                    { text: 'Talk Down', type: 'check', stat: 'cha', dc: 12, success: 'You avoid bloodshed.', fail: 'They attack anyway.', onSuccess: () => modRep('renown', 2), onFail: () => takeDamage(5) }
                ]),
                createEvent(`eny_7_${person.id}`, `Mockery`, `Your ${person.relation} ${person.name} mimics your walk and voice.`, [
                    { text: 'Laugh with them', type: 'check', stat: 'cha', dc: 10, success: 'You disarm them with humor. (+Rel)', fail: 'It looks desperate.', onSuccess: () => modRel(person.id, 15), onFail: () => modSanity(-1) },
                    { text: 'Punch', type: 'check', stat: 'str', dc: 8, success: 'That shut them up. (-Rel)', fail: 'You miss.', onSuccess: () => modRel(person.id, -15), onFail: () => {} },
                    { text: 'Ignore', type: 'check', stat: 'wis', dc: 10, success: 'They get bored.', fail: 'It stings.', onSuccess: () => {}, onFail: () => modSanity(-1) }
                ]),
                createEvent(`eny_8_${person.id}`, `Legal Trouble`, `Your ${person.relation} ${person.name} accuses you of a crime you didn't commit.`, [
                    { text: 'Argue Case', type: 'check', stat: 'int', dc: 10, success: 'The guard believes you.', fail: 'You pay a fine. (-10g, -Rel)', onSuccess: () => {}, onFail: () => { state.gold = Math.max(0, state.gold - 10); modRel(person.id, -10); } },
                    { text: 'Bribe Guard (20g)', type: 'flavor', req: s => s.gold >= 20, effect: () => { state.gold -= 20; log("Charges dropped."); } },
                    { text: 'Counter-Accuse', type: 'check', stat: 'cha', dc: 12, success: 'They get arrested instead!', fail: 'Double fine.', onSuccess: () => modRel(person.id, -30), onFail: () => state.gold -= 20 }
                ]),
                createEvent(`eny_9_${person.id}`, `Dark Rumors`, `You hear your ${person.relation} ${person.name} whispering to a dark figure.`, [
                    { text: 'Eavesdrop', type: 'check', stat: 'wis', dc: 12, success: 'You learn a secret! (+Rel)', fail: 'They spot you. (-Rel)', onSuccess: () => modRel(person.id, -15), onFail: () => modRel(person.id, -15) },
                    { text: 'Intervene', type: 'check', stat: 'str', dc: 10, success: 'You scare them off.', fail: 'You get beaten.', onSuccess: () => modRep('renown', 2), onFail: () => takeDamage(2) },
                    { text: 'Ignore', type: 'flavor', effect: () => log("None of your business.") }
                ]),
                createEvent(`eny_10_${person.id}`, `Truce?`, `Your ${person.relation} ${person.name} looks tired. "Must we do this forever?"`, [
                    { text: 'Make Peace', type: 'check', stat: 'cha', dc: 8, success: 'The feud ends. (Reset Rel)', fail: 'It was a trap!', onSuccess: () => { const r = state.relationships.find(x=>x.id===person.id); if(r) r.friendship = 0; }, onFail: () => takeDamage(2) },
                    { text: 'Never', type: 'flavor', effect: () => log("The war continues.") },
                    { text: 'Demand Payment', type: 'check', stat: 'cha', dc: 12, success: 'They pay 20g to end it.', fail: 'They spit at you.', onSuccess: () => { state.gold += 20; const r = state.relationships.find(x=>x.id===person.id); if(r) r.friendship = 0; }, onFail: () => {} }
                ]),
                                createEvent(`eny_11_${person.id}`, `Sabotaged Feast`, `Your ${person.relation} ${person.name} ruins your carefully prepared meal.`, [
                    { text: 'Confront', type: 'check', stat: 'cha', dc: 10, success: 'They apologize begrudgingly. (+Rel)', fail: 'They mock you further. (-Rel)', onSuccess: () => modRel(person.id, 10), onFail: () => modRel(person.id, -10) },
                    { text: 'Retaliate', type: 'flavor', effect: () => { modRel(person.id, -20); log("You spill their drink in revenge."); } },
                    { text: 'Ignore', type: 'flavor', effect: () => log("You salvage what you can.") }
                ]),

                createEvent(`eny_12_${person.id}`, `Street Race`, `Your ${person.relation} ${person.name} challenges you to a footrace through the market.`, [
                    { text: 'Accept', type: 'check', stat: 'dex', dc: 12, success: 'Victory! (+Renown)', fail: 'Tripped over a cart. (-HP)', onSuccess: () => modRep('renown', 5), onFail: () => takeDamage(2) },
                    { text: 'Decline', type: 'flavor', effect: () => log("They scoff at your cowardice.") },
                    { text: 'Sabotage', type: 'check', stat: 'int', dc: 10, success: 'They slip on spilled oil. (+Renown)', fail: 'You slip too.', onSuccess: () => modRep('renown', 3), onFail: () => takeDamage(1) }
                ]),

                createEvent(`eny_13_${person.id}`, `The Prank`, `Your ${person.relation} ${person.name} puts a frog in your bed.`, [
                    { text: 'Jump', type: 'check', stat: 'dex', dc: 10, success: 'You avoid the frog. (+Rel)', fail: 'It lands on you! (-Sanity)', onSuccess: () => modRel(person.id, 10), onFail: () => modSanity(-1) },
                    { text: 'Throw Back', type: 'flavor', effect: () => { modRel(person.id, -10); log("Frog revenge executed."); } },
                    { text: 'Laugh', type: 'flavor', effect: () => { modRel(person.id, 5); log("You take it in stride."); } }
                ]),

                createEvent(`eny_14_${person.id}`, `Insulting Letter`, `Your ${person.relation} ${person.name} sends a nasty note to your family.`, [
                    { text: 'Confront', type: 'check', stat: 'cha', dc: 12, success: 'They admit wrongdoing. (+Honor)', fail: 'They deny everything. (-Renown)', onSuccess: () => modRep('honor', 5), onFail: () => modRep('renown', -3) },
                    { text: 'Ignore', type: 'flavor', effect: () => log("Your family comforts you.") },
                    { text: 'Return Insult', type: 'check', stat: 'int', dc: 10, success: 'You humiliate them cleverly. (+Renown)', fail: 'Backfires. (-Honor)', onSuccess: () => modRep('renown', 5), onFail: () => modRep('honor', -5) }
                ]),

                createEvent(`eny_15_${person.id}`, `Ambushed Caravan`, `Your ${person.relation} ${person.name} sabotages your trade caravan.`, [
                    { text: 'Fight', type: 'check', stat: 'str', dc: 12, success: 'You recover goods. (+Renown)', fail: 'Lose some cargo. (-Gold)', onSuccess: () => modRep('renown', 5), onFail: () => state.gold = Math.max(0, state.gold - 20) },
                    { text: 'Track', type: 'check', stat: 'wis', dc: 10, success: 'You find them hiding. (+Honor)', fail: 'They vanish. (-Renown)', onSuccess: () => modRep('honor', 5), onFail: () => modRep('renown', -5) },
                    { text: 'Pay Back', type: 'flavor', effect: () => { state.gold -= 10; modRel(person.id, -10); log("You strike back with coin."); } }
                ]),

                createEvent(`eny_16_${person.id}`, `Poisoned Ale`, `Your ${person.relation} ${person.name} slipped something in your drink at the tavern.`, [
                    { text: 'Spit Out', type: 'check', stat: 'wis', dc: 10, success: 'You avoid harm.', fail: 'You get sick. (-HP)', onSuccess: () => {}, onFail: () => takeDamage(3) },
                    { text: 'Confront', type: 'check', stat: 'cha', dc: 12, success: 'They confess. (+Rel)', fail: 'They deny. (-Rel)', onSuccess: () => modRel(person.id, 10), onFail: () => modRel(person.id, -10) },
                    { text: 'Drink Anyway', type: 'flavor', effect: () => { takeDamage(2); log("Brave or foolish."); } }
                ]),

                createEvent(`eny_17_${person.id}`, `Broken Bridge`, `Your ${person.relation} ${person.name} sabotages a bridge you need to cross.`, [
                    { text: 'Repair', type: 'check', stat: 'dex', dc: 12, success: 'Safe passage. (+Renown)', fail: 'You slip. (-HP)', onSuccess: () => modRep('renown', 5), onFail: () => takeDamage(3) },
                    { text: 'Find Alternate', type: 'check', stat: 'wis', dc: 10, success: 'Shortcut found. (+Rel)', fail: 'You get lost. (-Sanity)', onSuccess: () => modRel(person.id, 10), onFail: () => modSanity(-1) },
                    { text: 'Confront', type: 'check', stat: 'str', dc: 10, success: 'They rebuild in your favor.', fail: 'They taunt you. (-Renown)', onSuccess: () => {}, onFail: () => modRep('renown', -2) }
                ]),

                createEvent(`eny_18_${person.id}`, `Poisoned Well`, `Your ${person.relation} ${person.name} poisons the village well.`, [
                    { text: 'Warn Villagers', type: 'check', stat: 'cha', dc: 10, success: 'They evacuate safely. (+Honor)', fail: 'Not enough time. (-HP)', onSuccess: () => modRep('honor', 5), onFail: () => takeDamage(3) },
                    { text: 'Stop Them', type: 'check', stat: 'str', dc: 12, success: 'You catch them. (+Renown, -Rel)', fail: 'They escape. (-Honor)', onSuccess: () => { modRep('renown', 5); modRel(person.id, -20); }, onFail: () => modRep('honor', -5) },
                    { text: 'Ignore', type: 'flavor', effect: () => log("You hope someone else notices.") }
                ]),

                createEvent(`eny_19_${person.id}`, `Ambushed at Night`, `Your ${person.relation} ${person.name} and accomplices attack your home.`, [
                    { text: 'Defend', type: 'check', stat: 'str', dc: 12, success: 'You fend them off. (+Renown, +Honor)', fail: 'They break in. (-HP)', onSuccess: () => { modRep('renown', 5); modRep('honor', 5); }, onFail: () => takeDamage(5) },
                    { text: 'Hide', type: 'check', stat: 'dex', dc: 10, success: 'Escape unharmed.', fail: 'Found anyway. (-HP)', onSuccess: () => {}, onFail: () => takeDamage(3) },
                    { text: 'Negotiate', type: 'check', stat: 'cha', dc: 12, success: 'They leave. (+Rel)', fail: 'They mock you. (-Rel)', onSuccess: () => modRel(person.id, 10), onFail: () => modRel(person.id, -10) }
                ]),

                createEvent(`eny_20_${person.id}`, `The Final Insult`, `Your ${person.relation} ${person.name} publicly humiliates you during the festival.`, [
                    { text: 'Challenge Duel', type: 'check', stat: 'str', dc: 14, success: 'You regain honor. (+Renown, +Honor)', fail: 'Defeated. (-HP, -Honor)', onSuccess: () => { modRep('renown', 10); modRep('honor', 10); }, onFail: () => { takeDamage(5); modRep('honor', -5); } },
                    { text: 'Retaliate Verbally', type: 'check', stat: 'cha', dc: 12, success: 'The crowd sides with you. (+Renown)', fail: 'They laugh. (-Renown)', onSuccess: () => modRep('renown', 5), onFail: () => modRep('renown', -5) },
                    { text: 'Walk Away', type: 'flavor', effect: () => log("Pride hurts, but you survive.") }
                ])
            ],
            friend: [
                createEvent(`frn_1_${person.id}`, `Drinking Contest`, `Your ${person.relation} ${person.name} slams a tankard down. "Bet you can't outdrink me!"`, [
                    { text: 'Accept', type: 'check', stat: 'con', dc: 12, success: 'You drink them under the table! (+Renown, +Rel)', fail: 'You blackout. (-2 HP)', onSuccess: () => { modRep('renown', 5); modRel(person.id, 15); }, onFail: () => takeDamage(2) },
                    { text: 'Decline', type: 'flavor', effect: () => log("You sip water sensibly.") },
                    { text: 'Buy Round (5g)', type: 'flavor', req: s => s.gold >= 5, effect: () => { state.gold -= 5; modRel(person.id, 20); log("Everyone cheers!"); } }
                ]),
                createEvent(`frn_2_${person.id}`, `Need a Loan`, `Your ${person.relation} ${person.name} asks to borrow 10 gold.`, [
                    { text: 'Lend it', type: 'flavor', req: s => s.gold >= 10, effect: () => { state.gold -= 10; modRel(person.id, 25); log("They promise to pay it back. (+Rel)"); } },
                    { text: 'Refuse', type: 'flavor', effect: () => { modRel(person.id, -10); log("They look dejected. (-Rel)"); } },
                    { text: 'Ask Why', type: 'check', stat: 'wis', dc: 8, success: 'Honest answer. (+Rel)', fail: 'They get defensive.', onSuccess: () => modRel(person.id, 10), onFail: () => modRel(person.id, -5) }
                ]),
                createEvent(`frn_3_${person.id}`, `Sparring Partner`, `Your ${person.relation} ${person.name} wants to practice fighting.`, [
                    { text: 'Spar', type: 'check', stat: 'str', dc: 10, success: 'Good training. (+Rel)', fail: 'You get bruised. (+Rel)', onSuccess: () => { modRel(person.id, 15); }, onFail: () => { modRel(person.id, 10); } },
                    { text: 'Refuse', type: 'flavor', effect: () => log("Not today.") },
                    { text: 'Teach', type: 'check', stat: 'int', dc: 10, success: 'You correct their form. (+Rel)', fail: 'You sound arrogant.', onSuccess: () => modRel(person.id, 20), onFail: () => modRel(person.id, -5) }
                ]),
                createEvent(`frn_4_${person.id}`, `Confession`, `Your ${person.relation} ${person.name} confesses a dark secret to you.`, [
                    { text: 'Keep Secret', type: 'check', stat: 'wis', dc: 8, success: 'Your bond deepens. (+Rel)', fail: 'The burden weighs on you. (-Sanity)', onSuccess: () => modRel(person.id, 25), onFail: () => modSanity(-1) },
                    { text: 'Blackmail', type: 'flavor', effect: () => { modRel(person.id, -50); state.gold += 20; modRep('infamy', 10); log("You extorted 20g. (-Rel)"); } },
                    { text: 'Advise', type: 'check', stat: 'int', dc: 10, success: 'Good advice. (+Rel)', fail: 'Bad advice.', onSuccess: () => modRel(person.id, 15), onFail: () => {} }
                ]),
                createEvent(`frn_5_${person.id}`, `Adventure Hook`, `Your ${person.relation} ${person.name} found a map!`, [
                    { text: 'Go exploring', type: 'check', stat: 'wis', dc: 12, success: 'You find treasure! (+20g, +Rel)', fail: 'You get lost in the woods.', onSuccess: () => { state.gold += 20; modRel(person.id, 15); }, onFail: () => {} },
                    { text: 'Pass', type: 'flavor', effect: () => log("Too dangerous.") },
                    { text: 'Sell Map', type: 'check', stat: 'cha', dc: 10, success: 'Split profit. (+10g)', fail: 'No buyer.', onSuccess: () => state.gold += 10, onFail: () => {} }
                ]),
                createEvent(`frn_6_${person.id}`, `Matchmaking`, `Your ${person.relation} ${person.name} introduces you to their cousin.`, [
                    { text: 'Charm them', type: 'check', stat: 'cha', dc: 10, success: 'A new romance begins! (+Rel)', fail: 'Awkward.', onSuccess: () => { createRandomRel(30); const r = state.relationships[state.relationships.length-1]; r.romance = 30; modRel(person.id, 15); }, onFail: () => {} },
                    { text: 'Decline', type: 'flavor', effect: () => log("Not interested.") },
                    { text: 'Be Polite', type: 'flavor', effect: () => { createRandomRel(20); log("A new acquaintance."); } }
                ]),
                createEvent(`frn_7_${person.id}`, `Gift Exchange`, `Your ${person.relation} ${person.name} hands you a wrapped bundle.`, [
                    { text: 'Open it', type: 'flavor', effect: () => { addItem('Wooden Flute', 'Common', 'A gift from a friend.', 5); modRel(person.id, 15); } },
                    { text: 'Give Gift', type: 'flavor', req: s => s.gold >= 5, effect: () => { state.gold -= 5; modRel(person.id, 25); log("They love it!"); } },
                    { text: 'Reject', type: 'flavor', effect: () => { modRel(person.id, -20); log("Rude."); } }
                ]),
                createEvent(`frn_8_${person.id}`, `Religious Festival`, `Your ${person.relation} ${person.name} drags you to the temple.`, [
                    { text: 'Pray', type: 'check', stat: 'wis', dc: 8, success: 'You feel blessed. (+Piety, +3 SP, +Rel)', fail: 'You fall asleep.', onSuccess: () => { modRep('piety', 5); modSanity(3); modRel(person.id, 15); }, onFail: () => {} },
                    { text: 'Donate', type: 'flavor', req: s => s.gold >= 2, effect: () => { state.gold -= 2; modRep('piety', 5); log("Generous."); } },
                    { text: 'Leave', type: 'flavor', effect: () => log("Not for you.") }
                ]),
                createEvent(`frn_9_${person.id}`, `Work Grievance`, `Your ${person.relation} ${person.name} complains about their boss for hours.`, [
                    { text: 'Listen', type: 'check', stat: 'con', dc: 10, success: 'You are a good listener. (+Rel)', fail: 'You snap at them. (-Rel)', onSuccess: () => modRel(person.id, 15), onFail: () => modRel(person.id, -10) },
                    { text: 'Advise', type: 'check', stat: 'int', dc: 10, success: 'They nod. (+Rel)', fail: 'They ignore you.', onSuccess: () => modRel(person.id, 15), onFail: () => {} },
                    { text: 'Change Topic', type: 'flavor', effect: () => log("You talk about weather.") }
                ]),
                createEvent(`frn_10_${person.id}`, `Dice Game`, `Your ${person.relation} ${person.name} takes out the dice.`, [
                    { text: 'Play (5g)', type: 'check', stat: 'int', dc: 10, req: s => s.gold >= 5, success: 'You win! (+5g, +Rel)', fail: 'You lose. (-5g, +Rel)', onSuccess: () => { state.gold += 5; modRel(person.id, 5); }, onFail: () => { state.gold -= 5; modRel(person.id, 5); } },
                    { text: 'Refuse', type: 'flavor', effect: () => log("Gambling is a sin.") },
                    { text: 'Cheat', type: 'check', stat: 'dex', dc: 12, success: 'You win big! (+10g)', fail: 'Caught! (-Rel)', onSuccess: () => state.gold += 10, onFail: () => modRel(person.id, -20) }
                ]), 
                                createEvent(`frn_11_${person.id}`, `Hunting Trip`, `Your ${person.relation} ${person.name} invites you to hunt in the forest.`, [
                    { text: 'Join', type: 'check', stat: 'dex', dc: 12, success: 'You bag a stag! (+Gold, +Rel)', fail: 'You get lost. (-Sanity)', onSuccess: () => { state.gold += 15; modRel(person.id, 15); }, onFail: () => modSanity(-1) },
                    { text: 'Decline', type: 'flavor', effect: () => log("You stay in town.") },
                    { text: 'Scout Ahead', type: 'check', stat: 'wis', dc: 10, success: 'Spot prey early. (+Rel)', fail: 'You trip. (-HP)', onSuccess: () => modRel(person.id, 15), onFail: () => takeDamage(2) }
                ]),

                createEvent(`frn_12_${person.id}`, `Festival Dance`, `Your ${person.relation} ${person.name} drags you into a dance circle.`, [
                    { text: 'Dance', type: 'check', stat: 'dex', dc: 10, success: 'You impress everyone. (+Renown, +Rel)', fail: 'Step on their toes! (-Rel)', onSuccess: () => { modRep('renown', 5); modRel(person.id, 15); }, onFail: () => modRel(person.id, -10) },
                    { text: 'Cheer', type: 'flavor', effect: () => { modRel(person.id, 5); log("You clap along."); } },
                    { text: 'Sit Out', type: 'flavor', effect: () => log("You watch from the sidelines.") }
                ]),

                createEvent(`frn_13_${person.id}`, `Secret Recipe`, `Your ${person.relation} ${person.name} shares their favorite stew recipe with you.`, [
                    { text: 'Cook Together', type: 'check', stat: 'int', dc: 10, success: 'Delicious! (+Rel)', fail: 'Burnt! (-Sanity)', onSuccess: () => modRel(person.id, 15), onFail: () => modSanity(-1) },
                    { text: 'Write Down', type: 'flavor', effect: () => { addItem('Stew Recipe', 'Common', 'Recipe from a friend.', 5); modRel(person.id, 15); } },
                    { text: 'Forget', type: 'flavor', effect: () => log("You enjoy the memory of cooking.") }
                ]),

                createEvent(`frn_14_${person.id}`, `Fishing Trip`, `Your ${person.relation} ${person.name} takes you to a quiet river.`, [
                    { text: 'Fish', type: 'check', stat: 'dex', dc: 10, success: 'Catch a big one! (+Gold, +Rel)', fail: 'Nothing bites.', onSuccess: () => { state.gold += 5; modRel(person.id, 15); }, onFail: () => {} },
                    { text: 'Relax', type: 'flavor', effect: () => { modSanity(1); modRel(person.id, 5); log("Peaceful day. (+1 SP)"); } },
                    { text: 'Prank', type: 'check', stat: 'dex', dc: 12, success: 'Splash them! (+Rel)', fail: 'They splash back. (-Rel)', onSuccess: () => modRel(person.id, 15), onFail: () => modRel(person.id, -5) }
                ]),

                createEvent(`frn_15_${person.id}`, `Crafting Lesson`, `Your ${person.relation} ${person.name} wants to teach you carpentry.`, [
                    { text: 'Learn', type: 'check', stat: 'int', dc: 10, success: 'You craft something fine. (+Rel)', fail: 'It collapses. (-Sanity)', onSuccess: () => modRel(person.id, 15), onFail: () => modSanity(-1) },
                    { text: 'Teach Them', type: 'check', stat: 'int', dc: 10, success: 'They admire your skill. (+Rel)', fail: 'They get frustrated. (-Rel)', onSuccess: () => modRel(person.id, 15), onFail: () => modRel(person.id, -10) },
                    { text: 'Skip', type: 'flavor', effect: () => log("Too busy for woodworking.") }
                ]),

                createEvent(`frn_16_${person.id}`, `Storytelling Night`, `Your ${person.relation} ${person.name} invites you to share tales by the fire.`, [
                    { text: 'Tell Story', type: 'check', stat: 'cha', dc: 10, success: 'Everyone is captivated. (+Renown, +Rel)', fail: 'They get bored. (-Rel)', onSuccess: () => { modRep('renown', 5); modRel(person.id, 15); }, onFail: () => modRel(person.id, -10) },
                    { text: 'Listen', type: 'flavor', effect: () => { modRel(person.id, 5); log("You enjoy the tales."); } },
                    { text: 'Sleep', type: 'flavor', effect: () => log("Dreaming by the fire.") }
                ]),

                createEvent(`frn_17_${person.id}`, `Secret Hideout`, `Your ${person.relation} ${person.name} shows you a hidden spot in town.`, [
                    { text: 'Explore', type: 'check', stat: 'wis', dc: 10, success: 'Found treasures! (+Gold, +Rel)', fail: 'Trap! (-HP)', onSuccess: () => { state.gold += 10; modRel(person.id, 15); }, onFail: () => takeDamage(2) },
                    { text: 'Keep Secret', type: 'flavor', effect: () => { modRel(person.id, 15); log("A bond is formed.") } },
                    { text: 'Forget', type: 'flavor', effect: () => log("You wander elsewhere.") }
                ]),

                createEvent(`frn_18_${person.id}`, `Pet Rescue`, `Your ${person.relation} ${person.name} asks for help saving a stray animal.`, [
                    { text: 'Help', type: 'check', stat: 'con', dc: 10, success: 'The animal is safe! (+Rel)', fail: 'You get scratched. (-HP)', onSuccess: () => modRel(person.id, 15), onFail: () => takeDamage(1) },
                    { text: 'Decline', type: 'flavor', effect: () => { modRel(person.id, -10); log("They are disappointed.") } },
                    { text: 'Adopt', type: 'flavor', effect: () => { addItem('Stray Kitten', 'Common', 'A new companion.', 5); modRel(person.id, 15); } }
                ]),

                createEvent(`frn_19_${person.id}`, `Cooking Challenge`, `Your ${person.relation} ${person.name} challenges you to a bake-off.`, [
                    { text: 'Accept', type: 'check', stat: 'int', dc: 10, success: 'Delicious! (+Rel, +Renown)', fail: 'Burnt dessert. (-Rel)', onSuccess: () => { modRel(person.id, 15); modRep('renown', 3); }, onFail: () => modRel(person.id, -10) },
                    { text: 'Decline', type: 'flavor', effect: () => log("Not your day for baking.") },
                    { text: 'Help Them', type: 'check', stat: 'int', dc: 8, success: 'Great teamwork! (+Rel)', fail: 'They get annoyed. (-Rel)', onSuccess: () => modRel(person.id, 15), onFail: () => modRel(person.id, -5) }
                ]),

                createEvent(`frn_20_${person.id}`, `Treasure Hunt`, `Your ${person.relation} ${person.name} found clues to a hidden chest!`, [
                    { text: 'Search Together', type: 'check', stat: 'wis', dc: 12, success: 'Treasure found! (+Gold, +Rel)', fail: 'Misread clues. (-Gold)', onSuccess: () => { state.gold += 25; modRel(person.id, 15); }, onFail: () => { state.gold = Math.max(0, state.gold - 5); } },
                    { text: 'Let Them Go Alone', type: 'flavor', effect: () => log("They return excited.") },
                    { text: 'Sell Clues', type: 'check', stat: 'cha', dc: 10, success: 'Profit shared. (+Gold)', fail: 'No buyers.', onSuccess: () => state.gold += 10, onFail: () => {} }
                ]),

                // NEW EVENT: Friend Confession
                createEvent(`frn_confess_${person.id}`, `Heartfelt Confession`, `Your friend ${person.name} pulls you aside, looking unusually nervous. "I have harbored feelings for you for a long time. Will you accept me as a suitor?"<br><button class="text-xs underline text-amber-900 mt-2" onclick="openNPC('${person.id}')">Inspect ${person.name}</button>`, [
                    { text: 'Accept Courtship', type: 'flavor', effect: () => { modRel(person.id, 20, 40); log("You embrace them warmly. A new romance begins."); } },
                    { text: 'Let Down Gently', type: 'check', stat: 'cha', dc: 10, success: 'They nod sadly but value your friendship.', fail: 'They are heartbroken and distant.', onSuccess: () => modRel(person.id, 5), onFail: () => modRel(person.id, -20) },
                    { text: 'Laugh', type: 'flavor', effect: () => { modRel(person.id, -50); log("You cruelly mocked their feelings."); modRep('infamy', 5); } }
                ])
            ],
            neutral: [
                createEvent(`neu_1_${person.id}`, `Bumping Shoulders`, `You collide with your ${person.relation} ${person.name} in the street.`, [
                    { text: 'Apologize', type: 'check', stat: 'cha', dc: 8, success: 'They nod politely. (+Rel)', fail: 'They grumble.', onSuccess: () => modRel(person.id, 5), onFail: () => modRel(person.id, -5) },
                    { text: 'Blame them', type: 'check', stat: 'str', dc: 10, success: 'They back off.', fail: 'Argument starts. (-Rel)', onSuccess: () => {}, onFail: () => modRel(person.id, -10) },
                    { text: 'Pickpocket', type: 'check', stat: 'dex', dc: 12, success: 'You stole 5g! (+Infamy)', fail: 'Caught!', onSuccess: () => { state.gold += 5; modRep('infamy', 2); }, onFail: () => modRep('infamy', 5) }
                ]),
                createEvent(`neu_2_${person.id}`, `Small Talk`, `Your ${person.relation} ${person.name} comments on the weather.`, [
                    { text: 'Chat', type: 'flavor', effect: () => { log("It is indeed a cloudy day. (+Rel)"); modRel(person.id, 5); } },
                    { text: 'Ignore', type: 'flavor', effect: () => log("Busy.") },
                    { text: 'Charm', type: 'check', stat: 'cha', dc: 10, success: 'They like you. (+Rel)', fail: 'Awkward.', onSuccess: () => modRel(person.id, 10), onFail: () => {} }
                ]),
                createEvent(`neu_3_${person.id}`, `Dropped Item`, `Your ${person.relation} ${person.name} drops a handkerchief.`, [
                    { text: 'Return it', type: 'check', stat: 'dex', dc: 8, success: 'They thank you. (+Honor, +Rel)', fail: 'You trip trying to pick it up.', onSuccess: () => { modRel(person.id, 10); modRep('honor', 2); }, onFail: () => {} },
                    { text: 'Steal it', type: 'flavor', effect: () => { addItem('Handkerchief', 'Common', 'Stolen.', 1); modRep('honor', -2); } },
                    { text: 'Ignore', type: 'flavor', effect: () => log("Not your problem.") }
                ]),
                createEvent(`neu_4_${person.id}`, `Market Haggle`, `You see your ${person.relation} ${person.name} selling apples.`, [
                    { text: 'Haggle', type: 'check', stat: 'cha', dc: 10, success: 'Good deal! (+1 HP, +Rel)', fail: 'Full price.', onSuccess: () => { state.gold = Math.max(0, state.gold - 1); state.health++; modRel(person.id, 5); }, onFail: () => state.gold = Math.max(0, state.gold - 2) },
                    { text: 'Buy (2g)', type: 'flavor', req: s => s.gold >= 2, effect: () => { state.gold -= 2; state.health++; log("Tasty."); } },
                    { text: 'Steal', type: 'check', stat: 'dex', dc: 12, success: 'Free apple!', fail: 'Caught.', onSuccess: () => state.health++, onFail: () => modRep('infamy', 2) }
                ]),
                createEvent(`neu_5_${person.id}`, `Ask Directions`, `You ask your ${person.relation} ${person.name} where the blacksmith is.`, [
                    { text: 'Ask', type: 'check', stat: 'int', dc: 8, success: 'Clear directions. (+Rel)', fail: 'You get lost.', onSuccess: () => { modRel(person.id, 5); }, onFail: () => {} },
                    { text: 'Guess', type: 'flavor', effect: () => log("You wander aimlessly.") },
                    { text: 'Charm', type: 'check', stat: 'cha', dc: 10, success: 'They walk you there. (+Rel)', fail: 'Confused.', onSuccess: () => modRel(person.id, 10), onFail: () => {} }
                ]),
                createEvent(`neu_6_${person.id}`, `News of the Realm`, `Your ${person.relation} ${person.name} has a newspaper.`, [
                    { text: 'Read over shoulder', type: 'check', stat: 'dex', dc: 10, success: 'You learn of the war. (+Rel)', fail: 'They catch you. (-Rel)', onSuccess: () => modRel(person.id, 5), onFail: () => modRel(person.id, -5) },
                    { text: 'Ask', type: 'check', stat: 'cha', dc: 8, success: 'They share the news.', fail: 'They ignore you.', onSuccess: () => {}, onFail: () => {} },
                    { text: 'Ignore', type: 'flavor', effect: () => log("Fake news.") }
                ]),
                createEvent(`neu_7_${person.id}`, `Charity`, `Your ${person.relation} ${person.name} is collecting for the poor.`, [
                    { text: 'Give 1g', type: 'flavor', req: s => s.gold >= 1, effect: () => { state.gold -= 1; modRep('piety', 1); modRel(person.id, 10); log("A small kindness. (+Rel)"); } },
                    { text: 'Walk away', type: 'flavor', effect: () => log("Not today.") },
                    { text: 'Mock', type: 'flavor', effect: () => { modRep('infamy', 1); modRel(person.id, -10); log("You laugh at them."); } }
                ]),
                createEvent(`neu_8_${person.id}`, `Observation`, `You watch your ${person.relation} ${person.name} working.`, [
                    { text: 'Observe', type: 'check', stat: 'wis', dc: 10, success: 'You learn a trick of the trade. (+Rel)', fail: 'Boring.', onSuccess: () => { modRel(person.id, 5); }, onFail: () => {} },
                    { text: 'Help', type: 'check', stat: 'con', dc: 10, success: 'They appreciate it. (+Rel)', fail: 'You mess up.', onSuccess: () => modRel(person.id, 10), onFail: () => modRel(person.id, -5) },
                    { text: 'Leave', type: 'flavor', effect: () => log("You move on.") }
                ]),
                createEvent(`neu_9_${person.id}`, `Shared Grievance`, `You both wait in a long line.`, [
                    { text: 'Complain', type: 'check', stat: 'cha', dc: 8, success: 'You bond over the delay. (+Rel)', fail: 'They ignore you.', onSuccess: () => modRel(person.id, 10), onFail: () => {} },
                    { text: 'Wait', type: 'check', stat: 'con', dc: 8, success: 'Patience is a virtue.', fail: 'Legs hurt.', onSuccess: () => {}, onFail: () => {} },
                    { text: 'Cut Line', type: 'check', stat: 'dex', dc: 12, success: 'Saved time.', fail: 'Yelled at. (-Rel)', onSuccess: () => {}, onFail: () => modRel(person.id, -10) }
                ]),
                createEvent(`neu_10_${person.id}`, `Fleeting Glance`, `Your ${person.relation} ${person.name} looks at you curiously.`, [
                    { text: 'Smile', type: 'check', stat: 'cha', dc: 8, success: 'They smile back. (+Rel)', fail: 'You have spinach in your teeth.', onSuccess: () => modRel(person.id, 10), onFail: () => modRel(person.id, -5) },
                    { text: 'Stare', type: 'check', stat: 'str', dc: 10, success: 'They look away.', fail: 'Staring contest.', onSuccess: () => {}, onFail: () => {} },
                    { text: 'Ignore', type: 'flavor', effect: () => log("Just a stranger.") }
                ]),
                                createEvent(`neu_11_${person.id}`, `Street Performer`, `Your ${person.relation} ${person.name} is juggling in the square.`, [
                    { text: 'Watch', type: 'flavor', effect: () => { modRel(person.id, 5); log("Entertaining performance.") } },
                    { text: 'Join In', type: 'check', stat: 'dex', dc: 10, success: 'You impress! (+Rel, +Renown)', fail: 'You drop everything. (-Rel)', onSuccess: () => { modRel(person.id, 10); modRep('renown', 2); }, onFail: () => modRel(person.id, -10) },
                    { text: 'Ignore', type: 'flavor', effect: () => log("Keep walking.") }
                ]),

                createEvent(`neu_12_${person.id}`, `Lost Pet`, `Your ${person.relation} ${person.name} is looking for a lost dog.`, [
                    { text: 'Help Search', type: 'check', stat: 'wis', dc: 10, success: 'Found it! (+Rel)', fail: 'Dog runs off. (-Sanity)', onSuccess: () => modRel(person.id, 15), onFail: () => modSanity(-1) },
                    { text: 'Give Advice', type: 'check', stat: 'int', dc: 10, success: 'They follow your tip. (+Rel)', fail: 'Ignored.', onSuccess: () => modRel(person.id, 10), onFail: () => {} },
                    { text: 'Leave', type: 'flavor', effect: () => log("Not your problem.") }
                ]),

                createEvent(`neu_13_${person.id}`, `Street Debate`, `Your ${person.relation} ${person.name} argues about politics loudly.`, [
                    { text: 'Join In', type: 'check', stat: 'cha', dc: 12, success: 'You persuade some onlookers. (+Renown)', fail: 'You offend them. (-Rel)', onSuccess: () => modRep('renown', 3), onFail: () => modRel(person.id, -10) },
                    { text: 'Stay Silent', type: 'flavor', effect: () => log("You observe quietly.") },
                    { text: 'Change Topic', type: 'flavor', effect: () => { modRel(person.id, 5); log("Talk about local events.") } }
                ]),

                createEvent(`neu_14_${person.id}`, `Shared Snack`, `Your ${person.relation} ${person.name} offers you some bread.` , [
                    { text: 'Accept', type: 'flavor', effect: () => { modRel(person.id, 10); log("You enjoy the snack.") } },
                    { text: 'Decline', type: 'flavor', effect: () => log("Politely refuse.") },
                    { text: 'Trade Something', type: 'check', stat: 'cha', dc: 10, success: 'Trade successful! (+Rel)', fail: 'They refuse.', onSuccess: () => modRel(person.id, 10), onFail: () => {} }
                ]),

                createEvent(`neu_15_${person.id}`, `Mysterious Note`, `You find a note from your ${person.relation} ${person.name} on the ground.`, [
                    { text: 'Read', type: 'flavor', effect: () => log("A cryptic message.") },
                    { text: 'Return', type: 'check', stat: 'dex', dc: 10, success: 'They thank you. (+Rel)', fail: 'They are annoyed.', onSuccess: () => modRel(person.id, 10), onFail: () => modRel(person.id, -5) },
                    { text: 'Ignore', type: 'flavor', effect: () => log("Leave it be.") }
                ]),

                createEvent(`neu_16_${person.id}`, `Broken Wagon`, `Your ${person.relation} ${person.name} struggles with a broken cart.`, [
                    { text: 'Help Push', type: 'check', stat: 'str', dc: 10, success: 'Cart moves! (+Rel)', fail: 'Strain yourself. (-HP)', onSuccess: () => modRel(person.id, 15), onFail: () => takeDamage(2) },
                    { text: 'Offer Advice', type: 'check', stat: 'int', dc: 10, success: 'It works! (+Rel)', fail: 'No effect.', onSuccess: () => modRel(person.id, 10), onFail: () => {} },
                    { text: 'Walk Away', type: 'flavor', effect: () => log("Too heavy.") }
                ]),

                createEvent(`neu_17_${person.id}`, `Street Musician`, `Your ${person.relation} ${person.name} is playing a lute.`, [
                    { text: 'Listen', type: 'flavor', effect: () => { modRel(person.id, 5); modSanity(1); log("Music soothes you. (+1 SP)") } },
                    { text: 'Request Song', type: 'check', stat: 'cha', dc: 10, success: 'They play beautifully. (+Rel)', fail: 'They ignore you.', onSuccess: () => modRel(person.id, 10), onFail: () => {} },
                    { text: 'Tip 1g', type: 'flavor', req: s => s.gold >= 1, effect: () => { state.gold -= 1; modRel(person.id, 10); log("Appreciated! (+Rel)") } }
                ]),

                createEvent(`neu_18_${person.id}`, `Muddy Puddle`, `Your ${person.relation} ${person.name} splashes water on you by accident.`, [
                    { text: 'Laugh', type: 'flavor', effect: () => { modRel(person.id, 10); log("Funny incident.") } },
                    { text: 'Scold', type: 'check', stat: 'cha', dc: 10, success: 'They apologize. (+Rel)', fail: 'They get defensive. (-Rel)', onSuccess: () => modRel(person.id, 10), onFail: () => modRel(person.id, -10) },
                    { text: 'Splash Back', type: 'check', stat: 'dex', dc: 12, success: 'You win the splash war! (+Rel)', fail: 'They retaliate. (-Rel)', onSuccess: () => modRel(person.id, 10), onFail: () => modRel(person.id, -10) }
                ]),

                createEvent(`neu_19_${person.id}`, `Odd Compliment`, `Your ${person.relation} ${person.name} compliments your unusual hat.`, [
                    { text: 'Thank', type: 'flavor', effect: () => { modRel(person.id, 10); log("Graciously accepted.") } },
                    { text: 'Brag', type: 'check', stat: 'cha', dc: 10, success: 'They are impressed. (+Rel)', fail: 'They roll eyes. (-Rel)', onSuccess: () => modRel(person.id, 10), onFail: () => modRel(person.id, -5) },
                    { text: 'Dismiss', type: 'flavor', effect: () => log("Ignore it.") }
                ]),

                createEvent(`neu_20_${person.id}`, `Shared Shortcut`, `Your ${person.relation} ${person.name} shows you a faster route through town.`, [
                    { text: 'Follow', type: 'flavor', effect: () => { modRel(person.id, 10); log("Saved time!") } },
                    { text: 'Decline', type: 'flavor', effect: () => log("Stick to your path.") },
                    { text: 'Race Them', type: 'check', stat: 'dex', dc: 10, success: 'You beat them! (+Rel)', fail: 'They win. (-Rel)', onSuccess: () => modRel(person.id, 10), onFail: () => modRel(person.id, -5) }
                ]),

                // NEW EVENT: Acquaintance Confession (Rare/Sudden)
                createEvent(`neu_confess_${person.id}`, `Unexpected Admirer`, `Your acquaintance ${person.name} approaches you with a flushed face and a small gift. "I... I admire you greatly. May I have the chance to court you?"<br><button class="text-xs underline text-amber-900 mt-2" onclick="openNPC('${person.id}')">Inspect ${person.name}</button>`, [
                    { text: 'Accept Proposal', type: 'flavor', effect: () => { modRel(person.id, 15, 30); log("You agree to let them court you. Sparks fly."); } },
                    { text: 'Polite Refusal', type: 'check', stat: 'cha', dc: 8, success: 'They apologize and retreat with dignity.', fail: 'They insist awkwardly.', onSuccess: () => {}, onFail: () => modRel(person.id, -5) },
                    { text: 'Mock Them', type: 'flavor', effect: () => { modRel(person.id, -30); modRep('infamy', 2); log("You laughed in their face."); } }
                ])
            ]
        };
        return pools[type] || pools['neutral'];
    }

    function processYear() {
        try {
            state.age++;
            state.year++;
            state.flags.lockedInChronicle = true; // Lock the player
            switchTab('log'); // Force view
            
            state.interactions = {}; 
            state.activityLog = { socialize: 0, lord: 0, tournament: 0, train: 0, brothel: 0, dungeon: 0, crime: 0, meditate: 0 }; 
            state.rejectedJobs = []; // RESET JOB REJECTIONS
            state.flags.travelAllowed = false; 
            state.flags.traveledThisYear = false;
            state.flags.requestedHouseFunds = false; // RESET STIPEND FLAG
            state.eventQueue = []; 
            
            generateMarket(state.location); // REGENERATE MARKET EVERY YEAR

            // --- NEW: CHILD MAINTENANCE COSTS ---
            // Children under 16 cost money to raise
            const dependents = state.relationships.filter(r => (r.relation === 'Son' || r.relation === 'Daughter') && r.age < 16 && r.health !== 'Deceased');
            
            if (dependents.length > 0) {
                const costPerChild = 5; 
                const totalCost = dependents.length * costPerChild;
                state.gold -= totalCost;
                log(`<span style="color:var(--stress)">Upkeep:</span> Providing for your ${dependents.length} children cost you ${totalCost}g.`);
                
                if (state.gold < 0) {
                    modSanity(-1);
                    log(`<span class="italic text-red-800">You are in debt. The burden of family weighs heavy. (-1 SP)</span>`);
                }
            }

            // --- NEW: PLAYER BIRTH LOGIC (Gestation Complete) ---
            if (state.flags.isPregnant) {
                triggerBirthSequence();
            }

            // --- HOUSE HOLDINGS UPDATE (New) ---
            if (state.house && state.house.holdings) {
                let tax = 0;
                let popGrowth = 0;
                
                state.house.holdings.forEach(h => {
                    // RESET UPGRADE FLAG FOR NEW YEAR
                    h.upgradedThisYear = false;

                    // Update Capacity if legacy data missing
                    if (!h.capacity) {
                        const tmpl = HOLDING_TEMPLATES[h.type] || HOLDING_TEMPLATES['Manor'];
                        h.capacity = tmpl.basePop + (h.level * tmpl.capPerLvl);
                    }

                    // Taxes: 1 gold per 10 people (approx)
                    const holdingTax = Math.floor(h.population * 0.1);
                    tax += holdingTax;
                    
                    // Population Growth: 2-5% per year, capped by Holding Size
                    if (h.population < h.capacity) {
                        const growthRate = 0.02 + (Math.random() * 0.03);
                        let newSouls = Math.floor(h.population * growthRate);
                        // Hard limit check
                        if (h.population + newSouls > h.capacity) {
                            newSouls = h.capacity - h.population;
                        }
                        h.population += newSouls;
                        popGrowth += newSouls;
                    }
                });

                if (tax > 0) {
                    state.house.treasury += tax;
                    // Only log for player if they are in the house
                    if (state.socialClass === 'House') {
                       // log(`<strong>House Holdings:</strong> Collected ${tax}g in taxes. Population grew by ${popGrowth}.`);
                    }
                }
            }

            // --- GROWTH LOGIC (Every 5 years until 30) ---
            if (state.age > 0 && state.age <= 30 && state.age % 5 === 0) {
                if (!state.growth) state.growth = { hp: 0, sp: 0 }; // Safety init
                
                const conMod = getModifier(state.stats.con);
                const wisMod = getModifier(state.stats.wis);
                
                // Gain 1d4 + Mod (Minimum 1)
                const hpGain = Math.max(1, Math.floor(Math.random() * 4) + 1 + conMod);
                const spGain = Math.max(1, Math.floor(Math.random() * 4) + 1 + wisMod);
                
                state.growth.hp += hpGain;
                state.growth.sp += spGain;
                
                log(`<strong style="color:var(--success)">Growth:</strong> You feel tougher and wiser. (+${hpGain} Max HP, +${spGain} Max SP)`);
            }

            // Recalculate Max Stats (Base + Growth)
            state.maxHealth = 10 + getModifier(state.stats.con) + (state.growth ? state.growth.hp : 0);
            // Recalculate Max Sanity as well to respect WIS changes and Growth
            state.maxSanity = Math.max(1, 8 + getModifier(state.stats.wis) + getModifier(state.stats.cha) + (state.growth ? state.growth.sp : 0));

            state.health = Math.min(state.maxHealth, state.health + 5); 

            const spFlux = Math.floor(Math.random() * 3) - 1; 
            state.sanity = Math.min(state.maxSanity, Math.max(0, state.sanity + spFlux));
            
            const logEl = document.getElementById('event-log');
            const marker = document.createElement('div');
            marker.className = 'event-entry age-marker';
            marker.innerText = `Age ${state.age}`;
            logEl.appendChild(marker);

            try {
                simulateNPCs();
            } catch(e) { console.error("NPC Sim Error:", e); }

            // MODIFIED: Only check inheritance here. AI Simulation moved to end of function.
            if (state.house && state.house.members.length > 0) {
                try { checkInheritance(); } catch(e) { console.error("Inheritance Error:", e); }
            }

            document.getElementById('year-display').innerText = `Year ${state.year}`;
            document.getElementById('age-display').innerText = state.age;

            try { processOccupation(); } catch(e) { console.error("Job Error:", e); }
            checkUnlocks();

            // Update UI immediately so tabs (Market/Char) show new year data even before events resolve
            updateUI(); 

            // --- 1. AGE EVENT SELECTION ---
            // Priority: Health Crisis > Sanity Break > Standard Age Event

            let ageEvent = null;

            // 0. CANON EVENT (Randomized Decade Check)
            if (state.age >= 10) {
                const decadeStart = Math.floor(state.age / 10) * 10;
                // If no target set, or target belongs to a previous decade (e.g. set for 15, now we are 20), pick new one
                if (!state.nextCanonAge || state.nextCanonAge < decadeStart) {
                     const endOfDecade = decadeStart + 9;
                     // If we start mid-decade (e.g. age 15), pick randomly between 15-19
                     const range = endOfDecade - state.age + 1;
                     state.nextCanonAge = state.age + Math.floor(Math.random() * range);
                     // console.log("Fate has chosen age:", state.nextCanonAge); // Debug
                }
            }

            if (!ageEvent && state.age === state.nextCanonAge) {
                // Select random canon event
                const pool = POOLS.Canon;
                if (pool && pool.length > 0) {
                    ageEvent = pool[Math.floor(Math.random() * pool.length)];
                    log(`<strong class="text-blue-900">CANON EVENT:</strong> A defining moment approaches...`);
                }
            }

            // A. Health Complications (Old Age)
            if (!ageEvent && state.age > 60) {
                const risk = (state.age - 60) * 2; 
                const roll = Math.floor(Math.random() * 100);
                
                if (roll < risk) {
                    const healthPool = POOLS.HealthIssues;
                    ageEvent = healthPool[Math.floor(Math.random() * healthPool.length)];
                    log(`<strong class="text-red-900">HEALTH CRISIS:</strong> Age takes its toll...`);
                }
            }

            // B. Jeopardy (Sanity) - Only if no Health Crisis
            if (!ageEvent) {
                if (state.sanity <= 2) {
                     ageEvent = POOLS.Jeopardy[2]; 
                } else if (state.sanity / state.maxSanity < 0.25) {
                    log(`<strong class="text-purple-800">JEOPARDY:</strong> Your mind is fracturing...`);
                    ageEvent = POOLS.Jeopardy[Math.floor(Math.random() * (POOLS.Jeopardy.length - 1))];
                }
            }

            // C. Standard Age Pool (Default) - Only if no Crisis
            if (!ageEvent) {
                let pool = POOLS.Infancy;
                if (state.age >= 3) pool = POOLS.Childhood;
                if (state.age >= 12) pool = POOLS.Teen;
                if (state.age >= 18) pool = POOLS.Adult;
                if (state.age >= 65) pool = POOLS.Elder;

                // DUPLICATE WARD LOGIC
                const validEvents = pool.filter(e => !state.recentEvents.includes(e.id));
                // If we run out of fresh events, reset to full pool
                const finalPool = validEvents.length > 0 ? validEvents : pool;
                
                ageEvent = finalPool[Math.floor(Math.random() * finalPool.length)];
                
                // Remember this event
                state.recentEvents.push(ageEvent.id);
                if(state.recentEvents.length > 8) state.recentEvents.shift(); // Keep last 8 unique
            }

            // Push Age Event
            if (ageEvent) {
                state.eventQueue.push(ageEvent);
            }

            // --- 2. SOCIAL & PARENTING EVENT SELECTION ---
            // 30% Chance for a Parenting Event if you have living children
            let parentingEvent = null;
            if (state.relationships.some(r => ['Son', 'Daughter'].includes(r.relation) && r.health !== 'Deceased')) {
                 if (Math.random() < 0.3) parentingEvent = generateParentingEvent();
            }

            if (parentingEvent) {
                state.eventQueue.push(parentingEvent);
            } 
            // Fallback to social if no parenting event triggers
            else if (state.age > 2) {
                const socialEvent = generateSocialEvent();
                if (socialEvent) {
                    state.eventQueue.push(socialEvent);
                } else if (state.age >= 6) {
                    const failPool = POOLS.SocialFail || [createEvent('fail_social', 'Lonely Crowd', 'You wander the city but recognize no one.', [{ text: 'Go home', type: 'flavor', effect: () => log("A quiet year.") }])];
                    const fallbackEvent = failPool[Math.floor(Math.random() * failPool.length)];
                    state.eventQueue.push(fallbackEvent);
                }
            }

            // --- 3. HOUSE EVENTS (Moved Last) ---
            if (state.house && state.house.members.length > 0) {
                try { simulateHouseAI(); } catch(e) { console.error("House AI Error:", e); }
            }

            processNextEvent();
        } catch(e) {
            console.error("Critical ProcessYear Failure:", e);
            log("Time marches on, though the records are blurry.");
        }
    }
    
    function simulateNPCs() {
        const logEl = document.getElementById('event-log');
        const jobs = Object.keys(CAREERS);
        
        state.relationships.forEach(r => {
            if(r.health === "Deceased") return;
            
            if (r.friendship > 0) r.friendship = Math.max(0, r.friendship - 5);
            if (r.romance > 0) r.romance = Math.max(0, r.romance - 10);
            
            r.age++;
            
            // --- NPC GROWTH (Every 5 years until 30) ---
            if (r.age <= 30 && r.age % 5 === 0) {
                const conMod = Math.floor((r.stats.con - 10) / 2);
                const wisMod = Math.floor((r.stats.wis - 10) / 2);
                
                const hpGain = Math.max(1, Math.floor(Math.random() * 4) + 1 + conMod);
                const spGain = Math.max(1, Math.floor(Math.random() * 4) + 1 + wisMod);
                
                // Initialize Max Sanity for NPCs if missing
                if (typeof r.maxSanity === 'undefined') {
                    const chaMod = Math.floor((r.stats.cha - 10) / 2);
                    r.maxSanity = Math.max(1, 8 + wisMod + chaMod);
                    r.sanity = r.maxSanity;
                }

                r.maxHp += hpGain;
                r.hp += hpGain; // Heal the new amount
                r.maxSanity += spGain;
                r.sanity += spGain;
            }

            // Dynamic Death Chance for NPCs (Old Age)
            let deathChance = 0.005; // 0.5% base chance (accidents/sickness)
            
            if (r.age > 55) {
                // Curve starts gentle, gets steep
                deathChance += (r.age - 55) * 0.002; 
            }
            
            // Hard cap check for very old age (increasing rapidly after 80)
            if (r.age > 80) {
                deathChance += 0.10; // +10% flat risk per year after 80
            }

            if (Math.random() < deathChance) {
                r.health = "Deceased";
                
                // --- NEW WACKY DEATH SYSTEM ---
                let cause = "passed away";
                const dieRoll = Math.random();

                if (r.age > 75) {
                    // Old Age dominates, but small chance of weirdness
                    if (dieRoll < 0.90) cause = DEATH_CAUSES.old[Math.floor(Math.random() * DEATH_CAUSES.old.length)];
                    else cause = DEATH_CAUSES.common[Math.floor(Math.random() * DEATH_CAUSES.common.length)];
                } else if (r.age < 50) {
                    // Premature deaths
                    if (dieRoll < 0.5) cause = DEATH_CAUSES.common[Math.floor(Math.random() * DEATH_CAUSES.common.length)];
                    else if (dieRoll < 0.8) cause = DEATH_CAUSES.violent[Math.floor(Math.random() * DEATH_CAUSES.violent.length)];
                    else cause = DEATH_CAUSES.fantasy[Math.floor(Math.random() * DEATH_CAUSES.fantasy.length)];
                } else {
                    // Middle age mix
                    if (dieRoll < 0.7) cause = DEATH_CAUSES.common[Math.floor(Math.random() * DEATH_CAUSES.common.length)];
                    else cause = DEATH_CAUSES.fantasy[Math.floor(Math.random() * DEATH_CAUSES.fantasy.length)];
                }
                
                // NEW: Record Death Details
                r.deathCause = cause;
                r.deathYear = state.year;

                // EDITED: Only log death if NPC is KNOWN to player
                if (r.isKnown) {
                    log(`<span style="color:var(--failure)">‚Ä† Your ${r.relation} ${r.name} has ${cause} at age ${r.age}.</span>`);
                    if(r.friendship > 20 || r.isFamily) modSanity(-1);
                }
                
                return; 
            }

            // NEW: Job Acquisition for Youth
            if (r.occupation === "Child" && r.age >= 12 && Math.random() < 0.3) {
                 const jobKey = jobs[Math.floor(Math.random() * jobs.length)];
                 const career = CAREERS[jobKey];
                 r.occupation = career.ranks[0].title;
                 if (r.isKnown) {
                    log(`<span style="color:var(--ink)">Career:</span> Your ${r.relation} ${r.name} has begun working as a ${r.occupation}.`);
                 }
            }

            // Existing Job Switching Logic (Modified for logging)
            if (r.age > 16 && r.occupation !== "Child") {
                if (Math.random() < 0.05) {
                     // UPDATED: Assign specific rank title on job change with Age Logic
                     const jobKey = jobs[Math.floor(Math.random() * jobs.length)];
                     const career = CAREERS[jobKey];
                     
                     let newRankIdx = 0;
                     const maxR = career.ranks.length - 1;
                     
                     // Older NPCs land higher positions when switching/promoting
                     if (r.age > 50) newRankIdx = Math.random() > 0.4 ? maxR : Math.min(1, maxR);
                     else if (r.age > 30) newRankIdx = Math.min(Math.floor(Math.random() * (maxR + 1)), maxR);
                     
                     const rank = career.ranks[newRankIdx];
                     if (r.occupation !== rank.title) {
                        r.occupation = rank.title;
                        if (r.isKnown) {
                            log(`<span style="color:var(--ink)">Career:</span> Your ${r.relation} ${r.name} is now a ${r.occupation}.`);
                        }
                     }
                }
            }
            
            // --- THE LIVING LINEAGE: MARRIAGE & CHILDREN ---
            // Expanded to include Spouses/In-Laws AND MOTHER for NPC pregnancy logic
            if (['Sibling', 'Son', 'Daughter', 'Spouse', 'Daughter-in-Law', 'Mother'].includes(r.relation) && r.health !== 'Deceased') {
                // Marriage Chance (18+, not married)
                if (r.age >= 18 && !r.isMarried && Math.random() < 0.1 && r.relation !== 'Spouse' && r.relation !== 'Mother') {
                    r.isMarried = true;
                    
                    // Generate Spouse
                    const spouseGender = r.gender === 'Male' ? 'Female' : 'Male';
                    const spouseName = getRandomName(spouseGender);
                    
                    let inLawRel = 'In-Law';
                    if (r.relation === 'Sibling') inLawRel = r.gender === 'Male' ? 'Sister-in-Law' : 'Brother-in-Law';
                    else if (r.relation === 'Son') inLawRel = 'Daughter-in-Law';
                    else if (r.relation === 'Daughter') inLawRel = 'Son-in-Law';

                    const spouse = addRelationship(spouseName, inLawRel, 50, spouseGender, "Commoner", r.locationIndex, false, true, r.age, true);
                    
                    // Link Spouses
                    r.spouseId = spouse.id;
                    spouse.spouseId = r.id;
                    spouse.isMarried = true;

                    // Add to house if noble (assumption: they marry into the family or are tracked)
                    if (state.house) {
                        addHouseMember(spouseName, spouseGender, "House Member", r.locationIndex, spouse.id);
                    }

                    if (r.isKnown) {
                        log(`<strong style="color:var(--gold)">Marriage:</strong> Your ${r.relation} ${r.name} married ${spouseName}.`);
                        
                        // NEW: Wedding Invitation Event
                        // If player is close enough or family, they get invited. Age Check: 10+
                        if (state.age >= 10 && (r.friendship > 30 || r.isFamily)) {
                            state.eventQueue.push({
                                id: `wedding_invite_${r.id}`,
                                title: 'Wedding Invitation',
                                text: `You have received an invitation to the wedding of your ${r.relation} <strong>${r.name}</strong> and ${spouseName}.`,
                                choices: [
                                    { 
                                        text: 'Attend with Gift (15g)', 
                                        type: 'flavor', 
                                        req: s => s.gold >= 15, 
                                        effect: () => { 
                                            state.gold -= 15; 
                                            modRel(r.id, 25); 
                                            modSanity(5);
                                            log(`You attended the wedding and presented a fine gift. ${r.name} was touched. (+5 SP)`); 
                                        } 
                                    },
                                    { 
                                        text: 'Attend Ceremony', 
                                        type: 'flavor', 
                                        effect: () => { 
                                            modRel(r.id, 10); 
                                            modSanity(3);
                                            log(`You attended the ceremony to show your support. (+3 SP)`); 
                                        } 
                                    },
                                    { 
                                        text: 'Send Regrets', 
                                        type: 'flavor', 
                                        effect: () => { 
                                            modRel(r.id, -5); 
                                            log(`You declined the invitation. ${r.name} was disappointed.`); 
                                        } 
                                    }
                                ]
                            });
                        }
                    }
                }

                // --- NEW: GESTATION SYSTEM (NPCs) ---
                
                // 1. Give Birth (if pregnant from previous year)
                if (r.isPregnant) {
                    // ARCANE UPDATE: Defer House Births to simulateHouseAI for Dynastic Events
                    const isHouseMember = state.house && state.house.members && state.house.members.some(m => m.id === r.id);
                    
                    if (!isHouseMember) {
                        r.isPregnant = false;
                        
                        // MULTIPLE BIRTH CHECK FOR NPCs
                        const numBirths = getBirthCount();
                        const birthLogNames = [];

                        for(let i=0; i<numBirths; i++) {
                            let childRel = 'Relative';
                            if (r.relation === 'Sibling') childRel = Math.random() > 0.5 ? 'Nephew' : 'Niece';
                            else if (r.relation === 'Son' || r.relation === 'Daughter' || r.relation === 'Daughter-in-Law') childRel = Math.random() > 0.5 ? 'Grandson' : 'Granddaughter';
                            else if (r.relation === 'Spouse') childRel = Math.random() > 0.5 ? 'Son' : 'Daughter';
                            else if (r.relation === 'Mother') childRel = 'Sibling'; // NEW: Mother has another child -> Sibling

                            const gender = (childRel === 'Nephew' || childRel === 'Grandson' || childRel === 'Son' || (childRel === 'Sibling' && Math.random()>0.5)) ? 'Male' : 'Female';
                            // Fix for generic Sibling label gender match logic is handled by display logic mostly, but let's be safe
                            
                            const childName = getRandomName(gender);
                            birthLogNames.push(childName);
                            
                            // Create the child
                            const child = addRelationship(childName, childRel, 50, gender, "Commoner", r.locationIndex, true, true, 0);
                            
                            // Link Parents
                            child.motherId = r.id;
                            child.fatherId = r.pregnancyFatherId || r.spouseId; // Prioritize tracked father
                            
                            // Genetics
                            // Father might be player if spouse gave birth
                            let fatherObj = null;
                            if (child.fatherId === 'PLAYER') {
                                fatherObj = { appearance: state.appearance, id: 'PLAYER' };
                            } else {
                                fatherObj = state.relationships.find(x => x.id === child.fatherId);
                            }
                            
                            const pFather = fatherObj || { appearance: GeneticEngine.generate() };
                            child.appearance = GeneticEngine.mix(pFather, r); // r is Mother
                        }
                        
                        if (r.isKnown) {
                            const typeText = numBirths > 1 ? (numBirths === 2 ? 'Twins' : (numBirths === 3 ? 'Triplets' : 'Quadruplets')) : 'baby';
                            
                            if (r.relation === 'Mother') {
                                log(`<strong style="color:var(--gold)">Family:</strong> Your mother gave birth to ${typeText}: ${birthLogNames.join(', ')}. You have new siblings!`);
                            } else {
                                log(`<strong style="color:var(--gold)">Family:</strong> ${r.name} gave birth to ${typeText}: ${birthLogNames.join(', ')}.`);
                            }
                        }
                    }
                }

                // 2. Conception Roll (Females Only)
                // Conditions: Female, Age 18-45, Not Pregnant, Not Dead
                if (r.gender === 'Female' && r.age >= 18 && r.age <= 45 && !r.isPregnant) {
                    // Married=15%, Single=1%
                    const fertility = (r.isMarried ? 0.15 : 0.01);
                    
                    if (Math.random() < fertility) {
                        r.isPregnant = true;
                        // If married to Player, father is Player
                        if (r.spouseId === 'PLAYER' || r.relation === 'Spouse') {
                            r.pregnancyFatherId = 'PLAYER';
                        } else {
                            r.pregnancyFatherId = r.spouseId;
                        }
                        
                        if (r.isKnown) {
                            log(`<span style="color:var(--ink)">News:</span> Your ${r.relation} ${r.name} is with child.`);
                        }
                    }
                }
            }
        });
    }

    function simulateHouseAI() {
        if (!state.house || state.socialClass !== 'House') return;
        
        // --- ARCANE UPDATE: DYNASTIC GROWTH (House Births) ---
        // Process births for House Members here to frame them as major events
        state.house.members.forEach(m => {
            if (m.id === 'PLAYER') return;
            const r = state.relationships.find(x => x.id === m.id);
            
            if (r && r.isPregnant) {
                r.isPregnant = false;
                
                // MULTIPLE BIRTH CHECK
                const numBirths = getBirthCount();
                const birthLogNames = [];

                for(let i=0; i<numBirths; i++) {
                    let childRel = 'Kinsman';
                    // Determine relation to PLAYER
                    if (r.relation === 'Sibling') childRel = Math.random() > 0.5 ? 'Nephew' : 'Niece';
                    else if (r.relation === 'Son' || r.relation === 'Daughter' || r.relation === 'Daughter-in-Law') childRel = Math.random() > 0.5 ? 'Grandson' : 'Granddaughter';
                    else if (r.relation === 'Spouse') childRel = Math.random() > 0.5 ? 'Son' : 'Daughter';
                    else if (r.relation === 'Mother') childRel = 'Sibling';

                    const gender = (childRel === 'Nephew' || childRel === 'Grandson' || childRel === 'Son' || (childRel === 'Sibling' && Math.random()>0.5)) ? 'Male' : 'Female';
                    
                    const childName = getRandomName(gender);
                    birthLogNames.push(childName);
                    
                    // Create the child
                    const child = addRelationship(childName, childRel, 50, gender, "House Member", r.locationIndex, true, true, 0);
                    
                    // Link Parents
                    child.motherId = r.id;
                    child.fatherId = r.pregnancyFatherId || r.spouseId;
                    
                    // Genetics
                    let fatherObj = null;
                    if (child.fatherId === 'PLAYER') {
                        fatherObj = { appearance: state.appearance, id: 'PLAYER' };
                    } else {
                        fatherObj = state.relationships.find(x => x.id === child.fatherId);
                    }
                    
                    const pFather = fatherObj || { appearance: GeneticEngine.generate() };
                    child.appearance = GeneticEngine.mix(pFather, r); 

                    // Add to House
                    addHouseMember(childName, gender, "House Member", r.locationIndex, child.id);
                }
                
                // HOUSE EVENT LOGGING & FLAVOR
                const typeText = numBirths > 1 ? (numBirths === 2 ? 'Twins' : 'Triplets') : 'a child';
                
                // Significant Event if close family
                if (['Sibling', 'Spouse', 'Daughter', 'Son', 'Mother'].includes(r.relation)) {
                     state.eventQueue.push({
                        id: `house_birth_${r.id}`,
                        title: 'The Line Continues',
                        text: `Joyous news rings through the halls of House ${state.house.name}! Your ${r.relation} <strong>${r.name}</strong> has given birth to ${typeText}: <strong>${birthLogNames.join(', ')}</strong>.<br><br>The dynasty is secure.`,
                        choices: [
                            { text: 'Celebrate', type: 'flavor', effect: () => { modSanity(5); log(`You celebrated the new life in your House.`); } }
                        ]
                    });
                } else {
                    // Standard House Log
                    log(`<strong style="color:var(--royal)">HOUSE EVENT:</strong> ${r.name} gave birth to ${birthLogNames.join(', ')}. The House grows stronger.`);
                }
            }
        });

        // --- NEW: SPOUSE HEIR REQUEST ---
        const spouse = state.relationships.find(r => r.relation === 'Spouse' && r.health !== 'Deceased');
        if (spouse && state.gender !== spouse.gender && !state.flags.isPregnant && !spouse.isPregnant) {
             const isFemale = state.gender === 'Female';
             // Simple fertility check
             const pFertile = isFemale ? (state.age >= 18 && state.age <= 45) : (state.age >= 18 && state.age < 60);
             const sFertile = isFemale ? (spouse.age >= 18 && spouse.age < 60) : (spouse.age >= 18 && spouse.age <= 45);
             
             if (pFertile && sFertile && Math.random() < 0.15) {
                 state.eventQueue.push({
                    id: 'house_heir_req',
                    title: 'The Future of the House',
                    text: `Your ${spouse.relation} ${spouse.name} finds you in a quiet moment. "The House depends on its bloodline," they say, taking your hand. "It is time we ensured our legacy."`,
                    choices: [
                        { 
                            text: 'Start Family', 
                            type: 'check', stat: 'con', dc: 10, 
                            success: 'Nature smiles upon you.', 
                            fail: 'Despite the effort, no child is conceived.', 
                            onSuccess: () => { 
                                modRel(spouse.id, 20, 15);
                                if (isFemale) {
                                    state.flags.isPregnant = true;
                                    state.flags.pregnancyPartnerId = spouse.id;
                                    log("You are with child!");
                                } else {
                                    spouse.isPregnant = true;
                                    spouse.pregnancyFatherId = 'PLAYER';
                                    log(`${spouse.name} is with child!`);
                                }
                            }, 
                            onFail: () => { 
                                modRel(spouse.id, 10, 5); 
                                log("You tried, but it was not meant to be this year."); 
                            } 
                        },
                        { 
                            text: 'Not Yet', 
                            type: 'flavor', 
                            effect: () => { 
                                modRel(spouse.id, -15, -10); 
                                log(`${spouse.name} withdraws, visibly disappointed.`); 
                            } 
                        }
                    ]
                });
                return; // Priority over other AI actions
             }
        }

        // Find Ruler
        const ruler = state.house.members.find(m => 
            (m.rank.includes('Lord') && !m.rank.includes('Emeritus')) || 
            (m.rank.includes('Lady') && !m.rank.includes('Dowager'))
        );

        if (!ruler || ruler.id === 'PLAYER') return; // Player controls house

        const rulerNPC = state.relationships.find(r => r.id === ruler.id);
        if (!rulerNPC || rulerNPC.health === 'Deceased') return; 

        // --- NEW: AGE 16 CAREER DEMAND ---
        if (state.age === 16 && !state.occupation) {
            // MODIFIED: Changed from unshift to push to ensure it happens after age/social events
            state.eventQueue.push({
                id: 'house_career_demand',
                title: 'Family Expectations',
                text: `Your ${rulerNPC.relation} ${rulerNPC.name} summons you to the solar. The hearth fire crackles, but their gaze is cold.<br><br>"You are sixteen now, ${state.name}. It is time you contributed to the House's legacy. I expect you to take up a vocation befitting your station. Do not idle away your bloodline."`,
                choices: [
                    { 
                        text: 'Study Diplomacy', 
                        type: 'flavor', 
                        effect: () => { 
                            modRel(rulerNPC.id, 10);
                            log("You vowed to serve the House with words and wit.");
                            attemptJob('diplomat'); 
                        } 
                    },
                    { 
                        text: 'Serve the Faith', 
                        type: 'flavor', 
                        effect: () => { 
                            modRel(rulerNPC.id, 5);
                            log("You chose to represent the House within the Clergy.");
                            attemptJob('clergy'); 
                        } 
                    },
                    { 
                        text: 'Refuse', 
                        type: 'flavor', 
                        effect: () => { 
                            modRel(rulerNPC.id, -30); 
                            modRep('infamy', 5);
                            log(`<span style="color:var(--failure)">DISAPPOINTMENT:</span> You refused your ${rulerNPC.relation}'s command. "Useless," they mutter. Your standing in the House falls.`); 
                        } 
                    }
                ]
            });
            return; // Priority Event - Skip other AI actions this turn
        }
        // ---------------------------------

        // AI Logic: Ruler manages assets
        
        // 1. Upgrade existing (Priority: Defense or Cap)
        // AI is now more aggressive if treasury allows (keep 20% reserve)
        const reserve = state.house.treasury * 0.2;
        const availableGold = state.house.treasury - reserve;

        const holdings = state.house.holdings;
        // Filter for affordable upgrades
        const affordableUpgrades = holdings
            .map((h, i) => ({ index: i, cost: getHoldingUpgradeCost(h.type, h.level), type: h.type, level: h.level, name: h.name, popRatio: h.population/h.capacity }))
            .filter(u => availableGold >= u.cost);

        // Sort by necessity (High pop ratio first)
        affordableUpgrades.sort((a, b) => b.popRatio - a.popRatio);

        // 50% Chance to upgrade if affordable
        if (affordableUpgrades.length > 0 && Math.random() < 0.5) {
            const upgrade = affordableUpgrades[0]; // Pick most urgent
            state.house.treasury -= upgrade.cost;
            
            const h = state.house.holdings[upgrade.index];
            h.level++;
            
            const tmpl = HOLDING_TEMPLATES[h.type] || HOLDING_TEMPLATES['Manor'];
            h.capacity = tmpl.basePop + (h.level * tmpl.capPerLvl);
            h.defense = tmpl.baseDef + (h.level * tmpl.defPerLvl);
            
            // Population boost from construction attraction
            h.population += Math.floor(tmpl.capPerLvl * 0.1); 
            
            log(`<strong style="color:var(--royal)">HOUSE:</strong> Your ${rulerNPC.relation} ${rulerNPC.name} ordered the expansion of <strong>${h.name}</strong> (Lvl ${h.level}).`);
            return; // One major action per year
        }

        // 2. Purchase New (Secondary)
        // If rich (high treasury), buy more land
        if (Math.random() < 0.3 && availableGold > 2000) {
            const types = ['Farm', 'Manor', 'Keep'];
            // Bias towards what they can afford
            const affordableTypes = types.filter(t => HOLDING_TEMPLATES[t].baseCost <= availableGold);
            
            if (affordableTypes.length > 0) {
                const type = affordableTypes[Math.floor(Math.random() * affordableTypes.length)];
                const tmpl = HOLDING_TEMPLATES[type];
                
                state.house.treasury -= tmpl.baseCost;
                
                const descriptor = tmpl.descriptors[Math.floor(Math.random() * tmpl.descriptors.length)];
                const formats = [`${state.house.name} ${descriptor}`, `The ${descriptor}`, `${descriptor} of ${state.house.name}`];
                const newName = formats[Math.floor(Math.random() * formats.length)];
                const desc = tmpl.descText[Math.floor(Math.random() * tmpl.descText.length)];

                state.house.holdings.push({
                    name: newName,
                    desc: desc,
                    type: type,
                    level: 1,
                    locationIndex: rulerNPC.locationIndex, 
                    population: Math.floor(tmpl.basePop * 0.5),
                    capacity: tmpl.basePop + tmpl.capPerLvl,
                    defense: tmpl.baseDef + tmpl.defPerLvl
                });
                log(`<strong style="color:var(--royal)">HOUSE:</strong> Your ${rulerNPC.relation} ${rulerNPC.name} commissioned the construction of <strong>${newName}</strong>.`);
                return; // Action taken
            }
        }

        // --- DYNASTIC MANAGEMENT (Arranged Marriages) ---
        
        // A. Arrange Player Marriage
        // Conditions: Player is unmarried, age 14-30, not the ruler themselves
        if (!state.flags.married && state.age >= 14 && state.age <= 30 && Math.random() < 0.15) {
            
            // Ensure a valid candidate is found
            let spouse = null;
            const isIncest = Math.random() < 0.4; // 40% Chance of keeping it in the family
            
            if (isIncest) {
                // Find unmarried relative of opposite gender in the House Members list
                const candidates = state.house.members.filter(m => 
                    m.id !== 'PLAYER' && 
                    m.gender !== state.gender && 
                    // Check logic: find their NPC object to check marriage status
                    (() => {
                        const rel = state.relationships.find(r => r.id === m.id);
                        return rel && !rel.isMarried && rel.health !== 'Deceased' && rel.age > 12;
                    })()
                );
                
                if (candidates.length > 0) {
                    const targetMember = candidates[Math.floor(Math.random() * candidates.length)];
                    spouse = state.relationships.find(r => r.id === targetMember.id);
                }
            }
            
            if (!spouse) {
                // External Match: Generate new noble
                const sGender = state.gender === 'Male' ? 'Female' : 'Male';
                spouse = addRelationship(getRandomName(sGender), "Suitor", 50, sGender, "Noble", state.location, false, false, 14 + Math.floor(Math.random()*10));
                // Give them a house name flavor
                const houseName = HOUSE_NAMES.lesser[Math.floor(Math.random() * HOUSE_NAMES.lesser.length)];
                spouse.occupation = `Noble of House ${houseName}`; // Fake title for flavor
            }

            if (spouse) {
                state.eventQueue.push({
                    id: 'house_marriage_' + state.age,
                    title: 'Arranged Marriage',
                    text: `Your ${rulerNPC.relation} ${rulerNPC.name} has arranged a union to strengthen the House.<br><br>
                           Candidate: <strong>${spouse.name}</strong> (${spouse.age}, ${spouse.occupation})<br>
                           <button class="text-xs underline text-amber-900 mt-2" onclick="openNPC('${spouse.id}')">Inspect Candidate Details</button>`,
                    choices: [
                        { 
                            text: 'Accept Duty', 
                            type: 'flavor', 
                            effect: () => { 
                                marryNPC(spouse.id); 
                                modRel(rulerNPC.id, 20); 
                                modRep('honor', 10); 
                                
                                // NEW: Treasury Funding Logic
                                let weddingType = 'Simple Ceremony';
                                let cost = 50;
                                
                                if (state.house.treasury >= 1500) {
                                    weddingType = 'Royal Extravaganza';
                                    cost = 1000;
                                    modRep('renown', 50);
                                } else if (state.house.treasury >= 500) {
                                    weddingType = 'Grand Feast';
                                    cost = 200;
                                    modRep('renown', 15);
                                }
                                
                                if (state.house.treasury >= cost) {
                                    state.house.treasury -= cost;
                                    log(`<span style="color:var(--royal)">DUTY:</span> You accepted the match. Your ${rulerNPC.relation} ${rulerNPC.name} funded a <strong>${weddingType}</strong> (${cost}g) from the treasury.`); 
                                } else {
                                    log(`<span style="color:var(--royal)">DUTY:</span> You accepted the match. The House treasury could only afford a modest blessing.`);
                                }
                            } 
                        },
                        { 
                            text: 'Refuse', 
                            type: 'flavor', 
                            effect: () => { 
                                modRel(rulerNPC.id, -30); 
                                modRep('infamy', 5); 
                                log(`<span style="color:var(--failure)">REFUSAL:</span> You spurned your ${rulerNPC.relation}'s arrangement. Tension rises in the House.`); 
                            } 
                        }
                    ]
                });
                return; // Priority event
            }
        }

        // B. Arrange NPC Marriages
        // Iterate through unmarried house members
        const marriageCandidates = state.house.members.filter(m => {
            if (m.id === 'PLAYER') return false; // Handled above
            const rel = state.relationships.find(r => r.id === m.id);
            return rel && !rel.isMarried && rel.health !== 'Deceased' && rel.age >= 16 && rel.age < 40;
        });

        if (marriageCandidates.length > 0 && Math.random() < 0.2) {
            const targetMember = marriageCandidates[Math.floor(Math.random() * marriageCandidates.length)];
            const targetNPC = state.relationships.find(r => r.id === targetMember.id);
            
            // Decide Outcome: 80% Accept, 20% Reject
            if (Math.random() < 0.8) {
                // Find Spouse (Internal or External)
                const sGender = targetNPC.gender === 'Male' ? 'Female' : 'Male';
                let spouseNPC = null;
                let spouseName = "";
                
                // 30% Chance Incest (Find another member)
                const internalCandidates = marriageCandidates.filter(m => m.id !== targetMember.id && m.gender === sGender);
                
                if (Math.random() < 0.3 && internalCandidates.length > 0) {
                    const intSpouseMem = internalCandidates[Math.floor(Math.random() * internalCandidates.length)];
                    spouseNPC = state.relationships.find(r => r.id === intSpouseMem.id);
                    spouseName = spouseNPC.name + " (Cousin)";
                } else {
                    // External Generation
                    const extHouse = HOUSE_NAMES.lesser[Math.floor(Math.random() * HOUSE_NAMES.lesser.length)];
                    spouseName = `${getRandomName(sGender)} of House ${extHouse}`;
                    // We generate them fully so they exist in system
                    spouseNPC = addRelationship(spouseName.split(' ')[0], "In-Law", 30, sGender, "Noble", targetNPC.locationIndex, false, true, targetNPC.age - 2 + Math.floor(Math.random()*5));
                    // Don't add external spouse to house members list (simplification) unless player cares? 
                    // Actually, let's track them if it's a House game.
                    addHouseMember(spouseNPC.name, sGender, "In-Law", targetNPC.locationIndex, spouseNPC.id);
                }

                // Execute Marriage
                targetNPC.isMarried = true;
                targetNPC.spouseId = spouseNPC.id;
                spouseNPC.isMarried = true;
                spouseNPC.spouseId = targetNPC.id;
                
                // NEW: Treasury Logic for NPC
                let weddingType = 'Simple Ceremony';
                let cost = 50;
                let funded = false;
                
                if (state.house.treasury >= 1500) {
                    weddingType = 'Royal Extravaganza';
                    cost = 1000;
                } else if (state.house.treasury >= 500) {
                    weddingType = 'Grand Feast';
                    cost = 200;
                }
                
                if (state.house.treasury >= cost) {
                    state.house.treasury -= cost;
                    funded = true;
                }

                if (funded) {
                    log(`<strong style="color:var(--royal)">HOUSE:</strong> Your ${rulerNPC.relation} ${rulerNPC.name} arranged a <strong>${weddingType}</strong> (${cost}g) between your ${targetNPC.relation} ${targetNPC.name} and ${spouseName}.`);
                } else {
                    log(`<strong style="color:var(--royal)">HOUSE:</strong> Your ${rulerNPC.relation} ${rulerNPC.name} arranged a humble marriage between your ${targetNPC.relation} ${targetNPC.name} and ${spouseName}.`);
                }
                
                // Trigger invite for player if they know the NPC. Age Check: 10+
                if (state.age >= 10 && targetNPC.isKnown && (targetNPC.friendship > 20 || targetNPC.isFamily)) {
                     state.eventQueue.push({
                        id: `wedding_invite_npc_${targetNPC.id}`,
                        title: 'Wedding Invitation',
                        text: `You are invited to the arranged wedding of your ${targetNPC.relation} ${targetNPC.name}.`,
                        choices: [
                            { text: 'Attend', type: 'flavor', effect: () => { modRel(targetNPC.id, 10); modSanity(2); log("You paid your respects at the wedding. (+2 SP)"); } },
                            { text: 'Ignore', type: 'flavor', effect: () => log("You did not attend.") }
                        ]
                    });
                }

            } else {
                log(`<strong style="color:var(--stress)">SCANDAL:</strong> Your ${targetNPC.relation} ${targetNPC.name} publicly refused a marriage arranged by ${rulerNPC.name}!`);
            }
            return;
        }

        // 3. Withdraw (Personal Expenses)
        if (Math.random() < 0.15 && state.house.treasury > 500) {
            const amt = 50 + Math.floor(Math.random() * 200);
            state.house.treasury -= amt;
            log(`<strong style="color:var(--royal)">HOUSE:</strong> Your ${rulerNPC.relation} ${rulerNPC.name} withdrew ${amt}g from the treasury for courtly expenses.`);
        }

        // 4. Member Contributions
        // NPCs with sufficient personal wealth may donate to the treasury
        
        // ARCANE UPDATE: Aggregation Variables
        let totalContributed = 0;
        let contributorNames = [];

        state.house.members.forEach(m => {
            if (m.id === 'PLAYER') return; // Player donates manually
            const npc = state.relationships.find(r => r.id === m.id);
            if (!npc || npc.health === 'Deceased') return;

            // Check if NPC is wealthy enough to contribute (> 100g)
            if (npc.gold > 100 && Math.random() < 0.15) {
                // They donate 10-30% of their wealth
                const percent = 0.10 + (Math.random() * 0.20);
                const donation = Math.floor(npc.gold * percent);
                
                if (donation > 0) {
                    npc.gold -= donation;
                    state.house.treasury += donation;
                    
                    // ARCANE UPDATE: Aggregate instead of log immediately
                    if (donation >= 10) {
                        totalContributed += donation;
                        // Avoid duplicates in name list if same person somehow triggers twice (unlikely but safe)
                        if (!contributorNames.includes(npc.name)) {
                            contributorNames.push(npc.name);
                        }
                    }
                }
            }
            
            // --- NEW: NPC TREASURY REQUESTS ---
            // If NPC is poor (< 20g) and not the ruler, they might ask for money
            // UPDATED: Age check added (16+)
            if (npc.gold < 20 && npc.id !== ruler.id && npc.age >= 16 && Math.random() < 0.2) {
                // Calculate amount based on rank
                let askAmt = 20;
                if (npc.rank.includes("Heir")) askAmt = 100;
                
                if (state.house.treasury >= askAmt) {
                    // Simulation Check (Simulated Charisma vs Lord)
                    const check = Math.floor(Math.random() * 20) + 1 + getModifier(npc.stats.cha);
                    
                    if (ruler.id === 'PLAYER') {
                        // PLAYER IS LORD: Generate Event
                        state.eventQueue.push({
                            id: `house_req_${npc.id}`,
                            title: 'Petition for Funds',
                            text: `Your ${npc.relation} ${npc.name} petitions the House for support. They ask for ${askAmt}g from the treasury. "Times are hard, my Lord."`,
                            choices: [
                                { 
                                    text: `Approve (${askAmt}g)`, 
                                    type: 'flavor', 
                                    effect: () => { 
                                        state.house.treasury -= askAmt; 
                                        npc.gold += askAmt; 
                                        modRel(npc.id, 10);
                                        log(`You granted ${npc.name}'s request for funds.`);
                                    } 
                                },
                                { 
                                    text: 'Deny', 
                                    type: 'flavor', 
                                    effect: () => { 
                                        modRel(npc.id, -10);
                                        log(`You denied ${npc.name}'s petition.`);
                                    } 
                                }
                            ]
                        });
                    } else {
                        // AI LORD DECISION
                        if (check >= 12) {
                            state.house.treasury -= askAmt;
                            npc.gold += askAmt;
                            // Only log if interesting
                            if(npc.isKnown && Math.random() > 0.5) {
                                log(`<span style="color:var(--ink)">House:</span> ${npc.name} was granted a stipend of ${askAmt}g from the treasury.`);
                            }
                        }
                    }
                }
            }
        });

        // ARCANE UPDATE: Log Consolidated Contributions
        if (totalContributed > 0) {
            let namesStr = "";
            if (contributorNames.length === 1) {
                namesStr = contributorNames[0];
            } else if (contributorNames.length === 2) {
                namesStr = `${contributorNames[0]} and ${contributorNames[1]}`;
            } else {
                const last = contributorNames.pop();
                namesStr = `${contributorNames.join(", ")}, and ${last}`;
            }
            log(`<strong style="color:var(--royal)">HOUSE:</strong> ${namesStr} contributed a total of ${totalContributed}g to the treasury.`);
        }

        // 5. FORCED SQUIRING (PC & NPC)
        const potentialSquires = state.house.members.filter(m => {
            const r = (m.id === 'PLAYER') ? { age: state.age, occupation: state.occupation, id: 'PLAYER' } : state.relationships.find(x => x.id === m.id);
            if (!r || r.health === 'Deceased') return false;
            // Age 8-14, Unemployed
            return r.age >= 8 && r.age <= 14 && !r.occupation;
        });

        potentialSquires.forEach(m => {
            if (Math.random() > 0.3) return; // 30% chance per year

            const isPlayer = m.id === 'PLAYER';
            const rulerIsPlayer = (ruler.id === 'PLAYER');

            if (rulerIsPlayer) {
                // Player is Lord: NPC asks Player
                if (!isPlayer) {
                    const npc = state.relationships.find(r => r.id === m.id);
                    state.eventQueue.push({
                        id: `squire_req_${m.id}`,
                        title: 'Petition for Training',
                        text: `Your kinsman <strong>${npc.name}</strong> (${npc.age}) approaches you. "My Lord, I wish to serve the House. Please assign me a knight."`,
                        choices: [
                            { 
                                text: 'Assign Master', 
                                type: 'flavor', 
                                effect: () => { 
                                    npc.occupation = "Squire"; 
                                    modRel(m.id, 15);
                                    log(`You assigned ${npc.name} to squire for a household knight.`);
                                } 
                            },
                            { text: 'Refuse', type: 'flavor', effect: () => { modRel(m.id, -10); log(`You denied ${npc.name}'s request.`); } }
                        ]
                    });
                }
            } else {
                // AI Lord
                if (isPlayer) {
                    // Lord forces Player
                    state.eventQueue.push({
                        id: 'force_squire_pc',
                        title: 'The Lord\'s Command',
                        text: `${rulerNPC.name} summons you. "You are idling away your potential. You shall squire immediately."`,
                        choices: [
                            { text: 'Accept', type: 'flavor', effect: () => { becomeSquire(null); modRel(rulerNPC.id, 5); } },
                            { text: 'Refuse', type: 'flavor', effect: () => { modRel(rulerNPC.id, -15); modRep('infamy', 2); log("You defied the Lord."); } }
                        ]
                    });
                } else {
                    // Lord forces NPC
                    const npc = state.relationships.find(r => r.id === m.id);
                    npc.occupation = "Squire";
                    if(npc.isKnown) log(`<span style="color:var(--ink)">House:</span> ${rulerNPC.name} ordered ${npc.name} to begin squiring.`);
                }
            }
        });
    }

    // NEW: Helper to get local ruler title for UI
    function getLocalRulerTitle(locationIndex) {
        const city = CITIES[locationIndex];
        // Hardcoded check for Chep (Capital) -> King
        if (city.name.includes("Chep")) return "King";
        
        // Check for Greater Houses -> Duke
        const greater = ["Valdoria", "Thalor", "Grimward", "Sunstrider", "Ironheart", "Moonshadow", "Stormbreaker"];
        if (greater.some(n => city.ruler.includes(n))) return "Duke";
        
        // Default
        return "Lord";
    }

    // --- ACTIVITIES ---
    function renderActivitiesTab() {
        const container = document.getElementById('act-content');
        if (state.age < 6) {
            container.innerHTML = `<p class="col-span-2 text-center italic mt-4">You are too young to explore the city alone.</p>`;
            return;
        }

        const lordTitle = getLocalRulerTitle(state.location);

        // Updated Activity Grid - Reordered & Labeled
        container.innerHTML = `
            <button onclick="actTrain()" class="act-btn choice-btn"><span class="act-icon">‚öîÔ∏è</span>Train <span class="text-[10px] opacity-70 block">(Age 8+)</span></button>
            <button onclick="actMeditate()" class="act-btn choice-btn"><span class="act-icon">üßò</span>Meditate</button>
            
            <button onclick="actSocialize()" class="act-btn choice-btn"><span class="act-icon">üçª</span>Socialize</button>
            <button onclick="actBrothel()" class="act-btn choice-btn"><span class="act-icon">‚ô•Ô∏è</span>Brothel <span class="text-[10px] opacity-70 block">(Age 18+)</span></button>
            
            <button onclick="actVisitLord()" class="act-btn choice-btn"><span class="act-icon">üëë</span>Visit ${lordTitle} <span class="text-[10px] opacity-70 block">(Age 16+, 50 Renown)</span></button>
            <button onclick="actTournament()" class="act-btn choice-btn"><span class="act-icon">üé™</span>Tournament <span class="text-[10px] opacity-70 block">(Age 16+)</span></button>
            
            <button onclick="actDungeon()" class="act-btn choice-btn"><span class="act-icon">üíÄ</span>Dungeon <span class="text-[10px] opacity-70 block">(Age 16+)</span></button>
            <button onclick="actCrime()" class="act-btn choice-btn"><span class="act-icon">üó°Ô∏è</span>Crime <span class="text-[10px] opacity-70 block">(Age 8+)</span></button>
        `;
    }

    // --- REVAMPED ACTIVITY HANDLERS ---

    function checkActLimit(type, max, failMsg) {
        if (state.activityLog[type] >= max) {
            log(`<span class="italic opacity-70">${failMsg}</span>`);
            switchTab('log');
            return false;
        }
        state.activityLog[type]++;
        return true;
    }

    function actSocialize() {
        if(state.health <= 0) return;
        // Age 6+ implied by tab visibility
        if(!checkActLimit('socialize', 3, "The taverns are empty and the streets quiet. You find no one of interest.")) return;

        const gender = Math.random() > 0.5 ? 'Male' : 'Female';
        const name = getRandomName(gender);
        const rank = Math.random() > 0.9 ? (gender === 'Male' ? 'Ser' : 'Dame') : "Commoner";
        
        // Dynamic Social Encounter
        const evt = createEvent('act_social', `Social Encounter`, `You spot ${name} (${rank}) in the city. They seem approachable.`, [
            { 
                text: 'Friendly Greeting', type: 'check', stat: 'cha', dc: 10, 
                success: 'You hit it off immediately! (+1 SP)', 
                fail: 'They nod politely but seem uninterested.',
                onSuccess: () => { addRelationship(name, "Friend", 35, gender, rank, state.location); modSanity(1); },
                onFail: () => { addRelationship(name, "Acquaintance", 10, gender, rank, state.location); }
            },
            {
                text: 'Flirt', type: 'check', stat: 'cha', dc: 12, req: s => s.age >= 14,
                success: 'They blush and smile back.',
                fail: 'They look uncomfortable.',
                onSuccess: () => { const r = addRelationship(name, "Love Interest", 20, gender, rank, state.location); r.romance = 30; },
                onFail: () => { addRelationship(name, "Acquaintance", -5, gender, rank, state.location); modSanity(-1); }
            },
            {
                text: 'Start Rivalry', type: 'check', stat: 'str', dc: 10,
                success: 'You insult them perfectly. A rivalry is born!',
                fail: 'They just laugh at you.',
                onSuccess: () => { addRelationship(name, "Rival", -30, gender, rank, state.location); modRep('infamy', 2); },
                onFail: () => { addRelationship(name, "Acquaintance", -10, gender, rank, state.location); }
            },
            { text: 'Walk Away', type: 'flavor', effect: () => log("You decide to keep to yourself.") }
        ]);
        renderEvent(evt);
        switchTab('log');
    }

    function actVisitLord() {
        if(state.health <= 0) return;
        if(!checkAge(16)) return;
        if(!checkActLimit('lord', 1, "The Lord is not accepting further audiences this year.")) return;

        const city = CITIES[state.location];
        const title = getLocalRulerTitle(state.location);
        const displayTitle = title === "King" ? "King/Queen" : (title === "Duke" ? "Duke/Duchess" : "Lord/Lady");

        if (state.reputation.renown < 50 && state.socialClass !== 'House') {
            log(`<strong class="text-red-800">Denied.</strong> The guards block your path. "The ${title} only grants audiences to those of name (50 Renown)."`);
            switchTab('log');
            return;
        }

        let dc = 18;
        if (state.socialClass === 'House') dc = 12;
        if (state.reputation.renown > 50) dc -= 5;
        
        const evt = createEvent('lord_approach', `Audience with the ${title}`, `You stand before the gates of the ${city.ruler}'s keep.`, [
            { 
                text: 'Request Audience', type: 'check', stat: 'cha', dc: dc, 
                success: `Granted! You meet the ${title}.`, 
                fail: `Denied. The guards turn you away.`, 
                onSuccess: () => {
                    log(`<strong class="text-green-800">Granted!</strong> The ${title} is impressed by your bearing. (+ Renown, +3 SP)`);
                    modRep('renown', 5);
                    modSanity(3);
                    renderEvent(POOLS.LordInteraction[0]);
                },
                onFail: () => {
                    log(`<strong class="text-red-800">Denied.</strong> The guards turn you away at the gate.`);
                }
            },
            { text: 'Leave', type: 'flavor', effect: () => log("You decide you are not ready.") }
        ]);
        renderEvent(evt);
        switchTab('log');
    }

    function actTournament() {
        if(state.health <= 0) return;
        if(!checkAge(16)) return;
        if(!checkActLimit('tournament', 1, "There are no active tournaments in the city right now.")) return;

        // ARCANE UPDATE: RESTRICT TO KNIGHTS
        // Must have 'knight' occupation AND be Rank 1 (Hedge Knight) or higher. Squires (Rank 0) cannot enter main lists.
        if (!state.occupation || state.occupation.id !== 'knight' || state.occupation.rankIndex < 1) {
            log(`<strong style="color:var(--royal)">Entry Denied:</strong> The Tournament Master blocks your path. "The lists are for anointed Knights only. Squires and Commoners may watch from the stands."`);
            switchTab('log');
            return;
        }

        // ARCANE UPDATE: USE BESTIARY FOR TOURNAMENT
        // Tier 1 (Hedge), Tier 2 (Sworn/Elite), Tier 3 (Champion/Legendary)
        const e1 = generateCreature('knight', 0, 'Standard');
        const e2 = generateCreature('knight', 1, 'Elite');
        const e3 = generateCreature('knight', 2, 'Legendary');

        // Round 3 (Final)
        const round3 = createEvent('tourney_r3', 'Tournament: The Final', `The Champion steps forward: <strong>${e3.name}</strong>. The crowd goes silent.`, [
            { 
              text: 'Duel (Combat)', type: 'combat', 
              enemy: e3,
              success: 'VICTORY! You disarm the champion to thunderous applause!', 
              fail: 'You are crushed.', 
              onSuccess: () => { modRep('renown', 50); state.gold += 200; addItem('Champion Helm', 'Rare', 'Proof of victory.', 150, null, 3); log("You won the Grand Prize: 200g!"); },
              onFail: () => { takeDamage(10); addTrait('Limp'); }
            },
            {
                text: 'Withdraw', type: 'flavor',
                effect: () => {
                    state.gold += 80;
                    modRep('renown', 20);
                    log("You withdraw with the runner-up purse (80g). A wise choice, perhaps.");
                }
            }
        ]);

        // Round 2
        const round2 = createEvent('tourney_r2', 'Tournament: Semi-Finals', `Your next opponent is <strong>${e2.name}</strong>.`, [
            { 
              text: 'Fight (Combat)', type: 'combat', 
              enemy: e2,
              success: 'You batter through their guard.',
              fail: 'They are too fast. (-5 HP)',
              onSuccess: () => state.eventQueue.unshift(round3),
              onFail: () => { takeDamage(5); log("Eliminated in Round 2."); }
            },
            {
                text: 'Withdraw', type: 'flavor',
                effect: () => {
                    state.gold += 20;
                    modRep('renown', 5);
                    log("You withdraw with the qualifier's purse (20g).");
                }
            }
        ]);

        // Round 1
        const round1 = createEvent('tourney_r1', 'Tournament: Qualifiers', `A challenger approaches: <strong>${e1.name}</strong>.`, [
            { 
              text: 'Joust (Combat)', type: 'combat', 
              enemy: e1,
              success: 'Your lance strikes true!',
              fail: 'You are unhorsed. (-5 HP)',
              onSuccess: () => state.eventQueue.unshift(round2),
              onFail: () => { takeDamage(5); log("Eliminated in Round 1."); }
            },
            {
                text: 'Withdraw', type: 'flavor',
                effect: () => log("You step down before the first bout. The crowd boos slightly.")
            }
        ]);

        const evt = createEvent('tourney_lobby', 'The Grand Tournament', 'Flags wave and the crowd roars. How will you participate?', [
            { 
                text: 'Enter Lists (Combat)', type: 'flavor', 
                effect: () => {
                    log(`<strong>The Grand Tournament:</strong> You enter the lists!`);
                    state.eventQueue.unshift(round1);
                }
            },
            {
                text: 'Watch (5g)', type: 'flavor',
                req: s => s.gold >= 5,
                effect: () => {
                    state.gold -= 5;
                    modSanity(2);
                    log("You enjoy a day of spectacle and cheering. (+2 Sanity)");
                }
            },
            { text: 'Leave', type: 'flavor', effect: () => log("You leave the grounds.") }
        ]);

        renderEvent(evt);
        switchTab('log');
    }

    function actTrain() {
        if(state.health <= 0) return;
        if(!checkAge(8)) return;
        if(!checkActLimit('train', 1, "Your body is exhausted. You cannot train anymore this year.")) return;

        const evt = createEvent('act_train', 'Training Grounds', 'What do you wish to improve?', [
            { text: 'Strength Drill', type: 'check', stat: 'str', dc: 12, success: 'You feel stronger! (+1 STR)', fail: 'You pull a muscle. No gain.', onSuccess: () => state.stats.str++, onFail: () => takeDamage(1) },
            { text: 'Agility Course', type: 'check', stat: 'dex', dc: 12, success: 'You feel faster! (+1 DEX)', fail: 'You trip and fall.', onSuccess: () => state.stats.dex++, onFail: () => takeDamage(1) },
            { text: 'Endurance Run', type: 'check', stat: 'con', dc: 12, success: 'You feel tougher! (+1 CON)', fail: 'You collapse breathless.', onSuccess: () => { state.stats.con++; state.maxHealth++; }, onFail: () => {} },
            { text: 'Library Study', type: 'check', stat: 'int', dc: 12, success: 'You feel smarter! (+1 INT)', fail: 'You fall asleep reading.', onSuccess: () => state.stats.int++, onFail: () => {} },
            { text: 'Leave', type: 'flavor', effect: () => log("You decide not to train today.") }
        ]);
        renderEvent(evt);
        switchTab('log');
    }

    function actBrothel() {
        if(state.health <= 0) return;
        if(!checkAge(18)) return;
        if(!checkActLimit('brothel', 3, "The establishment is closed for the night.")) return;

        const evt = createEvent('act_brothel', 'The Velvet Lantern', 'Music and perfume fill the air.', [
            { text: 'Common Company (10g)', type: 'flavor', req: s => s.gold >= 10, effect: () => { state.gold -= 10; modSanity(2); log("A pleasant distraction. (+2 SP)"); } },
            { text: 'Luxury Suite (50g)', type: 'flavor', req: s => s.gold >= 50, effect: () => { state.gold -= 50; modSanity(5); state.health = Math.min(state.maxHealth, state.health + 2); log("A night of pure hedonism. (+5 SP, +2 HP)"); } },
            { text: 'Gather Rumors (20g)', type: 'check', stat: 'cha', dc: 12, req: s => s.gold >= 20, success: 'You learn juicy secrets. (+Renown)', fail: 'You just get drunk.', onSuccess: () => { state.gold -= 20; modRep('renown', 5); }, onFail: () => { state.gold -= 20; } },
            { text: 'Leave', type: 'flavor', effect: () => log("You step back out into the fresh air.") }
        ]);
        renderEvent(evt);
        switchTab('log');
    }

    function actDungeon() {
        if(state.health <= 0) return;
        if(!checkAge(16)) return;
        if(!checkActLimit('dungeon', 1, "You have explored the local ruins enough for now.")) return;

        // Dynamic Dungeon Generator
        const loot = ['Ancient Coin', 'Silver Goblet', 'Gemstone', 'Magic Scroll'];
        const reward = loot[Math.floor(Math.random() * loot.length)];
        
        const evt = createEvent('act_dungeon', 'The Sunken Crypt', 'You descend into the dark, damp ruins.', [
            { text: 'Smash Door (STR)', type: 'check', stat: 'str', dc: 14, 
              success: `You bash through and find treasure! (+${reward})`, 
              fail: 'The door holds. You hurt your shoulder. (-HP)', 
              onSuccess: () => { addItem(reward, 'Uncommon', 'Dungeon loot', 50); modRep('renown', 2); }, 
              onFail: () => takeDamage(3) 
            },
            { text: 'Pick Lock (DEX)', type: 'check', stat: 'dex', dc: 14, 
              success: `Click. The chest opens! (+${reward})`, 
              fail: 'Trap triggered! Poison dart. (-HP)', 
              onSuccess: () => { addItem(reward, 'Uncommon', 'Dungeon loot', 50); }, 
              onFail: () => takeDamage(5) 
            },
            { text: 'Decipher Runes (INT)', type: 'check', stat: 'int', dc: 14, 
              success: 'You open a secret passage. (+Scroll)', 
              fail: 'You trigger a curse. (-Sanity)', 
              onSuccess: () => { addItem('Arcane Scroll', 'Rare', 'Ancient magic', 100); state.stats.int++; }, 
              onFail: () => { modSanity(-2); addTrait('Paranoid'); } 
            },
            { text: 'Leave', type: 'flavor', effect: () => log("The darkness is too forbidding today.") }
        ]);
        renderEvent(evt);
        switchTab('log');
    }

    function actCrime() {
        if(state.health <= 0) return;
        if(!checkAge(8)) return;
        if(!checkActLimit('crime', 3, "The guards are too alert right now. Lay low.")) return;

        const evt = createEvent('act_crime', 'Criminal Enterprise', 'Choose your target.', [
            { text: 'Pickpocket (Easy)', type: 'check', stat: 'dex', dc: 12, 
              success: 'Snagged a purse! (+10g)', 
              fail: 'Caught! You run. (+Infamy)', 
              onSuccess: () => { state.gold += 10; modRep('infamy', 1); }, 
              onFail: () => { modRep('infamy', 5); modRep('renown', -2); } 
            },
            { text: 'Burgle Shop (Medium)', type: 'check', stat: 'dex', dc: 15, 
              success: 'Cleaned out the register! (+50g)', 
              fail: 'Guard dog bit you. (-HP)', 
              onSuccess: () => { state.gold += 50; modRep('infamy', 3); }, 
              onFail: () => { takeDamage(5); modRep('infamy', 2); } 
            },
            { text: 'Heist Manor (Hard)', type: 'check', stat: 'int', dc: 18, 
              success: 'Jackpot! (+200g, +Infamy)', 
              fail: 'Arrested! Fined heavily.', 
              onSuccess: () => { state.gold += 200; modRep('infamy', 10); }, 
              onFail: () => { state.gold = Math.floor(state.gold / 2); modRep('infamy', 10); log("You spent months in jail."); } 
            },
            { text: 'Back Out', type: 'flavor', effect: () => log("You lose your nerve.") }
        ]);
        renderEvent(evt);
        switchTab('log');
    }

    function actMeditate() {
        if(state.health <= 0) return;
        if(!checkActLimit('meditate', 1, "Your mind is too cluttered to focus again.")) return;

        const evt = createEvent('act_meditate', 'Meditation', 'You seek inner peace.', [
            { text: 'Focus', type: 'check', stat: 'wis', dc: 12, 
              success: 'Clarity returns. (+1 SP)', 
              fail: 'Distracting thoughts plague you.', 
              onSuccess: () => modSanity(1), 
              onFail: () => {} 
            },
            { text: 'Stop', type: 'flavor', effect: () => log("You cannot find the time.") }
        ]);
        renderEvent(evt);
        switchTab('log');
    }

    // --- MAP SYSTEM ---
    function renderMapTab() {
        const container = document.getElementById('map-content');
        const visual = document.getElementById('map-visual');
        
        let visualHtml = '';
        CITIES.forEach((city, index) => {
            const isHere = state.location === index;
            const activeClass = isHere ? 'active' : '';
            visualHtml += `
                <div class="map-node ${activeClass}" style="left: ${city.x}%; top: ${city.y}%;" title="${city.name}">
                    <div class="map-label">${city.name}</div>
                </div>`;
        });
        visual.innerHTML = visualHtml;

        container.innerHTML = CITIES.map((city, index) => {
            const isHere = state.location === index;
            const extraClass = isHere ? 'current-city' : '';
            
            const currentCity = CITIES[state.location];
            const dist = Math.sqrt(Math.pow(city.x - currentCity.x, 2) + Math.pow(city.y - currentCity.y, 2));
            const travelTime = Math.min(10, Math.ceil(dist / 5)); 
            const cost = travelTime * 5; // 5 gold per month
            const timeText = travelTime === 0 ? "" : `(${travelTime} Mo, ${cost}g)`;

            let action = '';
            if (isHere) {
                action = `<span class="text-xs font-bold text-amber-900">Current Location</span>`;
            } else if (state.knighthood.isSworn) {
                action = `<button disabled class="text-xs bg-gray-800 text-gray-400 px-2 py-1 rounded cursor-not-allowed border border-gray-600" title="You are sworn to this post.">Sworn to Post</button>`;
            } else if (state.flags.traveledThisYear) {
                action = `<button disabled class="text-xs bg-gray-400 text-white px-2 py-1 rounded cursor-not-allowed">Travelled (Wait 1yr)</button>`;
            } else {
                action = `<button onclick="attemptTravel(${index})" class="text-xs bg-leather text-white px-2 py-1 rounded bg-[#5d4037]">Travel ${timeText}</button>`;
            }

            // --- NEW: Generate/Retrieve Lesser Houses ---
            if (!state.cityHouses[index]) {
                const numHouses = Math.floor(Math.random() * 6) + 1; // 1d6
                const houses = [];
                for(let i=0; i<numHouses; i++) {
                    const name = HOUSE_NAMES.lesser[Math.floor(Math.random() * HOUSE_NAMES.lesser.length)];
                    const sigil = TIER_DATA.lesser.sigils[Math.floor(Math.random() * TIER_DATA.lesser.sigils.length)];
                    // Simple deduplication
                    if (!houses.some(h => h.name === name)) {
                        houses.push({ name, sigil });
                    }
                }
                state.cityHouses[index] = houses;
            }

            let localHouses = [...state.cityHouses[index]];

            // Inject PC House if applicable
            // Logic: If PC is noble (state.house exists) and this city (index) is the location of their primary holding
            if (state.house && state.house.holdings && state.house.holdings.length > 0) {
                if (state.house.holdings[0].locationIndex === index) {
                    // Avoid duplicates if the random generator picked the same name
                    if (!localHouses.some(h => h.name === state.house.name)) {
                        localHouses.unshift({ name: state.house.name, sigil: state.house.sigil, isPC: true });
                    } else {
                        // If it exists, mark it as PC
                        const h = localHouses.find(h => h.name === state.house.name);
                        if(h) h.isPC = true;
                    }
                }
            }

            // ARCANE UPDATE: INJECT RULING GREATER/ROYAL HOUSE AT START
            let rulingBadge = '';
            if (city.ruler.includes('House')) {
                // Extract House Name from string like "Greater House Valdoria" or "Royal House Chep"
                const parts = city.ruler.split(' House ');
                if (parts.length > 1) {
                    const rulerName = parts[1];
                    const gHouse = GREATER_HOUSES_INFO[rulerName];
                    if (gHouse) {
                        // Clean Sigil (remove selection tags if present from copy-paste artifacts, though raw data should be clean)
                        const cleanSigil = gHouse.sigil.replace(/<[^>]*>/g, ''); 
                        rulingBadge = `<span class="inline-block bg-purple-100 border border-purple-300 text-purple-900 font-bold rounded px-1.5 py-0.5 text-[10px] mr-1 mb-1 shadow-sm" title="Ruling House">${cleanSigil} ${rulerName}</span>`;
                    }
                }
            }

            const houseListHtml = rulingBadge + localHouses.map(h => {
                const pcStyle = h.isPC ? 'border-amber-600 bg-amber-100 font-bold text-amber-900 ring-1 ring-amber-200 shadow-sm' : '';
                return `<span class="inline-block bg-white/50 border border-black/10 rounded px-1.5 py-0.5 text-[10px] mr-1 mb-1 ${pcStyle}" title="House ${h.name}">${h.sigil} ${h.name}</span>`;
            }).join('');
            
            return `
                <div class="city-card ${extraClass}">
                    <div>
                        <div class="font-bold text-lg">${city.name}</div>
                        <div class="text-xs font-bold text-royal">${city.ruler}</div>
                        <div class="text-xs italic opacity-80 mb-2">${city.desc}</div>
                        <div class="mt-2 pt-2 border-t border-black/5">
                            <div class="text-[9px] uppercase font-bold opacity-50 mb-1">Noble Houses</div>
                            <div class="flex flex-wrap">${houseListHtml}</div>
                        </div>
                    </div>
                    <div class="pl-2 border-l border-black/5 flex items-center">
                        ${action}
                    </div>
                </div>
            `;
        }).join('');
    }

    function attemptTravel(index) {
        if(state.health <= 0) return; // Guard
        if (!checkAge(8)) return;
        
        if (state.flags.traveledThisYear) {
            showMsg("Travel Weary", "You have already undertaken a journey this year. Rest a while.");
            return;
        }

        state.travelTarget = index;
        
        const city = CITIES[index];
        const currentCity = CITIES[state.location];
        const dist = Math.sqrt(Math.pow(city.x - currentCity.x, 2) + Math.pow(city.y - currentCity.y, 2));
        const months = Math.min(10, Math.ceil(dist / 5));
        const cost = months * 5;
        
        if (state.gold < cost) {
            showMsg("Cannot Travel", `You need ${cost} gold for supplies and safe passage.`);
            return;
        }

        const parents = [getParent('Father'), getParent('Mother')].filter(p => p && p.locationIndex === state.location);
        
        if (state.age < 16 && parents.length > 0 && !state.flags.travelAllowed) {
            renderEvent(POOLS.Permission[0]);
            switchTab('log');
        } else {
            travelTo(index);
        }
    }

    function travelTo(index) {
        const city = CITIES[index];
        const currentCity = CITIES[state.location];
        const dist = Math.sqrt(Math.pow(city.x - currentCity.x, 2) + Math.pow(city.y - currentCity.y, 2));
        const months = Math.min(10, Math.ceil(dist / 5));
        const cost = months * 5;
        
        state.gold -= cost;
        state.flags.traveledThisYear = true;
        log(`<strong>Travel:</strong> You paid ${cost}g and journeyed to ${city.name}. It took ${months} months.`);
        state.location = index;
        
        generateMarket(state.location); // REGENERATE MARKET ON TRAVEL

        const pool = POOLS.Travel;
        const event = pool[Math.floor(Math.random() * pool.length)];
        renderEvent(event);
        updateUI();
        switchTab('log');
    }

    function takeDamage(amt) {
        state.health -= amt;
        log(`<strong class="text-red-800">DAMAGE:</strong> You took ${amt} damage!`);
        updateUI();
        if (state.health <= 0) death();
    }

    function modSanity(amt) {
        state.sanity = Math.min(state.maxSanity, Math.max(0, state.sanity + amt));
    }

    // --- SETTINGS & NPC SHEETS ---
    function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
    function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }

    function toggleSoundSetting() {
        state.settings.sound = !state.settings.sound;
        document.getElementById('btn-sound-toggle').innerText = `Sound Effects: ${state.settings.sound ? 'ON' : 'OFF'}`;
    }

    function restartGame() { location.reload(); }
    
    function closeNPC() { document.getElementById('npc-modal').classList.add('hidden'); }

    // NEW: TRAIT POPUP LOGIC
    function showTraitInfo(name) {
        let desc = "A distinct feature acquired during your life.";
        let rarity = "Common";
        
        // 1. Check Mutations
        const mutation = MUTATION_POOL.find(m => m.name === name);
        if (mutation) {
            desc = mutation.desc;
            rarity = mutation.rarity;
        } 
        // 2. Check Acquired Traits
        else if (TRAIT_LIBRARY[name]) {
            desc = TRAIT_LIBRARY[name].desc;
            rarity = TRAIT_LIBRARY[name].rarity;
        }

        document.getElementById('trait-modal-title').innerText = name;
        document.getElementById('trait-modal-desc').innerText = desc;
        
        const badge = document.getElementById('trait-modal-badge');
        badge.innerText = rarity;
        // Reset classes and add dynamic styling
        badge.className = `gene-tag text-sm px-3 py-1 shadow-sm font-bold tracking-wider mut-${rarity.toLowerCase()}`;
        
        document.getElementById('trait-modal').classList.remove('hidden');
    }
    
    // NEW HELPER: Standardize NPC Name Display with Honorifics
    function getNPCName(r) {
        let n = r.name;
        
        // Knightly Prefix (System Update) - Ser for males, Dame for females
        // Prevent double-prefixing: skip if name already has Ser or Dame
        let prefix = "";
        const hasExistingPrefix = n.startsWith('Ser ') || n.startsWith('Dame ');
        const isJobKnight = r.occupation && r.occupation.includes('Knight');
        const isLegacyKnight = r.rank === 'Ser' || r.rank === 'Dame';
        
        if (!hasExistingPrefix && (isJobKnight || isLegacyKnight)) {
            prefix = r.gender === 'Female' ? "Dame " : "Ser ";
        }

        // Append House Name (If member of player's house)
        // ARCANE FIX: Ensure we don't double add if name already contains it
        if (state.house && state.house.members && state.house.members.some(m => m.id === r.id) && !n.includes(state.house.name)) {
            n += ` ${state.house.name}`;
        }
        // Append Occupational Honorific (Optional, kept simple for names)
        return prefix + n;
    }

    function openNPC(id) {
        // Removed death guard to allow viewing details after death
        const r = state.relationships.find(x => x.id === id);
        if(!r) return;
        const loc = CITIES[r.locationIndex].name;
        const isKnight = r.rank === 'Ser' || r.rank === 'Dame';
        
        // NEW: Calculate Birth Year
        const birthYear = state.year - r.age;

        // Determine Display Name using new helper
        const displayName = getNPCName(r);

        // --- CALC NPC ARMOR CLASS ---
        const npcDexMod = getModifier(r.stats.dex || 10);
        let npcAC = 10 + npcDexMod;
        // Abstract AC Bonus for combat professions (since inventory items aren't equipped)
        if (r.occupation && (r.occupation.includes('Knight') || r.occupation.includes('Guard') || r.occupation.includes('Soldier') || r.occupation.includes('Mercenary'))) {
            npcAC += 4; // Equivalent to Chain Shirt / Scale
        } else if (r.rank.includes('Noble') || r.rank.includes('Lord') || r.rank.includes('Lady')) {
            npcAC += 1; // Fine clothes/minor protection
        }

        // --- SUCCESSION & CLASS LOGIC ---
        let successionDisplay = '<span class="opacity-50 text-xs italic">N/A</span>';
        let socialClassDisplay = r.rank; // Default to stored rank
        let liegeDisplay = ''; // ARCANE UPDATE: NPC Liege Display

        // Check if member of player's house for succession calculation
        if (state.house && state.house.members) {
            const memberRec = state.house.members.find(m => m.id === r.id);
            
            if (memberRec) {
                // If they are in the house member list, clarify social class
                socialClassDisplay = `<span class="text-royal font-bold">Noble House</span>`;

                // Find current ruler to calculate line relative to them
                // UPDATED: Robust ruler check for titles
                let ruler = state.house.members.find(m => 
                    !m.rank.includes('Emeritus') && !m.rank.includes('Dowager') && !m.rank.includes('Mother') && !m.rank.includes('Consort') &&
                    (m.rank.includes('Lord') || m.rank.includes('Lady') || m.rank.includes('King') || m.rank.includes('Queen') || m.rank.includes('Duke') || m.rank.includes('Duchess'))
                );

                // ARCANE UPDATE: Determine Liege for House Members
                if (ruler) {
                    if (ruler.id === r.id) {
                        // They are the Head of House. Determine External Liege.
                        const houseName = state.house.name;
                        
                        if (houseName === 'Chep') {
                            liegeDisplay = `<span class="text-xs opacity-70 italic">The Crown (No Liege)</span>`;
                        } 
                        else if (GREATER_HOUSES_INFO[houseName]) {
                            // Greater House Duke -> Liege is King
                            liegeDisplay = `<p><strong>Liege:</strong> <span class="text-royal font-bold">The King (House Chep)</span></p>`;
                        } 
                        else {
                            // Lesser House -> Liege is City Ruler
                            const currentCity = CITIES[r.locationIndex];
                            let lordTitle = currentCity.ruler; // e.g. "Greater House Valdoria"
                            
                            if (lordTitle.includes("Chep")) {
                                lordTitle = "The King (House Chep)";
                            } else {
                                // Extract House Name for Duke title
                                const rulingHouse = lordTitle.replace("Greater House ", "").replace("Royal House ", "");
                                lordTitle = `Duke of ${rulingHouse}`;
                            }
                            liegeDisplay = `<p><strong>Liege:</strong> <span class="text-royal font-bold">${lordTitle}</span></p>`;
                        }
                    } else {
                        // They serve the ruler
                        // ARCANE UPDATE: Use getNPCName for full title display
                        let liegeName = 'You';
                        if (ruler.id !== 'PLAYER') {
                            const rulerRel = state.relationships.find(x => x.id === ruler.id);
                            liegeName = rulerRel ? getNPCName(rulerRel) : ruler.name;
                        }
                        liegeDisplay = `<p><strong>Liege:</strong> <span class="text-royal font-bold">${liegeName}</span></p>`;
                    }
                } else {
                    liegeDisplay = `<p><strong>Liege:</strong> <span class="text-royal font-bold">House ${state.house.name}</span></p>`;
                }

                // If this NPC IS the ruler
                if (ruler && ruler.id === r.id) {
                    successionDisplay = `<span class="text-purple-900 font-bold">üëë Reigning Patriarch</span>`;
                } else {
                    // Calculate Line
                    const line = calculateSuccession(ruler);
                    const index = line.findIndex(m => m.id === r.id);

                    if (index !== -1) {
                        if (index === 0) {
                            successionDisplay = `<span class="text-amber-600 font-bold">Heir Apparent</span>`;
                        } else {
                            // Simple ordinal suffix helper
                            const n = index + 1;
                            const ord = ["st","nd","rd"][((n+90)%100-10)%10-1]||"th";
                            successionDisplay = `<span class="font-bold text-amber-900">${n}${ord} in line</span>`;
                        }
                    } else {
                        successionDisplay = `<span class="opacity-50 text-xs">No claim</span>`;
                    }
                }
            }
        }

        // ARCANE UPDATE: Non-House Knight Liege Logic
        if (!liegeDisplay && (r.occupation.includes('Knight') || r.rank === 'Sworn Knight')) {
            if (r.rank === 'Sworn Knight') {
                liegeDisplay = `<p><strong>Liege:</strong> <span class="text-royal font-bold">You</span></p>`;
            } else {
                liegeDisplay = `<p><strong>Liege:</strong> <span class="text-royal font-bold">The Realm</span></p>`;
            }
        }
        
        let actions = '';
        
        // --- ARCANE UPDATE: LOCK CHECK ---
        const isLocked = state.flags.lockedInChronicle;
        const lockAttr = isLocked ? 'disabled' : '';
        const lockClass = isLocked ? 'opacity-50 cursor-not-allowed' : '';
        const lockTooltip = isLocked ? ' title="You are busy with an event"' : '';

        // --- NEW: SQUIRE / KNIGHT REQUEST BUTTON ---
        // Conditions: Player age 8-16, No Job, Target is Knight/Ser/Dame, Target location match
        const isTargetKnight = r.rank.includes('Ser') || r.rank.includes('Dame') || (r.occupation && r.occupation.includes('Knight'));
        
        // Squire Logic (Child/Teen)
        const canSquire = state.age >= 8 && state.age <= 16 && !state.occupation && isTargetKnight && !state.knighthood.rank;
        
        // Knighthood Petition Logic (Adult, Renown > 30, Combat Stats > 12)
        const isCombatReady = (state.stats.str >= 12 || state.stats.dex >= 12);
        const canPetition = state.age > 16 && !state.occupation && isTargetKnight && !state.knighthood.rank && state.reputation.renown >= 30 && isCombatReady;

        // NEW: Pledge Service Logic (Hedge Knight -> Sworn)
        const isHedgeKnight = state.occupation && state.occupation.id === 'knight' && state.knighthood.rank === 'Hedge Knight';
        const isRuler = r.rank.includes('Lord') || r.rank.includes('Lady') || r.rank.includes('King') || r.rank.includes('Queen') || r.rank.includes('Duke') || r.rank.includes('Duchess');
        
        // Add to actions if conditions met
        let squireAction = '';
        if (canSquire && state.location === r.locationIndex) {
             const squireClass = isLocked ? 'opacity-50 cursor-not-allowed' : '';
             const squireClick = !isLocked ? `askToSquire('${id}')` : '';
             squireAction = `<button onclick="${squireClick}" ${lockAttr} class="col-span-2 choice-btn text-xs justify-center bg-blue-900 text-blue-100 border-blue-950 ${squireClass}">üõ°Ô∏è Ask to Squire</button>`;
        } else if (canPetition && state.location === r.locationIndex) {
             const petitionClass = isLocked ? 'opacity-50 cursor-not-allowed' : '';
             const petitionClick = !isLocked ? `askForKnighthood('${id}')` : '';
             squireAction = `<button onclick="${petitionClick}" ${lockAttr} class="col-span-2 choice-btn text-xs justify-center bg-amber-700 text-white border-amber-900 ${petitionClass}">‚öîÔ∏è Petition for Knighthood</button>`;
        } else if (isHedgeKnight && isRuler && state.location === r.locationIndex) {
             const pledgeClass = isLocked ? 'opacity-50 cursor-not-allowed' : '';
             const pledgeClick = !isLocked ? `pledgeService('${id}')` : '';
             squireAction = `<button onclick="${pledgeClick}" ${lockAttr} class="col-span-2 choice-btn text-xs justify-center bg-purple-900 text-white border-purple-950 ${pledgeClass}">üó°Ô∏è Pledge Sword (Become Sworn)</button>`;
        }

        if (r.health === "Deceased") {
            actions = `
                <div class="col-span-2 text-center p-3 border border-gray-400 bg-gray-200 rounded text-gray-600 italic">
                    This person has passed away.<br>
                    <span class="text-xs">Visit the cemetery to pay respects.</span>
                </div>
            `;
        } else if (state.location === r.locationIndex) {
            // NEW: Added "Ask for Coin" button
            // Only enabled if interacted < 1 (to prevent spam) and relationship > 0 or family
            // UPDATED: Added Age Checks (Both must be 12+)
            const canAsk = (r.friendship >= 0 || r.isFamily) && !state.interactions[id] && state.age >= 12 && r.age >= 12;
            // Apply lock class if event is locked, otherwise check canAsk logic
            const askClass = (canAsk && !isLocked) ? "" : "opacity-50 cursor-not-allowed";
            const askAction = (canAsk && !isLocked) ? `askNPCForGold('${id}')` : "";

            actions = `
                <button onclick="startInteraction('${id}')" ${lockAttr} class="col-span-2 choice-btn text-lg justify-center bg-amber-900 border-amber-950 text-[#f4e4bc] hover:bg-amber-800 mb-2 ${lockClass}" ${lockTooltip}>
                    ‚öîÔ∏è Approach
                </button>
                <button onclick="interact('${id}', 'gift')" ${lockAttr} class="choice-btn text-xs justify-center ${lockClass}" ${lockTooltip}>üéÅ Gift (5g)</button>
                <button onclick="${askAction}" ${lockAttr} class="choice-btn text-xs justify-center ${askClass}">üí∞ Ask for Coin</button>
            `;
        } else {
            actions = `<button onclick="interact('${id}', 'letter')" ${lockAttr} class="col-span-2 choice-btn text-sm justify-center ${lockClass}" ${lockTooltip}>üïäÔ∏è Send Letter (1g)</button>`;
        }

        const hpDisplay = r.health === "Deceased" ? "Deceased" : `${r.hp}/${r.maxHp}`;
        
        // NEW: RENDER APPEARANCE AND MUTATIONS
        const ap = r.appearance || { hair: "Unknown", eyes: "Unknown", skin: "Unknown", mutations: [], defect: null };
        
        let mutationsHtml = '';
        
        // Render Defect if present
        if (ap.defect) {
             mutationsHtml += `<div class="mb-1"><span onclick="showTraitInfo('${ap.defect.name}')" class="gene-tag bg-red-800 text-white border-red-950 cursor-pointer hover:scale-110" title="${ap.defect.desc}">‚ö† ${ap.defect.name}</span></div>`;
        }

        // Render Mutations
        if (ap.mutations && ap.mutations.length > 0) {
            mutationsHtml += ap.mutations.map(m => {
                // UPDATED: Added onclick handler for NPC mutations
                return `<span onclick="showTraitInfo('${m.name}')" class="gene-tag mut-${m.rarity.toLowerCase()} cursor-pointer hover:scale-110 transition-transform" title="Click for info">${m.name}</span>`;
            }).join('');
        }
        
        if (mutationsHtml === '') mutationsHtml = '<span class="italic text-xs opacity-50">None</span>';

        // NEW: Death Info Block
        let deathInfo = '';
        if (r.health === "Deceased") {
            deathInfo = `<p class="text-red-900 font-bold text-xs mt-1">‚Ä† Died ${r.deathYear || 'Unknown'} (${r.deathCause || 'Unknown causes'})</p>`;
        }

        // NEW: Inventory HTML
        const invHtml = (r.inventory && r.inventory.length > 0) 
            ? r.inventory.map(i => `<span class="text-[10px] border border-black/20 rounded px-1 bg-white/50 item-rarity-${i.rarity}" title="${i.desc} - Val: ${i.value}g">${i.name}</span>`).join(' ') 
            : '<span class="text-xs italic opacity-50">Empty pockets.</span>';

        // NEW: Stats HTML Construction
        const s = r.stats || { str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10 };
        const statsHtml = `
            <div class="mb-4 border-t border-black/10 pt-2">
                <div class="text-xs font-bold uppercase mb-2">Attributes</div>
                <div class="grid grid-cols-6 gap-1 text-center text-xs">
                    <div class="bg-white/40 border border-[#5d4037] rounded p-1">
                        <div class="font-bold text-[10px] text-[#5d4037]">STR</div><div class="font-bold">${s.str}</div>
                    </div>
                    <div class="bg-white/40 border border-[#5d4037] rounded p-1">
                        <div class="font-bold text-[10px] text-[#5d4037]">DEX</div><div class="font-bold">${s.dex}</div>
                    </div>
                    <div class="bg-white/40 border border-[#5d4037] rounded p-1">
                        <div class="font-bold text-[10px] text-[#5d4037]">CON</div><div class="font-bold">${s.con}</div>
                    </div>
                    <div class="bg-white/40 border border-[#5d4037] rounded p-1">
                        <div class="font-bold text-[10px] text-[#5d4037]">INT</div><div class="font-bold">${s.int}</div>
                    </div>
                    <div class="bg-white/40 border border-[#5d4037] rounded p-1">
                        <div class="font-bold text-[10px] text-[#5d4037]">WIS</div><div class="font-bold">${s.wis}</div>
                    </div>
                    <div class="bg-white/40 border border-[#5d4037] rounded p-1">
                        <div class="font-bold text-[10px] text-[#5d4037]">CHA</div><div class="font-bold">${s.cha}</div>
                    </div>
                </div>
            </div>
        `;

        let html = `
            <h2 class="text-3xl font-medieval mb-1">${displayName}</h2>
            <div class="flex justify-between items-center mb-4 border-b border-black/10 pb-2">
                <span class="text-sm font-bold text-amber-900">${r.rank}</span>
                <span class="text-xs bg-black/10 px-2 py-1 rounded">${r.alignment}</span>
            </div>
            
            <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                <div>
                    <p><strong>Born:</strong> ${birthYear}</p>
                    <p><strong>Age:</strong> ${r.age}</p>
                    <p><strong>Sex:</strong> ${r.gender}</p>
                    <p><strong>City:</strong> ${loc}</p>
                    <p><strong>Job:</strong> ${r.occupation}</p>
                </div>
                <div>
                    <p><strong>Health:</strong> ${hpDisplay}</p>
                    <p><strong>Armor Class:</strong> <span class="text-blue-900 font-bold">${npcAC}</span></p>
                    ${deathInfo}
                    <p><strong>Relation:</strong> ${r.relation}</p>
                    <p><strong>Class:</strong> ${socialClassDisplay}</p>
                    ${liegeDisplay}
                    <p><strong>Claim:</strong> ${successionDisplay}</p>
                </div>
            </div>

            ${statsHtml}

            <div class="mb-4">
                <div class="text-xs font-bold uppercase mb-1">Appearance</div>
                <div class="text-sm italic mb-2">${ap.height} Height, ${ap.hair} Hair, ${ap.eyes} Eyes, ${ap.skin} Skin</div>
                <div class="text-xs font-bold uppercase mb-1">Mutations & Defects</div>
                <div>${mutationsHtml}</div>
            </div>

            <div class="mb-4 pt-2 border-t border-black/10">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-xs font-bold uppercase">Possessions</div>
                    <div class="text-xs font-bold text-amber-900">üí∞ ${r.gold || 0} GP</div>
                </div>
                <div class="flex flex-wrap gap-1">
                    ${invHtml}
                </div>
            </div>

            <div class="mb-4 space-y-2">
                <div>
                    <div class="flex justify-between text-xs mb-1"><span>Friendship (${getRelLabel(r.friendship)})</span><span>${r.friendship}</span></div>
                    <div class="bar-container"><div class="bar-fill ${r.friendship >= 0 ? 'friend-fill' : 'enemy-fill'}" style="width:${Math.abs(r.friendship)}%"></div></div>
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-1"><span>Romance</span><span>${r.romance}</span></div>
                    <div class="bar-container"><div class="bar-fill romance-fill" style="width:${r.romance}%"></div></div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-2">
                ${actions}
                ${squireAction}
            </div>
        `;
        document.getElementById('npc-content').innerHTML = html;
        document.getElementById('npc-modal').classList.remove('hidden');
    }

    /**
     * DYNAMIC INTERACTION ENGINE
     */
    function startInteraction(id) {
        if(state.health <= 0) return; // Guard
        closeNPC();
        switchTab('log');
        const r = state.relationships.find(x => x.id === id);
        if(!r) return;

        const isEnemy = r.friendship <= -20;
        const isLover = r.romance > 40;
        const isSpouse = r.relation === 'Spouse';
        const isFriend = r.friendship >= 30;
        
        const isAdult = state.age >= 18;
        const isTeen = state.age >= 13 && state.age < 18;

        // NEW: Eligibility Check for Confession
        // Must be at least 14, target 14+, not related, not married, not already a lover/spouse
        const canConfess = (state.age >= 14 && r.age >= 14 && !r.isMarried && !r.isFamily && !r.isBlood && !isSpouse && !isLover && r.relation !== 'Suitor');

        if (state.age < 4) {
            log(`You gurgle happily at ${r.name}. They pat your head awkwardly.`);
            return;
        }

        let evt = null;

        if (isEnemy) {
            if (isAdult || isTeen) {
                evt = createEvent(`int_enemy_${id}`, `Confrontation: ${r.name}`, `${r.name} sneers as you approach. "Lost your way, fool?"`, [
                    { text: 'Duel (Combat)', type: 'check', stat: 'str', dc: 12, success: `You batter them into submission!`, fail: `They thrash you soundly.`, onSuccess: () => { modRel(id, -20); takeDamage(2); modRep('renown', 5); }, onFail: () => { takeDamage(8); modRep('infamy', 2); } },
                    { text: 'Insult (Wit)', type: 'check', stat: 'int', dc: 13, success: `Your wit cuts deeper than a knife.`, fail: `You stutter and look weak.`, onSuccess: () => { modRel(id, -25); modRep('renown', 2); }, onFail: () => { modRep('honor', -2); } },
                    { text: 'Intimidate', type: 'check', stat: 'cha', dc: 14, success: `They back down, terrified.`, fail: `They laugh in your face.`, onSuccess: () => { modRel(id, -10); modRep('infamy', 5); }, onFail: () => {} }
                ]);
            } else {
                evt = createEvent(`int_enemy_kid_${id}`, `Bully: ${r.name}`, `${r.name} sticks their tongue out at you.`, [
                    { text: 'Push', type: 'check', stat: 'str', dc: 10, success: `You push them into the mud!`, fail: `They push you back harder.`, onSuccess: () => { modRel(id, -15); }, onFail: () => { takeDamage(1); } },
                    { text: 'Tell Adult', type: 'check', stat: 'cha', dc: 12, success: `They get in trouble!`, fail: `No one listens.`, onSuccess: () => { modRel(id, -20); }, onFail: () => {} }
                ]);
            }
        } 
        else if (isSpouse || isLover) {
            const title = isSpouse ? 'Spouse' : (r.relation === 'Suitor' ? 'Suitor' : 'Lover');
            if (isAdult || isTeen) {
                let choices = [];
                choices.push({ text: 'Woo & Romance', type: 'check', stat: 'cha', dc: 10, success: `Sparks fly! (+Romance, +2 SP)`, fail: `It falls flat.`, onSuccess: () => { modRel(id, 15, 20); modSanity(2); }, onFail: () => modRel(id, 0, -2) });
                choices.push({ text: 'Deep Conversation', type: 'check', stat: 'wis', dc: 8, success: `You bond over shared dreams. (+Rel, +1 SP)`, fail: `You argue instead.`, onSuccess: () => { modRel(id, 20); modSanity(1); }, onFail: () => { modRel(id, -10); } });
                
                if (!isSpouse && isLover && state.age >= 16) {
                    choices.push({ 
                        text: 'Propose Marriage', 
                        type: 'check', stat: 'cha', dc: 12, 
                        req: (s) => s.gold >= 50, // Ring cost?
                        success: `YES! You are now betrothed!`, 
                        fail: `They are not ready...`, 
                        onSuccess: () => { marryNPC(id); }, 
                        onFail: () => { modRel(id, -10, -5); } 
                    });
                } else if (isSpouse) {
                     choices.push({ 
                        text: 'Start a Family', 
                        type: 'check', 
                        stat: 'con', 
                        dc: 12, 
                        req: (s) => s.age < 50 && r.age < 45, 
                        success: `Success! A child is expected next year.`, 
                        fail: `Not this time.`, 
                        onSuccess: () => { 
                            if (state.gender === 'Female') {
                                state.flags.isPregnant = true;
                                state.flags.pregnancyPartnerId = r.id;
                                log("You are with child!");
                            } else {
                                // NPC Spouse becomes pregnant
                                const spouse = state.relationships.find(x => x.id === r.id);
                                if (spouse) {
                                    spouse.isPregnant = true;
                                    spouse.pregnancyFatherId = 'PLAYER';
                                    log(`${spouse.name} is with child!`);
                                }
                            }
                        }, 
                        onFail: () => {} 
                    });
                } else {
                     choices.push({ text: 'Spend Time', type: 'flavor', effect: () => { log(`You spend a quiet moment with ${r.name}.`); modSanity(2); } });
                }

                evt = createEvent(`int_love_${id}`, `${title}: ${r.name}`, `${r.name} smiles warmly as you approach.`, choices);
            } else {
                 evt = createEvent(`int_crush_${id}`, `Crush: ${r.name}`, `You feel butterflies near ${r.name}.`, [
                    { text: 'Give Flower', type: 'check', stat: 'cha', dc: 8, success: `They blush.`, fail: `They think it's weird.`, onSuccess: () => modRel(id, 15), onFail: () => modRel(id, -5) },
                    { text: 'Run Away', type: 'flavor', effect: () => log("You panic and run.") }
                 ]);
            }
        }
        else if (isFriend) {
            let choices = [];
            let title = `Friend: ${r.name}`;
            let text = `You meet ${r.name}.`;

            if (isAdult) {
                text = `You meet ${r.name} at the tavern.`;
                choices = [
                    { text: 'Drink Ale', type: 'check', stat: 'con', dc: 10, success: `A hearty night! (+3 SP)`, fail: `Hangover. (-HP)`, onSuccess: () => { modSanity(3); modRel(id, 15); }, onFail: () => { takeDamage(2); } },
                    { text: 'Gossip', type: 'check', stat: 'int', dc: 10, success: `You learn secrets. (+Rel)`, fail: `Boring news.`, onSuccess: () => { modRel(id, 10); }, onFail: () => {} },
                    { text: 'Borrow Gold', type: 'check', stat: 'cha', dc: 12, success: `They lend you 10g.`, fail: `They refuse.`, onSuccess: () => { state.gold+=10; modRel(id, -5); }, onFail: () => modRel(id, -2) }
                ];
            } else {
                // Teens/Kids
                text = `You meet ${r.name} to hang out.`;
                choices = [
                    { text: 'Play/Hangout', type: 'check', stat: 'dex', dc: 10, success: `You have fun! (+Rel)`, fail: `You trip.`, onSuccess: () => modRel(id, 15), onFail: () => takeDamage(1) },
                    { text: 'Share Item', type: 'check', stat: 'cha', dc: 8, success: `Best friends forever.`, fail: `They break it.`, onSuccess: () => modRel(id, 20), onFail: () => modRel(id, -10) }
                ];
            }

            // INJECT CONFESSION
            if (canConfess) {
                choices.push({
                    text: 'Confess Love',
                    type: 'check',
                    stat: 'cha',
                    dc: 12,
                    success: 'They are surprised but delighted. "I have felt the same."',
                    fail: 'They look awkward. "I... I value our friendship too much."',
                    onSuccess: () => { 
                        r.relation = "Suitor"; 
                        r.romance = 50; // Sets them as Lover instantly
                        r.friendship = Math.max(r.friendship, 40);
                        log(`<strong style="color:var(--royal)">COURTSHIP:</strong> You confessed your feelings to ${r.name}. They accepted! You are now Suitors.`);
                    },
                    onFail: () => { 
                        modRel(id, -10, -5); 
                        modSanity(-1); 
                        log(`You confessed to ${r.name}, but they did not reciprocate.`);
                    }
                });
            }

            evt = createEvent(`int_friend_${id}`, title, text, choices);
        }
        else {
            // NEUTRAL / ACQUAINTANCE
            let choices = [
                { text: 'Chat', type: 'check', stat: 'cha', dc: 8, success: `Pleasant conversation. (+Rel)`, fail: `Awkward silence.`, onSuccess: () => modRel(id, 10), onFail: () => {} },
                { text: 'Joke', type: 'check', stat: 'cha', dc: 10, success: `They laugh! (+Rel)`, fail: `Crickets.`, onSuccess: () => modRel(id, 15), onFail: () => modRel(id, -5) },
                { text: 'Insult', type: 'check', stat: 'cha', dc: 10, success: `You mocked them good. (+1 SP)`, fail: `They slap you.`, onSuccess: () => modSanity(1), onFail: () => takeDamage(1) }
            ];

            // INJECT CONFESSION (Harder DC for acquaintances)
            if (canConfess) {
                choices.push({
                    text: 'Ask to Court',
                    type: 'check',
                    stat: 'cha',
                    dc: 15,
                    success: 'They blush. "I am... interested. Let us see where this goes."',
                    fail: 'They laugh nervously. "I hardly know you."',
                    onSuccess: () => { 
                        r.relation = "Suitor"; 
                        r.romance = 45; 
                        r.friendship = Math.max(r.friendship, 20);
                        log(`<strong style="color:var(--royal)">COURTSHIP:</strong> ${r.name} agreed to become your Suitor.`);
                    },
                    onFail: () => { 
                        modRel(id, -5, -5); 
                        log(`${r.name} politely declined your sudden proposal.`);
                    }
                });
            }

            evt = createEvent(`int_neut_${id}`, `Meeting: ${r.name}`, `You approach ${r.name}.`, choices);
        }

        renderEvent(evt);
    }

    function marryNPC(id) {
        const r = state.relationships.find(x => x.id === id);
        if(!r) return;
        r.relation = 'Spouse';
        state.flags.married = true;
        log(`<strong style="color:var(--gold)">MARRIAGE:</strong> You and ${r.name} are joined in holy matrimony!`);
        updateUI();
    }

    function getRelLabel(val) {
        if (val <= -50) return "Enemy";
        if (val < 0) return "Disliked";
        if (val < 30) return "Acquaintance";
        if (val < 60) return "Friend";
        if (val < 90) return "Good Friend";
        return "Best Friend";
    }

    // --- OCCUPATION SYSTEM LOGIC ---
    function processOccupation() {
        if (!state.occupation) return;
        const occ = state.occupation;
        const career = CAREERS[occ.id];
        const rankInfo = career.ranks[occ.rankIndex];
        
        let income = rankInfo.wage;
        
        // --- ARCANE UPDATE: KNIGHTHOOD LOGIC ---
        if (occ.id === 'knight') {
            state.knighthood.rank = rankInfo.title;
            state.knighthood.stipend = rankInfo.wage;
            // Rank 2 (Sworn Knight) and Rank 3 (Commander) are sworn
            state.knighthood.isSworn = (occ.rankIndex >= 2);

            // SQUIRE PROGRESSION & CEREMONY
            if (occ.rankIndex === 0) {
                // Annual Stat Gain
                if (Math.random() > 0.5) state.stats.str++;
                else state.stats.dex++;
                log("Training as a Squire has improved your physique. (+1 STR/DEX)");

                // Unlock Skills
                if (occ.years === 1 && !state.combatSkills.includes('precision_strike')) {
                    state.combatSkills.push('precision_strike');
                    log(`<strong style="color:var(--royal)">TRAINING:</strong> You have mastered <strong>Precision Strike</strong>.`);
                }
                if (occ.years === 3 && !state.combatSkills.includes('shield_bash')) {
                    state.combatSkills.push('shield_bash');
                    log(`<strong style="color:var(--royal)">TRAINING:</strong> You have mastered <strong>Shield Bash</strong>.`);
                }

                // Knighting Trigger (Age 21 OR 5 Years Service)
                if (state.age >= 21 || occ.years >= 5) {
                    triggerKnightingCeremony();
                    return; // Skip standard progression check
                }
            }
        }

        let stressGain = rankInfo.stressMod;
        let perfGain = 5;

        if (occ.workStance === 'slack') { income *= 0.7; stressGain -= 5; perfGain = -5; } 
        else if (occ.workStance === 'intense') { income *= 1.5; stressGain += 5; perfGain = 15; }

        state.gold += Math.floor(income);
        occ.stress = Math.min(100, Math.max(0, occ.stress + stressGain));
        occ.performance = Math.min(100, Math.max(0, occ.performance + perfGain));
        occ.years++;

        // ARCANE UPDATE: DISTINCT LOGGING FOR KNIGHT STIPENDS
        if (occ.id === 'knight' && state.knighthood.isSworn) {
            let masterName = "The Order";
            if (state.knighthood.masterId) {
                const m = state.relationships.find(r => r.id === state.knighthood.masterId);
                if(m) masterName = m.name;
            } else if (state.house) {
                masterName = `House ${state.house.name}`;
            }
            log(`<strong style="color:var(--royal)">Knighthood:</strong> Received House Stipend of ${Math.floor(income)} GP from ${masterName}. Stress: ${occ.stress}%.`);
        } else {
            log(`<strong>Occupation:</strong> Earned ${Math.floor(income)} GP. Stress: ${occ.stress}%.`);
        }
        
        // Standard Promotion Logic (Disabled for Squires as they use Ceremony)
        if (occ.id !== 'knight' || occ.rankIndex > 0) {
            if (occ.performance === 100 && occ.rankIndex < career.ranks.length - 1 && Math.random() > 0.7) {
                occ.rankIndex++;
                occ.performance = 50;
                const newTitle = career.ranks[occ.rankIndex].title;
                log(`<strong class="text-green-800">PROMOTION:</strong> Raised to ${newTitle}!`);
                modRep('renown', 10);
                addHonorific(newTitle); 
            }
        }
    }

    // --- NEW: KNIGHTING CEREMONY ---
    function triggerKnightingCeremony() {
        // Find Master Name
        let masterName = "The Order";
        if (state.knighthood.masterId) {
            const m = state.relationships.find(r => r.id === state.knighthood.masterId);
            if(m) masterName = m.name;
        } else if (state.house) {
            masterName = `House ${state.house.name}`;
        }

        const evt = createEvent(
            'knighting_ceremony',
            'The Knighting Vigil',
            `You have served ${masterName} faithfully as a Squire. The night of your vigil has passed, and the sun rises on a new day. Your master draws their sword. "Kneel, Squire. Rise, Knight."<br><br>How will you serve?`,
            [
                {
                    text: 'Sworn Knight (Stipend, Locked Location)',
                    type: 'flavor',
                    effect: () => {
                        state.occupation.rankIndex = 2; // Sworn Knight
                        state.knighthood.rank = 'Sworn Knight';
                        state.knighthood.isSworn = true;
                        state.knighthood.stipend = 50;
                        addHonorific(state.gender === 'Female' ? 'Dame' : 'Ser');
                        syncKnightlyLineage();
                        modRep('honor', 20);
                        modRep('renown', 10);
                        log(`<strong style="color:var(--royal)">KNIGHTED:</strong> You swore a sacred oath to ${masterName}. You are now a Sworn Knight.`);
                        updateUI();
                    }
                },
                {
                    text: 'Hedge Knight (Free Travel, No Wage)',
                    type: 'flavor',
                    effect: () => {
                        state.occupation.rankIndex = 1; // Hedge Knight
                        state.knighthood.rank = 'Hedge Knight';
                        state.knighthood.isSworn = false;
                        state.knighthood.stipend = 0;
                        addHonorific(state.gender === 'Female' ? 'Dame' : 'Ser');
                        syncKnightlyLineage();
                        modRep('renown', 5);
                        log(`<strong style="color:var(--gold)">KNIGHTED:</strong> You accepted the title but kept your freedom. You are now a Hedge Knight.`);
                        updateUI();
                    }
                }
            ]
        );
        state.eventQueue.unshift(evt);
    }

    function renderOccupationTab() {
        const container = document.getElementById('occ-content');
        
        // --- ARCANE UPDATE: CUSTOM KNIGHTHOOD CARD ---
        if (state.occupation && state.occupation.id === 'knight') {
            syncKnightlyLineage();
            const k = state.knighthood;
            const occ = state.occupation;
            const master = state.relationships.find(r => r.id === k.masterId);
            
            // LOGIC UPDATE: Make Master Clickable if NPC
            let masterDisplay = state.house ? `House ${state.house.name}` : "The Order";
            if (master) {
                masterDisplay = `<button onclick="openNPC('${master.id}')" class="text-blue-900 font-bold underline hover:text-blue-700 transition-colors text-left">${master.name}</button>`;
            } else if (k.masterId === 'COUNCIL') {
                masterDisplay = "The Council";
            } else if (!state.house && !master) {
                // Fallback for independent knights
                masterDisplay = "The Realm";
            }
            
            // Determine Status Badge
            let statusBadge = '';
            if (k.rank === 'Squire') statusBadge = '<span class="bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs border border-gray-300">In Training</span>';
            else if (k.isSworn) statusBadge = '<span class="bg-blue-100 text-blue-900 px-2 py-1 rounded text-xs border border-blue-200">Sworn Oath</span>';
            else statusBadge = '<span class="bg-amber-100 text-amber-900 px-2 py-1 rounded text-xs border border-amber-200">Free Blade</span>';

            // NEW: Renounce Oath Button Logic
            let renounceBtn = '';
            if (k.isSworn) {
                renounceBtn = `<button onclick="renounceOath()" class="flex-1 border border-amber-800 text-amber-900 p-2 rounded hover:bg-amber-100 text-xs font-bold">Renounce Oath</button>`;
            }

            container.innerHTML = `
                <div class="job-card border-l-4 border-l-blue-900 min-w-0 overflow-hidden">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-bold text-xl font-medieval">Knighthood</h3>
                            <div class="text-sm font-bold text-blue-900">${k.rank}</div>
                        </div>
                        <div class="text-4xl opacity-20">üõ°Ô∏è</div>
                    </div>
                    
                    <div class="bg-white/50 p-2 rounded mb-3 text-sm border border-black/5 min-w-0">
                        <div class="flex justify-between items-start mb-1 gap-2">
                            <span class="opacity-70 flex-shrink-0">House Served:</span>
                            <span class="text-right break-words min-w-0 max-w-[220px]" title="${state.houseAlliance || 'None'}">${state.houseAlliance || 'None'}</span>
                        </div>
                        <div class="flex justify-between items-start mb-1 gap-2">
                            <span class="opacity-70 flex-shrink-0">Knighted By:</span>
                            <span class="text-right break-words min-w-0 max-w-[220px]" title="${state.mentorKnight || 'None'}">${state.mentorKnight || 'None'}</span>
                        </div>
                        <div class="flex justify-between mb-1">
                            <span class="opacity-70">Stipend:</span>
                            <span>${k.stipend} GP/yr</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="opacity-70">Status:</span>
                            ${statusBadge}
                        </div>
                    </div>

                    <div class="mt-2"><div class="text-xs flex justify-between"><span>Duty Performance</span><span>${occ.performance}%</span></div><div class="bar-container"><div class="bar-fill perf-fill" style="width: ${occ.performance}%"></div></div></div>
                    
                    ${k.rank === 'Squire' ? `<div class="mt-3 text-xs italic text-center opacity-70">"Service builds strength. Patience builds character."</div>` : ''}
                    
                    <div class="mt-4 pt-4 border-t border-black/10 flex gap-2">
                        <button onclick="quitJob()" class="flex-1 border border-red-800 text-red-800 p-2 rounded hover:bg-red-100 text-xs">Abandon Vows</button>
                        ${renounceBtn}
                    </div>
                </div>
            `;
            return;
        }

        // --- STANDARD CAREER RENDER ---
        if (!state.occupation) {
            let html = `<p class="italic mb-4">You currently have no vocation.</p><div class="space-y-2">`;
            const historyIds = Object.keys(state.jobHistory);
            if (historyIds.length > 0) {
                html += `<h4 class="font-bold border-b border-black/10 mb-2">Resume Career</h4>`;
                historyIds.forEach(hid => {
                    // Skip knighthood in resume history (cannot just "resume" vows without ceremony/interaction)
                    if (hid === 'knight') return;
                    
                    const hist = state.jobHistory[hid];
                    const c = CAREERS[hid];
                    html += `<button onclick="joinJob('${hid}')" class="choice-btn text-sm mb-2 border-l-4 border-amber-600"><span>Resume: ${c.ranks[hist.rankIndex].title}</span></button>`;
                });
                html += `<h4 class="font-bold border-b border-black/10 mb-2 mt-4">New Career</h4>`;
            }
            for (let id in CAREERS) {
                // ARCANE UPDATE: Knighthood is not a job board listing.
                if (id === 'knight') continue;

                const c = CAREERS[id];
                let canJoin = true;
                if (c.req.age && state.age < c.req.age) canJoin = false;
                if (c.req.stat && state.stats[c.req.stat] < c.req.val) canJoin = false;
                if (c.req.flag && !state.flags[c.req.flag]) canJoin = false;
                if (c.req.class && state.socialClass !== c.req.class) canJoin = false;
                
                // --- NEW: COOLDOWN LOGIC ---
                const isRejected = state.rejectedJobs.includes(id);
                if (isRejected) {
                    html += `<button disabled class="choice-btn text-sm opacity-50 cursor-not-allowed border-red-900"><span>${c.name}</span><span class="text-red-800 font-bold">Rejected this year</span></button>`;
                }
                else if (canJoin) {
                    html += `<button onclick="attemptJob('${id}')" class="choice-btn text-sm"><span>${c.name}: ${c.ranks[0].title}</span><span class="opacity-70">${c.ranks[0].wage} GP/yr</span></button>`;
                }
            }
            container.innerHTML = html;
        } else {
            const occ = state.occupation;
            const jobData = CAREERS[occ.id].ranks[occ.rankIndex];
            const jobName = CAREERS[occ.id].name;
            
            // UPDATED: Check for any valid title within this career, or the generic name
            const career = CAREERS[occ.id];
            const validTitles = career.ranks.map(k => k.title);
            validTitles.push(jobName); // Include generic name for legacy/special NPCs
            
            const coworkers = state.relationships.filter(r => validTitles.includes(r.occupation) && r.locationIndex === state.location && r.health !== 'Deceased');
            
            let coworkersHtml = '<div class="mt-4 pt-4 border-t border-black/20"><h4 class="font-bold mb-2">Colleagues</h4>';
            if (coworkers.length === 0) {
                coworkersHtml += '<p class="text-xs italic opacity-70 mb-2">You haven\'t bonded with anyone here yet.</p>';
            } else {
                coworkersHtml += '<div class="grid grid-cols-2 gap-2 mb-2">';
                coworkersHtml += coworkers.map(r => `
                    <div class="p-2 border border-black/10 rounded bg-white/30 cursor-pointer hover:bg-white/60 flex justify-between items-center" onclick="openNPC('${r.id}')">
                        <div class="font-bold text-xs truncate mr-1">${r.name}</div>
                        <div class="text-[10px] opacity-70">${getRelLabel(r.friendship)}</div>
                    </div>
                `).join('');
                coworkersHtml += '</div>';
            }
            coworkersHtml += `<button onclick="meetCoworker()" class="choice-btn text-xs w-full justify-center bg-[#5d4037]">Socialize with Colleagues</button></div>`;

            container.innerHTML = `
                <div class="job-card">
                    <h3 class="font-bold text-xl">${jobData.title}</h3>
                    <p class="text-sm opacity-70">${jobName} - Rank ${occ.rankIndex + 1}</p>
                    <div class="mt-2 text-sm">Wage: ${jobData.wage} GP/yr</div>
                    <div class="mt-4"><div class="text-xs flex justify-between"><span>Performance</span><span>${occ.performance}%</span></div><div class="bar-container"><div class="bar-fill perf-fill" style="width: ${occ.performance}%"></div></div></div>
                    <div class="mt-2"><div class="text-xs flex justify-between"><span>Stress</span><span>${occ.stress}%</span></div><div class="bar-container"><div class="bar-fill stress-fill" style="width: ${occ.stress}%"></div></div></div>
                    ${coworkersHtml}
                </div>
                <div class="flex gap-2 text-xs mb-4">
                    <button onclick="setStance('slack')" class="p-2 border rounded ${occ.workStance==='slack'?'bg-amber-300':'bg-white'}">Slack</button>
                    <button onclick="setStance('normal')" class="p-2 border rounded ${occ.workStance==='normal'?'bg-amber-500 text-white':'bg-white'}">Normal</button>
                    <button onclick="setStance('intense')" class="p-2 border rounded ${occ.workStance==='intense'?'bg-red-800 text-white':'bg-white'}">Intense</button>
                </div>
                <button onclick="quitJob()" class="w-full border border-red-800 text-red-800 p-2 rounded hover:bg-red-100">Quit Job</button>
            `;
        }
    }

    function meetCoworker() {
        if(state.health <= 0) return; // Guard
        if(!state.occupation) return;
        
        // UPDATED: Use same logic as renderOccupationTab to find existing colleagues
        const career = CAREERS[state.occupation.id];
        const jobName = career.name;
        const validTitles = career.ranks.map(k => k.title);
        validTitles.push(jobName);

        const existing = state.relationships.filter(r => validTitles.includes(r.occupation) && r.locationIndex === state.location && r.health !== 'Deceased');
        
        if (Math.random() < 0.4 || existing.length === 0) {
             const gender = Math.random() > 0.5 ? 'Male' : 'Female';
             const name = getRandomName(gender);
             const newCo = addRelationship(name, "Colleague", 20, gender, "Commoner", state.location);
             
             // UPDATED: Assign random rank from current career to new colleague
             const rndRank = career.ranks[Math.floor(Math.random() * career.ranks.length)];
             newCo.occupation = rndRank.title; 
             
             log(`You met a new colleague, ${name}.`);
        } else {
             const target = existing[Math.floor(Math.random() * existing.length)];
             log(`You spent time with ${target.name} during work.`);
             modRel(target.id, 5);
        }
    }

    function attemptJob(id) {
        if(state.health <= 0) return;
        const career = CAREERS[id];
        
        // INTERVIEW EVENT
        const interviewEvent = createEvent(
            'job_interview_' + id,
            `Application: ${career.name}`,
            `You approach the guild/foreman for a position as a ${career.ranks[0].title}.`,
            [
                {
                    text: 'Demonstrate Skill',
                    type: 'check',
                    stat: career.stat || 'str',
                    dc: career.dc || 10,
                    success: 'They are impressed. "You start today."',
                    fail: 'They shake their heads. "Not skilled enough."',
                    onSuccess: () => joinJob(id), 
                    onFail: () => { state.rejectedJobs.push(id); updateUI(); } 
                },
                {
                    text: 'Bribe (50g)',
                    type: 'check',
                    stat: 'cha',
                    dc: 10,
                    req: (s) => s.gold >= 50,
                    success: 'They take the coin with a wink. "Welcome aboard."',
                    fail: 'They take the coin but throw you out anyway. "We have standards."',
                    onSuccess: () => { state.gold -= 50; joinJob(id); },
                    onFail: () => { state.gold -= 50; state.rejectedJobs.push(id); updateUI(); }
                },
                {
                    text: 'Leave',
                    type: 'flavor',
                    effect: () => log("You decide to wait.")
                }
            ]
        );
        
        // MODIFIED: If triggered during event loop (e.g. House Event), inject into queue to prevent overwrite.
        if (state.flags.lockedInChronicle) {
            state.eventQueue.unshift(interviewEvent);
        } else {
            renderEvent(interviewEvent);
            switchTab('log');
        }
    }

    function joinJob(id) {
        if(state.health <= 0) return; // Guard
        if (state.jobHistory[id]) {
            state.occupation = state.jobHistory[id];
            state.occupation.performance = Math.max(0, state.occupation.performance - 20);
            log(`<strong>Career:</strong> Resumed post as ${CAREERS[id].ranks[state.occupation.rankIndex].title}.`);
            delete state.jobHistory[id];
        } else {
            state.occupation = { id, rankIndex: 0, performance: 50, stress: 0, workStance: 'normal', years: 0 };
            log(`<strong>Career:</strong> Started as ${CAREERS[id].ranks[0].title}.`);
        }
        state.flags.employed = true;
        // ADDED: Set Honorific when joining job
        addHonorific(CAREERS[id].ranks[state.occupation.rankIndex].title);
        updateUI();
    }

    function quitJob() {
        if(state.health <= 0) return; // Guard
        if (state.occupation) {
            const wasKnight = state.occupation.id === 'knight';
            log(`<strong>Career:</strong> Resigned.`);
            state.jobHistory[state.occupation.id] = state.occupation;
            state.occupation = null;
            state.flags.employed = false;
            if (wasKnight) {
                state.houseAlliance = "None";
                state.mentorKnight = "None";
                state.knighthood = { rank: null, masterId: null, isSworn: false, stipend: 0 };
            }
            updateUI();
        }
    }
    
    function setStance(s) {
        if(state.occupation) state.occupation.workStance = s;
        updateUI();
    }

    // --- RELATIONSHIP SYSTEM ---
    
    // NEW: PC Asks NPC for Gold
    function askNPCForGold(id) {
        if(state.health <= 0) return;
        // UPDATED: Age check (12+)
        if (!checkAge(12)) return;

        const r = state.relationships.find(x => x.id === id);
        if(!r) return;

        state.interactions[id] = 1; // Mark interaction used for year
        closeNPC();
        switchTab('log');

        const chaMod = getModifier(state.stats.cha);
        const roll = rollD20(chaMod);
        const dc = 12 + (r.friendship < 20 ? 5 : 0); // Harder if not close friends

        let amt = 10;
        if (r.rank.includes('Lord') || r.rank.includes('Lady') || r.rank.includes('Noble')) amt = 50;
        if (r.gold < amt) amt = Math.floor(r.gold / 2); // They can't give what they don't have

        if (amt <= 0) {
            log(`You asked ${r.name} for coin, but they have none to spare.`);
            return;
        }

        if (roll.total >= dc) {
            state.gold += amt;
            r.gold -= amt;
            log(`<strong style="color:green">SUCCESS:</strong> You asked ${r.name} for financial aid. They agreed and gave you ${amt}g. (Relationship Unchanged)`);
            AudioEngine.pulse();
        } else {
            modRel(id, -10);
            log(`<strong style="color:red">FAILURE:</strong> You asked ${r.name} for coin. They refused, looking offended. (Relationship Damaged)`);
        }
        updateUI();
    }

    function interact(id, action) {
        if(state.health <= 0) return; // Guard
        const r = state.relationships.find(x => x.id === id);
        if(!r) return;

        if (action === 'gift') {
            if (state.gold >= 5) {
                state.gold -= 5;
                r.friendship = Math.min(100, r.friendship + 10);
                if (r.romance > 0) r.romance += 5;
                log(`You gave ${r.name} a gift. They seem pleased.`);
            } else {
                showMsg("Insufficient Funds", "You do not have enough gold.");
            }
        } 
        else if (action === 'letter') {
            if (state.gold >= 1) {
                state.gold -= 1;
                r.friendship = Math.min(100, r.friendship + 2);
                log(`You sent a letter to ${r.name}.`);
            } else {
                showMsg("Insufficient Funds", "You do not have enough gold.");
            }
        }
        
        updateUI();
        closeNPC();
        switchTab('log');
    }

    function renderRelTab() {
        const container = document.getElementById('rel-content');
        const searchInput = document.getElementById('rel-search-input');
        const query = searchInput.value.toLowerCase();

        if (state.relationships.length === 0) {
            container.innerHTML = `<p class="italic opacity-50">You are alone.</p>`;
            return;
        }
        
        // FILTER: Only show people we know (isKnown !== false)
        const filtered = state.relationships.filter(r => 
            (r.isKnown !== false) && 
            (r.name.toLowerCase().includes(query) || r.relation.toLowerCase().includes(query))
        );

        if (filtered.length === 0) {
            container.innerHTML = `<p class="italic opacity-50">No known relationships found.</p>`;
            return;
        }

        container.innerHTML = filtered.map(r => {
            const locName = CITIES[r.locationIndex].name;
            const status = r.romance > 50 ? "‚ù§Ô∏è Partner" : getRelLabel(r.friendship);
            const familyTag = r.isFamily ? `<span class="text-[10px] bg-amber-900 text-white px-1 rounded ml-2">Kin</span>` : '';
            const deadClass = r.health === "Deceased" ? "opacity-50 grayscale" : "";
            
            // Use helper for consistent naming
            const displayName = getNPCName(r);
            
            return `
            <div class="rel-card ${deadClass}" onclick="openNPC('${r.id}')">
                <div>
                    <div class="font-bold">${displayName} ${familyTag}</div>
                    <div class="text-xs opacity-70">${r.relation} ‚Ä¢ ${r.rank}</div>
                    <div class="text-xs text-amber-900 font-bold">üìç ${locName}</div>
                </div>
                <div class="flex flex-col items-end gap-1 w-24">
                    <div class="text-xs font-bold">${status}</div>
                    <div class="w-full h-1 bg-black/10 rounded overflow-hidden">
                        <div class="h-full ${r.friendship >= 0 ? 'friend-fill' : 'enemy-fill'}" style="width:${Math.abs(r.friendship)}%"></div>
                    </div>
                    ${r.romance > 0 ? `<div class="w-full h-1 bg-black/10 rounded overflow-hidden"><div class="h-full romance-fill" style="width:${r.romance}%"></div></div>` : ''}
                </div>
            </div>`;
        }).join('');
    }

    // --- HOUSE & LINEAGE UI ---
    
    // NEW: Transaction Modal Logic
    let pendingTransType = null;

    function openTransaction(type) {
        if(state.health <= 0) return;
        pendingTransType = type;
        const title = type === 'donate' ? "Donate to House" : "Withdraw Funds";
        const max = type === 'donate' ? state.gold : state.house.treasury;
        
        document.getElementById('trans-title').innerText = title;
        document.getElementById('trans-text').innerText = `Enter amount (Max: ${max}g)`;
        document.getElementById('trans-input').value = "";
        document.getElementById('trans-input').max = max;
        document.getElementById('trans-modal').classList.remove('hidden');
        document.getElementById('trans-input').focus();
    }

    function confirmTransaction() {
        const input = document.getElementById('trans-input');
        const amt = parseInt(input.value);
        
        if (!amt || amt <= 0) {
            closeTransaction();
            return;
        }

        if (pendingTransType === 'donate') {
            if (state.gold >= amt) {
                state.gold -= amt;
                state.house.treasury += amt;
                
                // NEW: Reputation & Styling for Donation
                const renownGain = Math.ceil(amt / 100);
                const honorGain = Math.ceil(amt / 50);
                if (renownGain > 0) modRep('renown', renownGain);
                if (honorGain > 0) modRep('honor', honorGain);
                
                log(`<strong style="color:var(--royal)">HOUSE EVENT:</strong> You donated ${amt}g to House ${state.house.name}. The treasury grows.`);
            } else {
                showMsg("Insufficient Funds", "You do not have that much gold.");
            }
        } else if (pendingTransType === 'withdraw') {
            if (state.house.treasury >= amt) {
                state.house.treasury -= amt;
                state.gold += amt;
                
                // NEW: Infamy for withdrawal (using family funds for self)
                const infamyGain = Math.ceil(amt / 100);
                if (infamyGain > 0) modRep('infamy', infamyGain);

                log(`<strong style="color:var(--royal)">HOUSE EVENT:</strong> You withdrew ${amt}g from the treasury for personal use.`);
            } else {
                showMsg("Treasury Low", "The House coffers cannot afford that.");
            }
        }
        
        closeTransaction();
        updateUI();
    }

    function closeTransaction() {
        document.getElementById('trans-modal').classList.add('hidden');
        pendingTransType = null;
    }

    function donateToHouse() {
        openTransaction('donate');
    }
    
    function withdrawFromHouse() {
        openTransaction('withdraw');
    }

    // NEW: House Treasury Request Logic (Player)
    function requestHouseFunds() {
        if(state.health <= 0) return;
        // UPDATED: Age check (16+)
        if (!checkAge(16)) return;

        if(state.flags.requestedHouseFunds) {
            showMsg("Limit Reached", "You have already petitioned the House this year.");
            return;
        }
        
        // Calculate amount based on rank
        let askAmt = 50;
        if (state.class.includes("Heir")) askAmt = 200;
        if (state.house.treasury < askAmt) {
            showMsg("Treasury Empty", "The House coffers are too low.");
            return;
        }

        state.flags.requestedHouseFunds = true;
        
        const chaMod = getModifier(state.stats.cha);
        const roll = rollD20(chaMod);
        const dc = 12; // Standard DC

        if (roll.total >= dc) {
            state.house.treasury -= askAmt;
            state.gold += askAmt;
            log(`<strong style="color:var(--gold)">APPROVED:</strong> You petitioned your Lord for a stipend. Your silver tongue secured ${askAmt}g.`);
            AudioEngine.pulse();
        } else {
            // Find Lord for flavor
            const ruler = state.house.members.find(m => 
                (m.rank.includes('Lord') || m.rank.includes('Lady') || m.rank.includes('King') || m.rank.includes('Queen') || m.rank.includes('Duke')) 
                && !m.rank.includes('Emeritus')
            );
            const rulerName = ruler ? ruler.name : "The House Council";
            
            log(`<strong style="color:var(--failure)">DENIED:</strong> You petitioned ${rulerName} for funds, but were rebuffed.`);
            // Relationship hit if Lord is NPC
            if (ruler && ruler.id !== 'PLAYER') {
                modRel(ruler.id, -5);
            }
        }
        updateUI();
    }

    // NEW: LORD AUTHORITIES
    function getHoldingUpgradeCost(type, level) {
        // Linear scaling based on base cost: Base * Level
        const tmpl = HOLDING_TEMPLATES[type] || HOLDING_TEMPLATES['Manor'];
        return Math.floor(tmpl.baseCost * 0.5 * (level + 1));
    }

    function upgradeHolding(index) {
        if(state.health <= 0) return;
        const h = state.house.holdings[index];
        
        // CHECK LIMIT
        if (h.upgradedThisYear) {
            showMsg("Limit Reached", "Work is already underway on this holding. Wait until next year.");
            return;
        }

        const tmpl = HOLDING_TEMPLATES[h.type] || HOLDING_TEMPLATES['Manor'];
        const cost = getHoldingUpgradeCost(h.type, h.level);
        
        if (state.house.treasury >= cost) {
            state.house.treasury -= cost;
            h.level++;
            h.upgradedThisYear = true; // SET FLAG
            
            // Apply Template Scaling
            h.capacity = tmpl.basePop + (h.level * tmpl.capPerLvl);
            h.defense = tmpl.baseDef + (h.level * tmpl.defPerLvl);
            
            // Population boost from construction attraction
            h.population += Math.floor(tmpl.capPerLvl * 0.1); 
            
            log(`Expanded ${h.name} to Level ${h.level}. Defense: ${h.defense}, Capacity: ${h.capacity}.`);
            updateUI();
        } else {
            showMsg("Treasury Low", `You need ${cost}g in the House Treasury.`);
        }
    }

    // --- NEW: RECRUIT KNIGHT FUNCTION ---
    function recruitSwornKnight(holdingIndex) {
        if(state.health <= 0) return;
        
        if (!state.house || !state.house.holdings[holdingIndex]) return;
        
        const h = state.house.holdings[holdingIndex];
        const cost = 50;

        if (state.house.treasury < cost) {
            showMsg("Treasury Low", `Recruiting and equipping a Sworn Knight costs ${cost}g from the House Treasury.`);
            return;
        }

        ensureAvailableRetainers(holdingIndex);

        const availableHere = (state.availableRetainers || []).filter(id => {
            const r = state.relationships.find(x => x.id === id);
            return r && r.locationIndex === h.locationIndex && r.health !== 'Deceased';
        });

        if (availableHere.length > 0) {
            return hireRetainer(availableHere[0], holdingIndex);
        }

        state.house.treasury -= cost;
        const gender = Math.random() > 0.5 ? 'Male' : 'Female';
        const name = getRandomName(gender);
        const knight = addRelationship(name, "Sworn Knight", 60, gender, "Knight", h.locationIndex);
        knight.assignedHolding = holdingIndex;
        knight.occupation = "Sworn Knight";
        knight.rank = "Sworn Knight";
        knight.inventory.push({ name: 'House Mail', rarity: 'Uncommon', desc: `Chainmail bearing the sigil of ${state.house.name}.`, value: 50, dr: 4 });
        knight.inventory.push({ ...WEAPON_LIBRARY.longsword, weapon: WEAPON_LIBRARY.longsword, value: 25 });
        addHouseMember(name, gender, "Sworn Knight", h.locationIndex, knight.id);
        log(`<strong style="color:var(--royal)">Recruitment:</strong> You recruited <strong>${getNPCName(knight)}</strong> to guard <strong>${h.name}</strong>. (-${cost}g)`);
        AudioEngine.pulse();
        updateUI();
    }

    function hireRetainer(retainerId, holdingIndex) {
        if(state.health <= 0 || !state.house || !state.house.holdings[holdingIndex]) return;
        const h = state.house.holdings[holdingIndex];
        const cost = 50;
        if (state.house.treasury < cost) {
            showMsg("Treasury Low", `Hiring costs ${cost}g from the House Treasury.`);
            return;
        }
        const knight = state.relationships.find(r => r.id === retainerId);
        if (!knight || !state.availableRetainers.includes(retainerId)) return;
        const wasVeteran = knight.occupation === "Veteran Man-at-Arms";
        
        knight.assignedHolding = holdingIndex;
        knight.seekingEmployment = false;
        knight.occupation = "Sworn Knight";
        knight.rank = "Sworn Knight";
        if (!knight.inventory) knight.inventory = [];
        if (!knight.inventory.some(i => i.name && i.name.includes('Mail'))) {
            knight.inventory.push({ name: 'House Mail', rarity: 'Uncommon', desc: `Chainmail bearing the sigil of ${state.house.name}.`, value: 50, dr: 4 });
        }
        if (!knight.inventory.some(i => i.weapon)) {
            knight.inventory.push({ ...WEAPON_LIBRARY.longsword, weapon: WEAPON_LIBRARY.longsword, value: 25 });
        }
        addHouseMember(knight.name, knight.gender, "Sworn Knight", h.locationIndex, knight.id);
        state.availableRetainers = state.availableRetainers.filter(id => id !== retainerId);
        state.house.treasury -= cost;
        const serviceTag = knight.serviceType ? ` (${knight.serviceType})` : '';
        const typeLabel = wasVeteran ? "Veteran Man-at-Arms" : "Sworn Knight";
        log(`<strong style="color:var(--royal)">Recruitment:</strong> You hired <strong>${getNPCName(knight)}</strong>${serviceTag} as ${typeLabel} to guard <strong>${h.name}</strong>. (-${cost}g)`);
        AudioEngine.pulse();
        updateUI();
    }

    function setHouseTrait(traitName) {
        if(state.health <= 0) return;
        state.house.trait = traitName;
        log(`<strong style="color:var(--gold)">HOUSE DECREE:</strong> You have declared <strong>${traitName}</strong> as the new Bloodline Trait of House ${state.house.name}.`);
        updateUI();
    }

    function purchaseHolding(type) {
        if(state.health <= 0) return;
        const tmpl = HOLDING_TEMPLATES[type];
        if(!tmpl) return;
        const cost = tmpl.baseCost;
        
        if (state.house.treasury >= cost) {
            state.house.treasury -= cost;
            
            // Diverse Naming
            const descriptor = tmpl.descriptors[Math.floor(Math.random() * tmpl.descriptors.length)];
            
            const formats = [
                `${state.house.name} ${descriptor}`,
                `The ${descriptor}`,
                `${descriptor} of ${state.house.name}`,
                `${descriptor} Estate`,
                `${state.house.name}'s ${descriptor}`
            ];
            const newName = formats[Math.floor(Math.random() * formats.length)];
            
            const desc = tmpl.descText[Math.floor(Math.random() * tmpl.descText.length)];

            state.house.holdings.push({
                name: newName,
                desc: desc,
                type: type,
                level: 1,
                locationIndex: state.location,
                population: Math.floor(tmpl.basePop * 0.5), // Starts half full
                capacity: tmpl.basePop + tmpl.capPerLvl, // Level 1 Cap
                defense: tmpl.baseDef + tmpl.defPerLvl
            });
            log(`Purchased a new ${type}: <strong>${newName}</strong>!`);
            updateUI();
        } else {
            showMsg("Treasury Low", `You need ${cost}g in the House Treasury.`);
        }
    }

    function renderHouseTab() {
        const container = document.getElementById('house-content');
        const h = state.house || { name: 'Commoner', tier: 'Common Folk', sigil: 'üåæ', motto: 'Survival is Victory', heirloom: 'None', treasury: 0, trait: 'Hardy', holdings: [] };
        
        // --- HOLDINGS SECTION ---
        let holdingsHtml = '';
        let successionHtml = '';

        if(state.socialClass === 'House') {
            const isLord = state.class.includes("Lord") || state.class.includes("Lady") || state.class.includes("King") || state.class.includes("Queen") || state.class.includes("Duke") || state.class.includes("Duchess");
            
            // BUILD HOLDINGS LIST
            const holdingsList = (h.holdings || []).map((prop, idx) => {
                // Ensure properties exist for legacy saves
                if(!prop.capacity) prop.capacity = prop.population + 100;
                
                const upgradeCost = getHoldingUpgradeCost(prop.type, prop.level);
                // ADDED: City Location Lookup
                const locName = CITIES[prop.locationIndex] ? CITIES[prop.locationIndex].name : "Unknown Lands";

                // --- POPULATION BREAKDOWN LOGIC ---
                let soldiers = 0, servants = 0, knights = 0, commoners = 0;
                const pop = prop.population;

                // Preliminary calculation for soldiers/servants (Knights will be overridden by actuals)
                if (prop.type === 'Keep') {
                    soldiers = Math.floor(pop * 0.20);
                    servants = Math.floor(pop * 0.10);
                } else if (prop.type === 'Manor') {
                    soldiers = Math.floor(pop * 0.05);
                    servants = Math.floor(pop * 0.25);
                } else { // Farm
                    soldiers = Math.floor(pop * 0.01); // Militia
                    servants = Math.floor(pop * 0.05);
                }

                ensureAvailableRetainers(idx);

                const availableHere = (state.availableRetainers || []).filter(id => {
                    const r = state.relationships.find(x => x.id === id);
                    return r && r.locationIndex === prop.locationIndex && r.health !== 'Deceased';
                });

                const stationedKnights = state.relationships.filter(r => 
                    r.health !== 'Deceased' &&
                    state.house.members.some(m => m.id === r.id) &&
                    (r.rank === 'Sworn Knight' || r.rank.includes('Ser') || r.rank.includes('Dame') || (r.occupation && r.occupation.includes('Knight'))) &&
                    r.id !== 'PLAYER' &&
                    (r.assignedHolding === idx || (r.assignedHolding === undefined && r.locationIndex === prop.locationIndex))
                );

                // ARCANE UPDATE: Sync Demographic Count to Actual Entities
                knights = stationedKnights.length;
                commoners = Math.max(0, pop - (soldiers + servants + knights));

                let availableHtml = '';
                if (availableHere.length > 0 && isLord) {
                    availableHtml = `
                    <div class="mt-2 pt-2 border-t border-black/5">
                        <div class="text-[9px] uppercase font-bold opacity-60 mb-1">Available Retainers (${availableHere.length})</div>
                        <div class="space-y-1">
                            ${availableHere.map(id => {
                                const r = state.relationships.find(x => x.id === id);
                                if (!r) return '';
                                const goldVal = (r.gold || 0);
                                return `<div class="npc-card" onclick="openNPC('${r.id}')">
                                    <div><span class="font-bold text-sm">üõ°Ô∏è ${r.name}</span></div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-amber-900 font-bold">${goldVal}g</span>
                                        <button onclick="event.stopPropagation(); hireRetainer('${r.id}', ${idx})" class="text-[10px] px-1.5 py-0.5 bg-green-800 text-white rounded border border-green-900 hover:bg-green-700">Hire 50g</button>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>`;
                }

                let knightsHtml = '';
                if (stationedKnights.length > 0) {
                    knightsHtml = `
                    <div class="mt-2 pt-2 border-t border-black/5">
                        <div class="text-[9px] uppercase font-bold opacity-60 mb-1">Stationed Swords (${stationedKnights.length})</div>
                        <div class="space-y-1">
                            ${stationedKnights.map(k => {
                                // ARCANE UPDATE: Removed Gold Display
                                return `<div class="npc-card" onclick="openNPC('${k.id}')">
                                    <div><span class="font-bold text-sm">üõ°Ô∏è ${k.name}</span></div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>`;
                } else {
                    knightsHtml = `<div class="mt-2 pt-2 border-t border-black/5 text-[10px] italic opacity-50">No knights currently stationed here.</div>`;
                }

                const demogHtml = `
                <div class="mt-2 pt-2 border-t border-black/10 text-[10px] grid grid-cols-4 gap-1 text-center opacity-80">
                    <div>üåæ Common Folk: ${commoners.toLocaleString()}</div>
                    <div>üßπ Servants: ${servants.toLocaleString()}</div>
                    <div>‚öîÔ∏è Guards: ${soldiers.toLocaleString()}</div>
                    <div>üõ°Ô∏è Sworn Knights: ${knights}</div>
                </div>`;

                let lordControls = '';
                if (isLord) {
                    // Logic to check limit
                    const isUpgraded = prop.upgradedThisYear;
                    const btnClass = isUpgraded 
                        ? "bg-gray-400 border-gray-500 cursor-not-allowed opacity-50" 
                        : "bg-green-900 border-green-950 hover:bg-green-800";
                    const btnText = isUpgraded ? "Upgrading..." : `Upgrade (${upgradeCost}g)`;
                    const disabledAttr = isUpgraded ? "disabled" : "";

                    lordControls = `
                    <div class="mt-2 pt-2 border-t border-black/10 flex justify-end gap-2">
                        <button onclick="recruitSwornKnight(${idx})" class="choice-btn text-[10px] px-2 py-1 bg-blue-900 border-blue-950 text-white hover:bg-blue-800">
                            Recruit Knight (50g)
                        </button>
                        <button onclick="upgradeHolding(${idx})" ${disabledAttr} class="choice-btn text-[10px] px-2 py-1 ${btnClass}">
                            ${btnText}
                        </button>
                    </div>`;
                }

                // CHANGED: Use <details> for clickable/expandable interaction
                return `
                <details class="bg-white/40 rounded border border-leather/30 text-left mb-2 group">
                    <summary class="p-3 cursor-pointer list-none flex justify-between items-center hover:bg-white/60 transition-colors select-none">
                        <div>
                            <div class="font-bold text-amber-900 group-open:text-amber-950">${prop.name}</div>
                            <div class="text-xs font-bold text-amber-800 mt-1">üìç ${locName}</div> 
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-bold bg-amber-100 px-1 rounded border border-amber-200">Lvl ${prop.level} ${prop.type}</div>
                            <div class="text-[10px] opacity-50 mt-1 group-open:hidden">‚ñº Details</div>
                        </div>
                    </summary>
                    <div class="px-3 pb-3 border-t border-black/5 bg-white/20">
                        <div class="text-xs italic opacity-70 mb-2 mt-2">${prop.desc}</div>
                        <div class="mt-2 grid grid-cols-2 text-xs gap-2">
                            <div class="flex items-center gap-1" title="Population / Capacity"><span class="text-lg">üë•</span> <span>${prop.population.toLocaleString()} / ${prop.capacity.toLocaleString()}</span></div>
                            <div class="flex items-center gap-1 justify-end"><span class="text-lg">üõ°Ô∏è</span> <span>${prop.defense} Def</span></div>
                        </div>
                        ${demogHtml}
                        ${availableHtml}
                        ${knightsHtml}
                        ${lordControls}
                    </div>
                </details>`;
            }).join('');

            // LORD PURCHASE CONTROLS
            let purchaseHtml = '';
            if (isLord) {
                purchaseHtml = `
                <div class="mt-4 border-t border-black/10 pt-4">
                    <h4 class="font-bold text-sm mb-2 text-left">Purchase New Holdings</h4>
                    <div class="flex gap-2 justify-center">
                        <button onclick="purchaseHolding('Farm')" class="choice-btn text-xs flex-1 flex flex-col items-center p-2">
                            <span class="text-lg">üåæ</span>
                            <span>Farm</span>
                            <span class="opacity-70">${HOLDING_TEMPLATES['Farm'].baseCost}g</span>
                        </button>
                        <button onclick="purchaseHolding('Manor')" class="choice-btn text-xs flex-1 flex flex-col items-center p-2">
                            <span class="text-lg">üè°</span>
                            <span>Manor</span>
                            <span class="opacity-70">${HOLDING_TEMPLATES['Manor'].baseCost}g</span>
                        </button>
                        <button onclick="purchaseHolding('Keep')" class="choice-btn text-xs flex-1 flex flex-col items-center p-2">
                            <span class="text-lg">üè∞</span>
                            <span>Keep</span>
                            <span class="opacity-70">${HOLDING_TEMPLATES['Keep'].baseCost}g</span>
                        </button>
                    </div>
                </div>`;
            }

            // SUCCESSION INFO BOX
            const currentLord = state.house.members.find(m => 
                !m.rank.includes('Emeritus') && !m.rank.includes('Dowager') && !m.rank.includes('Mother') && !m.rank.includes('Consort') &&
                (m.rank.includes('Lord') || m.rank.includes('Lady') || m.rank.includes('King') || m.rank.includes('Queen') || m.rank.includes('Duke') || m.rank.includes('Duchess'))
            );
            // UPDATED: Check for all heir types
            const heir = state.house.members.find(m => m.rank === 'Heir' || m.rank === 'Crown Prince' || m.rank === 'Crown Princess' || m.rank === 'Marquess' || m.rank === 'Marchioness');
            
            successionHtml = `
                <div class="mt-4 pt-4 border-t border-black/10">
                    <h4 class="font-bold text-sm mb-2 text-left">Succession</h4>
                    <div class="grid grid-cols-2 gap-2 text-xs text-left">
                        <div class="bg-purple-900/10 p-2 rounded border border-purple-900/20">
                            <div class="uppercase font-bold text-[10px] opacity-70">Current Head</div>
                            <span class="font-bold text-purple-900">${currentLord ? currentLord.name : 'Interregnum'}</span>
                        </div>
                        <div class="bg-green-900/10 p-2 rounded border border-green-900/20">
                            <div class="uppercase font-bold text-[10px] opacity-70">Heir Apparent</div>
                            <span class="font-bold text-green-800">${heir ? heir.name : 'None'}</span>
                        </div>
                    </div>
                </div>
            `;

            // NEW: Logic for Non-Lord Actions (Request Stipend)
            let memberActions = '';
            if (!isLord) {
                const reqClass = state.flags.requestedHouseFunds ? "opacity-50 cursor-not-allowed bg-gray-400" : "bg-amber-700 border-amber-900";
                const reqText = state.flags.requestedHouseFunds ? "Stipend Requested" : "Request Stipend (CHA)";
                memberActions = `<button onclick="requestHouseFunds()" class="choice-btn text-xs px-2 py-1 ${reqClass}" ${state.flags.requestedHouseFunds ? 'disabled' : ''}>${reqText}</button>`;
                
                // NEW: House Squiring Option
                if (state.age >= 8 && state.age <= 16 && !state.occupation && !state.knighthood.rank) {
                    memberActions += `<button onclick="requestHouseSquiring()" class="choice-btn text-xs px-2 py-1 bg-blue-900 border-blue-950 text-white ml-2">Request Squiring</button>`;
                }
            }

             holdingsHtml = `
                <div class="holding-card mt-6">
                    <div class="holding-icon">üè∞</div>
                    <h3 class="font-medieval text-2xl text-amber-900 mb-2">House Assets</h3>
                    
                    <div class="mt-4 mb-4 flex justify-between items-center bg-amber-50 p-2 rounded border border-amber-100">
                        <div class="text-left">
                             <div class="text-xs uppercase font-bold text-amber-800">Gold</div>
                             <div class="text-xl font-bold text-amber-900">${h.treasury.toLocaleString()} Gold</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="donateToHouse()" class="choice-btn text-xs px-2 py-1 bg-amber-700 border-amber-900">Donate</button>
                            ${isLord ? `<button onclick="withdrawFromHouse()" class="choice-btn text-xs px-2 py-1 bg-amber-800 border-amber-950">Withdraw</button>` : memberActions}
                        </div>
                    </div>

                    <div class="max-h-60 overflow-y-auto pr-1">
                        ${holdingsList}
                    </div>
                    
                    ${purchaseHtml}
                    ${successionHtml}
                </div>`;
        }

        // --- UNIFIED TREE RENDERING LOGIC ---
        const renderNode = (p) => {
            const isDead = p.health === 'Deceased' ? 'dead' : '';
            // Blood badge logic is good, keep it
            const bloodBadge = p.isBlood ? `<span class="tree-blood">Blood</span>` : (p.isFamily ? `<span class="tree-married">In-Law</span>` : '');
            
            let extraIcon = '';
            // UPDATED: Included Duke/Duchess in crown logic
            if (p.rank.includes("Lord") || p.rank.includes("Lady") || p.rank.includes("King") || p.rank.includes("Queen") || p.rank.includes("Duke") || p.rank.includes("Duchess")) {
                if(!p.rank.includes("Emeritus") && !p.rank.includes("Dowager") && !p.rank.includes("Mother") && !p.rank.includes("Consort")) extraIcon = `<div class="tree-crown">üëë</div>`;
            }
            if (p.health === "Deceased") extraIcon += `<div class="tree-grave">üíÄ</div>`;

            return `
                <div class="tree-member ${isDead}" onclick="openNPC('${p.id}')">
                    ${bloodBadge}
                    ${extraIcon}
                    <div class="tree-name">${p.name}</div>
                    <div class="tree-role">${p.relation}</div>
                </div>`;
        };

        // HELPER: Render a person AND their spouse if they have one
        const renderCouple = (p) => {
            let html = renderNode(p);
            
            // Check for linked spouse ID
            if (p.spouseId) {
                const spouse = state.relationships.find(r => r.id === p.spouseId);
                // Only render if spouse exists and isn't already the person passed (safety)
                if (spouse && spouse.id !== p.id) {
                    html += renderNode(spouse);
                    return `<div class="tree-member-group">${html}</div>`;
                }
            }
            return html;
        };

        const renderPlayerNode = () => {
             let extraIcon = '';
             // UPDATED: Included Duke/Duchess/King/Queen
             if (state.class.includes("Lord") || state.class.includes("Lady") || state.class.includes("King") || state.class.includes("Queen") || state.class.includes("Duke") || state.class.includes("Duchess")) extraIcon = `<div class="tree-crown">üëë</div>`;
             
             let html = `
                <div class="tree-member player" onclick="switchTab('char')" title="View Character Sheet">
                    <span class="tree-blood">Blood</span>
                    ${extraIcon}
                    <div class="tree-name">${state.name}</div>
                    <div class="tree-role">You</div>
                </div>`;
            
            // Check for Player Spouse
            const spouse = state.relationships.find(r => r.relation === 'Spouse');
            if (spouse) {
                html += renderNode(spouse);
                return `<div class="tree-member-group">${html}</div>`;
            }
            return html;
        };

        // Gather Relations by Group
        const grandparents = state.relationships.filter(r => ['Grandfather', 'Grandmother'].includes(r.relation));
        const parents = state.relationships.filter(r => ['Father', 'Mother'].includes(r.relation));
        const unclesAunts = state.relationships.filter(r => ['Uncle', 'Aunt'].includes(r.relation));
        const siblings = state.relationships.filter(r => r.relation === 'Sibling');
        
        // --- UPDATED TREE RENDERING ---
        
        // Helper to get kids of a specific person
        const getKidsOf = (parentId) => state.relationships.filter(r => r.parentId === parentId);

        // Recursive function to render a node and its children (Nieces/Nephews/Grandkids)
        const renderDescendants = (person) => {
            const kids = getKidsOf(person.id);
            
            // Render the couple (Person + Spouse)
            const nodeHtml = renderCouple(person); 
            
            if (kids.length === 0) return `<li>${nodeHtml}</li>`;
            
            return `
                <li>
                    ${nodeHtml}
                    <ul>
                        ${kids.map(k => renderDescendants(k)).join('')}
                    </ul>
                </li>
            `;
        };

        // Player Children (Son/Daughter) are direct roots of the player branch
        const playerChildren = state.relationships.filter(r => ['Son', 'Daughter'].includes(r.relation));
        
        // --- BRANCH 1: PLAYER & SIBLINGS (SORTED BY AGE) ---
        // Merge Player and Siblings into one generation list
        const currentGeneration = [...siblings];
        // Add proxy object for Player
        currentGeneration.push({ id: 'PLAYER', age: state.age, isPlayer: true });
        
        // Sort: Oldest to Left (Descending Age)
        currentGeneration.sort((a, b) => b.age - a.age);

        const generationHtml = currentGeneration.map(member => {
            if (member.isPlayer) {
                // Render Player
                return `
                    <li>
                        ${renderPlayerNode()}
                        ${playerChildren.length > 0 ? 
                            `<ul>${playerChildren.map(c => renderDescendants(c)).join('')}</ul>` 
                            : ''}
                    </li>`;
            } else {
                // Render Sibling
                return renderDescendants(member);
            }
        }).join('');

        const playerBranch = `<ul>${generationHtml}</ul>`;

        // --- BRANCH 2: UNCLES/AUNTS & COUSINS ---
        // Use renderCouple to show Uncle+Aunt
        let uaBranch = '';
        if (unclesAunts.length > 0) {
            uaBranch = unclesAunts.map(ua => {
                // If this aunt/uncle is the "primary" (blood), render them + spouse
                // If they are an in-law (married to an uncle/aunt), we skip them here because the blood relative will pull them in via renderCouple
                // NOTE: 'Aunt' usually generated as blood in setup, but if we add logic for Uncle's wife later, she might be 'Aunt' too.
                // For now, assuming Uncles/Aunts in list are blood.
                return `<li>${renderCouple(ua)}</li>`;
            }).join('');
        }

        // --- LEVEL 2: PARENTS + UNCLES/AUNTS ---
        let parentsNode = '';
        if (parents.length > 0) {
            // Filter to just one parent (e.g. Father) to avoid double rendering the couple
            // Since we linked them, renderCouple(Father) will show Mother.
            const primaryParent = parents.find(p => p.gender === 'Male') || parents[0];
            
            parentsNode = `
                <li>
                    ${renderCouple(primaryParent)}
                    ${playerBranch}
                </li>
            `;
        } else {
             // Fallback for orphans or missing parents data in tree
             parentsNode = `
                <li>
                    <div class="tree-member-group opacity-50 border-dashed">Unknown Parents</div>
                    ${playerBranch}
                </li>
            `;
        }

        // --- LEVEL 1: ROOT (Grandparents or Placeholder) ---
        let treeStructure = '';
        
        if (grandparents.length > 0) {
            // Similar logic: Pick Grandfather to render couple
            const primaryGP = grandparents.find(p => p.gender === 'Male') || grandparents[0];
            
            treeStructure = `
                <ul>
                    <li>
                        ${renderCouple(primaryGP)}
                        <ul>
                            ${parentsNode}
                            ${uaBranch}
                        </ul>
                    </li>
                </ul>
            `;
        } else {
            // No Grandparents
            if (state.socialClass === 'Commoner') {
                // For commoners, if no grandparents, skip the "Ancestors" node entirely.
                // Just render the parents/uncles at the top level.
                treeStructure = `
                    <ul>
                        ${parentsNode}
                        ${uaBranch}
                    </ul>
                `;
            } else {
                // For Nobles, always show the "House Ancestors" placeholder for flavor/structure
                treeStructure = `
                    <ul>
                        <li>
                            <div class="p-2 border border-dashed border-leather/30 rounded italic opacity-50 bg-white/20">House Ancestors</div>
                            <ul>
                                ${parentsNode}
                                ${uaBranch}
                            </ul>
                        </li>
                    </ul>
                `;
            }
        }
        
        let houseTraitHtml = '';
        if(state.house && state.house.trait) {
            const mut = MUTATION_POOL.find(m => m.name === state.house.trait);
            const rarity = mut ? mut.rarity.toLowerCase() : 'common';
            // UPDATED: Made clickable
            houseTraitHtml = `<div class="mt-2 text-sm">Bloodline Trait: <span onclick="showTraitInfo('${state.house.trait}')" class="gene-tag mut-${rarity} cursor-pointer hover:scale-110 transition-transform" title="Click for info">${state.house.trait}</span></div>`;
        }

        // NEW: Allow Lord to set Bloodline Trait from own traits
        // UPDATED: Check for all ruler ranks
        const rulerTitles = ['Lord', 'Lady', 'King', 'Queen', 'Duke', 'Duchess'];
        const isRuler = rulerTitles.some(t => state.class.includes(t));

        if (state.socialClass === 'House' && isRuler) {
             const available = [];
             if (state.appearance.mutations) available.push(...state.appearance.mutations.map(m => m.name));
             if (state.traits) available.push(...state.traits);
             
             // Filter out current trait
             const options = available.filter(t => t !== state.house.trait);

             if (options.length > 0) {
                 houseTraitHtml += `<div class="mt-2 pt-2 border-t border-black/10">
                    <div class="text-xs font-bold mb-1 opacity-70">Consecrate Bloodline Trait</div>
                    <div class="flex flex-wrap justify-center gap-1">
                        ${options.map(t => `<button onclick="setHouseTrait('${t}')" class="px-2 py-0.5 text-[10px] border border-leather rounded bg-white/40 hover:bg-amber-700 hover:text-white transition-colors">${t}</button>`).join('')}
                    </div>
                 </div>`;
             }
        }

        let headerTitle = `House ${h.name}`;
        if (state.socialClass === 'Commoner') headerTitle = `Your Family`;

        container.innerHTML = `
            <div class="house-crest opacity-70">${h.sigil}</div>
            <h2 class="text-4xl font-medieval text-amber-900 mb-1">${headerTitle}</h2>
            <div class="mb-4 text-center">
                <span class="font-bold text-lg uppercase tracking-widest block">${h.tier}</span>
                <span class="italic text-sm">"${h.motto}"</span>
                ${houseTraitHtml}
            </div>
            ${holdingsHtml}
            
            <h2 class="text-4xl font-medieval text-amber-900 mt-8 mb-4 border-b-2 border-leather/20 pb-2">Family Tree</h2>
            <div class="tree overflow-x-auto pb-8 flex justify-center">
                ${treeStructure}
            </div>
        `;
    }

    function meetHouseMember(name, gender, rank) {
        addRelationship(name, "Kinsman", 30, gender, rank, state.location);
        log(`You introduced yourself to ${name} of your House.`);
        updateUI();
    }

    function useItem(index) {
        if(state.health <= 0) return; // Guard
        const item = state.inventory[index];
        let used = false;
        let msgParts = [];

        // NEW: Check for effect object
        if (item.effect) {
            // HP Restoration
            if (item.effect.hp) {
                state.health = Math.min(state.maxHealth, state.health + item.effect.hp);
                msgParts.push(`restored ${item.effect.hp} HP`);
                used = true;
            }
            // SP Restoration
            if (item.effect.sp) {
                modSanity(item.effect.sp);
                msgParts.push(`restored ${item.effect.sp} SP`);
                used = true;
            }
            // Trait Removal / Addition (Future proofing)
            if (item.effect.trait) {
                // Logic for adding trait
            }
            
            if (used) {
                log(`<span style="color:var(--success)">USED:</span> You used <strong>${item.name}</strong> and ${msgParts.join(', ')}.`);
                state.inventory.splice(index, 1);
                updateUI();
            }
        } 
        
        // Fallback or Non-usable logic
        if (!used) {
            showMsg("Cannot Use", "This item has no immediate effect.");
        }
    }

    // --- CEMETERY TAB ---
    function renderCemeteryTab() {
        const container = document.getElementById('cemetery-content');
        
        if (state.age < 8) {
            container.innerHTML = `<p class="italic opacity-50 text-center mt-10">You are too young to understand the gravity of this place.</p>`;
            return;
        }

        const dead = state.relationships.filter(r => r.health === "Deceased");

        if (dead.length === 0) {
            container.innerHTML = `<p class="italic opacity-50 text-center mt-10">The earth is undisturbed. You have lost no one yet.</p>`;
            return;
        }

        container.innerHTML = dead.map(r => {
            const lootedClass = r.graveRobbed ? "opacity-50 grayscale" : "";
            const lootedText = r.graveRobbed ? `<span class="text-red-800 font-bold block mt-2 text-xs">DESECRATED</span>` : "";
            const hasInteracted = state.interactions[r.id];
            const cause = r.deathCause || "passed away";
            
            return `
            <div class="grave-card ${lootedClass}">
                <div class="grave-stone">
                    <div class="text-2xl mb-2">‚Ä†</div>
                    <div class="font-bold text-xs uppercase">${r.name}</div>
                    <div class="text-[10px] italic">${r.relation}</div>
                    <div class="text-[10px] mt-1">Died Age ${r.age}</div>
                    <div class="text-[9px] opacity-80 italic mt-1 px-2 leading-tight">${cause}</div>
                </div>
                ${lootedText}
                <div class="flex justify-center gap-2 mt-4">
                    <button onclick="payRespects('${r.id}')" class="choice-btn text-xs justify-center w-auto ${hasInteracted ? 'opacity-50 cursor-not-allowed' : ''}" ${hasInteracted ? 'disabled' : ''}>Pay Respects</button>
                    <button onclick="searchGrave('${r.id}')" class="choice-btn text-xs justify-center w-auto bg-gray-800 text-gray-300 ${hasInteracted ? 'opacity-50 cursor-not-allowed' : ''}" ${hasInteracted ? 'disabled' : ''}>Search Grave</button>
                </div>
            </div>`;
        }).join('');
    }

    function payRespects(id) {
        if(state.health <= 0) return; // Guard
        const r = state.relationships.find(x => x.id === id);
        if(!r) return;
        
        if (state.interactions[id]) {
            showMsg("Visited", "You have already visited this grave this year.");
            return;
        }
        state.interactions[id] = 1; 

        modRep('piety', 2);
        modSanity(2);
        log(`You knelt before the grave of ${r.name}. Your mind feels clearer. (+Piety, +2 SP)`);
        updateUI();
        switchTab('log'); 
    }

    function searchGrave(id) {
        if(state.health <= 0) return; // Guard
        const r = state.relationships.find(x => x.id === id);
        if(!r) return;
        
        if (state.interactions[id]) {
            showMsg("Visited", "You have already visited this grave this year.");
            return;
        }

        if (r.graveRobbed) {
            state.interactions[id] = 1;
            log(`You dig through the disturbed earth of ${r.name}'s grave, but find nothing but old bones.`);
            modSanity(-1);
            updateUI();
            switchTab('log');
            return;
        }

        showConfirm("Desecrating the dead is a heinous act. Are you sure?", () => {
             state.interactions[id] = 1; 
             r.graveRobbed = true;
             modRep('infamy', 10);
             modRep('piety', -10);
             
             const check = rollD20(getModifier(state.stats.int));
             const dc = 14;

             if (check.total >= dc) {
                 const goldFound = Math.floor(Math.random() * 50) + 10;
                 state.gold += goldFound;
                 log(`<strong class="text-amber-600">GRAVE ROBBED:</strong> You dug up ${r.name}'s grave and found ${goldFound} gold! (+Infamy, -Piety)`);
                 if(Math.random() > 0.8) {
                     addItem('Bone Ring', 'Rare', 'Stolen from the dead.', 100);
                 }
             } else {
                 log(`<strong class="text-red-800">CURSED:</strong> You found nothing but rot, and something followed you home. (+Infamy, -Piety)`);
                 addTrait('Haunted');
                 modSanity(-3);
             }
             updateUI();
             switchTab('log');
        });
    }

    // UPDATED: Now accepts effect parameter, dr parameter, AND weapon object
    function addItem(name, rarity, desc, value, effect = null, dr = 0, weapon = null) {
        // --- INVENTORY LIMIT CHECK ---
        const maxSlots = 10 + getModifier(state.stats.str);
        if (state.inventory.length >= maxSlots) {
            log(`<span style="color:var(--failure)">OVERBURDENED:</span> You found <strong>${name}</strong> but had no room (Max ${maxSlots}). It was left behind.`);
            return false;
        }

        state.inventory.push({ 
            name, rarity, desc, value, effect, dr, weapon,
            id: Math.random().toString(36).substr(2, 9) 
        });
        log(`<strong style="color:var(--gold)">ITEM GET:</strong> Found <span class="item-rarity-${rarity}">${name}</span>!`);
        updateUI();
        return true;
    }

    function sellItem(index) {
        if(state.health <= 0) return; // Guard for death
        const item = state.inventory[index];
        state.gold += item.value;
        log(`Sold ${item.name} for ${item.value}g.`);
        state.inventory.splice(index, 1);
        updateUI();
    }

    function modRep(type, amt) { state.reputation[type] += amt; }
    
    function modRel(id, amt, romanceAmt = 0) {
        const r = state.relationships.find(x => x.id === id);
        if(r) {
            r.friendship = Math.min(100, Math.max(-100, r.friendship + amt));
            if (romanceAmt !== 0) r.romance = Math.min(100, Math.max(0, r.romance + romanceAmt));
        }
    }

    function checkUnlocks() {
        // Unlocks UI removed per request, logic maintained silently if needed
        // Original list population code removed.
    }

    function nextTurn() {
        processNextEvent();
    }

    function renderEvent(event) {
        if (!event) {
            nextTurn(); // Skip if invalid
            return;
        }

        // LOCK: Ensure player stays in Chronicle during ANY event interaction (Activities, Quest, etc.)
        state.flags.lockedInChronicle = true;
        updateUI(); // Force UI update to lock tabs visually immediately

        // --- DYNAMIC PROMPT UPDATE ---
        const promptEl = document.getElementById('decision-prompt');
        if (promptEl) {
            promptEl.innerHTML = `
                <div class="text-xl border-b border-amber-900/20 pb-1 mb-1">${event.title}</div>
                <div class="text-base font-serif font-normal opacity-90 leading-tight">${event.text}</div>
            `;
        }

        log(`<strong>${event.title}:</strong> ${event.text}`);
        const container = document.getElementById('choices-container');
        container.innerHTML = '';
        
        let validChoicesCount = 0;

        event.choices.forEach(choice => {
            // Safety check for requirements
            try {
                if (choice.req && !choice.req(state)) return;
            } catch (e) {
                console.warn("Requirement check failed:", e);
                return;
            }

            validChoicesCount++;
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            
            // Safety check for stats to prevent rendering crashes
            let badge = '';
            if (choice.type === 'check') {
                const statName = choice.stat ? choice.stat : 'str'; // Fallback
                const statVal = state.stats[statName] || 10;
                const mod = getModifier(statVal);
                const color = mod >= 0 ? '#86efac' : '#fca5a5';
                badge = `<span class="dc-badge" style="color: ${color}">${statName.toUpperCase()} ${formatMod(mod)} (DC ${choice.dc})</span>`;
            } else if (choice.type === 'flavor') {
                badge = `<span class="opacity-50 text-xs">Free Action</span>`;
            }

            btn.innerHTML = `<span>${choice.text}</span> ${badge}`;
            
            // Wrap click in error handler
            btn.onclick = () => { 
                container.querySelectorAll('button').forEach(b => b.disabled = true); 
                try {
                    resolveChoice(choice); 
                } catch (e) {
                    console.error("Choice resolution failed", e);
                    // Force progression on crash to prevent softlock
                    log(`<span class="text-red-500">Fate stumbled, but time marches on.</span>`);
                    updateUI();
                    nextTurn();
                }
            };
            container.appendChild(btn);
        });

        // FALLBACK: If no choices are valid (e.g. all reqs failed), provide a default continue
        if (validChoicesCount === 0) {
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.innerHTML = `<span>...</span> <span class="opacity-50 text-xs">Continue</span>`;
            btn.onclick = () => { nextTurn(); };
            container.appendChild(btn);
        }
    }

    function resolveChoice(choice) {
        if (choice.type === 'flavor') {
            if (choice.effect) {
                try {
                    choice.effect();
                } catch(e) { console.error("Effect error", e); }
            }
            nextTurn();
        } else if (choice.type === 'combat') {
            // INTEGRATION: Combat System
            // ARCANE FIX: Removed double nextTurn() calls. CombatEngine.endCombat calls nextTurn(), 
            // so calling it here caused the next event in the queue (e.g. Round 2) to be skipped/overwritten.
            CombatEngine.start(
                choice.enemy, 
                () => { // On Victory
                    if(choice.success) log(choice.success);
                    if(choice.onSuccess) choice.onSuccess();
                    updateUI();
                    // nextTurn(); REMOVED
                },
                () => { // On Defeat/Flee
                    if(choice.fail) log(choice.fail);
                    if(choice.onFail) choice.onFail();
                    updateUI();
                    // nextTurn(); REMOVED
                }
            );
        } else if (choice.type === 'check') {
            const statName = choice.stat ? choice.stat : 'str';
            const statVal = state.stats[statName] || 10;
            const result = rollD20(getModifier(statVal));
            
            const passed = result.total >= choice.dc;
            const resultClass = result.isCrit ? 'dice-crit' : (passed ? 'dice-success' : 'dice-failure');
            const resultText = result.isCrit ? 'NAT 20!' : (result.isFail ? 'CRIT FAIL!' : (passed ? 'SUCCESS' : 'FAILURE'));
            
            log(`<div class="mt-2 mb-2 p-2 bg-black/5 rounded text-sm"><span class="font-bold">Rolling ${statName.toUpperCase()}:</span> d20(${result.roll}) ${formatMod(result.mod)} = <span class="text-lg font-bold">${result.total}</span> vs DC ${choice.dc}<br><span class="${resultClass} dice-result">${resultText}</span></div>`);
            
            setTimeout(() => {
                try {
                    if (passed) { 
                        if(choice.success) log(choice.success); 
                        if(choice.onSuccess) choice.onSuccess(); 
                    } else { 
                        if(choice.fail) log(choice.fail); 
                        if(choice.onFail) choice.onFail(); 
                    }
                } catch (e) {
                    console.error("Effect execution failed", e);
                }
                updateUI();
                nextTurn();
            }, 600);
        } else {
            // Fallback for malformed types
            nextTurn();
        }
    }

    function processNextEvent() {
        if (state.health <= 0) {
            death();
            return;
        }

        if (state.eventQueue.length > 0) {
            const evt = state.eventQueue.shift();
            renderEvent(evt);
        } else {
            state.flags.lockedInChronicle = false; // Unlock when queue is empty
            updateUI(); // Refresh UI to unlock tabs
            
            // --- RESET PROMPT ---
            const promptEl = document.getElementById('decision-prompt');
            if (promptEl) promptEl.innerText = "Fate awaits...";

            const container = document.getElementById('choices-container');
            container.innerHTML = '';
            const btn = document.createElement('button');
            btn.className = 'choice-btn justify-center font-bold';
            btn.innerText = "Advance Year";
            btn.onclick = processYear;
            container.appendChild(btn);
        }
    }

    function getPlayerArmor() {
        let armor = 0;
        for (let slot in state.equipped) {
            const item = state.equipped[slot];
            if (item && item.dr) armor += item.dr;
        }
        return armor;
    }

    function takeDamage(amt) {
        const armor = getPlayerArmor();
        const reducedAmt = Math.max(0, amt - armor);
        
        state.health -= reducedAmt;
        if (reducedAmt < amt) {
             log(`<strong class="text-red-800">DAMAGE:</strong> You took ${reducedAmt} damage! (Armor blocked ${amt - reducedAmt})`);
        } else {
             log(`<strong class="text-red-800">DAMAGE:</strong> You took ${reducedAmt} damage!`);
        }
        
        updateUI();
        if (state.health <= 0) {
             state.eventQueue = []; // Clear pending events on death
             death();
        }
    }

    function death() {
        // Unlock tabs so player can explore history/stats
        state.flags.lockedInChronicle = false;
        
        const container = document.getElementById('choices-container');
        container.innerHTML = `
            <div class="text-center text-red-800 font-bold text-xl p-4">YOUR WATCH HAS ENDED</div>
            <div class="text-center mb-4 italic">Fate has claimed you. History moves on.</div>
            <button onclick="restartGame()" class="choice-btn w-full justify-center bg-red-900 text-white font-medieval text-xl">Start New Chronicle</button>
        `;
        log(`<strong style="color:red">DEATH:</strong> At the age of ${state.age}, ${state.name} passes.`);
        
        // Re-enable input area for the button
        document.getElementById('input-area').style.opacity = 1;
        document.getElementById('input-area').style.pointerEvents = 'auto';
        
        updateUI(); // Apply the unlock to tabs
    }

    function log(html) {
        const logEl = document.getElementById('event-log');
        const div = document.createElement('div');
        div.className = 'event-entry';
        div.innerHTML = html;
        logEl.appendChild(div);
        
        logEl.scrollTop = logEl.scrollHeight;
        switchTab('log');
    }

    function updateUI() {
        // Wrap render calls in safety blocks to prevent entire UI freeze if one tab fails
        const safeRender = (fn, name) => {
            try { fn(); } catch(e) { console.error(`UI Render Failed [${name}]:`, e); }
        };

        try {
            for (let key in state.stats) {
                const val = state.stats[key];
                document.getElementById(`stat-${key}`).innerText = val;
                document.getElementById(`mod-${key}`).innerText = formatMod(getModifier(val));
            }

            // Honorific Update (UPDATED)
            let displayName = state.name;
            
            // Knightly Honorifics (System Update)
            // UPDATED: Now applies to Hedge Knights (Rank 1) and above
            // Prevent double-prefixing: skip if name already has Ser or Dame
            if (state.occupation && state.occupation.id === 'knight' && state.occupation.rankIndex >= 1) {
                const hasExistingPrefix = displayName.startsWith('Ser ') || displayName.startsWith('Dame ');
                if (!hasExistingPrefix) {
                    const prefix = state.gender === 'Female' ? "Dame " : "Ser ";
                    displayName = prefix + displayName;
                }
            }
            
            // 1. Append House Name if noble
            if (state.house) {
                displayName += ` ${state.house.name}`;
            }

            // 2. Append Honorific (Default: Occupation Title)
            // UPDATED: Filters out redundant knight titles from suffixes
            if (state.primaryHonorific && !['Ser', 'Dame'].includes(state.primaryHonorific)) {
                displayName += ` the ${state.primaryHonorific}`;
            }

            document.getElementById('display-name').innerText = displayName;

            document.getElementById('gold-display').innerText = state.gold;
            document.getElementById('social-display').innerText = state.socialClass;
            
            // ARCANE UPDATE: PC Sheet Liege Display
            const liegeRow = document.getElementById('liege-container');
            if (state.occupation && state.occupation.id === 'knight' && state.knighthood.isSworn) {
                let masterName = "The Order";
                if (state.knighthood.masterId) {
                    const m = state.relationships.find(r => r.id === state.knighthood.masterId);
                    if(m) {
                        // ARCANE FIX: Use getNPCName for Liege display
                        masterName = getNPCName(m);
                    }
                } else if (state.house) {
                    masterName = `House ${state.house.name}`;
                }
                document.getElementById('liege-display').innerText = masterName;
                liegeRow.classList.remove('hidden');
            } else {
                liegeRow.classList.add('hidden');
            }


            document.getElementById('display-class').innerText = state.class;
            document.getElementById('location-display').innerText = CITIES[state.location].name;
            document.getElementById('header-hp').innerText = `${state.health} / ${state.maxHealth} Health Points`;
            document.getElementById('hp-display').innerText = `${state.health} / ${state.maxHealth}`;
            document.getElementById('armor-display').innerText = getPlayerAC(); 
            document.getElementById('header-sp').innerText = `${state.sanity} / ${state.maxSanity} Sanity Points`;
            document.getElementById('sp-display').innerText = `${state.sanity} / ${state.maxSanity}`;
            document.getElementById('sex-display').innerText = state.gender;
            document.getElementById('align-display').innerText = "True Neutral"; 
            
            document.getElementById('rep-renown').innerText = state.reputation.renown;
            document.getElementById('rep-honor').innerText = state.reputation.honor;
            document.getElementById('rep-piety').innerText = state.reputation.piety;
            document.getElementById('rep-infamy').innerText = state.reputation.infamy;
            
            // RENDER PLAYER GENES & APPEARANCE
            const ap = state.appearance;
            // UPDATED: Removed gender from appearance string (now in its own row)
            document.getElementById('appearance-display').innerText = `${ap.height} Height, ${ap.hair} Hair, ${ap.eyes} Eyes, ${ap.skin} Skin`;

            const geneList = document.getElementById('gene-list');
            let htmlContent = '';

            // 1. Defect Slot (Red Badge)
            if (ap.defect) {
                htmlContent += `<div class="mb-1"><span onclick="showTraitInfo('${ap.defect.name}')" class="gene-tag bg-red-800 text-white border-red-950 cursor-pointer hover:scale-110" title="${ap.defect.desc}">‚ö† ${ap.defect.name}</span></div>`;
            }

            // 2. Mutations
            if (ap.mutations && ap.mutations.length > 0) {
                htmlContent += ap.mutations.map(m => {
                    return `<span onclick="showTraitInfo('${m.name}')" class="gene-tag mut-${m.rarity.toLowerCase()} cursor-pointer hover:scale-110 transition-transform" title="Click for info">${m.name}</span>`;
                }).join('');
            } 
            
            // Fallback
            if (!ap.defect && (!ap.mutations || ap.mutations.length === 0)) {
                htmlContent = '<span class="italic opacity-50">No distinctive mutations.</span>';
            }

            geneList.innerHTML = htmlContent;

            // RENDER HONORIFICS (NEW)
            const honList = document.getElementById('honorific-list');
            if (state.honorifics.length === 0) {
                honList.innerHTML = '<span class="italic opacity-50">No titles yet.</span>';
            } else {
                honList.innerHTML = state.honorifics.map(h => {
                    const isActive = h === state.primaryHonorific;
                    const style = isActive 
                        ? 'bg-[#5d4037] text-[#f4e4bc] border-[#2c1e16] ring-1 ring-[#b8860b]' 
                        : 'bg-white/50 border-[#5d4037] hover:bg-[#5d4037] hover:text-white text-gray-800';
                    return `<button onclick="setHonorific('${h}')" class="px-2 py-1 border rounded text-xs transition-colors font-medieval ${style}">${h}</button>`;
                }).join('');
            }
            
            // LOCK TABS VISUALLY
            // MODIFIED: Only disable specific tabs, keeping Char and Inv open
            const allowedTabs = ['tab-log', 'tab-char', 'tab-inv'];
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (state.flags.lockedInChronicle && !allowedTabs.includes(btn.id)) {
                    btn.classList.add('disabled');
                } else {
                    btn.classList.remove('disabled');
                }
            });

        } catch(e) { console.error("UI Header Update Failed", e); }

        safeRender(renderHouseTab, 'House');
        safeRender(renderRelTab, 'Relations');
        safeRender(renderOccupationTab, 'Occupation');
        safeRender(renderInventory, 'Inventory');
        safeRender(renderMapTab, 'Map');
        safeRender(renderActivitiesTab, 'Activities');
        safeRender(renderMarketTab, 'Market'); 
        safeRender(renderCemeteryTab, 'Cemetery'); 
    }

    function addTrait(trait) {
        if(state.traits.includes(trait)) return;
        state.traits.push(trait);
        
        // NEW: Apply Stat Modifiers from Traits
        const def = TRAIT_LIBRARY[trait];
        if (def && def.stats) {
            for (let s in def.stats) {
                state.stats[s] += def.stats[s];
            }
        }

        const list = document.getElementById('traits-list');
        if (state.traits.length === 1) list.innerHTML = '';
        
        // UPDATED: Render as clickable item
        const div = document.createElement('div');
        div.className = "cursor-pointer hover:bg-amber-900/10 p-1 rounded -ml-1 transition-colors flex items-center gap-2";
        div.onclick = () => showTraitInfo(trait);
        div.innerHTML = `<span>‚Ä¢ ${trait}</span> <span class="text-[10px] opacity-50">üõà</span>`;
        list.appendChild(div);
        
        log(`<strong>New Trait:</strong> ${trait}`);
    }

    // ADDED: Honorific Helpers
    function addHonorific(title) {
        if(!state.honorifics.includes(title)) {
            state.honorifics.push(title);
        }
        state.primaryHonorific = title;
        updateUI();
    }

    function setHonorific(title) {
        state.primaryHonorific = title;
        updateUI();
    }

    function switchTab(tab) {
        // MODIFIED: No popup, just logic check. 
        // Allowed tabs: Log (Chronicle), Char (Character), Inv (Inventory)
        const allowed = ['log', 'char', 'inv'];
        
        if (state.flags.lockedInChronicle && !allowed.includes(tab)) {
            return; // Silent failure, tab is visually disabled via CSS
        }
        
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`${tab}-tab`).classList.remove('hidden');
        document.getElementById(`tab-${tab}`).classList.add('active');
    }

    // --- NEW: BIRTH & PARENTING ENGINE ---

    function triggerBirthSequence() {
        state.flags.isPregnant = false;
        const partnerId = state.flags.pregnancyPartnerId;
        const partner = state.relationships.find(r => r.id === partnerId);
        
        // 1. Determine Number of Births
        const numBirths = getBirthCount();
        state.pendingBirths = []; // Queue for the modal

        // 2. Pre-generate all children
        for (let i = 0; i < numBirths; i++) {
            const gender = Math.random() > 0.5 ? 'Male' : 'Female';
            const defaultName = getRandomName(gender);
            
            // Genetics
            const fatherObj = partner || { appearance: GeneticEngine.generate() }; // Fallback if unknown
            const playerProxy = { appearance: state.appearance, id: 'PLAYER' };
            const appearance = GeneticEngine.mix(fatherObj, playerProxy);
            
            // Push to queue
            state.pendingBirths.push({
                tempId: i,
                gender: gender,
                defaultName: defaultName,
                appearance: appearance,
                fatherId: partnerId || 'Unknown',
                motherId: 'PLAYER',
                totalBirths: numBirths
            });
        }

        // 3. Open Modal for First Child
        renderBirthModal();
    }

    function renderBirthModal() {
        if (!state.pendingBirths || state.pendingBirths.length === 0) {
            document.getElementById('birth-modal').classList.add('hidden');
            return;
        }

        const child = state.pendingBirths[0];
        const container = document.getElementById('birth-content');
        const input = document.getElementById('birth-name-input');
        
        input.value = child.defaultName;

        // Render Visuals
        let geneHtml = '';
        if (child.appearance.mutations.length > 0) {
            geneHtml = child.appearance.mutations.map(m => `<span class="gene-tag mut-${m.rarity.toLowerCase()}">${m.name}</span>`).join('');
        } else {
            geneHtml = `<span class="italic opacity-50 text-xs">No distinctive mutations.</span>`;
        }
        
        if (child.appearance.defect) {
            geneHtml += `<div class="mt-1"><span class="gene-tag bg-red-800 text-white border-red-950">‚ö† ${child.appearance.defect.name}</span></div>`;
        }

        const title = child.totalBirths > 1 ? `Child ${child.totalBirths - state.pendingBirths.length + 1} of ${child.totalBirths}` : "A New Life";

        container.innerHTML = `
            <div class="text-sm font-bold uppercase text-center mb-2 tracking-widest opacity-60">${title}</div>
            <div class="bg-white/50 p-4 rounded border border-[#5d4037] text-center">
                <div class="text-5xl mb-2">${child.gender === 'Male' ? 'üë¶' : 'üëß'}</div>
                <div class="text-xl font-bold mb-1">${child.gender}</div>
                <div class="text-xs italic mb-3">
                    ${child.appearance.hair} Hair, ${child.appearance.eyes} Eyes, ${child.appearance.skin} Skin
                </div>
                <div class="border-t border-black/10 pt-2">
                    <div class="text-[10px] uppercase font-bold mb-1">Genetic Potential</div>
                    <div>${geneHtml}</div>
                </div>
            </div>
        `;

        document.getElementById('birth-modal').classList.remove('hidden');
        input.focus();
        input.select();
    }

    function confirmBirth() {
        const input = document.getElementById('birth-name-input');
        const name = input.value || "Nameless"; // Fallback
        const childData = state.pendingBirths.shift(); // Remove from queue

        // 1. Create Relationship
        const child = addRelationship(name, (childData.gender === 'Male' ? 'Son' : 'Daughter'), 80, childData.gender, "House Member", state.location, true, true, 0);
        
        // 2. Apply Genetics & Link
        child.appearance = childData.appearance;
        child.motherId = childData.motherId;
        child.fatherId = childData.fatherId;

        // 3. Add to House
        if (state.house) {
            addHouseMember(name, childData.gender, "House Member", state.location, child.id);
        }

        // 4. Log
        log(`<strong style="color:var(--gold)">BIRTH:</strong> You welcomed <strong>${name}</strong> (${childData.gender}) into the world.`);

        // 5. Next or Finish
        if (state.pendingBirths.length > 0) {
            renderBirthModal();
        } else {
            document.getElementById('birth-modal').classList.add('hidden');
            modSanity(5);
            updateUI();
        }
    }

    function generateParentingEvent() {
        // Filter living children
        const children = state.relationships.filter(r => ['Son', 'Daughter'].includes(r.relation) && r.health !== 'Deceased');
        if (children.length === 0) return null;

        const child = children[Math.floor(Math.random() * children.length)];
        
        // Age Categories
        let stage = 'infant'; // 0-2
        if (child.age >= 3 && child.age < 13) stage = 'child';
        else if (child.age >= 13 && child.age < 18) stage = 'teen';
        else if (child.age >= 18) stage = 'adult';

        const pools = {
            infant: [
                createEvent(`par_inf_cry_${child.id}`, `Sleepless Night`, `${child.name} is crying uncontrollably.`, [
                    { text: 'Comfort Them', type: 'check', stat: 'con', dc: 10, success: 'They settle down. (+Rel)', fail: 'You are exhausted. (-1 HP)', onSuccess: () => modRel(child.id, 10), onFail: () => takeDamage(1) },
                    { text: 'Sing Lullaby', type: 'check', stat: 'cha', dc: 10, success: 'They sleep peacefully. (+Rel, +3 SP)', fail: 'They cry louder.', onSuccess: () => { modRel(child.id, 15); modSanity(3); }, onFail: () => modSanity(-1) },
                    { text: 'Ignore', type: 'flavor', effect: () => { modRel(child.id, -5); modSanity(-1); log("A long night."); } }
                ]),
                createEvent(`par_inf_word_${child.id}`, `First Words`, `${child.name} is babbling and looking at you.`, [
                    { text: 'Teach "Mama/Papa"', type: 'check', stat: 'cha', dc: 12, success: 'They say it! (+3 SP)', fail: 'They just drool.', onSuccess: () => modSanity(3), onFail: () => {} },
                    { text: 'Teach "Sword"', type: 'check', stat: 'str', dc: 12, success: 'A warrior born! (+Rel)', fail: 'Goo-goo.', onSuccess: () => modRel(child.id, 15), onFail: () => {} },
                    { text: 'Smile', type: 'flavor', effect: () => { modRel(child.id, 10); log("A happy moment."); } }
                ])
            ],
            child: [
                createEvent(`par_kid_play_${child.id}`, `Playtime`, `${child.name} wants to play pretend.`, [
                    { text: 'Play Monster', type: 'check', stat: 'str', dc: 10, success: 'They squeal with joy! (+Rel)', fail: 'You scare them too much.', onSuccess: () => modRel(child.id, 15), onFail: () => modRel(child.id, -5) },
                    { text: 'Tell Story', type: 'check', stat: 'int', dc: 10, success: 'They listen intently. (+Rel)', fail: 'They get bored.', onSuccess: () => modRel(child.id, 15), onFail: () => {} },
                    { text: 'Too Busy', type: 'flavor', effect: () => { modRel(child.id, -10); log("They walk away sad."); } }
                ]),
                createEvent(`par_kid_trouble_${child.id}`, `Mischief`, `${child.name} broke a vase!`, [
                    { text: 'Scold', type: 'check', stat: 'cha', dc: 12, success: 'They apologize. (+Discipline)', fail: 'They throw a tantrum.', onSuccess: () => modRel(child.id, 5), onFail: () => modRel(child.id, -10) },
                    { text: 'Forgive', type: 'flavor', effect: () => { modRel(child.id, 10); log("You sweep up the pieces together."); } },
                    { text: 'Discipline', type: 'flavor', effect: () => { modRel(child.id, -15); log("You sent them to bed without supper."); } }
                ])
            ],
            teen: [
                createEvent(`par_teen_reb_${child.id}`, `Rebellion`, `${child.name} refuses to do their chores.`, [
                    { text: 'Demand Respect', type: 'check', stat: 'cha', dc: 14, success: 'They fall in line. (+Respect)', fail: 'They storm out. (-Rel)', onSuccess: () => modRel(child.id, 5), onFail: () => modRel(child.id, -20) },
                    { text: 'Talk Calmly', type: 'check', stat: 'wis', dc: 12, success: 'You reach an understanding. (+Rel)', fail: 'They roll their eyes.', onSuccess: () => modRel(child.id, 15), onFail: () => modRel(child.id, -5) },
                    { text: 'Punish', type: 'flavor', effect: () => { modRel(child.id, -30); log("Resentment grows."); } }
                ]),
                createEvent(`par_teen_love_${child.id}`, `Young Love`, `${child.name} asks for advice about a crush.`, [
                    { text: 'Encourage', type: 'check', stat: 'cha', dc: 10, success: 'They beam with hope. (+Rel)', fail: 'Bad advice.', onSuccess: () => modRel(child.id, 20), onFail: () => modRel(child.id, -5) },
                    { text: 'Warn them', type: 'check', stat: 'wis', dc: 12, success: 'They appreciate the caution.', fail: 'They think you are old.', onSuccess: () => modRel(child.id, 10), onFail: () => modRel(child.id, -10) },
                    { text: 'Dismiss', type: 'flavor', effect: () => { modRel(child.id, -10); log("You tell them to focus on studies."); } }
                ])
            ],
            adult: [
                createEvent(`par_adult_money_${child.id}`, `Financial Aid`, `${child.name} asks for coin to start a venture.`, [
                    { text: 'Give 50g', type: 'flavor', req: s => s.gold >= 50, effect: () => { state.gold -= 50; modRel(child.id, 30); log("You support their dreams."); } },
                    { text: 'Loan it', type: 'check', stat: 'int', dc: 12, success: 'They agree to terms. (+Rel)', fail: 'They are insulted.', onSuccess: () => modRel(child.id, 10), onFail: () => modRel(child.id, -10) },
                    { text: 'Refuse', type: 'flavor', effect: () => { modRel(child.id, -20); log("You tell them to earn it themselves."); } }
                ]),
                createEvent(`par_adult_visit_${child.id}`, `A Visit`, `${child.name} comes to visit you.`, [
                    { text: 'Feast', type: 'flavor', req: s => s.gold >= 10, effect: () => { state.gold -= 10; modRel(child.id, 20); log("A wonderful evening."); } },
                    { text: 'Chat', type: 'check', stat: 'cha', dc: 10, success: 'Great conversation. (+Rel)', fail: 'Awkward silence.', onSuccess: () => modRel(child.id, 15), onFail: () => {} },
                    { text: 'Ask for Help', type: 'flavor', effect: () => { modRel(child.id, -5); log("You burden them with your problems."); } }
                ])
            ]
        };

        const pool = pools[stage];
        return pool[Math.floor(Math.random() * pool.length)];
    }

    // --- WEDDING SYSTEM (Renovated) ---
    
    function improveFamilyRelations(amt) {
        state.relationships.forEach(r => {
            if (r.isFamily || r.isBlood) {
                modRel(r.id, amt);
            }
        });
        log(`Your family approves of the union. (+${amt} Rel with Kin)`);
    }

    function processWeddingGifts(tier) {
        // Collect gifts from family/friends (Not the spouse)
        const friends = state.relationships.filter(r => (r.friendship > 50 || r.isFamily) && r.health !== 'Deceased' && r.relation !== 'Spouse');
        
        let giftCount = 0;
        let goldTotal = 0;
        
        friends.forEach(f => {
            let giveChance = 0.5;
            if (tier === 'grand') giveChance = 0.8;
            if (tier === 'royal') giveChance = 1.0;
            
            if (Math.random() < giveChance) {
                let giftVal = Math.floor(Math.random() * 20) + 5; // Base 5-25g
                if (tier === 'grand') giftVal *= 2;
                if (tier === 'royal') giftVal *= 5;
                
                // Wealthier NPCs give more
                if (f.rank.includes('Lord') || f.rank.includes('Lady')) giftVal *= 2;
                
                goldTotal += giftVal;
                giftCount++;
            }
        });

        if (goldTotal > 0) {
            state.gold += goldTotal;
            log(`<strong style="color:var(--gold)">Wedding Gifts:</strong> You received ${goldTotal}g in gifts from ${giftCount} guests.`);
        } else if (friends.length > 0) {
            log("Your guests ate well, but brought no gifts.");
        }
    }

    function triggerWeddingPlanning(spouseId) {
        const spouse = state.relationships.find(r => r.id === spouseId);
        
        const evt = createEvent('wedding_plan', 'Wedding Arrangements', `You and ${spouse.name} are to be wed! How will you celebrate this union?`, [
            {
                text: 'Elopement (Free)',
                type: 'flavor',
                effect: () => {
                    log("You exchange vows in secret under the moonlight.");
                    marryNPC(spouseId);
                    modRep('renown', -2); // Slight scandal
                }
            },
            {
                text: 'Simple Ceremony (50g)',
                type: 'flavor',
                req: s => s.gold >= 50,
                effect: () => {
                    state.gold -= 50;
                    log("A modest but beautiful ceremony at the local temple.");
                    marryNPC(spouseId);
                    modRep('renown', 5);
                    modRel(spouseId, 10);
                    processWeddingGifts('simple');
                }
            },
            {
                text: 'Grand Feast (200g)',
                type: 'flavor',
                req: s => s.gold >= 200,
                effect: () => {
                    state.gold -= 200;
                    log("A celebration filled with music, wine, and laughter!");
                    marryNPC(spouseId);
                    modRep('renown', 25);
                    modRel(spouseId, 20);
                    improveFamilyRelations(15);
                    processWeddingGifts('grand');
                }
            },
            {
                text: 'Royal Extravaganza (1000g)',
                type: 'flavor',
                req: s => s.gold >= 1000,
                effect: () => {
                    state.gold -= 1000;
                    log("A legendary wedding that will be sung of for generations!");
                    marryNPC(spouseId);
                    modRep('renown', 100);
                    modRel(spouseId, 50);
                    improveFamilyRelations(40);
                    processWeddingGifts('royal');
                }
            },
            {
                text: 'Postpone',
                type: 'flavor',
                effect: () => {
                    log(`You decide to wait to plan the wedding.`);
                }
            }
        ]);
        renderEvent(evt);
    }

    // Initialize Game
    window.onload = init;
</script>

</body>
</html>
